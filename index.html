<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Tactical Command V7</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #020617; --card: #0f172a; --sidebar: #020617;
            --primary: #2dd4bf; --accent: #3b82f6; --danger: #f43f5e; --warn: #fbbf24;
            --text: #f8fafc; --text-muted: #64748b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #1e293b; display: flex; flex-direction: column; z-index: 1000; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 12px; font-weight: 700; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #0f172a; color: var(--primary); border-right: 4px solid var(--primary); }

        /* Layout */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at 10% 10%, #0f172a, transparent); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #1e293b; padding-bottom: 10px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }

        /* KPI & Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #1e293b; text-align: center; }
        .kpi-val { font-family: 'Orbitron'; font-size: 24px; color: var(--primary); display: block; }

        .scooter-card { background: var(--card); border: 1px solid #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 15px; }
        .timer-display { font-family: 'Orbitron'; font-size: 32px; color: var(--primary); text-align: center; margin: 15px 0; }
        
        /* Buttons */
        .btn { padding: 10px 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-start { background: var(--primary); color: #000; width: 100%; margin-bottom: 20px; font-size: 18px; }
        .btn-pause { background: var(--warn); color: #000; flex: 1; }
        .btn-resume { background: var(--accent); color: #fff; flex: 1; }
        .btn-stop { background: var(--danger); color: #fff; flex: 1; }

        .glass-table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; font-size: 13px; }
        th { background: #020617; padding: 12px; text-align: right; color: var(--text-muted); }
        td { padding: 12px; border-bottom: 1px solid #1e293b; }

        #login-overlay { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media(max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 65px; flex-direction: row; border-top: 1px solid #1e293b; border-left: none; }
            .nav-item { flex-direction: column; font-size: 10px; flex: 1; padding: 10px; }
            .main-content { padding-bottom: 80px; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="background:var(--card); padding:40px; border-radius:20px; text-align:center; width:340px; border:1px solid #1e293b;">
            <h1 style="font-family:Orbitron; color:var(--primary)">YALLA LOGIN</h1>
            <input type="password" id="passInput" style="width:100%; padding:15px; margin:20px 0; background:#000; border:1px solid #1e293b; color:var(--primary); font-size:24px; text-align:center;" placeholder="****">
            <button onclick="login()" class="btn btn-start">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <nav class="sidebar">
        <div class="nav-item active" onclick="nav('rental')"><i class="fas fa-motorcycle"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
        <div class="nav-item" onclick="nav('attendance')"><i class="fas fa-fingerprint"></i> Ø§Ù„Ø­Ø¶ÙˆØ±</div>
        <div class="nav-item" onclick="nav('maint')"><i class="fas fa-tools"></i> Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</div>
        <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="nav-item" style="color:var(--danger); margin-top:auto" onclick="location.reload()"><i class="fas fa-power-off"></i></div>
    </nav>

    <main class="main-content">
        <div class="top-bar">
            <h2 id="p-title" style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div id="clock" style="font-family:Orbitron; color:var(--primary)">00:00:00</div>
        </div>

        <!-- Section: Rental -->
        <div id="sec-rental" class="section active">
            <button class="btn btn-start" onclick="newTripPopup()">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© ØªÙƒØªÙŠÙƒÙŠØ©</button>
            <div id="active-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;"></div>
        </div>

        <!-- Section: Maintenance -->
        <div id="sec-maint" class="section">
            <button class="btn btn-start" style="background:var(--warn)" onclick="maintPopup()">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ Ù…ÙØ§Ø¬Ø¦</button>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="maint-list"></tbody>
            </table>
        </div>

        <!-- Section: Attendance -->
        <div id="sec-attendance" class="section">
            <div class="kpi-card" style="padding:40px">
                <i class="fas fa-map-marker-alt" style="font-size:40px; color:var(--primary); margin-bottom:20px;"></i>
                <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</h3>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-resume" onclick="attendance('IN')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
                    <button class="btn btn-stop" onclick="attendance('OUT')">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <!-- Section: Admin (History) -->
        <div id="sec-admin" class="section">
            <div class="top-bar">
                <input type="date" id="historyDate" onchange="loadHistory(this.value)" style="padding:10px; background:#000; color:white; border:1px solid var(--primary); border-radius:8px;">
                <div id="day-rev" style="color:var(--primary); font-weight:bold;">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…: 0 Ø¬</div>
            </div>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead>
                <tbody id="history-list"></tbody>
            </table>
        </div>
    </main>

    <script>
        // --- Config ---
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 };
        const MIN_COST = 40; // Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº
        const MIN_TIME = 15; // Ø£ÙˆÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù€ 40

        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();

        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'), 1000);

        // --- Auth ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                if(p === "9924") document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                initSync();
            } else { Swal.fire('Error', 'Wrong Code', 'error'); }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'admin') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('historyDate').value = today;
                loadHistory(today);
            }
            if(id === 'maint') loadMaint();
        }

        // --- Core Rental ---
        function initSync() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('active-grid'); grid.innerHTML = "";
                snap.forEach(t => {
                    const d = t.val();
                    let elapsed = 0;
                    if(d.status === 'active') {
                        elapsed = Math.floor((Date.now() - d.startTime - (d.pausedDuration || 0)) / 60000);
                    } else {
                        elapsed = Math.floor((d.pauseStart - d.startTime - (d.pausedDuration || 0)) / 60000);
                    }

                    grid.innerHTML += `
                        <div class="scooter-card">
                            <div style="display:flex; justify-content:space-between"><b>${d.scooter}</b><small>${d.client}</small></div>
                            <div class="timer-display">${elapsed}m</div>
                            <div style="display:flex; gap:10px;">
                                ${d.status === 'active' ? 
                                    `<button class="btn btn-pause" onclick="pauseTrip('${t.key}')"><i class="fas fa-pause"></i> ÙˆÙ‚Ù</button>` : 
                                    `<button class="btn btn-resume" onclick="resumeTrip('${t.key}')"><i class="fas fa-play"></i> Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`
                                }
                                <button class="btn btn-stop" onclick="endTripPopup('${t.key}', ${elapsed}, '${d.scooter}', '${d.client}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function newTripPopup() {
            const { value: form } = await Swal.fire({
                title: 'Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                html: '<input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">',
                background: '#020617', color: '#fff', confirmButtonColor: '#2dd4bf',
                preConfirm: () => [document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-n').value]
            });
            if(form && form[0]) {
                db.ref('active_trips').push({ scooter:form[0], client:form[1]||'Ø²Ø§Ø¦Ø±', startTime:Date.now(), status:'active', pausedDuration: 0 });
                sendTG(`ğŸ›µ <b>Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª</b>\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${form[0]}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${form[1]||'Ø²Ø§Ø¦Ø±'}`);
            }
        }

        function pauseTrip(key) {
            db.ref(`active_trips/${key}`).update({ status: 'paused', pauseStart: Date.now() });
        }

        function resumeTrip(key) {
            db.ref(`active_trips/${key}`).once('value', snap => {
                const d = snap.val();
                const diff = Date.now() - d.pauseStart;
                db.ref(`active_trips/${key}`).update({ status: 'active', pausedDuration: (d.pausedDuration || 0) + diff });
            });
        }

        async function endTripPopup(key, mins, scooter, client) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±: Ø£ÙˆÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù€ 40ØŒ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø¨Ù€ 2.66 (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ 40/15)
            let cost = MIN_COST;
            if(mins > MIN_TIME) {
                cost = MIN_COST + (mins - MIN_TIME) * 2.66;
            }
            cost = Math.round(cost);

            const { value: result } = await Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨',
                html: `
                    <h2 style="color:var(--primary)">${cost} Ø¬.Ù…</h2>
                    <p>Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                    <hr>
                    <input id="sw-disc" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ… (Ø¥Ù† ÙˆØ¬Ø¯)">
                    <input id="sw-reason" class="swal2-input" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø®ØµÙ… / Ø§Ù„Ø¹Ø·Ù„">
                `,
                background: '#020617', color: '#fff', showCancelButton: true,
                preConfirm: () => {
                    return { disc: parseFloat(document.getElementById('sw-disc').value) || 0, reason: document.getElementById('sw-reason').value }
                }
            });

            if(result) {
                const final = cost - result.disc;
                const today = new Date().toISOString().split('T')[0];
                
                db.ref(`history/${today}`).push({ scooter, client, mins, cost, disc: result.disc, reason: result.reason, final });
                db.ref('active_trips/'+key).remove();

                let msg = `ğŸ <b>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${scooter}\nğŸ•’ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬`;
                if(result.disc > 0) msg += `\nâš ï¸ Ø®ØµÙ…: ${result.disc} Ø¬\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: ${result.reason}\nâœ… Ø§Ù„Ù…Ø­ØµÙ„: ${final} Ø¬`;
                sendTG(msg);

                Swal.fire('ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡', `Ø§Ù„Ù…Ø­ØµÙ„: ${final} Ø¬`, 'success');
            }
        }

        // --- Admin & History ---
        function loadHistory(date) {
            db.ref(`history/${date}`).on('value', snap => {
                const list = document.getElementById('history-list'); list.innerHTML = "";
                let total = 0;
                snap.forEach(c => {
                    const v = c.val();
                    total += (v.final || 0);
                    list.innerHTML += `<tr><td>${v.scooter}</td><td>${v.client}</td><td>${v.mins}m</td><td>${v.cost}</td><td style="color:red">${v.disc}</td><td>${v.reason||'-'}</td></tr>`;
                });
                document.getElementById('day-rev').innerText = `Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…: ${total} Ø¬`;
            });
        }

        // --- Maintenance ---
        async function maintPopup() {
            const { value: f } = await Swal.fire({
                title: 'ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„',
                html: '<input id="m-s" class="swal2-input" placeholder="Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="m-e" class="swal2-input" placeholder="Ø§Ù„Ø¹Ø·Ù„"><input id="m-c" class="swal2-input" type="number" placeholder="ØªÙƒÙ„ÙØ© Ø§Ù„Ù‚Ø·Ø¹Ø©">',
                background: '#020617', color: '#fff',
                preConfirm: () => [document.getElementById('m-s').value.toUpperCase(), document.getElementById('m-e').value, document.getElementById('m-c').value]
            });
            if(f) {
                db.ref('maintenance_log').push({ scooter:f[0], error:f[1], cost:parseFloat(f[2])||0, date:Date.now() });
                sendTG(`ğŸ› ï¸ <b>Ø¹Ø·Ù„ Ù…Ø³Ø¬Ù„</b>\nğŸ›µ ${f[0]}\nğŸ”§ Ø§Ù„Ø¹Ø·Ù„: ${f[1]}\nğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ©: ${f[2]} Ø¬`);
                Swal.fire('ØªÙ…', 'Ø³ÙØ¬Ù„ Ø§Ù„Ø¹Ø·Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        function loadMaint() {
            db.ref('maintenance_log').limitToLast(15).on('value', snap => {
                const tb = document.getElementById('maint-list'); tb.innerHTML = "";
                snap.forEach(c => {
                    const v = c.val();
                    tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.error}</td><td style="color:red">${v.cost}</td><td>${new Date(v.date).toLocaleDateString()}</td></tr>`;
                });
            });
        }

        // --- Utils ---
        function sendTG(text) {
            fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: TELEGRAM.chat, text, parse_mode: 'HTML' })
            });
        }

        function attendance(type) {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, SHOP_LOC.lat, SHOP_LOC.lng);
                if(dist > 200) return Swal.fire('Error', 'Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø­Ù„', 'error');
                const t = new Date().toLocaleTimeString();
                sendTG(`ğŸ“ <b>${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'}</b>\nğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${t}`);
                Swal.fire('ØªÙ…', `Ø³ÙØ¬Ù„Øª Ø§Ù„Ø­Ø±ÙƒØ©: ${t}`, 'success');
            });
        }

        function getDist(la1, lo1, la2, lo2) {
            const R = 6371e3; const d1 = la1*Math.PI/180, d2 = la2*Math.PI/180;
            const dl = (la2-la1)*Math.PI/180, do1 = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dl/2)**2 + Math.cos(d1)*Math.cos(d2)*Math.sin(do1/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

    </script>
</body>
</html>
