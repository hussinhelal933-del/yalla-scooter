<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Titan V75 | Cyber Command</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --card: #0a0a0a; --primary: #00d2ff; --danger: #ff0055; --success: #00ff9d; --warn: #ffcc00; --border: rgba(0, 210, 255, 0.1); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin:0; padding:0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        .app-header { height: 60px; background: #050505; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .app-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        
        .trip-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; border-right: 4px solid var(--primary); }
        .unit-timer { font-family: 'Rajdhani'; font-size: 38px; text-align: center; color: var(--primary); font-weight: 900; }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 15px; text-align: center; }
        .kpi-val { font-family: 'Rajdhani'; font-size: 22px; font-weight: 700; color: var(--primary); }

        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-ghost { background: #111; color: #aaa; border: 1px solid #333; }

        .cam-box { height: 180px; background: #000; border-radius: 15px; margin: 10px 0; overflow: hidden; border: 1px dashed #333; position: relative; }
        video, #photo-res { width: 100%; height: 100%; object-fit: cover; }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .sidebar { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: #050505; z-index: 3000; transition: 0.4s; border-left: 1px solid #222; padding: 20px; }
        .sidebar.active { right: 0; }
        .nav-item { padding: 14px; color: #888; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size: 35px;">TITAN OS V75</h1>
        <input type="password" id="passInput" style="background:#0a0a0a; border:1px solid #333; color:#fff; padding:15px; width:80%; border-radius:12px; text-align:center; font-size:24px; margin-top:20px;" placeholder="PIN CODE">
        <button onclick="App.login()" class="btn btn-primary" style="width:80%; margin-top:20px;">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <header class="app-header">
        <div style="font-family:'Rajdhani'; font-weight:900; color:var(--primary);">YALLA TITAN</div>
        <div id="clock" style="font-family:'Rajdhani'; color:#666;">00:00:00</div>
        <div onclick="App.toggleSidebar()" style="color:var(--primary); font-size:20px;"><i class="fas fa-bars"></i></div>
    </header>

    <nav id="sidebar" class="sidebar">
        <div class="nav-item" onclick="App.nav('ops')"><i class="fas fa-rocket"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <div class="nav-item" onclick="App.nav('fleet')"><i class="fas fa-microchip"></i> Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø°ÙƒØ§Ø¡</div>
        <button onclick="location.reload()" class="btn btn-danger" style="margin-top:20px;">Ø®Ø±ÙˆØ¬</button>
    </nav>

    <main id="main-screen" class="app-content hidden">
        <div class="kpi-grid">
            <div class="kpi-card"><small>Ø§Ù„Ø¯Ø±Ø¬</small><br><span id="cash-vault" class="kpi-val">0</span></div>
            <div class="kpi-card"><small>Ø§Ù„Ù†Ø´Ø·</small><br><span id="active-count" class="kpi-val">0</span></div>
        </div>

        <div id="sec-ops" class="section">
            <div style="background: #0a0a0a; padding: 15px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px;">
                <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="margin-bottom:10px;">
                <input type="text" id="scoot-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± (Ù…Ø«Ø§Ù„ A5)">
                
                <div class="cam-box">
                    <video id="video" autoplay playsinline class="hidden"></video>
                    <img id="photo-res" src="https://via.placeholder.com/300x150?text=ID+PHOTO">
                </div>
                <div class="grid" style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="btn btn-ghost" onclick="App.toggleCam()">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button class="btn btn-primary hidden" id="snap-btn" onclick="App.takePhoto()">Ø§Ù„ØªÙ‚Ø§Ø·</button>
                </div>

                <button class="btn btn-primary" onclick="App.startTrip()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
            </div>
            
            <div id="active-trips-list"></div>
        </div>

        <div id="sec-fleet" class="section hidden">
            <h3 style="color:var(--primary); margin-bottom:15px;">ğŸ¤– ØªØ­Ù„ÙŠÙ„ Yalla AI</h3>
            <div id="ai-insight" style="background:#111; padding:15px; border-radius:15px; font-size:12px; border-left:4px solid var(--primary);">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
            </div>
            
            <h3 style="color:var(--primary); margin:20px 0 10px;">âš™ï¸ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Bridge)</h3>
            <div id="fleet-control-list"></div>
        </div>
    </main>

<script>
    // --- Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù†Ø¸Ø§Ù… ---
    const App = {
        config: { base: 40, price: 2.66 },
        db: null,
        capturedPhoto: "",
        onlineTrips: [],

        init: function() {
            firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
            this.db = firebase.database();
            this.sync();
            setInterval(this.updateClock, 1000);
        },

        login: function() {
            const p = document.getElementById('passInput').value;
            if(p === "9924") { 
                document.getElementById('login-overlay').style.display='none';
                document.getElementById('main-screen').classList.remove('hidden');
                this.init();
            } else { alert("PIN Ø®Ø·Ø£"); }
        },

        toggleSidebar: () => document.getElementById('sidebar').classList.toggle('active'),
        
        nav: function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            this.toggleSidebar();
        },

        updateClock: () => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG');
        },

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ---
        toggleCam: async function() {
            const v = document.getElementById('video');
            const res = document.getElementById('photo-res');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                v.srcObject = stream;
                v.classList.remove('hidden');
                res.classList.add('hidden');
                document.getElementById('snap-btn').classList.remove('hidden');
            } catch(e) { alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø±ÙÙˆØ¶Ø©"); }
        },

        takePhoto: function() {
            const v = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = v.videoWidth; canvas.height = v.videoHeight;
            canvas.getContext('2d').drawImage(v, 0, 0);
            this.capturedPhoto = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById('photo-res').src = this.capturedPhoto;
            document.getElementById('photo-res').classList.remove('hidden');
            v.classList.add('hidden');
            v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('snap-btn').classList.add('hidden');
        },

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø­Ù„Ø§Øª ---
        startTrip: function() {
            const name = document.getElementById('cust-name').value;
            const scoot = document.getElementById('scoot-id').value;
            if(!name || !scoot) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            this.db.ref('active_trips').push({
                customer: name,
                scooter: scoot,
                startTime: Date.now(),
                photo: this.capturedPhoto,
                status: 'running'
            });

            document.getElementById('cust-name').value = "";
            document.getElementById('scoot-id').value = "";
            this.capturedPhoto = "";
            document.getElementById('photo-res').src = "https://via.placeholder.com/300x150?text=ID+PHOTO";
        },

        finishTrip: function(id, startTime, scootId) {
            const mins = Math.max(0, Math.floor((Date.now() - startTime) / 60000));
            const cost = Math.round(this.config.base + (mins > 15 ? (mins - 15) * this.config.price : 0));

            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬.Ù…</b>`,
                showCancelButton: true,
                confirmButtonText: 'ØªØ­ØµÙŠÙ„ ÙˆØªØ£ÙƒÙŠØ¯'
            }).then(r => {
                if(r.isConfirmed) {
                    this.db.ref('history').push({ scooter: scootId, cost, mins, date: Date.now() });
                    this.db.ref('vault_total').transaction(v => (v || 0) + cost);
                    this.db.ref('active_trips/' + id).remove();
                }
            });
        },

        // --- Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯ ---
        sendCmd: function(scootId, cmd) {
            this.db.ref('commands/' + scootId).set({ action: cmd, time: Date.now() });
            Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', `Ø£Ù…Ø± ${cmd} Ù„Ù„Ø³ÙƒÙˆØªØ± ${scootId}`, 'success');
        },

        // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ ---
        sync: function() {
            this.db.ref('active_trips').on('value', snap => {
                const data = snap.val() || {};
                const list = document.getElementById('active-trips-list');
                const fleet = document.getElementById('fleet-control-list');
                list.innerHTML = ""; fleet.innerHTML = "";
                let count = 0;

                for(let id in data) {
                    count++;
                    const t = data[id];
                    const mins = Math.floor((Date.now() - t.startTime) / 60000);
                    
                    list.innerHTML += `
                        <div class="trip-card">
                            <div style="display:flex; justify-content:space-between">
                                <b>ğŸ›µ ${t.scooter}</b> <span>${t.customer}</span>
                            </div>
                            <div class="unit-timer">${mins} MIN</div>
                            <button class="btn btn-primary" onclick="App.finishTrip('${id}', ${t.startTime}, '${t.scooter}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                        </div>`;

                    fleet.innerHTML += `
                        <div class="trip-card" style="border-right-color:var(--warn)">
                            <b>Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø³ÙƒÙˆØªØ± ${t.scooter}</b>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button class="btn btn-primary" onclick="App.sendCmd('${t.scooter}','UNLOCK')">ÙØªØ­</button>
                                <button class="btn btn-danger" onclick="App.sendCmd('${t.scooter}','LOCK')">Ù‚ÙÙ„</button>
                            </div>
                        </div>`;
                }
                document.getElementById('active-count').innerText = count;
                this.runAI(data);
            });

            this.db.ref('vault_total').on('value', snap => {
                document.getElementById('cash-vault').innerText = (snap.val() || 0).toFixed(2);
            });
        },

        runAI: function(data) {
            const count = Object.keys(data).length;
            let msg = count > 2 ? "ğŸ”¥ Ø¶ØºØ· Ø¹Ù…Ù„ Ù…Ø±ØªÙØ¹: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©." : "ğŸŸ¢ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø³ØªÙ‚Ø±Ø©: ÙŠÙ…ÙƒÙ† Ø¥Ø¬Ø±Ø§Ø¡ ØµÙŠØ§Ù†Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªÙˆÙ‚ÙØ©.";
            if(count === 0) msg = "ğŸ’¤ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø©: ÙˆÙ‚Øª Ù…Ø«Ø§Ù„ÙŠ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.";
            document.getElementById('ai-insight').innerText = msg;
        }
    };
</script>

</body>
</html>
