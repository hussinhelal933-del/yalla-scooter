<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Command V46 | Mobile Pro</title>
    
    <!-- Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #000; --sidebar: #050505; --glass: rgba(15, 20, 35, 0.95);
            --primary: #00d2ff; --accent: #0072ff; --danger: #ff0055;
            --success: #00ff9d; --warn: #ffcc00; --border: rgba(0, 210, 255, 0.2);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { margin: 0; background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Mobile Header */
        .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--sidebar); border-bottom: 1px solid #222; z-index: 1001; }
        .brand { font-family: 'Rajdhani'; font-size: 24px; font-weight: 900; color: var(--primary); text-shadow: 0 0 10px rgba(0,210,255,0.4); }

        /*Sidebar as Mobile Menu*/
        .sidebar { position: fixed; right: -280px; top: 0; width: 280px; height: 100%; background: var(--sidebar); border-left: 1px solid #222; z-index: 2000; overflow-y: auto; transition: 0.4s; }
        .sidebar.open { right: 0; }
        .nav-item { padding: 15px 20px; margin: 5px 15px; cursor: pointer; color: #666; display: flex; align-items: center; gap: 15px; font-weight: 600; border-radius: 12px; }
        .nav-item.active { background: linear-gradient(90deg, rgba(0,210,255,0.1), transparent); color: var(--primary); border-right: 4px solid var(--primary); }

        /* Main Content Area */
        .main-content { flex: 1; padding: 15px; overflow-y: auto; background: radial-gradient(circle at top left, #0a1020, #000); padding-bottom: 80px; }

        /* KPI Grid for Mobile */
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: var(--glass); border: 1px solid var(--border); padding: 15px; border-radius: 15px; text-align: center; }
        .kpi-val { font-family: 'Rajdhani'; font-size: 24px; font-weight: 700; color: #fff; display: block; }

        /* Tracking Map (The Added Part) */
        #live-map { width: 100%; height: 300px; border-radius: 20px; border: 1px solid var(--primary); margin-bottom: 20px; z-index: 10; }

        /* Trip Cards */
        .fleet-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .unit-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 15px; }
        .unit-timer { font-family: 'Rajdhani'; font-size: 35px; text-align: center; color: var(--primary); font-weight: 700; }

        /* Form Inputs */
        input, select, textarea { background: #111 !important; border: 1px solid #333 !important; color: #fff !important; border-radius: 12px !important; padding: 12px !important; width: 100%; margin-bottom: 10px; }
        .btn { padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 8px; }
        .btn-primary { background: linear-gradient(90deg, var(--accent), var(--primary)); color: #fff; }
        .btn-danger { background: rgba(255,0,85,0.1); border: 1px solid var(--danger); color: var(--danger); }

        /* Utility */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .section { display: none; }
        .section.active { display: block; }
        .overlay-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1500; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div style="background:var(--glass); padding:30px; border-radius:25px; text-align:center; width:90%; max-width:350px; border:1px solid var(--border);">
            <h2 style="font-family:'Rajdhani'; color:var(--primary);">YALLA COMMAND</h2>
            <input type="password" id="passInput" style="text-align:center; font-size:24px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary" style="margin-top:15px;">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Header & Sidebar -->
    <header class="mobile-header">
        <i class="fas fa-bars" style="font-size:24px;" onclick="toggleSidebar()"></i>
        <div class="brand">TITAN V46</div>
        <div id="clock" style="font-family:'Rajdhani'; font-size:14px; color:var(--primary);">00:00</div>
    </header>

    <div class="overlay-bg" id="overlay-bg" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="brand" style="font-size:20px; padding:20px;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-rocket"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø©</div>
        <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav-item" onclick="nav('maint')"><i class="fas fa-tools"></i> Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
        <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
        <div id="set-nav" class="nav-item" style="display:none" onclick="nav('settings')"><i class="fas fa-sliders-h"></i> Ø§Ù„Ù…Ø®Ø²Ù†</div>
        <div style="padding:20px; border-top:1px solid #222;">
            <button id="shift-btn" onclick="toggleShift()" class="btn btn-primary">ÙØªØ­ ÙˆØ±Ø¯ÙŠØ©</button>
            <button class="btn btn-danger" onclick="addExpensePopup()" style="margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
        </div>
    </nav>

    <!-- Content -->
    <main class="main-content">
        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-val" id="k-active">0</span><small>Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-net-cash" style="color:var(--success)">0</span><small>ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬</small></div>
        </div>

        <!-- 1. ØªØªØ¨Ø¹ Ù„Ø§ÙŠÙ + Ø±Ø­Ù„Ø§Øª -->
        <div id="sec-ops" class="section active">
            <h3 style="margin:0 0 10px;">ğŸ“ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <div id="live-map"></div>
            
            <button class="btn btn-primary" onclick="startTripPopup()" style="padding:15px; font-size:16px; margin-bottom:20px;">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <div id="fleet-grid" class="fleet-grid"></div>
        </div>

        <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ) -->
        <div id="sec-clients" class="section">
            <input type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„..." oninput="loadClients(this.value)">
            <div id="clients-list" style="background:var(--glass); border-radius:15px; padding:10px;"></div>
        </div>

        <div id="sec-maint" class="section">
            <select id="maint-select-scooter"><option>Ø§Ø®ØªØ± Ø³ÙƒÙˆØªØ±...</option></select>
            <textarea id="maint-reason" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø·Ù„..."></textarea>
            <button class="btn btn-danger" onclick="sendToMaint()">Ø¥ÙŠÙ‚Ø§Ù Ù„Ù„ØµÙŠØ§Ù†Ø©</button>
            <hr border="0" style="height:1px; background:#222; margin:20px 0;">
            <div id="maint-list"></div>
        </div>

        <div id="sec-admin" class="section">
            <input type="date" id="admin-date-picker" onchange="loadDailyStats(this.value)">
            <div class="kpi-grid">
                <div class="kpi-card"><h3>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</h3><span id="day-rev" class="kpi-val" style="color:var(--success)">0</span></div>
                <div class="kpi-card"><h3>Ø§Ù„Ø±Ø¨Ø­</h3><span id="day-net" class="kpi-val">0</span></div>
            </div>
            <div id="action-logs" style="background:#0a0a0a; padding:10px; border-radius:10px; font-size:10px; height:200px; overflow-y:auto;"></div>
        </div>

        <div id="sec-settings" class="section">
             <div class="kpi-card">
                <h3>ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
                <input type="number" id="conf-baseCost" placeholder="ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯" onchange="saveConfig()">
                <input type="number" id="conf-pricePerMin" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©" onchange="saveConfig()">
             </div>
        </div>
    </main>

<script>
    // --- 1. Firebase & Initial Config ---
    const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
    firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    const storage = firebase.storage();

    let activeTrips = {}, config = { baseCost: 40, baseMins: 15, pricePerMin: 2.66 }, currentShiftId = null, isAdmin = false;
    let map = null, markers = {};

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay-bg').style.display = document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none';
    }

    function login() {
        const p = document.getElementById('passInput').value;
        if(p === "1213") { isAdmin = false; document.getElementById('login-overlay').style.display='none'; init(); }
        else if(p === "9924") { isAdmin = true; document.getElementById('adm-nav').style.display='flex'; document.getElementById('set-nav').style.display='flex'; document.getElementById('login-overlay').style.display='none'; init(); }
        else Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
    }

    function init() {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (The Live Map)
        if(!map) {
            map = L.map('live-map').setView([30.0444, 31.2357], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª (Live Tracking)
        db.ref('live_nodes').on('value', snap => {
            snap.forEach(child => {
                const data = child.val(), id = child.key;
                if(data.lat) {
                    if(markers[id]) markers[id].setLatLng([data.lat, data.lon]);
                    else markers[id] = L.marker([data.lat, data.lon]).addTo(map).bindPopup("Ø³ÙƒÙˆØªØ±: " + id);
                    if(data.isAlarm) markers[id].bindTooltip("âš ï¸ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚!").openTooltip();
                }
            });
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙˆØ±Ø¯ÙŠØ© ÙˆØ§Ù„Ø±Ø­Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ§Øª (Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ)
        db.ref('settings').on('value', s => { if(s.exists()) { config = s.val(); document.getElementById('conf-baseCost').value = config.baseCost; document.getElementById('conf-pricePerMin').value = config.pricePerMin; } });
        db.ref('shifts/current').on('value', s => {
            if(s.exists()) {
                currentShiftId = s.key; document.getElementById('shift-btn').innerText = "ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø¯ÙŠØ©";
                document.getElementById('k-net-cash').innerText = (s.val().totalCash - (s.val().totalExpenses||0)) + " Ø¬";
            } else {
                currentShiftId = null; document.getElementById('shift-btn').innerText = "ÙØªØ­ ÙˆØ±Ø¯ÙŠØ©";
            }
        });

        db.ref('active_trips').on('value', snap => { activeTrips = snap.val() || {}; renderTrips(); });
        db.ref('inventory').on('value', snap => {
            const sel = document.getElementById('maint-select-scooter'); sel.innerHTML = '<option>Ø§Ø®ØªØ± Ø³ÙƒÙˆØªØ±...</option>';
            snap.forEach(d => { if(d.val().status === 'available') sel.innerHTML += `<option value="${d.key}">${d.key}</option>`; });
        });
        
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'}); }, 1000);
    }

    // --- 2. Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… (Logic Ù…Ù† ÙƒÙˆØ¯Ùƒ) ---
    async function startTripPopup() {
        if(!currentShiftId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§ÙØªØ­ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        const { value: res } = await Swal.fire({
            title: 'Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            html: `
                <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input id="sw-sc" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                <input id="sw-img" type="file" accept="image/*" class="swal2-file">
            `,
            preConfirm: () => [document.getElementById('sw-ph').value, document.getElementById('sw-sc').value, document.getElementById('sw-img').files[0]]
        });
        if(res && res[0]) {
            const [ph, sc, file] = res;
            const tripRef = db.ref('active_trips').push();
            tripRef.set({ phone: ph, scooter: sc, startTime: Date.now(), status: 'active', pausedTime: 0, idPhoto: 'https://i.gifer.com/ZZ5H.gif' });
            db.ref('inventory/'+sc).update({ status: 'active' });
            if(file) {
                storage.ref(`ids/${Date.now()}.jpg`).put(file).then(s => s.ref.getDownloadURL()).then(url => tripRef.update({ idPhoto: url }));
            }
        }
    }

    function renderTrips() {
        const grid = document.getElementById('fleet-grid'); grid.innerHTML = "";
        for(let k in activeTrips) {
            const t = activeTrips[k];
            let p = t.pausedTime || 0; if(t.status === 'paused') p += (Date.now() - t.lastPauseStart);
            const mins = Math.floor((Date.now() - t.startTime - p) / 60000);
            grid.innerHTML += `
                <div class="unit-card">
                    <div style="display:flex; justify-content:space-between"><b>ğŸ›µ ${t.scooter}</b> <small>${t.phone}</small></div>
                    <div class="unit-timer">${mins} Ø¯</div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-primary" style="padding:8px" onclick="terminateTrip('${k}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                    </div>
                </div>
            `;
        }
        document.getElementById('k-active').innerText = Object.keys(activeTrips).length;
    }

    async function terminateTrip(key) {
        const t = activeTrips[key];
        const mins = Math.floor((Date.now() - t.startTime - (t.pausedTime||0)) / 60000);
        let cost = Math.max(config.baseCost, Math.round(config.baseCost + (mins-config.baseMins)*config.pricePerMin));
        
        const { value: paid } = await Swal.fire({
            title: 'ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº',
            html: `<h1>${cost} Ø¬</h1><input id="p-amt" type="number" class="swal2-input" value="${cost}">`,
            preConfirm: () => document.getElementById('p-amt').value
        });

        if(paid) {
            db.ref('shifts/current/totalCash').transaction(c => (c||0) + parseFloat(paid));
            db.ref('history/'+new Date().toISOString().split('T')[0]).push({ ...t, cost, paid, mins, time: Date.now() });
            db.ref('active_trips/'+key).remove();
            db.ref('inventory/'+t.scooter).update({ status: 'available' });
        }
    }

    function nav(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        toggleSidebar();
    }

    function saveConfig() {
        db.ref('settings').set({ 
            baseCost: parseFloat(document.getElementById('conf-baseCost').value), 
            pricePerMin: parseFloat(document.getElementById('conf-pricePerMin').value),
            baseMins: 15
        });
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Attendance, Expenses, Logs) ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
</script>
</body>
</html>
