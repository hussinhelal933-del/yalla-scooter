<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Tactical Command Center V10</title>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-deep: #020617; --panel-bg: #0f172a; --sidebar-bg: #070d19;
            --accent-teal: #2dd4bf; --accent-blue: #3b82f6; --danger-red: #f43f5e; --warn-gold: #fbbf24;
            --text-white: #f8fafc; --text-dim: #64748b; --border-line: #1e293b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: all 0.2s ease; }
        body { margin: 0; background: var(--bg-deep); color: var(--text-white); height: 100vh; display: flex; overflow: hidden; }

        /* --- Sidebar UI --- */
        .sidebar { width: 260px; background: var(--sidebar-bg); border-left: 1px solid var(--border-line); display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header { padding: 40px 20px; text-align: center; border-bottom: 1px solid var(--border-line); }
        .sidebar-header h2 { font-family: 'Orbitron'; font-size: 18px; color: var(--accent-teal); margin: 0; letter-spacing: 2px; }
        
        .nav-group { flex: 1; padding: 20px 0; overflow-y: auto; }
        .nav-link { padding: 18px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: var(--text-dim); font-weight: 700; position: relative; }
        .nav-link i { font-size: 18px; width: 25px; }
        .nav-link:hover, .nav-link.active { color: var(--accent-teal); background: rgba(45, 212, 191, 0.05); }
        .nav-link.active::after { content: ''; position: absolute; right: 0; top: 15%; height: 70%; width: 4px; background: var(--accent-teal); box-shadow: 0 0 15px var(--accent-teal); }

        /* --- Main Content Layout --- */
        .viewport { flex: 1; display: flex; flex-direction: column; padding: 25px; overflow: hidden; position: relative; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .live-clock { font-family: 'Orbitron'; font-size: 22px; color: var(--accent-teal); text-shadow: 0 0 10px rgba(45, 212, 191, 0.3); }

        .dashboard-scroll { flex: 1; overflow-y: auto; padding-right: 5px; }
        .section { display: none; }
        .section.active { display: block; animation: slideIn 0.4s ease forwards; }

        /* --- Tactical Cards --- */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--panel-bg); border: 1px solid var(--border-line); padding: 20px; border-radius: 16px; position: relative; }
        .kpi-card::before { content: ''; position: absolute; top:0; left:0; width: 30px; height: 3px; background: var(--accent-teal); }
        .kpi-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .kpi-val { font-family: 'Orbitron'; font-size: 28px; display: block; margin-top: 5px; color: #fff; }

        /* --- Live Fleet Management --- */
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .unit-card { background: var(--panel-bg); border: 1px solid var(--border-line); border-radius: 20px; padding: 25px; position: relative; backdrop-filter: blur(10px); }
        .unit-card.paused { border: 1px dashed var(--warn-gold); opacity: 0.8; }
        .unit-id { font-family: 'Orbitron'; font-size: 20px; color: var(--accent-teal); margin-bottom: 5px; }
        .timer-big { font-family: 'Orbitron'; font-size: 42px; text-align: center; margin: 20px 0; color: #fff; }
        
        /* --- Controls --- */
        .ctrl-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { padding: 12px 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: 900; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; flex: 1; }
        .btn-primary { background: var(--accent-teal); color: #020617; }
        .btn-pause { background: var(--warn-gold); color: #020617; }
        .btn-resume { background: var(--accent-blue); color: #fff; }
        .btn-danger { background: var(--danger-red); color: #fff; }

        /* --- Data Tables --- */
        .data-table-container { background: var(--panel-bg); border-radius: 16px; border: 1px solid var(--border-line); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(0,0,0,0.3); padding: 18px; text-align: right; color: var(--text-dim); font-size: 12px; }
        td { padding: 15px 18px; border-bottom: 1px solid var(--border-line); font-size: 14px; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* --- Auth Overlay --- */
        #login-screen { position: fixed; inset: 0; background: var(--bg-deep); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel-bg); padding: 50px; border-radius: 30px; width: 400px; text-align: center; border: 1px solid var(--border-line); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .auth-card input { width: 100%; padding: 20px; background: #000; border: 1px solid var(--border-line); color: var(--accent-teal); font-family: 'Orbitron'; font-size: 32px; text-align: center; border-radius: 15px; margin-bottom: 30px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media(max-width: 1024px) {
            .sidebar { width: 80px; }
            .nav-text, .sidebar-header h2 { display: none; }
            .kpi-row { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- Authentication -->
    <div id="login-screen">
        <div class="auth-card">
            <h1 style="font-family: Orbitron; color: var(--accent-teal); letter-spacing: 5px;">ACCESS CONTROL</h1>
            <p style="color: var(--text-dim); margin-bottom: 40px;">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØµØ±ÙŠØ­ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
            <input type="password" id="authCode" placeholder="****">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; padding: 20px; font-size: 18px;">AUTHORIZE</button>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header"><h2>YALLA COMMAND</h2></div>
        <div class="nav-group">
            <div class="nav-link active" onclick="switchSection('ops')"><i class="fas fa-satellite-dish"></i> <span class="nav-text">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</span></div>
            <div class="nav-link" onclick="switchSection('clients')"><i class="fas fa-users-cog"></i> <span class="nav-text">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></div>
            <div class="nav-link" onclick="switchSection('workshop')"><i class="fas fa-microchip"></i> <span class="nav-text">ÙˆØ±Ø´Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</span></div>
            <div class="nav-link" onclick="switchSection('attendance')"><i class="fas fa-fingerprint"></i> <span class="nav-text">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</span></div>
            <div id="admin-only-link" class="nav-link" style="display:none" onclick="switchSection('admin')"><i class="fas fa-shield-alt"></i> <span class="nav-text">Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Admin)</span></div>
        </div>
        <div class="nav-link" style="color: var(--danger-red); border-top: 1px solid var(--border-line)" onclick="location.reload()">
            <i class="fas fa-power-off"></i> <span class="nav-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
        </div>
    </aside>

    <!-- Content Area -->
    <main class="viewport">
        <div class="top-header">
            <h2 id="section-title" style="margin:0; font-weight: 900;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Live Fleet)</h2>
            <div class="live-clock" id="sys-clock">00:00:00</div>
        </div>

        <div class="dashboard-scroll">
            
            <!-- SECTION: OPERATIONS -->
            <div id="section-ops" class="section active">
                <div class="kpi-row">
                    <div class="kpi-card"><span class="kpi-label">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span><span id="kpi-active" class="kpi-val">0</span></div>
                    <div class="kpi-card"><span class="kpi-label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</span><span id="kpi-rev" class="kpi-val">0</span></div>
                    <div class="kpi-card"><span class="kpi-label">Ù…Ù‡Ù…Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</span><span id="kpi-trips" class="kpi-val">0</span></div>
                    <div class="kpi-card"><span class="kpi-label">ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</span><span id="kpi-maint" class="kpi-val" style="color:var(--warn-gold)">0</span></div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="margin:0">Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                    <button onclick="launchNewTrip()" class="btn btn-primary" style="width:200px">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
                
                <div id="fleet-monitor" class="fleet-grid">
                    <!-- Dynamic Rental Cards -->
                </div>
            </div>

            <!-- SECTION: CLIENTS -->
            <div id="section-clients" class="section">
                <div class="top-header">
                    <input type="text" id="clientFilter" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ù‡Ø§ØªÙ..." oninput="fetchClients(this.value)" style="width:100%; padding:15px; background: #000; border:1px solid var(--border-line); color:white; border-radius:12px;">
                </div>
                <div class="data-table-container">
                    <table>
                        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ±Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody id="client-list-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: ADMIN CENTER -->
            <div id="section-admin" class="section">
                <div class="kpi-row">
                    <div class="kpi-card" style="background: var(--accent-teal); color:#000;"><span class="kpi-label" style="color: #064e3b">ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span><span id="adm-profit" class="kpi-val" style="color: #000">0</span></div>
                    <div class="kpi-card"><span class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><span id="adm-exp" class="kpi-val" style="color: var(--danger-red)">0</span></div>
                </div>
                
                <div style="display:flex; gap:20px; align-items:center; margin-bottom:30px;">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</label>
                    <input type="date" id="reportDate" onchange="loadFinancialHistory(this.value)" style="padding:12px; background:#000; color:white; border:1px solid var(--accent-teal); border-radius:8px;">
                </div>

                <div class="data-table-container">
                    <table>
                        <thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead>
                        <tbody id="history-list-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- SECTION: ATTENDANCE -->
            <div id="section-attendance" class="section">
                <div class="kpi-card" style="text-align:center; padding:60px;">
                    <i class="fas fa-location-arrow" style="font-size:60px; color:var(--accent-teal); margin-bottom:30px;"></i>
                    <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ (Geo-Fencing)</h2>
                    <p style="color:var(--text-dim)">ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø£Ùˆ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù.</p>
                    <div style="display:flex; gap:20px; justify-content:center; margin-top:30px;">
                        <button onclick="handleAttendance('IN')" class="btn btn-primary" style="width:150px">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
                        <button onclick="handleAttendance('OUT')" class="btn btn-danger" style="width:150px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù</button>
                    </div>
                </div>
            </div>

            <!-- SECTION: WORKSHOP -->
            <div id="section-workshop" class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª</h3>
                    <button onclick="registerMaintenance()" class="btn btn-pause" style="width:200px">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„/Ø¥ØµÙ„Ø§Ø­</button>
                </div>
                <div class="data-table-container">
                    <table>
                        <thead><tr><th>Ø§Ù„Ù…Ø¹Ø¯Ø©</th><th>ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„</th></tr></thead>
                        <tbody id="maint-list-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const TG_API = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_COORDS = { lat: 30.0444, lng: 31.2357 };
        const PRICING = { min: 40, base_mins: 15, per_min: 2.66 };

        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();
        let cachedTrips = {};

        // Clock System
        setInterval(() => {
            document.getElementById('sys-clock').innerText = new Date().toLocaleTimeString('ar-EG');
            refreshLiveTimers();
        }, 1000);

        // --- 2. AUTHENTICATION ---
        function attemptLogin() {
            const code = document.getElementById('authCode').value;
            if(code === "1213" || code === "9924") {
                if(code === "9924") document.getElementById('admin-only-link').style.display = 'flex';
                document.getElementById('login-screen').style.display = 'none';
                initRealtimeSync();
            } else {
                Swal.fire({icon: 'error', title: 'Ø±Ù…Ø² ØªØµØ±ÙŠØ­ Ø®Ø§Ø·Ø¦', background: '#0f172a', color: '#fff'});
            }
        }

        function switchSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('section-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            
            const titles = {ops: 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Live Fleet)', clients: 'Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', workshop: 'ÙˆØ±Ø´Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ', attendance: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ', admin: 'Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©'};
            document.getElementById('section-title').innerText = titles[id];
            
            if(id === 'clients') fetchClients();
            if(id === 'workshop') fetchMaintenance();
            if(id === 'admin') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').value = today;
                loadFinancialHistory(today);
            }
        }

        // --- 3. CORE RENTAL ENGINE ---
        function initRealtimeSync() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('fleet-monitor');
                grid.innerHTML = "";
                cachedTrips = snap.val() || {};
                let count = 0;

                for(let key in cachedTrips) {
                    count++;
                    const d = cachedTrips[key];
                    const isPaused = d.status === 'paused';
                    grid.innerHTML += `
                        <div class="unit-card ${isPaused ? 'paused' : ''}">
                            <div class="unit-id">${d.scooter} <span style="font-size:10px; color:var(--text-dim); float:left;">${d.client}</span></div>
                            <div class="timer-big" id="timer-${key}">00:00:00</div>
                            <div class="ctrl-group">
                                ${!isPaused ? 
                                    `<button class="btn btn-pause" onclick="controlTrip('${key}', 'pause')"><i class="fas fa-pause"></i> ÙˆÙ‚Ù</button>` : 
                                    `<button class="btn btn-resume" onclick="controlTrip('${key}', 'resume')"><i class="fas fa-play"></i> Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`
                                }
                                <button class="btn btn-danger" onclick="terminateTrip('${key}')"><i class="fas fa-stop"></i> Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('kpi-active').innerText = count;
            });

            // Revenue KPI Today
            const today = new Date().toISOString().split('T')[0];
            db.ref(`history/${today}`).on('value', snap => {
                let total = 0, count = 0;
                snap.forEach(c => { total += (c.val().final || 0); count++; });
                document.getElementById('kpi-rev').innerText = total + " Ø¬";
                document.getElementById('kpi-trips').innerText = count;
            });
        }

        function refreshLiveTimers() {
            const now = Date.now();
            for(let key in cachedTrips) {
                const d = cachedTrips[key];
                const el = document.getElementById(`timer-${key}`);
                if(!el) continue;

                let diffMs = (d.status === 'active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
                const s = Math.floor(diffMs / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }

        async function launchNewTrip() {
            const { value: res } = await Swal.fire({
                title: 'Ø¨Ø¯Ø¡ Ù…Ù‡Ù…Ø© ØªÙƒØªÙŠÙƒÙŠØ©',
                html: `
                    <input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                    <input id="sw-p" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="instantClientCheck(this.value)">
                    <div id="instant-status" style="font-size:11px; margin-top:5px;"></div>
                    <input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                `,
                background: '#0f172a', color: '#fff', confirmButtonColor: '#2dd4bf',
                preConfirm: () => [document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-p').value, document.getElementById('sw-n').value]
            });

            if(res && res[0]) {
                const [s, p, n] = res;
                // Check scooter health
                const sHealth = await db.ref('scooters/'+s).once('value');
                if(sHealth.exists() && sHealth.val().status === 'maint') return Swal.fire('Error', 'Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒÙˆØªØ± ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©!', 'error');

                db.ref('active_trips').push({ scooter:s, phone:p||'0', client:n||'Ø²Ø§Ø¦Ø±', startTime:Date.now(), status:'active', pausedDuration:0 });
                if(p!=='0') db.ref('clients/'+p).update({ name:n, lastVisit:Date.now() });
                broadcastTG(`ğŸš€ <b>Ù…Ù‡Ù…Ø© Ø¨Ø¯Ø£Øª</b>\nØ§Ù„Ù…Ø¹Ø¯Ø©: ${s}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${n}`);
            }
        }

        async function instantClientCheck(phone) {
            if(phone.length < 10) return;
            const snap = await db.ref('clients/'+phone).once('value');
            const div = document.getElementById('instant-status');
            if(snap.exists()) {
                const c = snap.val();
                if(c.blocked) { div.innerHTML = "<span style='color:red'>â›” ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ±!</span>"; }
                else { div.innerHTML = `<span style='color:var(--accent-teal)'>âœ… Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„ (ØµØ±Ù: ${c.totalSpend||0} Ø¬)</span>`; document.getElementById('sw-n').value = c.name; }
            }
        }

        function controlTrip(key, action) {
            if(action === 'pause') db.ref(`active_trips/${key}`).update({ status: 'paused', pauseStart: Date.now() });
            else {
                db.ref(`active_trips/${key}`).once('value', snap => {
                    const d = snap.val();
                    db.ref(`active_trips/${key}`).update({ status: 'active', pausedDuration: (d.pausedDuration||0) + (Date.now() - d.pauseStart) });
                });
            }
        }

        async function terminateTrip(key) {
            const d = cachedTrips[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            
            let cost = PRICING.min;
            if(mins > PRICING.base_mins) cost = Math.round(PRICING.min + (mins - PRICING.base_mins) * PRICING.per_min);

            const { value: fin } = await Swal.fire({
                title: 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø¨',
                html: `<h1 style="color:var(--accent-teal); margin:0;">${cost} Ø¬.Ù…</h1><small>Ø§Ù„Ø²Ù…Ù†: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</small><hr style="border-color:#1e293b"><input id="sw-disc" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…"><input id="sw-why" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨ Ø£Ùˆ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ù…ÙƒØªØ´Ù">`,
                background:'#0f172a', color:'#fff', showCancelButton:true,
                preConfirm: () => { return { disc: parseFloat(document.getElementById('sw-disc').value)||0, reason: document.getElementById('sw-why').value } }
            });

            if(fin) {
                const final = cost - fin.disc;
                const today = new Date().toISOString().split('T')[0];
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, phone:d.phone, mins, cost, disc:fin.disc, reason:fin.reason, final, timestamp: Date.now() });
                
                if(d.phone !== '0') db.ref(`clients/${d.phone}`).transaction(c => { return { ...c, totalSpend:(c?.totalSpend||0)+final, trips:(c?.trips||0)+1 } });
                db.ref('active_trips/'+key).remove();
                
                let msg = `ğŸ <b>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ•’ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬`;
                if(fin.disc > 0) msg += `\nâš ï¸ Ø®ØµÙ…: ${fin.disc} Ø¬\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: ${fin.reason}\nâœ… Ø§Ù„ØµØ§ÙÙŠ: ${final} Ø¬`;
                broadcastTG(msg);
            }
        }

        // --- 4. DATA MANAGEMENT ---
        function fetchClients(search = "") {
            db.ref('clients').on('value', snap => {
                const tb = document.getElementById('client-list-body'); tb.innerHTML = "";
                snap.forEach(c => {
                    if(search && !c.key.includes(search)) return;
                    const v = c.val();
                    tb.innerHTML += `<tr><td>${v.name}</td><td>${c.key}</td><td>${v.trips||0}</td><td>${v.totalSpend||0} Ø¬</td><td>${v.blocked?'â›” Ù…Ø­Ø¸ÙˆØ±':'âœ… Ù†Ø´Ø·'}</td><td><button class="btn btn-danger" style="padding:5px 10px;" onclick="toggleBlock('${c.key}', ${!v.blocked})">${v.blocked?'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±':'Ø­Ø¸Ø±'}</button></td></tr>`;
                });
            });
        }

        function toggleBlock(phone, state) { db.ref('clients/'+phone).update({ blocked: state }); fetchClients(); }

        function loadFinancialHistory(date) {
            db.ref(`history/${date}`).on('value', snap => {
                const tb = document.getElementById('history-list-body'); tb.innerHTML = "";
                let total = 0;
                snap.forEach(c => {
                    const v = c.val(); total += (v.final || 0);
                    tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.client}</td><td>${v.mins}m</td><td>${v.cost}</td><td style="color:red">${v.disc}</td><td>${v.reason||'-'}</td></tr>`;
                });
                document.getElementById('adm-profit').innerText = total + " Ø¬";
            });
        }

        async function registerMaintenance() {
            const { value: m } = await Swal.fire({
                title: 'Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø© ØªÙƒØªÙŠÙƒÙŠ',
                html: '<input id="ms" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="me" class="swal2-input" placeholder="ÙˆØµÙ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"><input id="mc" class="swal2-input" type="number" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">',
                background: '#0f172a', color: '#fff',
                preConfirm: () => [document.getElementById('ms').value.toUpperCase(), document.getElementById('me').value, document.getElementById('mc').value]
            });
            if(m && m[0]) {
                db.ref('maintenance_log').push({ scooter: m[0], part: m[1], cost: parseFloat(m[2])||0, date: Date.now() });
                db.ref(`scooters/${m[0]}`).update({ status:'maint' });
                broadcastTG(`ğŸ› ï¸ <b>ØªÙ‚Ø±ÙŠØ± ØµÙŠØ§Ù†Ø©</b>\nØ§Ù„Ù…Ø¹Ø¯Ø©: ${m[0]}\nğŸ”§ Ø§Ù„Ø¹Ø·Ù„: ${m[1]}\nğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ©: ${m[2]} Ø¬`);
                fetchMaintenance();
            }
        }

        function fetchMaintenance() {
            db.ref('maintenance_log').limitToLast(20).on('value', snap => {
                const tb = document.getElementById('maint-list-body'); tb.innerHTML = "";
                let costSum = 0, count = 0;
                snap.forEach(c => {
                    const v = c.val(); count++; costSum += (v.cost || 0);
                    tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.part}</td><td style="color:var(--danger-red)">${v.cost} Ø¬</td><td>${new Date(v.date).toLocaleDateString()}</td></tr>`;
                });
                document.getElementById('kpi-maint').innerText = count;
                document.getElementById('adm-exp').innerText = costSum + " Ø¬";
            });
        }

        // --- 5. ATTENDANCE & TELEGRAM ---
        function handleAttendance(type) {
            if(!navigator.geolocation) return Swal.fire('Error', 'GPS ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'error');
            Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª...', didOpen:()=>Swal.showLoading(), background:'#0f172a', color:'#fff'});
            
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, SHOP_COORDS.lat, SHOP_COORDS.lng);
                if(dist > 200) return Swal.fire('ÙØ´Ù„ Ø§Ù„ØªØµØ±ÙŠØ­', `Ø£Ù†Øª Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ù„ Ø¨Ù…Ø³Ø§ÙØ© ${Math.floor(dist)} Ù…ØªØ±`, 'error');

                const now = new Date();
                const time = now.toLocaleTimeString('ar-EG');
                db.ref(`attendance/${now.toISOString().split('T')[0]}`).push({ type, time, coords: `${pos.coords.latitude},${pos.coords.longitude}` });
                broadcastTG(`ğŸ“ <b>Ø³Ø¬Ù„ ${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'}</b>\nğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${time}\nğŸ—ºï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ù…Ø·Ø§Ø¨ÙÙ‚`);
                Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${type==='IN'?'Ø­Ø¶ÙˆØ±Ùƒ':'Ø§Ù†ØµØ±Ø§ÙÙƒ'} ÙÙŠ ${time}`, 'success');
            }, () => Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ', 'error'));
        }

        function calculateDistance(la1, lo1, la2, lo2) {
            const R = 6371e3; const d1 = la1*Math.PI/180, d2 = la2*Math.PI/180;
            const dl = (la2-la1)*Math.PI/180, do1 = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dl/2)**2 + Math.cos(d1)*Math.cos(d2)*Math.sin(do1/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function broadcastTG(text) {
            fetch(`https://api.telegram.org/bot${TG_API.token}/sendMessage`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: TG_API.chat, text, parse_mode: 'HTML' })
            });
        }

    </script>
</body>
</html>
