<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Tactical Live Dashboard</title>
    
    <!-- Firebase & Icons -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #020617; --card: #0f172a; --panel: #070d19;
            --primary: #2dd4bf; --accent: #3b82f6; --danger: #f43f5e; --warn: #fbbf24;
            --text: #f8fafc; --border: #1e293b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Header --- */
        header { height: 60px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100; }
        .logo { font-family: 'Orbitron'; font-weight: 900; color: var(--primary); letter-spacing: 2px; }
        #live-clock { font-family: 'Orbitron'; color: var(--primary); font-size: 18px; }

        /* --- Main Layout --- */
        .dashboard-container { display: flex; flex: 1; overflow: hidden; }

        /* Panel Style */
        .side-panel { width: 300px; background: var(--panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; gap: 20px; }
        .center-stage { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at center, #0f172a, #020617); }
        .admin-panel { width: 350px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: none; }

        /* Cards & UI */
        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .section-title { font-weight: 900; font-size: 14px; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }

        /* Active Trip Card */
        .trip-card { background: #1e293b77; border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; backdrop-filter: blur(10px); }
        .trip-card.paused { border-color: var(--warn); opacity: 0.8; }
        .live-timer { font-family: 'Orbitron'; font-size: 36px; text-align: center; color: var(--primary); margin: 15px 0; text-shadow: 0 0 10px rgba(45, 212, 191, 0.3); }
        
        /* Buttons */
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-warn { background: var(--warn); color: #000; flex: 1; }
        .btn-danger { background: var(--danger); color: #fff; flex: 1; }
        .btn-accent { background: var(--accent); color: #fff; flex: 1; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .history-table th { text-align: right; color: #64748b; padding-bottom: 10px; }
        .history-table td { padding: 8px 0; border-bottom: 1px solid #1e293b; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        @media(max-width: 1024px) {
            .dashboard-container { flex-direction: column; }
            .side-panel, .admin-panel { width: 100%; border: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-satellite-dish"></i> YALLA TACTICAL</div>
        <div id="live-clock">00:00:00</div>
        <div id="status-tag" style="font-size: 10px; background: #064e3b; color: #2dd4bf; padding: 4px 12px; border-radius: 20px;">SYSTEM ONLINE</div>
    </header>

    <div class="dashboard-container">
        
        <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
        <aside class="side-panel">
            <div class="glass-card">
                <div class="section-title"><i class="fas fa-plus-circle"></i> Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                <button class="btn btn-primary" onclick="newTripPopup()"><i class="fas fa-motorcycle"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
            </div>

            <div class="glass-card">
                <div class="section-title"><i class="fas fa-fingerprint"></i> Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-accent" style="flex:1" onclick="attendance('IN')">Ø­Ø¶ÙˆØ±</button>
                    <button class="btn btn-danger" style="flex:1" onclick="attendance('OUT')">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>

            <div class="glass-card">
                <div class="section-title"><i class="fas fa-tools"></i> Ø¨Ù„Ø§Øº Ø¹Ø·Ù„</div>
                <button class="btn btn-warn" onclick="maintPopup()" style="width:100%"><i class="fas fa-exclamation-triangle"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„</button>
            </div>

            <div class="glass-card">
                <button class="btn" style="width:100%; background:#1e293b; color:white;" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (9924)</button>
            </div>
        </aside>

        <!-- Ø§Ù„Ù…Ù†ØªØµÙ: Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ© -->
        <section class="center-stage">
            <div class="section-title" style="font-size:18px;"><i class="fas fa-play"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</div>
            <div id="active-rental-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:20px;">
                <!-- Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø­ÙŠØ© -->
            </div>
        </section>

        <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ÙŠÙØªØ­ Ø¨Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯) -->
        <aside id="admin-aside" class="admin-panel">
            <div class="section-title"><i class="fas fa-database"></i> Ù…Ø±ÙƒØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="glass-card" style="background:var(--primary); color:#000; text-align:center;">
                <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</small>
                <div id="total-revenue" style="font-size:24px; font-weight:900;">0 Ø¬.Ù…</div>
            </div>
            
            <input type="date" id="histDate" onchange="loadHistory(this.value)" style="width:100%; background:#000; color:white; border:1px solid var(--border); padding:10px; border-radius:8px; margin-bottom:15px;">
            
            <div style="overflow-y:auto; flex:1;">
                <table class="history-table">
                    <thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>ÙˆÙ‚Øª</th><th>ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead>
                    <tbody id="hist-body"></tbody>
                </table>
            </div>
        </aside>

    </div>

    <script>
        // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ø¨Ø· ---
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 };
        const MIN_COST = 40;
        const MIN_TIME = 15;

        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();

        // Ø³Ø§Ø¹Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙŠØ©
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG');
            updateUIHolders(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        }, 1000);

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª (Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­ÙŠ) ---
        let localActiveData = {};

        function initDataSync() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('active-rental-grid');
                grid.innerHTML = "";
                localActiveData = snap.val() || {};
                
                if(Object.keys(localActiveData).length === 0) {
                    grid.innerHTML = `<p style="color:#64748b; grid-column:1/-1; text-align:center; padding:50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹..</p>`;
                }

                for(let key in localActiveData) {
                    const d = localActiveData[key];
                    const isPaused = d.status === 'paused';
                    grid.innerHTML += `
                        <div class="trip-card ${isPaused ? 'paused' : ''}" id="card-${key}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <b style="font-size:18px; color:var(--primary)">${d.scooter}</b>
                                <span style="font-size:10px; background:#0f172a; padding:3px 8px; border-radius:5px;">${d.client}</span>
                            </div>
                            <div class="live-timer" id="timer-${key}">00:00:00</div>
                            <div style="display:flex; gap:10px;">
                                ${!isPaused ? 
                                    `<button class="btn btn-warn" onclick="pauseTrip('${key}')"><i class="fas fa-pause"></i> ÙˆÙ‚Ù</button>` : 
                                    `<button class="btn btn-accent" onclick="resumeTrip('${key}')"><i class="fas fa-play"></i> Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`
                                }
                                <button class="btn btn-danger" onclick="endTripPrompt('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙØ­Ø©
        function updateUIHolders() {
            const now = Date.now();
            for(let key in localActiveData) {
                const d = localActiveData[key];
                const timerEl = document.getElementById(`timer-${key}`);
                if(!timerEl) continue;

                let diffMs = 0;
                if(d.status === 'active') {
                    diffMs = now - d.startTime - (d.pausedDuration || 0);
                } else {
                    diffMs = d.pauseStart - d.startTime - (d.pausedDuration || 0);
                }

                const totalSecs = Math.floor(diffMs / 1000);
                const h = String(Math.floor(totalSecs / 3600)).padStart(2, '0');
                const m = String(Math.floor((totalSecs % 3600) / 60)).padStart(2, '0');
                const s = String(totalSecs % 60).padStart(2, '0');
                timerEl.innerText = `${h}:${m}:${s}`;
            }
        }

        async function newTripPopup() {
            const { value: form } = await Swal.fire({
                title: 'Ù…Ù‡Ù…Ø© ØªØ£Ø¬ÙŠØ± Ø¬Ø¯ÙŠØ¯Ø©',
                html: '<input id="s-scoot" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="s-name" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">',
                background: '#070d19', color: '#fff', confirmButtonColor: '#2dd4bf',
                preConfirm: () => [document.getElementById('s-scoot').value.toUpperCase(), document.getElementById('s-name').value]
            });
            if(form && form[0]) {
                db.ref('active_trips').push({ 
                    scooter: form[0], client: form[1]||'Ø²Ø§Ø¦Ø±', 
                    startTime: Date.now(), status: 'active', pausedDuration: 0 
                });
                sendTG(`ğŸ›µ <b>Ù…Ù‡Ù…Ø© Ø¨Ø¯Ø£Øª</b>\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${form[0]}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${form[1]||'Ø²Ø§Ø¦Ø±'}`);
            }
        }

        function pauseTrip(key) {
            db.ref(`active_trips/${key}`).update({ status: 'paused', pauseStart: Date.now() });
        }

        function resumeTrip(key) {
            db.ref(`active_trips/${key}`).once('value', snap => {
                const d = snap.val();
                const diff = Date.now() - d.pauseStart;
                db.ref(`active_trips/${key}`).update({ 
                    status: 'active', 
                    pausedDuration: (d.pausedDuration || 0) + diff 
                });
            });
        }

        async function endTripPrompt(key) {
            const d = localActiveData[key];
            const now = Date.now();
            let diffMs = (d.status === 'active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
            const mins = Math.floor(diffMs / 60000);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©: 40 Ø¬ Ø£ÙˆÙ„ Ø±Ø¨Ø¹ Ø³Ø§Ø¹Ø©ØŒ Ø«Ù… Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ù€ 2.66
            let cost = MIN_COST;
            if(mins > MIN_TIME) cost = MIN_COST + (mins - MIN_TIME) * 2.66;
            cost = Math.round(cost);

            const { value: res } = await Swal.fire({
                title: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ØµÙŠÙ„',
                html: `
                    <h1 style="color:var(--primary); margin:0;">${cost} Ø¬.Ù…</h1>
                    <small>Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</small><hr style="border-color:#334155">
                    <input id="sw-disc" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">
                    <input id="sw-why" class="swal2-input" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø®ØµÙ… / Ø§Ù„Ø¹Ø·Ù„">
                `,
                background: '#070d19', color: '#fff', showCancelButton: true,
                preConfirm: () => {
                    return { disc: parseFloat(document.getElementById('sw-disc').value) || 0, reason: document.getElementById('sw-why').value }
                }
            });

            if(res) {
                const final = cost - res.disc;
                const today = new Date().toISOString().split('T')[0];
                db.ref(`history/${today}`).push({ 
                    scooter: d.scooter, client: d.client, mins, 
                    cost, disc: res.disc, reason: res.reason, final 
                });
                db.ref('active_trips/'+key).remove();

                let msg = `ğŸ <b>Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ•’ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬`;
                if(res.disc > 0) msg += `\nâš ï¸ Ø®ØµÙ…: ${res.disc} Ø¬\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: ${res.reason}\nâœ… Ø§Ù„ØµØ§ÙÙŠ: ${final} Ø¬`;
                sendTG(msg);
            }
        }

        // --- 3. Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ---
        function adminLogin() {
            Swal.fire({
                title: 'ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', input: 'password', background: '#070d19', color: '#fff',
                preConfirm: (v) => v === "9924" ? true : Swal.showValidationMessage('Ø®Ø·Ø£')
            }).then(r => {
                if(r.isConfirmed) {
                    document.getElementById('admin-aside').style.display = 'flex';
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('histDate').value = today;
                    loadHistory(today);
                }
            });
        }

        function loadHistory(date) {
            db.ref(`history/${date}`).on('value', snap => {
                const tb = document.getElementById('hist-body'); tb.innerHTML = "";
                let total = 0;
                snap.forEach(c => {
                    const v = c.val();
                    total += (v.final || 0);
                    tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.mins}m</td><td style="color:var(--primary)">${v.final}</td><td>${v.reason||'-'}</td></tr>`;
                });
                document.getElementById('total-revenue').innerText = total + " Ø¬.Ù…";
            });
        }

        // --- 4. Ø®Ø¯Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ---
        async function maintPopup() {
            const { value: f } = await Swal.fire({
                title: 'Ø¨Ù„Ø§Øº Ø¹Ø·Ù„ ØªÙƒØªÙŠÙƒÙŠ',
                html: '<input id="m-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="m-e" class="swal2-input" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„"><input id="m-c" class="swal2-input" type="number" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©">',
                background: '#070d19', color: '#fff',
                preConfirm: () => [document.getElementById('m-s').value.toUpperCase(), document.getElementById('m-e').value, document.getElementById('m-c').value]
            });
            if(f && f[0]) {
                db.ref('maintenance_log').push({ scooter: f[0], error: f[1], cost: parseFloat(f[2])||0, date: Date.now() });
                sendTG(`ğŸ› ï¸ <b>Ø¹Ø·Ù„ Ø·Ø§Ø±Ø¦</b>\nğŸ›µ ${f[0]}\nğŸ”§ Ø§Ù„Ø¹Ø·Ù„: ${f[1]}\nğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ©: ${f[2]} Ø¬`);
                Swal.fire('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', '', 'success');
            }
        }

        function attendance(type) {
            if(!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, SHOP_LOC.lat, SHOP_LOC.lng);
                if(dist > 200) return Swal.fire('ÙØ´Ù„!', 'ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø­Ù„', 'error');
                const t = new Date().toLocaleTimeString();
                sendTG(`ğŸ“ <b>${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'}</b>\nğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${t}`);
                Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', t, 'success');
            });
        }

        function getDist(la1, lo1, la2, lo2) {
            const R = 6371e3; const d1 = la1*Math.PI/180, d2 = la2*Math.PI/180;
            const dl = (la2-la1)*Math.PI/180, do1 = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dl/2)**2 + Math.cos(d1)*Math.cos(d2)*Math.sin(do1/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function sendTG(text) {
            fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: TELEGRAM.chat, text, parse_mode: 'HTML' })
            });
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        initDataSync();

    </script>
</body>
</html>
