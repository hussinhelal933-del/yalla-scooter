<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Titan V74 | Advanced Guardian</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --card: #0a0a0a; --primary: #00d2ff; --danger: #ff0055; --success: #00ff9d; --warn: #ffcc00; --border: rgba(0, 210, 255, 0.1); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .app-header { height: 60px; background: #050505; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .sidebar { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: #050505; z-index: 3000; transition: 0.4s; border-left: 1px solid #222; padding: 20px; }
        .sidebar.active { right: 0; }
        .nav-item { padding: 14px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #888; margin-bottom: 8px; }
        .nav-item.active { background: rgba(0,210,255,0.1); color: var(--primary); font-weight: bold; }

        .app-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        .trip-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; border-right: 4px solid var(--primary); }
        .unit-timer { font-family: 'Rajdhani'; font-size: 38px; text-align: center; color: var(--primary); font-weight: 900; margin: 10px 0; }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 15px; text-align: center; }
        .kpi-val { font-family: 'Rajdhani'; font-size: 22px; font-weight: 700; color: var(--primary); }

        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        .analysis-card { background: #0f1218; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #222; }
        .fraud-alert { background: var(--danger); color: white; padding: 5px 10px; border-radius: 5px; font-size: 10px; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1} }
        
        /* Ø¥Ø¶Ø§ÙØ© Ø³ØªØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© */
        .bat-info { font-size: 10px; color: #666; display: block; margin-top: 5px; }
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div style="text-align:center; width:85%; max-width:320px;">
            <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size: 35px;">TITAN OS V74</h1>
            <input type="password" id="passInput" style="background:#0a0a0a; border:1px solid #333; color:#fff; padding:15px; width:100%; border-radius:12px; text-align:center; font-size:24px; margin-top:20px;" placeholder="PIN CODE">
            <button onclick="login()" class="btn btn-primary" style="margin-top:20px;">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <header class="app-header">
        <div style="font-family:'Rajdhani'; font-weight:900; color:var(--primary);">TITAN GUARDIAN</div>
        <div id="clock" style="font-family:'Rajdhani'; color:#666;">00:00:00</div>
        <div onclick="toggleSidebar()" style="color:var(--primary); font-size:20px;"><i class="fas fa-bars"></i></div>
    </header>

    <nav id="sidebar" class="sidebar">
        <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-rocket"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <div class="nav-item" onclick="nav('fleet')"><i class="fas fa-motorcycle"></i> Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø©</div>
        <div class="nav-item" onclick="nav('analysis')"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¹Ø·Ø§Ù„</div>
        <div class="nav-item" onclick="nav('history')"><i class="fas fa-history"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…</div>
        <button onclick="location.reload()" class="btn btn-danger" style="margin-top:auto;">Ø®Ø±ÙˆØ¬</button>
    </nav>

    <main class="app-content">
        <div class="kpi-grid">
            <div class="kpi-card"><small>Ø§Ù„Ø¯Ø±Ø¬</small><br><span id="cash-vault" class="kpi-val" style="color:var(--success)">0</span></div>
            <div class="kpi-card"><small>Ø§Ù„Ù†Ø´Ø·</small><br><span id="active-count" class="kpi-val">0</span></div>
        </div>

        <div id="sec-ops" class="section active">
            <button class="btn btn-primary" onclick="openStartTripModal()">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø©</button>
            <div id="trip-list" style="margin-top:20px;"></div>
        </div>

        <div id="sec-fleet" class="section">
            <div id="fleet-list"></div>
            <div id="admin-map" style="width:100%; height:300px; border-radius:15px; margin-top:15px;"></div>
        </div>

        <div id="sec-analysis" class="section">
            <h3 style="color:var(--primary); margin-bottom:15px;">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª</h3>
            <div id="analysis-container"></div>
        </div>

        <div id="sec-history" class="section">
            <h3>Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
            <div id="history-list"></div>
        </div>

        <div id="sec-scooter-node" class="section" style="text-align:center;">
            <div style="font-size:80px; font-family:'Rajdhani'; color:var(--primary);" id="node-speed">0</div>
            <h2 id="node-name-display">-</h2>
            <div id="node-dist-ui">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="trip-dist">0</span> Ù…ØªØ±</div>
            <div id="node-bat-ui" style="margin-top:20px; color:#666;"><i class="fas fa-battery-three-quarters"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©...</div>
        </div>
    </main>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
    const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
    const CONFIG = { basePrice: 40, freeMins: 15, pricePerMin: 2.66 };
    const SHOP_LOCATION = { lat: 30.0444, lon: 31.2357 }; 

    firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com", storageBucket: "yalla-scooter-pro.appspot.com" });
    const db = firebase.database();
    const storage = firebase.storage();

    let map = null, markers = {}, scooterName = "", onlineFleet = {}, lastPos = null;

    // Ù…ÙŠØ²Ø© Ù…Ø¶Ø§ÙØ©: Ù†Ø¸Ø§Ù… ØµÙˆØªÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    const audioAlert = (type) => {
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        osc.type = type === 'danger' ? 'sawtooth' : 'sine';
        osc.frequency.setValueAtTime(type === 'danger' ? 150 : 440, ctx.currentTime);
        osc.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.2);
    };

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    function login() {
        const p = document.getElementById('passInput').value;
        const overlay = document.getElementById('login-overlay');
        if(p === "1214") { 
            Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±', input: 'text' }).then(r => {
                if(r.value) { 
                    scooterName = r.value; 
                    document.getElementById('node-name-display').innerText = scooterName;
                    overlay.style.display='none'; 
                    nav('scooter-node'); 
                    startScooterBeacon(); 
                }
            });
        } else if(p === "1213" || p === "9924") { overlay.style.display='none'; initAdmin(); }
        else { alert("Ø±Ù…Ø² Ø®Ø§Ø·Ø¦"); }
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø³ÙƒÙˆØªØ± Ø§Ù„Ù…Ø·ÙˆØ±Ø© ---
    async function startScooterBeacon() {
        const ref = db.ref('fleet_online/' + scooterName);
        ref.onDisconnect().remove();
        let totalTripDist = 0;
        
        // Ù…ÙŠØ²Ø© Ù…Ø¶Ø§ÙØ©: Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
        let batteryLevel = "N/A";
        if(navigator.getBattery) {
            const bat = await navigator.getBattery();
            batteryLevel = (bat.level * 100) + "%";
            bat.onlevelchange = () => { batteryLevel = (bat.level * 100) + "%"; };
        }

        navigator.geolocation.watchPosition(pos => {
            const current = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            const speedKm = Math.round((pos.coords.speed || 0)*3.6);
            
            if(lastPos) {
                const d = calculateDistance(lastPos.lat, lastPos.lon, current.lat, current.lon);
                totalTripDist += d;
                db.ref('scooter_stats/'+scooterName+'/totalKm').transaction(v => (v || 0) + (d/1000));
            }
            lastPos = current;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
            ref.set({ 
                name: scooterName, ...current, 
                speed: speedKm, 
                battery: batteryLevel,
                lastSeen: Date.now() 
            });

            const speedEl = document.getElementById('node-speed');
            speedEl.innerText = speedKm;
            // Ù…ÙŠØ²Ø© Ù…Ø¶Ø§ÙØ©: ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø±
            speedEl.style.color = speedKm > 40 ? 'var(--danger)' : 'var(--primary)';
            
            document.getElementById('trip-dist').innerText = Math.round(totalTripDist);
            document.getElementById('node-bat-ui').innerHTML = `<i class="fas fa-battery-three-quarters"></i> Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${batteryLevel}`;
        }, null, {enableHighAccuracy: true});
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ ---
    function initAdmin() {
        db.ref('fleet_online').on('value', snap => { onlineFleet = snap.val() || {}; renderFleet(); });
        db.ref('active_trips').on('value', snap => { renderTrips(snap.val() || {}); });
        db.ref('vault_total').on('value', snap => { document.getElementById('cash-vault').innerText = snap.val() || 0; });
        db.ref('scooter_stats').on('value', snap => { renderAnalysis(snap.val() || {}); });
        db.ref('history').limitToLast(10).on('value', snap => { renderHistory(snap.val() || {}); });
    }

    function renderFleet() {
        const list = document.getElementById('fleet-list');
        list.innerHTML = "";
        for(let id in onlineFleet) {
            const s = onlineFleet[id];
            list.innerHTML += `
                <div class="trip-card" style="border-right-color:var(--success)">
                    <div style="display:flex; justify-content:space-between">
                        <b>ğŸ›µ ${s.name}</b>
                        <span style="color:var(--success)">â— Ù…ØªØµÙ„</span>
                    </div>
                    <div style="font-size:12px; margin-top:5px;">
                        Ø§Ù„Ø³Ø±Ø¹Ø©: ${s.speed} ÙƒÙ…/Ø³ | Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${s.battery || '??'}
                    </div>
                </div>`;
        }
    }

    function renderAnalysis(stats) {
        const container = document.getElementById('analysis-container');
        container.innerHTML = "";
        for(let id in stats) {
            const s = stats[id];
            const isDanger = (s.faultCount || 0) > 3;
            container.innerHTML += `
                <div class="analysis-card" style="border-right: 5px solid ${isDanger?'var(--danger)':'var(--success)'}">
                    <div style="display:flex; justify-content:space-between;">
                        <b>ğŸ›µ ${id}</b>
                        <button class="btn" style="width:80px; font-size:10px; padding:5px; background:orange;" onclick="reportFault('${id}')">Ø¨Ù„Ø§Øº Ø¹Ø·Ù„</button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; margin-top:10px; font-size:12px; text-align:center;">
                        <div>ğŸ›£ï¸ Ù…Ø³Ø§ÙØ©<br><b>${(s.totalKm || 0).toFixed(2)}</b> ÙƒÙ…</div>
                        <div>ğŸ’° Ø£Ø±Ø¨Ø§Ø­<br><b>${s.totalEarnings || 0}</b> Ø¬</div>
                        <div>ğŸ› ï¸ Ø£Ø¹Ø·Ø§Ù„<br><b style="color:${isDanger?'red':'white'}">${s.faultCount || 0}</b></div>
                    </div>
                </div>`;
        }
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---
    function openStartTripModal() {
        Swal.fire({
            title: 'Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            html: `
                <input id="scoot-id" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                <input id="client-phone" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            `,
            confirmButtonText: 'Ø§Ù†Ø·Ù„Ø§Ù‚',
            preConfirm: () => {
                return {
                    scooterId: document.getElementById('scoot-id').value,
                    clientPhone: document.getElementById('client-phone').value
                }
            }
        }).then(r => {
            if(r.value && r.value.scooterId) {
                const tripData = {
                    scooterId: r.value.scooterId,
                    clientPhone: r.value.clientPhone,
                    startTime: Date.now(),
                    status: 'active'
                };
                db.ref('active_trips').push(tripData);
                sendTG(`ğŸš€ *Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©*\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${tripData.scooterId}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${tripData.clientPhone}`);
            }
        });
    }

    async function finishTrip(id) {
        db.ref('active_trips/'+id).once('value', async s => {
            const t = s.val();
            const scooterLive = onlineFleet[t.scooterId];
            
            let fraudDetected = false;
            if(scooterLive) {
                const distFromShop = calculateDistance(scooterLive.lat, scooterLive.lon, SHOP_LOCATION.lat, SHOP_LOCATION.lon);
                if(distFromShop > 150) {
                    fraudDetected = true;
                    audioAlert('danger'); // ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø®Ø·Ø±
                }
            }

            const mins = calculateMins(t);
            let cost = Math.round(CONFIG.basePrice + (mins > CONFIG.freeMins ? (mins - CONFIG.freeMins) * CONFIG.pricePerMin : 0));

            const { value: res } = await Swal.fire({
                title: fraudDetected ? 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø³ÙƒÙˆØªØ± Ø¨Ø¹ÙŠØ¯!' : 'ØªØ­ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨',
                html: `${fraudDetected ? '<b style="color:red">ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø³ÙƒÙˆØªØ± Ù„Ø§ ÙŠØ²Ø§Ù„ ÙÙŠ Ø§Ù„Ø´Ø§Ø±Ø¹!</b><br>':''} Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬.Ù…</b>
                       <input id="d-amt" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">`,
                confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡',
                background: fraudDetected ? '#300' : '#0a0a0a'
            });

            if(res) {
                const final = cost - parseFloat(document.getElementById('d-amt').value || 0);
                db.ref('scooter_stats/'+t.scooterId+'/totalEarnings').transaction(v => (v || 0) + final);
                db.ref('vault_total').transaction(v => (v || 0) + final);
                db.ref('history').push({ ...t, final, mins, fraud: fraudDetected, date: Date.now() });
                db.ref('active_trips/'+id).remove();
                
                audioAlert('success'); // ØµÙˆØª ØªØ£ÙƒÙŠØ¯ Ù†Ø¬Ø§Ø­

                if(fraudDetected) {
                    sendTG(`ğŸš¨ *ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ø§Ø¹Ø¨ Ù…Ø­ØªÙ…Ù„!*\nØ§Ù„Ù…ÙˆØ¸Ù Ø£ØºÙ„Ù‚ Ø±Ø­Ù„Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (${t.scooterId}) ÙˆÙ‡Ùˆ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…Ø­Ù„! ğŸš©`);
                }
                sendTG(`ğŸ *Ø¥Ù†Ù‡Ø§Ø¡ Ø±Ø­Ù„Ø©*\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${t.scooterId}\nØ§Ù„ØµØ§ÙÙŠ: ${final} Ø¬.Ù…`);
            }
        });
    }

    function reportFault(id) {
        Swal.fire({ title: 'ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„', input: 'text', placeholder: 'ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„...' }).then(r => {
            if(r.value) {
                db.ref('scooter_stats/'+id+'/faultCount').transaction(v => (v || 0) + 1);
                db.ref('scooter_stats/'+id+'/logs').push({ msg: r.value, date: Date.now() });
                sendTG(`ğŸ› ï¸ *Ø¨Ù„Ø§Øº Ø¹Ø·Ù„ Ø¬Ø¯ÙŠØ¯*\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${id}\nØ§Ù„ÙˆØµÙ: ${r.value}`);
            }
        });
    }

    function renderHistory(data) {
        const list = document.getElementById('history-list');
        list.innerHTML = "";
        Object.values(data).reverse().forEach(h => {
            list.innerHTML += `<div style="font-size:12px; padding:8px; border-bottom:1px solid #111;">
                ${new Date(h.date).toLocaleTimeString()} | <b>${h.scooterId}</b> | Ø§Ù„ØµØ§ÙÙŠ: ${h.final}Ø¬ ${h.fraud ? 'ğŸš©':''}
            </div>`;
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function renderTrips(data) {
        const list = document.getElementById('trip-list'); list.innerHTML = "";
        let count = 0;
        for(let id in data) {
            count++; const t = data[id];
            list.innerHTML += `<div class="trip-card">
                <b>ğŸ›µ ${t.scooterId}</b> | ğŸ“± ${t.clientPhone}
                <div class="unit-timer">${calculateMins(t)} MIN</div>
                <button class="btn btn-primary" onclick="finishTrip('${id}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>`;
        }
        document.getElementById('active-count').innerText = count;
    }

    function calculateMins(trip) {
        let total = Date.now() - trip.startTime;
        let paused = trip.totalPausedTime || 0;
        if (trip.status === 'paused') paused += (Date.now() - trip.lastPauseStart);
        return Math.max(0, Math.floor((total - paused) / 60000));
    }

    function nav(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
    }

    function sendTG(msg) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage?chat_id=${TELEGRAM.chat}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`); }
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); }, 1000);
</script>
</body>
</html>
