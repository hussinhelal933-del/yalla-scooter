<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Command V26 | Glass Edition</title>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass-bg: rgba(17, 25, 40, 0.6);
            --glass-border: rgba(255, 255, 255, 0.125);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            
            --primary: #00d2ff; /* Cyan Neon */
            --secondary: #928DAB;
            --accent: #3a7bd5;
            --danger: #ff0055;
            --warn: #ffcc00;
            --text: #ffffff;
            --text-muted: #a3a3a3;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg-gradient); 
            background-attachment: fixed;
            color: var(--text); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* Glassmorphism Base Class */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        /* Sidebar */
        .sidebar { 
            width: 280px; 
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border); 
            display: flex; 
            flex-direction: column; 
            z-index: 1000; 
        }
        
        .brand { 
            padding: 35px 20px; 
            text-align: center; 
            color: var(--primary); 
            font-family: 'Rajdhani', sans-serif; 
            font-size: 26px; 
            font-weight: 700; 
            text-shadow: 0 0 15px rgba(0, 210, 255, 0.5);
            border-bottom: 1px solid var(--glass-border);
        }
        
        .nav-group { flex: 1; padding: 20px 10px; overflow-y: auto; }
        
        .nav-item { 
            padding: 16px 20px; 
            margin-bottom: 8px;
            cursor: pointer; 
            color: var(--text-muted); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            font-weight: 500; 
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item:hover, .nav-item.active { 
            background: rgba(0, 210, 255, 0.1); 
            color: var(--primary); 
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.1);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        /* Main View */
        .main-content { 
            flex: 1; 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
        }

        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .top-bar h2 { font-weight: 900; letter-spacing: 1px; }

        .section { display: none; flex: 1; overflow-y: auto; padding-bottom: 100px; padding-right: 5px; }
        .section.active { display: block; animation: slideIn 0.5s ease; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* KPI & Dashboard */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        
        .kpi-card { 
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 20px; 
            border-radius: 20px; 
            text-align: center; 
            position: relative; 
            overflow: hidden;
        }
        
        .kpi-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            opacity: 0; transform: scale(0.5); transition: 0.5s;
        }
        .kpi-card:hover::after { opacity: 1; transform: scale(1); }
        
        .kpi-val { 
            font-family: 'Rajdhani', sans-serif; 
            font-size: 32px; 
            font-weight: 700;
            color: var(--text); 
            display: block; 
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .kpi-card small { color: var(--text-muted); font-size: 14px; font-weight: bold; }

        /* Unit Cards */
        .unit-card { 
            background: rgba(20, 20, 30, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 24px; 
            padding: 20px; 
            position: relative;
            backdrop-filter: blur(5px);
            transition: transform 0.3s;
        }
        .unit-card:hover { transform: translateY(-5px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); border-color: rgba(0, 210, 255, 0.3); }
        
        .unit-card.paused { border: 1px solid var(--warn); background: rgba(255, 204, 0, 0.05); }

        .unit-timer { 
            font-family: 'Rajdhani', sans-serif; 
            font-size: 42px; 
            text-align: center; 
            color: var(--primary); 
            margin: 15px 0; 
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.4);
        }
        
        .id-preview { 
            width: 100%; height: 140px; object-fit: cover; 
            border-radius: 15px; 
            border: 1px solid var(--glass-border); 
            margin: 10px 0; 
            filter: brightness(0.8);
        }

        /* Tables & Charts */
        .glass-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0 8px;
            margin-top: 10px;
        }
        .glass-table th { 
            text-align: right; 
            color: var(--text-muted); 
            padding: 15px; 
            font-weight: 600;
        }
        .glass-table td { 
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(5px);
            padding: 15px; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .glass-table tr td:first-child { border-radius: 0 15px 15px 0; }
        .glass-table tr td:last-child { border-radius: 15px 0 0 15px; }
        .glass-table tr:hover td { background: rgba(255, 255, 255, 0.08); transform: scale(1.01); }

        .chart-box { 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--glass-border); 
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 25px; 
            height: 320px; 
        }

        /* Buttons & Inputs */
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], select {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid var(--glass-border) !important;
            color: #fff !important;
            border-radius: 12px !important;
            padding: 12px !important;
        }
        input:focus { border-color: var(--primary) !important; box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }

        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary { 
            background: linear-gradient(45deg, var(--accent), var(--primary)); 
            color: #fff; 
            box-shadow: 0 4px 20px rgba(0, 210, 255, 0.3);
        }
        .btn-primary:hover { box-shadow: 0 6px 25px rgba(0, 210, 255, 0.5); transform: translateY(-2px); }
        
        .btn-danger { 
            background: linear-gradient(45deg, #ff416c, #ff4b2b); 
            color: white; 
            box-shadow: 0 4px 20px rgba(255, 75, 43, 0.3);
        }
        
        .btn-warn { 
            background: linear-gradient(45deg, #f7971e, #ffd200); 
            color: #000; 
        }

        /* Login */
        #login-overlay { 
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(20px); 
            z-index: 9999; 
            display: flex; align-items: center; justify-content: center; 
        }
        .login-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            width: 380px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; transform: translateX(100%); transition: 0.3s; }
            .sidebar.open { transform: translateX(0); }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size: 32px; margin-bottom: 10px;">YALLA COMMAND</h1>
            <p style="color:var(--text-muted); margin-bottom: 30px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ V26</p>
            <input type="password" id="passInput" style="width:100%; text-align:center; font-size:24px; letter-spacing: 5px; margin-bottom: 25px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <nav class="sidebar">
        <div class="brand"><i class="fas fa-layer-group"></i> YALLA</div>
        <div class="nav-group">
            <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-satellite-dish"></i> <span class="nav-text">Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</span></div>
            <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users-cog"></i> <span class="nav-text">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></div>
            <div class="nav-item" onclick="nav('maint')"><i class="fas fa-charging-station"></i> <span class="nav-text">Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©</span></div>
            <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-shield-alt"></i> <span class="nav-text">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡</span></div>
        </div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger); border-top:1px solid var(--glass-border)" onclick="location.reload()">
            <i class="fas fa-power-off"></i> <span class="nav-text">Ø®Ø±ÙˆØ¬</span>
        </div>
    </nav>

    <main class="main-content">
        <div class="top-bar">
            <h2 id="p-title" style="margin:0; font-family:'Rajdhani'; text-transform: uppercase;">Dashboard Overview</h2>
            <div id="clock" style="font-family:'Rajdhani'; color:var(--primary); font-size:22px; font-weight:bold; background: rgba(0,210,255,0.1); padding: 5px 15px; border-radius: 10px;">00:00:00</div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-val" id="k-active" style="color:var(--primary)">0</span>
                <small>Ø³ÙƒÙˆØªØ± Ù†Ø´Ø·</small>
            </div>
            <div class="kpi-card">
                <span class="kpi-val" id="k-rev" style="color:#2ecc71">0</span>
                <small>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ… (Ø¬.Ù…)</small>
            </div>
            <div class="kpi-card">
                <span class="kpi-val" id="k-trips" style="color:#f1c40f">0</span>
                <small>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª</small>
            </div>
            <div class="kpi-card">
                <span class="kpi-val" style="color:var(--danger)" id="k-blocked">0</span>
                <small>Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</small>
            </div>
        </div>

        <!-- Section: Operations -->
        <div id="sec-ops" class="section active">
            <button class="btn btn-primary" onclick="startTripPopup()" style="width:100%; margin-bottom:25px; font-size:18px; padding: 15px;">
                <i class="fas fa-rocket"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>
            <div id="fleet-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:25px;"></div>
        </div>

        <!-- Section: Clients -->
        <div id="sec-clients" class="section">
            <div style="background:var(--glass-bg); padding:20px; border-radius:20px; margin-bottom:20px; border:1px solid var(--glass-border);">
                <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="loadClients(this.value)" style="width:100%;">
            </div>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„ØµØ±Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="clients-list"></tbody>
            </table>
        </div>

        <!-- Section: Admin (Performance Analysis) -->
        <div id="sec-admin" class="section">
            <div class="chart-box"><canvas id="revenueChart"></canvas></div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin:30px 0 15px;">
                <h3 style="margin:0; font-family:'Rajdhani'"><i class="fas fa-tachometer-alt" style="color:var(--primary)"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</h3>
                <input type="date" id="historyDate" onchange="loadHistory(this.value)">
            </div>
            
            <table class="glass-table" style="margin-bottom: 30px;">
                <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="scooter-stats-list"></tbody>
            </table>

            <h3 style="margin:20px 0 10px; font-family:'Rajdhani'">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            <table class="glass-table">
                <thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
                <tbody id="hist-list"></tbody>
            </table>
        </div>

        <!-- Placeholder for Maint -->
        <div id="sec-maint" class="section">
            <div style="text-align:center; padding:50px; color:var(--text-muted)">
                <i class="fas fa-tools" style="font-size:50px; margin-bottom:20px;"></i>
                <h2>Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²</h2>
            </div>
        </div>

    </main>

    <script>
        // --- 1. CONFIG & SYSTEM ---
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 };

        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();
        let activeTrips = {};
        let perfChart;

        // Custom Swal Mixin for Glass Theme
        const GlassSwal = Swal.mixin({
            customClass: {
                popup: 'glass-panel'
            },
            background: 'transparent',
            color: '#fff',
            confirmButtonColor: '#00d2ff',
            cancelButtonColor: '#ff0055'
        });

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG');
            refreshTimers();
        }, 1000);

        // --- 2. AUTH & NAV ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                if(p === "9924") document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                initSync();
            } else { GlassSwal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'clients') loadClients();
            if(id === 'admin') { 
                const t = new Date().toISOString().split('T')[0]; 
                loadHistory(t); 
                loadScooterStats();
                initAnalytics();
            }
        }

        // --- 3. TRIP ENGINE ---
        async function startTripPopup() {
            const { value: res } = await GlassSwal.fire({
                title: 'ØªØ®ØµÙŠØµ Ø±Ø­Ù„Ø© Ø±Ø³Ù…ÙŠØ©',
                html: `
                    <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="checkBlockStatus(this.value)" style="background:rgba(0,0,0,0.5); color:white; border:1px solid #444;">
                    <div id="block-msg" style="font-size:12px; margin-top:5px;"></div>
                    <input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±" style="background:rgba(0,0,0,0.5); color:white; border:1px solid #444;">
                    <input id="sw-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© %" style="background:rgba(0,0,0,0.5); color:white; border:1px solid #444;">
                    <input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="background:rgba(0,0,0,0.5); color:white; border:1px solid #444;">
                    <p style="font-size:12px; margin-top:10px;">ØªØµÙˆÙŠØ± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</p>
                    <input id="sw-img" type="file" accept="image/*" capture="environment" class="swal2-file" style="background:rgba(0,0,0,0.5); color:white;">
                `,
                preConfirm: () => {
                    const img = document.getElementById('sw-img').files[0];
                    if(!img) return Swal.showValidationMessage('ÙŠØ¬Ø¨ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©!');
                    return [document.getElementById('sw-ph').value, document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-b').value, document.getElementById('sw-n').value, img]
                }
            });

            if(res) {
                const [ph, s, bat, name, img] = res;
                const cSnap = await db.ref('clients/'+ph).once('value');
                if(cSnap.exists() && cSnap.val().blocked) return GlassSwal.fire('Ù…Ø±ÙÙˆØ¶!', 'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');

                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref('active_trips').push({ 
                        phone: ph, scooter: s, startBat: bat, client: name||'Ø²Ø§Ø¦Ø±', 
                        idPhoto: e.target.result, startTime: Date.now(), status: 'active', pausedDuration: 0 
                    });
                };
                reader.readAsDataURL(img);
                sendTG(`ğŸš€ <b>Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª</b>\nØ³ÙƒÙˆØªØ±: ${s}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}\nØ¨Ø·Ø§Ø±ÙŠØ©: ${bat}%`);
            }
        }

        async function terminateTrip(key) {
            const d = activeTrips[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            let cost = Math.round(mins > 15 ? 40 + (mins - 15) * 2.66 : 40);

            const { value: fin } = await GlassSwal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨',
                html: `<h1 style="color:var(--primary); font-size:60px; font-family:'Rajdhani'">${cost} Ø¬</h1>
                       <input id="sw-bat" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù† %" style="background:rgba(0,0,0,0.5); color:white;">
                       <input id="sw-disc" type="number" class="swal2-input" placeholder="Ø®ØµÙ…" style="background:rgba(0,0,0,0.5); color:white;">
                       <input id="sw-why" class="swal2-input" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø®ØµÙ… / Ù…Ù„Ø§Ø­Ø¸Ø§Øª" style="background:rgba(0,0,0,0.5); color:white;">`,
                preConfirm: () => { return { bat: document.getElementById('sw-bat').value, disc: parseFloat(document.getElementById('sw-disc').value)||0, reason: document.getElementById('sw-why').value } }
            });

            if(fin) {
                const final = cost - fin.disc;
                const today = new Date().toISOString().split('T')[0];
                
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, mins, final, reason:fin.reason });
                
                db.ref(`scoot_stats/${d.scooter}`).transaction(s => {
                    return { ...s, total_mins: (s?.total_mins||0) + mins, battery: fin.bat };
                });

                if(d.phone) db.ref(`clients/${d.phone}`).transaction(c => { return { ...c, totalSpend:(c?.totalSpend||0)+final, trips:(c?.trips||0)+1 } });
                
                db.ref('active_trips/'+key).remove();
                sendTG(`ğŸ <b>Ø§ÙƒØªÙ…Ø§Ù„ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ•’ ${mins}m\nğŸ’° Ø§Ù„Ù…Ø­ØµÙ„: ${final} Ø¬`);
            }
        }

        // --- 4. DATA TABLES ---
        function loadClients(q = "") {
            db.ref('clients').on('value', snap => {
                const list = document.getElementById('clients-list'); list.innerHTML = "";
                let blockedCount = 0;
                snap.forEach(c => {
                    const v = c.val(); if(v.blocked) blockedCount++;
                    if(q && !c.key.includes(q)) return;
                    list.innerHTML += `
                        <tr>
                            <td>${v.name}</td><td style="font-family:'Rajdhani'">${c.key}</td><td>${v.points||0}</td><td>${v.totalSpend||0}</td>
                            <td style="color:${v.blocked?'var(--danger)':'var(--primary)'}; font-weight:bold;">${v.blocked?'Ù…Ø­Ø¸ÙˆØ±':'Ù†Ø´Ø·'}</td>
                            <td><button class="btn" style="background:${v.blocked?'var(--primary)':'var(--danger)'}; padding:5px 10px; font-size:11px;" onclick="toggleBlock('${c.key}', ${!v.blocked})">${v.blocked?'ÙÙƒ':'Ø­Ø¸Ø±'}</button></td>
                        </tr>`;
                });
                document.getElementById('k-blocked').innerText = blockedCount;
            });
        }

        function toggleBlock(ph, state) { db.ref('clients/'+ph).update({ blocked: state }); }

        function loadScooterStats() {
            db.ref('scoot_stats').on('value', snap => {
                const tb = document.getElementById('scooter-stats-list'); tb.innerHTML = "";
                snap.forEach(s => {
                    const v = s.val();
                    const hours = (v.total_mins / 60).toFixed(1);
                    tb.innerHTML += `<tr><td style="font-weight:bold">${s.key}</td><td style="color:var(--primary); font-family:'Rajdhani'">${hours}h</td><td style="font-family:'Rajdhani'">${v.battery}%</td><td><span style="color:#2ecc71">â— Ø¬Ø§Ù‡Ø²</span></td></tr>`;
                });
            });
        }

        function initAnalytics() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if(perfChart) perfChart.destroy();
            perfChart = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'], 
                    datasets: [{ 
                        label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', 
                        data: [500, 800, 600, 1100, 950, 1400, 1800], 
                        borderColor: '#00d2ff', 
                        backgroundColor: 'rgba(0, 210, 255, 0.1)', 
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        fill: true, 
                        tension: 0.4 
                    }] 
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#aaa' } }, 
                        x: { grid: { display: false }, ticks: { color: '#aaa' } } 
                    } 
                }
            });
        }

        // --- Helpers ---
        async function checkBlockStatus(ph) {
            if(ph.length < 10) return;
            const snap = await db.ref('clients/'+ph).once('value');
            const div = document.getElementById('block-msg');
            if(snap.exists() && snap.val().blocked) div.innerHTML = "<span style='color:var(--danger); font-weight:bold;'>âš ï¸ Ù…Ø­Ø¸ÙˆØ± Ø£Ù…Ù†ÙŠØ§Ù‹!</span>";
        }
        function initSync() { 
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('fleet-grid'); grid.innerHTML = "";
                activeTrips = snap.val() || {}; let count = 0;
                for(let k in activeTrips) {
                    count++; const d = activeTrips[k];
                    grid.innerHTML += `
                        <div class="unit-card ${d.status==='paused'?'paused':''}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:18px; font-weight:900; color:white;">${d.scooter}</span>
                                <small style="color:var(--text-muted);"><i class="fas fa-user"></i> ${d.client}</small>
                            </div>
                            <img src="${d.idPhoto}" class="id-preview">
                            <div class="unit-timer" id="timer-${k}">00:00:00</div>
                            <div style="display:flex; gap:10px;">
                                ${d.status==='active'?`<button class="btn btn-warn" style="flex:1" onclick="controlTrip('${k}','pause')"><i class="fas fa-pause"></i> ÙˆÙ‚Ù</button>`:`<button class="btn btn-primary" style="flex:1" onclick="controlTrip('${k}','resume')"><i class="fas fa-play"></i> Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`}
                                <button class="btn btn-danger" style="flex:1" onclick="terminateTrip('${k}')"><i class="fas fa-flag-checkered"></i> Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>`;
                }
                document.getElementById('k-active').innerText = count;
            });
            const t = new Date().toISOString().split('T')[0];
            db.ref(`history/${t}`).on('value', snap => {
                let r = 0, total = 0; snap.forEach(x => { r += (x.val().final || 0); total++; });
                document.getElementById('k-rev').innerText = r; document.getElementById('k-trips').innerText = total;
            });
        }
        function refreshTimers() {
            const now = Date.now();
            for(let k in activeTrips) {
                const d = activeTrips[k]; const el = document.getElementById(`timer-${k}`); if(!el) continue;
                let diff = (d.status==='active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
                const s = Math.floor(diff / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }
        function controlTrip(k, a) {
            if(a==='pause') db.ref(`active_trips/${k}`).update({ status:'paused', pauseStart:Date.now() });
            else db.ref(`active_trips/${k}`).once('value', s => { const d = s.val(); db.ref(`active_trips/${k}`).update({ status:'active', pausedDuration: (d.pausedDuration||0)+(Date.now()-d.pauseStart) }); });
        }
        function sendTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }
        function loadHistory(d) {
            db.ref(`history/${d}`).on('value', snap => {
                const tb = document.getElementById('hist-list'); tb.innerHTML = "";
                snap.forEach(c => { const v = c.val(); tb.innerHTML += `<tr><td style="font-weight:bold">${v.scooter}</td><td>${v.client}</td><td style="font-family:'Rajdhani'">${v.mins}m</td><td style="color:#2ecc71; font-weight:bold">${v.final}</td><td style="font-size:12px">${v.reason||'-'}</td></tr>`; });
            });
        }
    </script>
</body>
</html>
