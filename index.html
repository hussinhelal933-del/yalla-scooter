<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter | Pro Management</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-navy: #0f172a;
            --card-dark: #1e293b;
            --accent-cyan: #22d3ee;
            --accent-teal: #14b8a6;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg-navy); color: #f1f5f9; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar المحدثة بالكامل */
        .sidebar { width: 280px; background: #020617; border-left: 1px solid #334155; display: flex; flex-direction: column; }
        .nav-group { padding: 15px 20px 5px; font-size: 11px; color: var(--accent-teal); font-weight: bold; text-transform: uppercase; }
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #94a3b8; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--card-dark); color: var(--accent-cyan); border-right: 4px solid var(--accent-cyan); }

        /* Content Area */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { padding: 15px 25px; background: #0f172a; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .content { flex: 1; padding: 25px; overflow-y: auto; }

        /* Tactical Cards */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--card-dark); padding: 20px; border-radius: 12px; border: 1px solid #334155; text-align: center; }
        .stat-card h2 { font-size: 32px; color: var(--accent-cyan); margin: 5px 0; }

        /* Tables */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: var(--card-dark); border-radius: 10px; overflow: hidden; }
        .admin-table th { background: #334155; padding: 12px; text-align: right; color: var(--accent-teal); }
        .admin-table td { padding: 12px; border-bottom: 1px solid #0f172a; font-size: 14px; }

        .btn { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-cyan { background: var(--accent-cyan); color: #020617; }
        .btn-danger { background: var(--danger); color: white; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div style="padding: 25px; text-align: center; font-weight: 900; color: var(--accent-cyan); border-bottom: 1px solid #1e293b;">YALLA SYSTEM v2</div>
        
        <div class="nav-group">العمليات الميدانية</div>
        <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-desktop"></i> لوحة التحكم</div>
        <div class="nav-item" onclick="switchTab('attendance')"><i class="fas fa-user-clock"></i> الحضور والانصراف</div>
        
        <div class="nav-group">إدارة الموارد البشرية</div>
        <div class="nav-item" onclick="switchTab('workers')"><i class="fas fa-users-cog"></i> قاعدة بيانات العمال</div>
        
        <div class="nav-group">الإدارة العليا (صلاحيات)</div>
        <div class="nav-item" onclick="switchTab('reports')"><i class="fas fa-file-invoice-dollar"></i> تقارير الأرباح</div>
        <div class="nav-item" onclick="switchTab('maint')"><i class="fas fa-tools"></i> سجل الأعطال</div>
        
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn btn-danger" style="width: 100%;" onclick="location.reload()">خروج آمن</button>
        </div>
    </aside>

    <main class="main">
        <header class="top-bar">
            <h2 id="page-title">لوحة العمليات التكتيكية</h2>
            <div id="live-time" style="color: var(--accent-teal); font-weight: bold;">00:00:00</div>
        </header>

        <section class="content">
            
            <div id="tab-dashboard" class="tab-content">
                <div class="grid-3">
                    <div class="stat-card"><h2><span id="act-trips">0</span></h2><p>رحلات نشطة</p></div>
                    <div class="stat-card"><h2><span id="day-rev">0</span></h2><p>إيراد اليوم</p></div>
                    <div class="stat-card"><h2><span id="month-trips">0</span></h2><p>رحلات الشهر</p></div>
                </div>
                <div id="active-trips-area"></div>
            </div>

            <div id="tab-attendance" class="tab-content hidden">
                <h3>تسجيل الدوام اللحظي</h3>
                <div class="stat-card" style="max-width: 500px; margin: 0 auto;">
                    <select id="worker-select" style="width: 100%; padding: 12px; background: #0f172a; color: white; border: 1px solid var(--accent-teal); border-radius: 8px;">
                        <option value="">اختر اسم الموظف...</option>
                    </select>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-cyan" style="flex: 1;" onclick="attendance('in')">تسجيل حضور</button>
                        <button class="btn btn-danger" style="flex: 1;" onclick="attendance('out')">تسجيل انصراف</button>
                    </div>
                </div>
            </div>

            <div id="tab-workers" class="tab-content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>سجل القوى العاملة</h3>
                    <button class="btn btn-cyan" onclick="addWorker()">+ إضافة موظف</button>
                </div>
                <table class="admin-table">
                    <thead><tr><th>الاسم</th><th>الوظيفة</th><th>إجمالي ساعات العمل</th><th>الحالة</th></tr></thead>
                    <tbody id="workers-list"></tbody>
                </table>
            </div>

            <div id="tab-reports" class="tab-content hidden">
                <h3>تحليل أداء الشهر</h3>
                <div class="grid-3">
                    <div class="stat-card"><h2 id="total-month-rev">0</h2><p>أرباح الشهر الجارية</p></div>
                    <div class="stat-card"><h2 id="avg-trips">0</h2><p>متوسط الرحلات اليومي</p></div>
                    <div class="stat-card"><h2 id="top-worker">--</h2><p>الموظف الأكثر انضباطاً</p></div>
                </div>
            </div>

            <div id="tab-maint" class="tab-content hidden">
                <h3>رادار الأعطال والصيانة</h3>
                <div class="stat-card" style="border-color: var(--danger); margin-bottom: 20px;">
                    <p>أكثر سكوتر تكراراً للأعطال:</p>
                    <h2 id="bad-scooter" style="color: var(--danger);">--</h2>
                </div>
                <table class="admin-table">
                    <thead><tr><th>رقم السكوتر</th><th>نوع العطل</th><th>التاريخ</th><th>التكلفة التقديرية</th></tr></thead>
                    <tbody id="maint-list"></tbody>
                </table>
            </div>

        </section>
    </main>

    <script>
        // Firebase Config (استخدم بياناتك الحقيقية)
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ساعة حية
        setInterval(() => {
            document.getElementById('live-time').innerText = new Date().toLocaleTimeString('ar-EG');
        }, 1000);

        // التبديل بين التبويبات
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            
            // تحديث البيانات بناءً على التبويب
            if(id === 'workers') loadWorkers();
            if(id === 'maint') loadMaintLogs();
            if(id === 'reports') loadAdminStats();
        }

        // --- إدارة العمال ---
        function addWorker() {
            Swal.fire({
                title: 'إضافة موظف جديد',
                html: `<input id="w-name" class="swal2-input" placeholder="الاسم الكامل"><input id="w-job" class="swal2-input" placeholder="المسمى الوظيفي">`,
                preConfirm: () => {
                    const name = document.getElementById('w-name').value;
                    const job = document.getElementById('w-job').value;
                    if(name) db.ref('staff').push({ name, job, totalHours: 0 });
                }
            });
        }

        function loadWorkers() {
            db.ref('staff').on('value', snap => {
                const list = document.getElementById('workers-list');
                const select = document.getElementById('worker-select');
                list.innerHTML = "";
                select.innerHTML = '<option value="">اختر اسم الموظف...</option>';
                
                snap.forEach(child => {
                    const w = child.val();
                    list.innerHTML += `<tr><td>${w.name}</td><td>${w.job}</td><td>${w.totalHours || 0} س</td><td>متصل</td></tr>`;
                    select.innerHTML += `<option value="${child.key}">${w.name}</option>`;
                });
            });
        }

        // --- الحضور والانصراف ---
        function attendance(type) {
            const workerId = document.getElementById('worker-select').value;
            if(!workerId) return Swal.fire('تنبيه', 'يرجى اختيار موظف', 'warning');
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            db.ref(`attendance/${dateStr}/${workerId}`).update({
                [type]: now.getTime(),
                label: now.toLocaleTimeString('ar-EG')
            }).then(() => {
                Swal.fire('تم التسجيل', `تم تسجيل ${type === 'in' ? 'حضور' : 'انصراف'} بنجاح`, 'success');
            });
        }

        // --- تحليل الإدارة والصيانة ---
        function loadMaintLogs() {
            db.ref('maintenance').on('value', snap => {
                const list = document.getElementById('maint-list');
                list.innerHTML = "";
                let counts = {};
                
                snap.forEach(entry => {
                    const m = entry.val();
                    counts[m.scooter] = (counts[m.scooter] || 0) + 1;
                    list.innerHTML += `<tr><td>${m.scooter}</td><td>${m.issue}</td><td>${m.date}</td><td>${m.cost || 0} ج.م</td></tr>`;
                });
                
                // تحديد السكوتر "المنحوس"
                const worst = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, "--");
                document.getElementById('bad-scooter').innerText = worst;
            });
        }

        // بدء التشغيل
        loadWorkers();
        switchTab('dashboard');
    </script>
</body>
</html>
