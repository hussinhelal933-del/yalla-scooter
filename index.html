<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter Pro V58 | Titan System</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@700;900&family=Cairo:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --primary: #00d2ff; --danger: #ff0055; --success: #00ff9d; --warn: #ffcc00; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: #fff; height: 100vh; overflow: hidden; transition: 0.5s; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 25px; }
        .login-box { width: 100%; max-width: 320px; text-align: center; }
        input { background: #111; border: 1px solid #333; color: #fff; border-radius: 12px; padding: 15px; width: 100%; text-align: center; font-size: 24px; margin-bottom: 20px; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn-primary { background: linear-gradient(135deg, #0072ff, #00d2ff); color: #fff; padding: 15px; border: none; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 18px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø§Ù„ØªØ§Ø¨Ù„ÙˆÙ‡) */
        #scooter-dash { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #0a1a35, #000); }
        .speed-ring { width: 260px; height: 260px; border: 8px solid var(--primary); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--primary); position: relative; }
        .speed-val { font-family: 'Rajdhani'; font-size: 110px; font-weight: 900; line-height: 1; }
        .unit { font-size: 20px; color: var(--primary); font-weight: bold; }
        .stat-bar { display: flex; gap: 30px; margin-top: 40px; font-size: 20px; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        #admin-panel { display: none; height: 100vh; flex-direction: column; padding: 10px; }
        #admin-map { width: 100%; height: 60%; border-radius: 20px; border: 1px solid var(--primary); margin-bottom: 10px; }
        .scooter-card { background: #111; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 5px solid var(--primary); }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn-sm { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #fff; }
        .btn-lock { background: var(--danger); }
        .btn-unlock { background: var(--success); }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ */
        .alarm-active { background: var(--danger) !important; animation: blink 0.5s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.7;} 100% {opacity: 1;} }

        .section.active { display: flex !important; }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div class="login-box">
            <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size:45px; margin-bottom:10px;">TITAN V58</h1>
            <p style="color:gray; margin-bottom:30px;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± Ø§Ù„Ø°ÙƒÙŠ</p>
            <input type="password" id="passInput" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„">
            <button onclick="handleLogin()" class="btn-primary">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙƒÙˆØªØ± -->
    <div id="scooter-dash" class="section">
        <div style="position:absolute; top:20px; width:100%; text-align:center; color:var(--primary); font-weight:bold;">SCOOTER ID: S1</div>
        <div id="zone-alert" style="color:var(--danger); font-weight:bold; margin-bottom:15px; display:none;">âš ï¸ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­!</div>
        
        <div class="speed-ring">
            <span class="speed-val" id="live-speed">0</span>
            <span class="unit">KM/H</span>
        </div>

        <div class="stat-bar">
            <span><i class="fas fa-battery-full" style="color:var(--success)"></i> <span id="live-batt">--%</span></span>
            <span><i class="fas fa-satellite-dish" style="color:var(--primary)"></i> <span id="gps-status">GPS..</span></span>
        </div>

        <div id="bt-status" style="margin-top:20px; color:var(--warn);">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø³ÙƒÙˆØªØ±...</div>
        <button id="bt-connect-btn" onclick="startScooterNode()" class="btn-primary" style="width:220px; margin-top:20px;">Ø±Ø¨Ø· Ø¨Ù„ÙˆØªÙˆØ« Ø§Ù„Ø³ÙƒÙˆØªØ±</button>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ Ø§Ù„ØªØ§Ù†ÙŠ) -->
    <div id="admin-panel" class="section">
        <div style="display:flex; justify-content:space-between; padding:10px; color:var(--primary);">
            <b>ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ğŸ›°ï¸</b>
            <span onclick="location.reload()">Ø®Ø±ÙˆØ¬</span>
        </div>
        <div id="admin-map"></div>
        <div id="scooter-list-container" style="overflow-y:auto; flex:1;">
            <!-- Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª Ù‡ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ -->
        </div>
    </div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Firebase) Ù…Ù† ØµÙˆØ±Ùƒ ---
    const firebaseConfig = {
        apiKey: "AIzaSyC...", 
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        projectId: "yalla-scooter-pro",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø²ÙˆÙ† (Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ù…Ø§Ù†) ---
    const SAFE_ZONE = { lat: 30.0444, lon: 31.2357, radius: 1000 }; // ÙƒÙŠÙ„Ùˆ Ù…ØªØ± ÙˆØ§Ø­Ø¯

    let scooterChar = null, map = null, markers = {};
    const UUID_SERVICE = "00001a00-0000-1000-8000-00805f9b34fb";
    const UUID_CHAR = "00001a01-0000-1000-8000-00805f9b34fb";

    function handleLogin() {
        const pass = document.getElementById('passInput').value;
        if(pass === "1214") {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('scooter-dash').classList.add('active');
            initGps();
            listenForRemoteCommands(); // Ø¨Ø¯Ø¡ Ø³Ù…Ø§Ø¹ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        } else if(pass === "9924") {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-panel').classList.add('active');
            initAdminMap();
        } else {
            alert("Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­");
        }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³ÙƒÙˆØªØ± ---
    async function startScooterNode() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'Mi' }, { namePrefix: 'MIScooter' }],
                optionalServices: [UUID_SERVICE]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(UUID_SERVICE);
            scooterChar = await service.getCharacteristic(UUID_CHAR);
            await scooterChar.startNotifications();
            
            document.getElementById('bt-connect-btn').style.display = 'none';
            document.getElementById('bt-status').innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙƒÙˆØªØ± âœ…";

            scooterChar.addEventListener('characteristicvaluechanged', (e) => {
                let v = e.target.value;
                let speed = (v.getUint16(10, true) / 1000).toFixed(0);
                let batt = v.getUint8(15);
                document.getElementById('live-speed').innerText = speed;
                document.getElementById('live-batt').innerText = batt + "%";
                db.ref('live_nodes/S1').update({ speed, batt, lastUpdate: Date.now() });
            });
        } catch(e) { alert("Ø®Ø·Ø£ Ø¨Ù„ÙˆØªÙˆØ«: " + e.message); }
    }

    function initGps() {
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                document.getElementById('gps-status').innerText = "LIVE";

                // ÙØ­Øµ Ø§Ù„Ø²ÙˆÙ†
                const R = 6371e3;
                const dLat = (lat - SAFE_ZONE.lat) * Math.PI/180;
                const dLon = (lon - SAFE_ZONE.lon) * Math.PI/180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(SAFE_ZONE.lat*Math.PI/180) * Math.cos(lat*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                const dist = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
                
                const isOut = dist > SAFE_ZONE.radius;
                if(isOut) {
                    document.body.classList.add('alarm-active');
                    document.getElementById('zone-alert').style.display = 'block';
                } else {
                    document.body.classList.remove('alarm-active');
                    document.getElementById('zone-alert').style.display = 'none';
                }

                db.ref('live_nodes/S1').update({ lat, lon, isAlarm: isOut, lastUpdate: Date.now() });
            }, null, { enableHighAccuracy: true });
        }
    }

    // --- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨ÙØ¹Ø¯) ---
    function listenForRemoteCommands() {
        db.ref('iot_commands/S1').on('value', async (snap) => {
            const cmd = snap.val();
            if(!scooterChar) return;
            
            if(cmd === "LOCK") {
                await scooterChar.writeValue(new Uint8Array([0x55, 0xAA, 0x03, 0x20, 0x03, 0x70, 0x01, 0x69, 0xFF]));
                db.ref('iot_commands/S1').set("IDLE"); // ØªØµÙÙŠØ± Ø§Ù„Ø£Ù…Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            } else if(cmd === "UNLOCK") {
                await scooterChar.writeValue(new Uint8Array([0x55, 0xAA, 0x03, 0x20, 0x03, 0x71, 0x01, 0x68, 0xFF]));
                db.ref('iot_commands/S1').set("IDLE");
            }
        });
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
    function initAdminMap() {
        map = L.map('admin-map').setView([30.0444, 31.2357], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        db.ref('live_nodes').on('value', snap => {
            const container = document.getElementById('scooter-list-container');
            container.innerHTML = "";
            snap.forEach(child => {
                const data = child.val();
                const id = child.key;
                if(data.lat) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                    if(markers[id]) markers[id].setLatLng([data.lat, data.lon]);
                    else markers[id] = L.marker([data.lat, data.lon]).addTo(map).bindPopup("Ø³ÙƒÙˆØªØ±: " + id);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
                    container.innerHTML += `
                        <div class="scooter-card" style="${data.isAlarm ? 'border-left-color:red' : ''}">
                            <div style="display:flex; justify-content:space-between">
                                <b>ğŸ›µ Ø³ÙƒÙˆØªØ±: ${id} ${data.isAlarm ? 'âš ï¸' : ''}</b>
                                <b style="color:var(--primary)">${data.speed || 0} KM/H</b>
                            </div>
                            <div style="font-size:12px; color:gray; margin-top:5px;">Ø¨Ø·Ø§Ø±ÙŠØ©: ${data.batt || '--'}% | Ø­Ø§Ù„Ø©: ${data.isAlarm ? 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ø²ÙˆÙ†' : 'Ø¢Ù…Ù†'}</div>
                            <div class="controls">
                                <button class="btn-sm btn-lock" onclick="sendRemoteCmd('${id}', 'LOCK')">Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ</button>
                                <button class="btn-sm btn-unlock" onclick="sendRemoteCmd('${id}', 'UNLOCK')">ÙØªØ­ Ø§Ù„Ø³ÙƒÙˆØªØ±</button>
                            </div>
                        </div>
                    `;
                }
            });
        });
    }

    function sendRemoteCmd(id, cmd) {
        db.ref('iot_commands/' + id).set(cmd);
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ù€ " + cmd + " Ù„Ù„Ø³ÙƒÙˆØªØ±");
    }

    // Ù…Ù†Ø¹ Ù†ÙˆÙ… Ø§Ù„Ø´Ø§Ø´Ø©
    if(navigator.wakeLock) navigator.wakeLock.request('screen');
</script>
</body>
</html>
