<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter Master V90 | Cyber AI</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --sidebar: #050505; --card: #0d1117; --primary: #00d2ff; --ai: #a29bfe; --danger: #ff0055; --success: #00ff9d; --border: rgba(0, 210, 255, 0.1); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .app-header { height: 60px; background: #050505; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .sidebar { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: #050505; z-index: 3000; transition: 0.4s; border-left: 1px solid #222; padding: 20px; }
        .sidebar.active { right: 0; }
        .nav-item { padding: 14px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #888; margin-bottom: 8px; }
        .nav-item.active { background: rgba(0,210,255,0.1); color: var(--primary); font-weight: bold; }

        /* Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª */
        .app-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 15px; text-align: center; }
        .kpi-val { font-family: 'Rajdhani'; font-size: 22px; font-weight: 700; color: var(--primary); }

        .trip-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; border-right: 4px solid var(--primary); position: relative; }
        .unit-timer { font-family: 'Rajdhani'; font-size: 38px; text-align: center; color: var(--primary); font-weight: 900; }

        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-ai { background: var(--ai); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }

        /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        .cam-preview { width: 100%; height: 180px; background: #000; border-radius: 15px; border: 1px dashed #333; margin: 10px 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… -->
    <div id="login-overlay">
        <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size: 35px; margin-bottom:10px;">TITAN MASTER</h1>
        <input type="password" id="pinInput" style="background:#0a0a0a; border:1px solid #333; color:#fff; padding:15px; width:280px; border-radius:12px; text-align:center; font-size:24px;" placeholder="PIN CODE">
        <button onclick="App.auth()" class="btn btn-primary" style="width:280px; margin-top:15px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <header class="app-header">
        <div style="font-family:'Rajdhani'; font-weight:900; color:var(--primary);">YALLA MASTER</div>
        <div id="clock" style="font-family:'Rajdhani'; color:#666;">00:00:00</div>
        <div onclick="App.toggleSidebar()" style="color:var(--primary); font-size:20px;"><i class="fas fa-bars"></i></div>
    </header>

    <nav id="sidebar" class="sidebar">
        <div class="nav-item active" onclick="App.nav('ops')"><i class="fas fa-play"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</div>
        <div class="nav-item" onclick="App.nav('ai')"><i class="fas fa-brain"></i> Yalla AI Analysis</div>
        <div class="nav-item" onclick="App.nav('fleet')"><i class="fas fa-map-marked-alt"></i> Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
        <div class="nav-item admin-only" onclick="App.nav('finance')"><i class="fas fa-wallet"></i> Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„ÙˆØ±Ø¯ÙŠØ©</div>
        <div class="nav-item" onclick="App.openWiFiCam()"><i class="fas fa-video"></i> ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ù„ WiFi</div>
        <button onclick="location.reload()" class="btn btn-danger" style="margin-top:auto;">Ø®Ø±ÙˆØ¬</button>
    </nav>

    <main class="app-content">
        <!-- KPIs -->
        <div class="kpi-grid">
            <div class="kpi-card"><small>Ø§Ù„Ø¯Ø±Ø¬</small><br><span id="k-cash" class="kpi-val">0.00</span></div>
            <div class="kpi-card"><small>Ø§Ù„Ù†Ø´Ø·</small><br><span id="k-active" class="kpi-val">0</span></div>
        </div>

        <!-- 1. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
        <div id="sec-ops" class="section">
            <div style="background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px;">
                <input type="text" id="c-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="background:#000; border:1px solid #333; color:#fff; padding:12px; width:100%; border-radius:10px; margin-bottom:10px;">
                <input type="text" id="s-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±" style="background:#000; border:1px solid #333; color:#fff; padding:12px; width:100%; border-radius:10px; margin-bottom:10px;">
                
                <div class="cam-preview" id="cam-box">
                    <video id="video" class="hidden" autoplay playsinline></video>
                    <img id="id-photo" src="https://via.placeholder.com/300x150?text=ØµÙˆØ±+Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" style="width:100%; height:100%; object-fit:contain;">
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-ghost" onclick="App.toggleCam()" style="background:#111; color:#fff;">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button id="snap-btn" class="btn btn-primary hidden" onclick="App.takeSnap()">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø·</button>
                </div>
                <button class="btn btn-primary" onclick="App.startTrip()" style="margin-top:15px; font-size:18px;">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
            </div>
            <div id="active-trips"></div>
        </div>

        <!-- 2. AI Analysis -->
        <div id="sec-ai" class="section hidden">
            <h3 style="color:var(--ai); margin-bottom:15px;"><i class="fas fa-robot"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
            <div id="ai-insight" style="background:#111; padding:20px; border-radius:15px; border-left:5px solid var(--ai); line-height:1.8; font-size:13px; color:#ccc;">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…...
            </div>
        </div>

        <!-- 3. Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
        <div id="sec-fleet" class="section hidden">
            <div id="map-box" style="width:100%; height:350px; border-radius:15px; border:1px solid #222;"></div>
            <div id="fleet-list" style="margin-top:20px;"></div>
        </div>

        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Node) -->
        <div id="sec-node" class="section hidden" style="text-align:center;">
            <div style="font-size:100px; font-family:'Rajdhani'; color:var(--primary); font-weight:900;" id="n-speed">00</div>
            <h1 id="n-name">SCOOTER NODE</h1>
            <div id="n-batt" style="color:var(--success); font-size:20px; margin-top:20px;">ğŸ”‹ 100%</div>
        </div>
    </main>

<script>
    const App = {
        config: { base: 40, price: 2.66, wifiCam: "Ø±Ø§Ø¨Ø·_ÙƒØ§Ù…ÙŠØ±Ø§_Ø§Ù„ÙˆØ§ÙŠ_ÙØ§ÙŠ_Ù‡Ù†Ø§" },
        db: null,
        capturedPhoto: "",
        trips: [],

        init: function() {
            firebase.initializeApp({ 
                databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
                storageBucket: "yalla-scooter-pro.appspot.com" 
            });
            this.db = firebase.database();
            this.sync();
            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); }, 1000);
        },

        auth: function() {
            const pin = document.getElementById('pinInput').value;
            const overlay = document.getElementById('login-overlay');
            if(pin === "9924") { 
                document.querySelectorAll('.admin-only').forEach(e => e.classList.remove('hidden'));
                overlay.style.display='none'; this.init(); 
            }
            else if(pin === "1213") { overlay.style.display='none'; this.init(); }
            else if(pin === "1214") { 
                Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±', input: 'text' }).then(r => {
                    if(r.value) { 
                        overlay.style.display='none'; 
                        document.getElementById('n-name').innerText = r.value;
                        this.init(); this.runNode(r.value); 
                    }
                });
            } else { Swal.fire('PIN Ø®Ø·Ø£'); }
        },

        toggleSidebar: () => document.getElementById('sidebar').classList.toggle('active'),
        nav: function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            this.toggleSidebar();
        },

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù€ ID ---
        toggleCam: async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('video').srcObject = stream;
                document.getElementById('video').classList.remove('hidden');
                document.getElementById('id-photo').classList.add('hidden');
                document.getElementById('snap-btn').classList.remove('hidden');
            } catch(e) { alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }
        },

        takeSnap: function() {
            const v = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = v.videoWidth; canvas.height = v.videoHeight;
            canvas.getContext('2d').drawImage(v, 0, 0);
            this.capturedPhoto = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById('id-photo').src = this.capturedPhoto;
            document.getElementById('id-photo').classList.remove('hidden');
            v.classList.add('hidden');
            v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('snap-btn').classList.add('hidden');
        },

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª ---
        startTrip: function() {
            const name = document.getElementById('c-name').value;
            const scoot = document.getElementById('s-id').value;
            if(!name || !scoot) return Swal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');

            this.db.ref('active_trips').push({
                customer: name, scooter: scoot, startTime: Date.now(), photo: this.capturedPhoto
            });

            document.getElementById('c-name').value = "";
            document.getElementById('s-id').value = "";
            this.capturedPhoto = "";
            document.getElementById('id-photo').src = "https://via.placeholder.com/300x150?text=ØµÙˆØ±+Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©";
        },

        finishTrip: function(id, start, scoot) {
            const mins = Math.max(0, Math.floor((Date.now() - (start || Date.now())) / 60000));
            const cost = Math.round(this.config.base + (mins > 15 ? (mins - 15) * this.config.price : 0)) || 0;

            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬.Ù…</b><br><input id="disc" type="number" class="swal2-input" placeholder="Ø®ØµÙ…ØŸ">`,
                confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸'
            }).then(r => {
                if(r.isConfirmed) {
                    const d = parseFloat(document.getElementById('disc').value || 0);
                    const final = Math.max(0, cost - d);
                    this.db.ref('vault_total').transaction(v => (v || 0) + final);
                    this.db.ref('history').push({ scooter: scoot, cost: final, mins, date: Date.now() });
                    this.db.ref('active_trips/' + id).remove();
                }
            });
        },

        // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù€ AI ---
        sync: function() {
            this.db.ref('active_trips').on('value', snap => {
                const list = document.getElementById('active-trips');
                list.innerHTML = ""; let count = 0;
                const data = snap.val() || {};
                for(let id in data) {
                    count++;
                    const t = data[id];
                    const mins = Math.floor((Date.now() - (t.startTime || Date.now())) / 60000);
                    list.innerHTML += `
                        <div class="trip-card">
                            <b>ğŸ›µ ${t.scooter}</b> | ğŸ‘¤ ${t.customer}
                            <div class="unit-timer">${mins} MIN</div>
                            <button class="btn btn-primary" onclick="App.finishTrip('${id}', ${t.startTime}, '${t.scooter}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                        </div>`;
                }
                document.getElementById('k-active').innerText = count;
                this.runAI(data);
            });

            this.db.ref('vault_total').on('value', s => document.getElementById('k-cash').innerText = (s.val() || 0).toFixed(2) + " Ø¬");
        },

        runAI: function(activeData) {
            const count = Object.keys(activeData).length;
            let msg = count > 3 ? "âš ï¸ Ø¶ØºØ· Ø¹Ù…Ù„ Ø¹Ø§Ù„ÙŠ: ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø´Ø­Ù† Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©." : "ğŸŸ¢ Ø§Ù„ÙˆØ¶Ø¹ Ù…Ø³ØªÙ‚Ø±: ÙŠÙ…ÙƒÙ†Ùƒ ÙØ­Øµ Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ø¯Ø© ÙˆØµÙŠØ§Ù†ØªÙ‡Ø§.";
            if(count === 0) msg = "ğŸ’¤ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙˆÙ‚Øª Ù…Ø«Ø§Ù„ÙŠ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.";
            document.getElementById('ai-insight').innerText = msg;
        },

        openWiFiCam: function() {
            window.open(this.config.wifiCam, '_blank');
        },

        // --- ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø§Ù„Ø¹Ø¯Ø§Ø¯) ---
        runNode: function(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-node').classList.remove('hidden');
            navigator.geolocation.watchPosition(pos => {
                const spd = Math.round((pos.coords.speed || 0) * 3.6);
                document.getElementById('n-speed').innerText = spd;
                this.db.ref('fleet_online/' + name).update({ speed: spd, lat: pos.coords.latitude, lon: pos.coords.longitude, lastSeen: Date.now() });
            }, null, {enableHighAccuracy: true});
        }
    };
</script>
</body>
</html>
