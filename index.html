<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter | Tactical Dashboard</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-main: #0f172a;
            --sidebar-navy: #1e293b;
            --accent-teal: #14b8a6;
            --accent-blue: #38bdf8;
            --text-dark: #f8fafc;
            --card-white: #1e293b;
            --border-color: #334155;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg-main); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 240px; background: var(--sidebar-navy); color: white; display: flex; flex-direction: column; padding: 20px 0; border-left: 1px solid var(--border-color); }
        .brand { padding: 0 20px 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .brand h2 { font-weight: 900; font-size: 20px; color: var(--accent-teal); margin: 0; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; color: #94a3b8; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: var(--accent-teal); border-right: 4px solid var(--accent-teal); }

        /* --- Main Content --- */
        .main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 60px; background: var(--sidebar-navy); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .content-area { flex: 1; padding: 25px; overflow-y: auto; }

        /* --- Dashboard Grid --- */
        .dashboard-grid { display: grid; grid-template-columns: 300px 1fr 350px; gap: 20px; margin-bottom: 25px; }
        .section-title { font-weight: 700; font-size: 16px; margin-bottom: 15px; color: #94a3b8; display: flex; align-items: center; gap: 8px; }
        .glass-card { background: var(--card-white); border-radius: 12px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }

        /* Stats Boxes */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-box { background: var(--sidebar-navy); padding: 20px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--accent-teal); }
        .stat-val { font-size: 28px; font-weight: 900; display: block; color: #fff; }
        .stat-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        /* Trips List */
        .trip-item { background: #334155; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-right: 4px solid var(--accent-blue); }
        .trip-timer { font-size: 20px; font-weight: 800; color: var(--accent-blue); }

        /* AI Chat Box */
        .ai-chat-box { height: 400px; display: flex; flex-direction: column; background: #0f172a; border-radius: 12px; border: 1px solid var(--accent-teal); overflow: hidden; }
        #ai-logs { flex: 1; padding: 15px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; max-width: 85%; }
        .msg.bot { background: rgba(20, 184, 166, 0.1); color: var(--accent-teal); align-self: flex-start; }
        .msg.user { background: #334155; color: white; align-self: flex-end; margin-right: auto; }

        /* Login Overlay */
        #login-overlay { position: fixed; inset: 0; background: #020617; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--sidebar-navy); padding: 40px; border-radius: 20px; width: 350px; text-align: center; border: 1px solid var(--accent-teal); }
        .login-input { width: 100%; padding: 15px; margin: 20px 0; border: 1px solid var(--border-color); background: #0f172a; color: white; border-radius: 10px; font-size: 20px; text-align: center; }
        
        .btn-action { background: var(--accent-teal); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-action:hover { filter: brightness(1.2); transform: translateY(-2px); }

        .page-section { display: none; }
        .page-section.active { display: block; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color:var(--accent-teal)">Yalla Scooter</h2>
            <p style="color:#94a3b8">نظام الإدارة التكتيكي</p>
            <input type="password" id="passInput" class="login-input" placeholder="رقم الدخول">
            <button onclick="login()" class="btn-action">دخول النظام</button>
        </div>
    </div>

    <nav class="sidebar">
        <div class="brand"><h2><i class="fas fa-bolt"></i> TACTICAL DASH</h2></div>
        <div class="nav-item active" onclick="showSec('rental', this)"><i class="fas fa-motorcycle"></i> العمليات</div>
        <div class="nav-item" onclick="showSec('admin', this)"><i class="fas fa-brain"></i> المحلل الذكي</div>
        <div class="nav-item" style="margin-top:auto; color:#ef4444" onclick="location.reload()"><i class="fas fa-power-off"></i> خروج</div>
    </nav>

    <div class="main-container">
        <div class="top-bar">
            <div id="page-title" style="font-weight: 800; font-size: 18px; color: var(--accent-teal);">لوحة التحكم الرئيسية</div>
            <div id="live-clock" style="color: #94a3b8; font-weight: 600;">--:--:--</div>
        </div>

        <div class="content-area">
            
            <div id="sec-rental" class="page-section active">
                <div class="stats-row">
                    <div class="stat-box"><span id="stat-active" class="stat-val" style="color:var(--accent-blue)">0</span><span class="stat-label">نشط حالياً</span></div>
                    <div class="stat-box"><span id="stat-revenue" class="stat-val" style="color:var(--accent-teal)">0</span><span class="stat-label">إيراد اليوم</span></div>
                    <div class="stat-box"><span id="stat-trips" class="stat-val" style="color:#8b5cf6">0</span><span class="stat-label">إجمالي الرحلات</span></div>
                    <div class="stat-box"><span id="stat-maint" class="stat-val" style="color:#f59e0b">0</span><span class="stat-label">أعطال</span></div>
                </div>

                <div class="dashboard-grid">
                    <div class="glass-card">
                        <div class="section-title"><i class="fas fa-play" style="color:var(--accent-blue)"></i> الرحلات الحالية</div>
                        <div id="active-list" style="max-height: 450px; overflow-y:auto;"></div>
                        <button class="btn-action" style="margin-top:15px;" onclick="newTripPopup()">+ رحلة جديدة</button>
                    </div>

                    <div class="glass-card">
                        <div class="section-title"><i class="fas fa-chart-area"></i> توزيع الاستخدام اليومي</div>
                        <canvas id="mainChart"></canvas>
                    </div>

                    <div class="glass-card">
                        <div class="section-title"><i class="fas fa-bullseye"></i> مؤشر الأداء</div>
                        <div style="text-align: center; margin-top: 50px;">
                            <h1 id="perf-perc" style="font-size: 60px; color: var(--accent-teal); margin:0;">0%</h1>
                            <p style="color:#94a3b8">نسبة إنجاز الهدف اليومي</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-admin" class="page-section">
                <div class="dashboard-grid" style="grid-template-columns: 1fr 400px;">
                    <div class="ai-chat-box">
                        <div style="padding:15px; background:rgba(20, 184, 166, 0.2); font-weight:bold; color:var(--accent-teal); border-bottom:1px solid var(--accent-teal)">
                            <i class="fas fa-robot"></i> المحلل المالي الذكي
                        </div>
                        <div id="ai-logs">
                            <div class="msg bot">تحياتي أيها القائد. أنا جاهز لتحليل البيانات المالية والميدانية. كيف يمكنني مساعدتك؟</div>
                        </div>
                        <div style="padding:15px; display:flex; gap:10px; background: var(--sidebar-navy);">
                            <input type="text" id="ai-input" style="flex:1; padding:12px; border-radius:8px; border:none; background:#0f172a; color:white;" placeholder="اسأل عن أداء اليوم...">
                            <button onclick="askAI()" class="btn-action" style="width:100px;">إرسال</button>
                        </div>
                    </div>
                    
                    <div class="glass-card">
                        <div class="section-title">إحصائيات تكتيكية</div>
                        <div id="ai-stats-content">
                            <p style="color:#94a3b8">قم بسؤال المحلل عن "ملخص اليوم" للحصول على تقرير كامل.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // تكوين Firebase (استخدم بياناتك)
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // نظام الدخول
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                document.getElementById('login-overlay').style.display = 'none';
                initData();
            } else {
                Swal.fire('خطأ', 'كود الدخول غير صحيح', 'error');
            }
        }

        // التنقل بين الصفحات
        function showSec(id, el) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            el.classList.add('active');
        }

        // ساعة حية
        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG');
        }, 1000);

        // جلب البيانات من Firebase
        let dailyRevenue = 0;
        let totalTrips = 0;
        let activeCount = 0;

        function initData() {
            // 1. الرحلات النشطة
            db.ref('active_trips').on('value', snap => {
                const list = document.getElementById('active-list');
                list.innerHTML = "";
                activeCount = 0;
                
                snap.forEach(t => {
                    const trip = t.val();
                    const mins = Math.floor((Date.now() - trip.start)/60000);
                    activeCount++;
                    list.innerHTML += `
                        <div class="trip-item">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <b><i class="fas fa-motorcycle"></i> ${trip.scooter}</b>
                                <span class="trip-timer">${mins}m</span>
                            </div>
                            <small style="color:#94a3b8">${trip.client}</small>
                            <button onclick="endTrip('${t.key}', '${trip.scooter}', ${mins})" style="width:100%; border:none; background:rgba(239,68,68,0.2); color:#ef4444; margin-top:8px; border-radius:4px; padding:6px; cursor:pointer; font-weight:bold;">إنهاء</button>
                        </div>
                    `;
                });
                document.getElementById('stat-active').innerText = activeCount;
            });

            // 2. إحصائيات اليوم
            const today = new Date().toISOString().split('T')[0];
            db.ref(`history/${today}`).on('value', snap => {
                dailyRevenue = 0;
                totalTrips = 0;
                snap.forEach(c => { 
                    dailyRevenue += (c.val().total || 0); 
                    totalTrips++; 
                });
                document.getElementById('stat-revenue').innerText = dailyRevenue + " ج";
                document.getElementById('stat-trips').innerText = totalTrips;
                
                // تحديث مؤشر الأداء (مثلاً الهدف 2000 جنيه يومياً)
                const perf = Math.min(Math.floor((dailyRevenue/2000)*100), 100);
                document.getElementById('perf-perc').innerText = perf + "%";
            });
        }

        // إنهاء رحلة
        function endTrip(key, scooter, mins) {
            const price = 2; // جنيه لكل دقيقة
            const total = Math.max(price * mins, 10); // الحد الأدنى 10 جنيه

            Swal.fire({
                title: 'إنهاء الرحلة',
                text: `القيمة المطلوبة: ${total} جنيه لـ ${mins} دقيقة`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'تحصيل وإغلاق'
            }).then(r => {
                if(r.isConfirmed) {
                    const today = new Date().toISOString().split('T')[0];
                    db.ref(`history/${today}`).push({ scooter, total, duration: mins, end: Date.now() });
                    db.ref('active_trips/'+key).remove();
                }
            });
        }

        // إنشاء رحلة جديدة
        function newTripPopup() {
            Swal.fire({
                title: 'بدء رحلة جديدة',
                html: `
                    <input id="sw-s" class="swal2-input" placeholder="رقم السكوتر">
                    <input id="sw-n" class="swal2-input" placeholder="اسم العميل">
                `,
                preConfirm: () => {
                    const s = document.getElementById('sw-s').value;
                    const n = document.getElementById('sw-n').value;
                    if(!s) return Swal.showValidationMessage('يرجى كتابة رقم السكوتر');
                    db.ref('active_trips').push({ scooter:s, client:n||'عميل', start:Date.now() });
                }
            });
        }

        // المحلل الذكي AI
        async function askAI() {
            const input = document.getElementById('ai-input');
            const log = document.getElementById('ai-logs');
            const q = input.value.trim();
            if(!q) return;

            log.innerHTML += `<div class="msg user">${q}</div>`;
            input.value = "";

            setTimeout(() => {
                let answer = "";
                if(q.includes("أرباح") || q.includes("كم") || q.includes("ملخص")) {
                    answer = `بناءً على البيانات اللحظية، تم تحقيق ${dailyRevenue} جنيه من ${totalTrips} رحلة اليوم. متوسط الدخل لكل رحلة هو ${Math.floor(dailyRevenue/totalTrips || 0)} جنيه.`;
                } else if(q.includes("نشط") || q.includes("شغال")) {
                    answer = `يوجد حالياً ${activeCount} رحلات في الميدان. الاستخدام مستقر.`;
                } else {
                    answer = "أنا مبرمج لتحليل البيانات المالية. يمكنك سؤالي عن الأرباح، عدد الرحلات، أو ملخص اليوم.";
                }
                log.innerHTML += `<div class="msg bot">${answer}</div>`;
                log.scrollTop = log.scrollHeight;
            }, 600);
        }
    </script>
</body>
</html>
