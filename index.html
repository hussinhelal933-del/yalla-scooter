<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter V65.0 | Complete Neon System</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #020205; --sidebar: #05050a; --card: #0a0a0f;
            --primary: #00f2ff; --neon-purple: #bc13fe; --neon-red: #ff0055;
            --neon-green: #00ff9d; --border: rgba(0, 242, 255, 0.2);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 400px; text-align: center; padding: 50px; border-radius: 30px; border: 2px solid var(--primary); background: var(--card); box-shadow: 0 0 20px var(--primary); }
        
        /* Pilot UI */
        #scooter-ui { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        .neon-ring { width: 250px; height: 250px; border: 5px solid #111; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 30px var(--primary); border-top-color: var(--primary); }
        .speed-val { font-family: 'Orbitron'; font-size: 90px; text-shadow: 0 0 20px var(--primary); }

        /* Dashboard */
        #app-ui { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #1a1a1a; display: flex; flex-direction: column; padding: 20px; }
        .nav-item { padding: 15px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #444; margin-bottom: 5px; font-weight: bold; }
        .nav-item.active { color: var(--primary); background: rgba(0, 242, 255, 0.05); border-right: 4px solid var(--primary); }
        .main-container { flex: 1; overflow-y: auto; padding: 25px; }

        /* Cards */
        .neon-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 0 10px rgba(0,242,255,0.05); }
        .trip-card { display: flex; justify-content: space-between; align-items: center; border-right: 8px solid var(--primary); }
        .trip-card.fallen { border-right-color: var(--neon-purple); box-shadow: 0 0 20px var(--neon-purple); animation: shake 0.5s infinite; }
        .trip-card.out-zone { border-right-color: var(--neon-red); box-shadow: 0 0 20px var(--neon-red); }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        /* UI Elements */
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }
        .btn-danger { background: rgba(255, 0, 85, 0.1); color: var(--neon-red); border: 1px solid var(--neon-red); }
        .section { display: none; } .section.active { display: block; }
        .admin-only { display: none; }
        #gps-page { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        #full-map { flex: 1; }
        input { width: 100%; padding: 12px; background: #111; border: 1px solid #222; color: #fff; border-radius: 8px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h1 style="color:var(--primary); font-family:'Orbitron';">YALLA V65</h1>
            <input type="password" id="passInput" placeholder="â€¢â€¢â€¢â€¢">
            <button onclick="handleAuth()" class="btn btn-primary" style="margin-top:20px">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Scooter Screen -->
    <div id="scooter-ui">
        <div class="neon-ring"><span class="speed-val" id="node-speed">0</span><p>KM/H</p></div>
        <div id="node-id" style="margin-top:20px; color:#111;">ID: --</div>
    </div>

    <!-- Admin Panel -->
    <div id="app-ui">
        <nav class="sidebar">
            <h2 style="color:var(--primary); text-align:center; margin-bottom:20px; font-family:Orbitron">YALLA</h2>
            <div class="nav-item active" onclick="nav('trips')"><i class="fas fa-bolt"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</div>
            <div class="nav-item" onclick="nav('fleet')"><i class="fas fa-map"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
            <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
            <div class="nav-item" onclick="nav('finance')"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ÙˆØ±Ø¯ÙŠØ©</div>
            <div class="nav-item" onclick="nav('ai')"><i class="fas fa-brain"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            <div class="nav-item" onclick="nav('history')"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
            <div class="nav-item admin-only" onclick="nav('settings')"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²Ù†</div>
        </nav>

        <main class="main-container">
            <!-- Trips Section -->
            <div id="sec-trips" class="section active">
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <div class="neon-card" style="flex:1">Ø§Ù„Ù†Ø´Ø·: <b id="k-active" style="color:var(--primary)">0</b></div>
                    <div class="neon-card admin-only" style="flex:1">Ø§Ù„Ø¯Ø±Ø¬: <b id="k-cash" style="color:var(--neon-green)">0</b></div>
                </div>
                <button class="btn btn-primary" onclick="openNewTrip()" style="margin-bottom:20px">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <div id="active-trips-list"></div>
            </div>

            <!-- AI Section -->
            <div id="sec-ai" class="section">
                <div class="neon-card">
                    <h2>Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ AI</h2>
                    <button class="btn btn-primary" onclick="runAI()" style="margin-top:15px">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
                    <div id="ai-results" style="margin-top:20px"></div>
                </div>
            </div>

            <!-- Fleet Section -->
            <div id="sec-fleet" class="section"><div id="fleet-list"></div></div>

            <!-- Clients Section -->
            <div id="sec-clients" class="section">
                <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù…..." oninput="searchClients(this.value)">
                <div id="clients-list" style="margin-top:20px"></div>
            </div>

            <!-- Finance Section -->
            <div id="sec-finance" class="section">
                <button class="btn btn-primary" onclick="toggleShift()" id="shift-btn">ÙØªØ­ ÙˆØ±Ø¯ÙŠØ©</button>
                <button class="btn btn-danger" onclick="expensePopup()" style="margin-top:10px">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
                <div id="finance-logs" style="margin-top:20px"></div>
            </div>

            <!-- History Section -->
            <div id="sec-history" class="section"><div id="history-list"></div></div>

            <!-- Settings Section -->
            <div id="sec-settings" class="section admin-only">
                <div class="neon-card">
                    <h3>ØªØ¹Ø±ÙŠÙØ© Ø§Ù„ØªØ£Ø¬ÙŠØ±</h3>
                    <p>Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ 15 Ø¯:</p><input type="number" id="set-min" onchange="saveConfig()">
                    <p style="margin-top:10px">ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ø£ÙˆÙ„ 15 Ø¯):</p><input type="number" id="set-base" onchange="saveConfig()">
                </div>
                <h3 style="margin-top:20px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h3>
                <div id="stock-list" style="margin-top:10px"></div>
                <button class="btn btn-primary" onclick="addScooterToStock()" style="margin-top:10px">+ Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ±</button>
            </div>
        </main>
    </div>

    <!-- GPS Map -->
    <div id="gps-page">
        <div style="padding:15px; display:flex; justify-content:space-between; background:#000;">
            <b id="gps-title">Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØªØ¨Ø¹</b>
            <button onclick="closeGps()" class="btn-danger" style="width:80px">Ø±Ø¬ÙˆØ¹</button>
        </div>
        <div id="full-map"></div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let shopLoc = { lat: 30.0444, lon: 31.2357 }, isAdmin = false;
    let config = { base: 40, min: 2.66 }, activeTrips = {}, gMap, gMarker;
    let myId = localStorage.getItem('yalla_id') || "Y-" + Math.floor(1000+Math.random()*9000);
    localStorage.setItem('yalla_id', myId);
    document.getElementById('node-id').innerText = "ID: " + myId;
    const beep = new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3');

    function handleAuth() {
        const p = document.getElementById('passInput').value;
        if(p === "1214") { document.getElementById('login-overlay').style.display='none'; document.getElementById('scooter-ui').style.display='flex'; runScooter(); }
        else if(p === "1213" || p === "9924") { isAdmin=(p==="9924"); document.getElementById('login-overlay').style.display='none'; document.getElementById('app-ui').style.display='flex'; runApp(); }
    }

    function runScooter() {
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude, speed = Math.round(pos.coords.speed*3.6)||0;
                document.getElementById('node-speed').innerText = speed;
                db.ref('live_nodes/'+myId).update({ lat, lon, speed, outZone: getDist(lat,lon,shopLoc.lat,shopLoc.lon)>2000, lastUpdate: Date.now() });
            }, null, {enableHighAccuracy:true});
        }
        window.addEventListener('deviceorientation', e => {
            if(Math.abs(e.beta)>75 || Math.abs(e.gamma)>75) { db.ref('live_nodes/'+myId+'/fallen').set(true); beep.play(); }
            else { db.ref('live_nodes/'+myId+'/fallen').set(false); beep.pause(); }
        });
    }

    function runApp() {
        if(isAdmin) document.querySelectorAll('.admin-only').forEach(e=>e.style.display='block');
        db.ref('active_trips').on('value', s => { activeTrips = s.val()||{}; renderTrips(); });
        db.ref('live_nodes').on('value', s => {
            const list = document.getElementById('fleet-list'); list.innerHTML = "";
            s.forEach(c => { list.innerHTML += `<div class="neon-card">ğŸ›µ ${c.key} | Ø§Ù„Ø³Ø±Ø¹Ø©: ${c.val().speed} <button onclick="openGps('${c.key}')" class="btn btn-primary" style="width:70px; display:inline-flex; margin-top:5px">Ø®Ø±ÙŠØ·Ø©</button></div>`; });
        });
        db.ref('settings').on('value', s => { if(s.exists()){ config=s.val(); document.getElementById('set-min').value=config.min; document.getElementById('set-base').value=config.base; }});
        db.ref('shifts/current/cash').on('value', s => document.getElementById('k-cash').innerText = (s.val()||0)+" Ø¬");
        db.ref('inventory').on('value', s => {
            const list = document.getElementById('stock-list'); list.innerHTML = "";
            s.forEach(d => { list.innerHTML += `<div class="neon-card" style="display:flex; justify-content:space-between"><b>${d.key}</b> <span>${d.val().status}</span></div>`; });
        });
        loadHistory();
    }

    function renderTrips() {
        const list = document.getElementById('active-trips-list'); list.innerHTML = "";
        let count = 0;
        for(let k in activeTrips) {
            count++; const t = activeTrips[k];
            const card = document.createElement('div'); card.className = 'neon-card trip-card'; card.id = `card-${k}`;
            list.appendChild(card);
            db.ref('live_nodes/'+t.scooterId).on('value', s => {
                const d = s.val()||{};
                if(d.fallen) card.classList.add('fallen'); else card.classList.remove('fallen');
                if(d.outZone) card.classList.add('out-zone'); else card.classList.remove('out-zone');
            });
            card.innerHTML = `<div><h2 style="color:var(--primary)">ğŸ›µ ${t.scooterId}</h2><small>ğŸ‘¤ ${t.phone}</small></div>
            <div style="display:flex; gap:10px;"><button class="btn btn-primary" onclick="openGps('${t.scooterId}')" style="width:50px"><i class="fas fa-crosshairs"></i></button>
            <button class="btn btn-danger" onclick="finishTrip('${k}')" style="width:100px">Ø¥Ù†Ù‡Ø§Ø¡</button></div>`;
        }
        document.getElementById('k-active').innerText = count;
    }

    async function finishTrip(key) {
        const t = activeTrips[key], mins = Math.floor((Date.now()-t.start)/60000);
        let cost = Math.max(config.base, Math.round(config.base + (mins-15)*config.min));
        const { value: res } = await Swal.fire({
            title: 'ØªØ­ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨', background:'#0a0a0f', color:'#fff',
            html: `<h1>${cost} Ø¬</h1><p>Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯</p><input id="disc" class="swal2-input" placeholder="Ø§Ù„Ø®ØµÙ…"><input id="resn" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨">`,
            preConfirm: () => ({ disc: document.getElementById('disc').value||0, reason: document.getElementById('resn').value||"Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨" })
        });
        if(res) {
            const final = cost - parseFloat(res.disc);
            db.ref('shifts/history').push({ ...t, cost, final, discount:res.disc, reason:res.reason, end:Date.now() });
            db.ref('shifts/current/cash').transaction(v => (v||0)+final);
            db.ref('active_trips/'+key).remove();
            db.ref('inventory/'+t.scooterId).update({ status:'available' });
        }
    }

    async function openNewTrip() {
        const { value: res } = await Swal.fire({ title:'ØªØ£Ø¬ÙŠØ± Ø¬Ø¯ÙŠØ¯', html:'<input id="ph" class="swal2-input" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„"><input id="sc" class="swal2-input" placeholder="Ø§Ù„Ø³ÙƒÙˆØªØ±">', preConfirm:()=>[document.getElementById('ph').value, document.getElementById('sc').value]});
        if(res && res[1]) { db.ref('active_trips').push({ phone:res[0], scooterId:res[1], start:Date.now() }); db.ref('inventory/'+res[1]).update({ status:'active' }); }
    }

    function searchClients(q) {
        db.ref('clients').orderByKey().startAt(q).endAt(q+"\uf8ff").once('value', s => {
            const list = document.getElementById('clients-list'); list.innerHTML = "";
            s.forEach(c => { list.innerHTML += `<div class="neon-card">${c.key} | Ø¯ÙŠÙˆÙ†: ${c.val().debt||0}</div>`; });
        });
    }

    function runAI() {
        db.ref('shifts/history').limitToLast(20).once('value', s => {
            let rev = 0, count = 0; s.forEach(c => { rev += parseFloat(c.val().final); count++; });
            document.getElementById('ai-results').innerHTML = `<div class="neon-card" style="border-color:var(--neon-green)">ğŸ¤– ØªØ­Ù„ÙŠÙ„ AI: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯Ø®Ù„ Ø¢Ø®Ø± Ø§Ù„Ø±Ø­Ù„Ø§Øª ${rev} Ø¬ Ù…Ù† ${count} Ø±Ø­Ù„Ø©. Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ø³ØªÙ‚Ø±.</div>`;
        });
    }

    function toggleShift() {
        db.ref('shifts/current').once('value', s => {
            if(s.exists()){ db.ref('shifts/history_shifts').push({...s.val(), end:Date.now()}); db.ref('shifts/current').remove(); Swal.fire('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©'); }
            else { db.ref('shifts/current').set({start:Date.now(), cash:0}); Swal.fire('ØªÙ… ÙØªØ­ ÙˆØ±Ø¯ÙŠØ©'); }
        });
    }

    async function expensePopup() {
        const { value: amt } = await Swal.fire({ title:'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ', input:'number', inputLabel:'Ø§Ù„Ù…Ø¨Ù„Øº'});
        if(amt) { const { value: reas } = await Swal.fire({ title:'Ø§Ù„Ø³Ø¨Ø¨', input:'text'}); db.ref('shifts/current/cash').transaction(v=>(v||0)-parseFloat(amt)); }
    }

    function openGps(id) {
        document.getElementById('gps-page').style.display='flex';
        if(!gMap) { gMap = L.map('full-map').setView([shopLoc.lat, shopLoc.lon], 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(gMap); gMarker = L.marker([shopLoc.lat, shopLoc.lon]).addTo(gMap); }
        db.ref('live_nodes/'+id).on('value', s => { if(s.exists()){ gMarker.setLatLng([s.val().lat, s.val().lon]); gMap.setView([s.val().lat, s.val().lon]); }});
    }
    function closeGps() { document.getElementById('gps-page').style.display='none'; }
    function nav(id) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById('sec-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); event.currentTarget.classList.add('active'); }
    function saveConfig() { db.ref('settings').set({ min: parseFloat(document.getElementById('set-min').value), base: parseFloat(document.getElementById('set-base').value) }); }
    function loadHistory() { db.ref('shifts/history').limitToLast(10).on('value', s => { const list=document.getElementById('history-list'); list.innerHTML=""; s.forEach(c=>{ const h=c.val(); list.innerHTML+=`<div class="neon-card">ğŸ›µ ${h.scooterId} | Ù…Ø¯ÙÙˆØ¹: ${h.final} Ø¬ | Ø®ØµÙ…: ${h.discount}</div>`; }); }); }
    function getDist(lat1, lon1, lat2, lon2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180; const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
</script>
</body>
</html>
