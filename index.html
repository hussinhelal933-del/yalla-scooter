<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter | ???? ??????? ??????</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb; --bg-body: #f3f4f6; --surface: #ffffff;
            --text-main: #1f2937; --success: #10b981; --border: #e5e7eb;
            --danger: #ef4444; --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; }

        /* Sidebar & Layout */
        .sidebar { width: 280px; background: #111827; color: #fff; height: 100vh; position: fixed; right: 0; top: 0; padding: 30px 20px; display: flex; flex-direction: column; z-index: 100; }
        .main-content { margin-right: 280px; width: calc(100% - 280px); padding: 30px; }
        @media(max-width: 1024px) { .sidebar { display: none; } .main-content { margin-right: 0; width: 100%; } }

        .brand { font-size: 24px; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; color: #9ca3af; font-weight: 600; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; }

        /* Forms & Cards */
        .stat-card { background: var(--surface); padding: 25px; border-radius: 16px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .trip-card { background: var(--surface); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
        .form-card { background: var(--surface); padding: 25px; border-radius: 16px; border: 1px solid var(--border); }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #f9fafb; margin-bottom: 10px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-outline { border: 1px solid var(--border); background: transparent; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; text-align: center; }
        
        /* Attendance Status Colors */
        .status-badge { padding: 4px 12px; border-radius: 20px; color: #fff; font-size: 12px; font-weight: bold; }
        .bg-green { background-color: var(--success); }
        .bg-orange { background-color: var(--warning); }
        .bg-red { background-color: var(--danger); }

        #fullAdminDashboard { position: fixed; inset: 0; background: #f3f4f6; z-index: 5000; overflow-y: auto; display: none; padding: 20px; }
        .admin-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; }
        .admin-table th, .admin-table td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        .admin-table th { background: #111827; color: #fff; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="login-screen" class="modal-overlay">
        <div class="modal-card">
            <i class="fas fa-shield-alt" style="font-size: 40px; color: var(--primary);"></i>
            <h2 style="margin: 15px 0;">???? ??????? - ?????</h2>
            <input type="password" id="pass" placeholder="??? ??????" style="text-align: center; font-size: 18px;">
            <button class="btn btn-primary" onclick="login()">???? ??????</button>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <h3>?? ????? ?????? (????? ?????)</h3>
            <p id="locStatus" style="font-size:13px; margin:15px 0; color:#666;">???? ????? ??????...</p>
            <button id="clockInBtn" class="btn btn-primary" onclick="processAttendance('????')" disabled>????? ????</button>
            <button id="clockOutBtn" class="btn btn-dark" style="margin-top:10px; background:#333; color:#fff;" onclick="processAttendance('??????')" disabled>????? ??????</button>
            <button class="btn btn-outline" style="margin-top:10px;" onclick="document.getElementById('attendanceModal').style.display='none'">?????</button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-bolt"></i> Yalla Scooter</div>
        <div class="nav-item active"><i class="fas fa-home"></i> ????????</div>
        <div class="nav-item" onclick="openAttendanceModal()" style="color:var(--success);"><i class="fas fa-map-marker-alt"></i> ???? ???????</div>
        <div class="nav-item" onclick="openAdminAuth()" style="color:var(--warning);"><i class="fas fa-user-shield"></i> ???? ???????</div>
        <div class="nav-item" onclick="location.reload()" style="margin-top:auto; color:var(--danger);"><i class="fas fa-sign-out-alt"></i> ????</div>
    </aside>

    <main class="main-content" id="appContent" style="display: none;">
        <!-- Stats Summary -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="stat-card"><div>??????? ??????<div id="stat-income" style="font-size: 24px; font-weight: 800;">0</div></div></div>
            <div class="stat-card"><div>????? ????<div id="stat-active" style="font-size: 24px; font-weight: 800;">0</div></div></div>
        </div>

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
            <div>
                <h3>??????? ???????</h3>
                <div id="activeTripsGrid" style="margin-top: 15px;"></div>
            </div>
            
            <div class="form-card">
                <h3 style="margin-bottom: 15px;">????? ?????</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">??????: <b id="staffDisplay"></b></p>
                <input type="text" id="scooterID" placeholder="??? ??????? (????? S1)">
                <input type="text" id="custName" placeholder="??? ??????">
                <input type="number" id="custPhone" placeholder="??? ??????">
                <button class="btn btn-primary" onclick="startTrip()">??? ?????? ????</button>
            </div>
        </div>
    </main>

    <!-- Admin Full Screen -->
    <div id="fullAdminDashboard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>???? ?????? (???????)</h2>
            <button class="btn btn-danger" style="width:auto;" onclick="document.getElementById('fullAdminDashboard').style.display='none'">?????</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-outline" onclick="switchAdminTab('attendance')">?? ??? ??????</button>
            <button class="btn btn-outline" onclick="switchAdminTab('trips')">?? ??????? ????????</button>
        </div>

        <div id="admin-attendance-tab">
            <table class="admin-table">
                <thead><tr><th>??????</th><th>?????</th><th>??????</th></tr></thead>
                <tbody id="attendanceTableBody"></tbody>
            </table>
        </div>
        
        <div id="admin-trips-tab" class="hidden">
            <table class="admin-table">
                <thead><tr><th>?????</th><th>?????</th><th>??????</th><th>???????</th></tr></thead>
                <tbody id="tripsTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminAuthModal" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <h3>?? ????? ???????</h3>
            <input type="password" id="adminPassInput" placeholder="??? ??????" style="text-align:center; margin-top:15px;">
            <button class="btn btn-primary" onclick="verifyAdmin()">??? ??????</button>
            <button class="btn btn-outline" style="margin-top:10px;" onclick="document.getElementById('adminAuthModal').style.display='none'">?????</button>
        </div>
    </div>

    <!-- Finish Trip Modal -->
    <div id="finishModal" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <h3>????? ??????</h3>
            <div id="finishBody"></div>
        </div>
    </div>

    <script>
        // --- ????????? ---
        const TELEGRAM_TOKEN = "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs"; 
        const ADMIN_CHAT_ID = "5684905593"; // ????? ????? ?????? ?? ??????
        
        // ???????? ????? ????? - ?????
        const TARGET_LAT = 27.185688; 
        const TARGET_LON = 31.191188;
        const ALLOWED_DIST = 0.15; // 150 ???
        const SHIFT_START = "10:00";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yalla-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.firebasestorage.app",
            messagingSenderId: "185791475252",
            appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const MY_DEVICE_ID = localStorage.getItem('dev_id') || 'dev_'+Math.random().toString(36).substr(2,9);
        localStorage.setItem('dev_id', MY_DEVICE_ID);

        // --- ????? ?????? ---
        function login() {
            const p = document.getElementById('pass').value;
            db.ref('settings').once('value', snap => {
                const settings = snap.val() || { user_pass: "1234", admin_pass: "9924" };
                if (p === settings.user_pass || p === settings.admin_pass) {
                    let name = localStorage.getItem('staff_name');
                    if (!name) {
                        name = prompt("????? ????? ???? (???? ??? ???):");
                        if (name) localStorage.setItem('staff_name', name);
                        else return;
                    }
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('staffDisplay').innerText = name;
                    initApp();
                } else { alert("????? ???"); }
            });
        }

        function initApp() {
            listenTrips();
            updateStats();
            setInterval(updateTimers, 1000);
        }

        // --- ?????? ????????? ---
        function openAttendanceModal() {
            document.getElementById('attendanceModal').style.display = 'flex';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const dist = getDistance(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LON);
                    if (dist <= ALLOWED_DIST) {
                        document.getElementById('locStatus').innerHTML = "? ??? ?? ?????? ????";
                        document.getElementById('clockInBtn').disabled = false;
                        document.getElementById('clockOutBtn').disabled = false;
                    } else {
                        document.getElementById('locStatus').innerHTML = "? ???? ?????? (???? " + (dist*1000).toFixed(0) + " ???)";
                    }
                }, () => { document.getElementById('locStatus').innerText = "?? ???? ????? ??? GPS"; });
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function processAttendance(type) {
            const now = new Date();
            const timeStr = now.getHours() + ":" + now.getMinutes().toString().padStart(2,'0');
            const dateStr = now.toISOString().split('T')[0];
            let status = "green"; 

            if (type === "????") {
                const [h, m] = SHIFT_START.split(':').map(Number);
                const diff = (now.getHours()*60+now.getMinutes()) - (h*60+m);
                if (diff > 30) status = "red"; else if (diff > 15) status = "orange";
            }

            const data = { name: localStorage.getItem('staff_name'), time: timeStr, type, status };
            db.ref('attendance/'+dateStr+'/'+MY_DEVICE_ID).set(data).then(() => {
                alert("?? ????? " + type);
                document.getElementById('attendanceModal').style.display = 'none';
                sendTelegram(`?? ${type === '????' ? '???? ????' : '?????? ????'}\n?????: ${data.name}\n?????: ${timeStr}\n??????: ${status}`);
            });
        }

        // --- ????? ??????? ---
        function startTrip() {
            const sc = document.getElementById('scooterID').value;
            const nm = document.getElementById('custName').value;
            if (!sc) return alert("???? ??? ???????");
            
            const trip = {
                scooter: sc, custName: nm || "????",
                staff: localStorage.getItem('staff_name'),
                start: Date.now(), status: "running"
            };
            db.ref('active_trips').push(trip).then(() => {
                sendTelegram(`?? ???? ?????\n?????: ${sc}\n?????: ${trip.staff}\n????: ${nm}`);
                document.getElementById('scooterID').value = "";
                document.getElementById('custName').value = "";
            });
        }

        function listenTrips() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('activeTripsGrid');
                grid.innerHTML = "";
                let count = 0;
                snap.forEach(child => {
                    count++;
                    const t = child.val();
                    grid.innerHTML += `
                        <div class="trip-card">
                            <div style="display:flex; justify-content:space-between"><b>?????: ${t.scooter}</b> <span>${t.custName}</span></div>
                            <div id="timer-${child.key}" style="font-size:24px; font-weight:bold; color:var(--primary); margin:10px 0;">00:00</div>
                            <button class="btn btn-danger" onclick="openFinish('${child.key}')">????? ??????</button>
                        </div>
                    `;
                });
                document.getElementById('stat-active').innerText = count;
            });
        }

        function updateTimers() {
            db.ref('active_trips').once('value', snap => {
                snap.forEach(child => {
                    const diff = Date.now() - child.val().start;
                    const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000);
                    const el = document.getElementById('timer-'+child.key);
                    if(el) el.innerText = `${m}:${s.toString().padStart(2,'0')}`;
                });
            });
        }

        function openFinish(key) {
            db.ref('active_trips/'+key).once('value', snap => {
                const t = snap.val();
                const mins = Math.ceil((Date.now() - t.start)/60000);
                const cost = mins * 2.5;
                document.getElementById('finishBody').innerHTML = `
                    <h2 style="font-size:32px;">${cost.toFixed(2)} ?.?</h2>
                    <p>${mins} ?????</p>
                    <div style="margin:15px 0; text-align:right;">
                        <label><input type="checkbox" id="hasIssue"> ??? / ???</label>
                        <input type="text" id="reason" placeholder="?????" style="margin-top:5px;">
                        <input type="number" id="disc" placeholder="?????? ???????">
                    </div>
                    <button class="btn btn-primary" onclick="confirmFinish('${key}', ${mins}, ${cost})">????? ??????</button>
                `;
                document.getElementById('finishModal').style.display = 'flex';
            });
        }

        function confirmFinish(key, mins, cost) {
            const isIssue = document.getElementById('hasIssue').checked;
            const reason = document.getElementById('reason').value || "????";
            const disc = parseFloat(document.getElementById('disc').value) || 0;
            const final = cost - disc;

            db.ref('active_trips/'+key).once('value', snap => {
                const t = snap.val();
                const record = { ...t, mins, final, disc, reason, isIssue, end: Date.now() };
                const today = new Date().toISOString().split('T')[0];
                
                db.ref('history/'+today).push(record);
                db.ref('active_trips/'+key).remove();
                
                document.getElementById('finishModal').style.display = 'none';
                sendTelegram(`?? ????? ????\n?????: ${t.scooter}\n????: ${final} ?.?\n???: ${mins} ?\n?????: ${t.staff}${isIssue ? '\n?? ???: '+disc : ''}`);
            });
        }

        // --- ???? ??????? ---
        function openAdminAuth() { document.getElementById('adminAuthModal').style.display = 'flex'; }
        
        function verifyAdmin() {
            const p = document.getElementById('adminPassInput').value;
            db.ref('settings/admin_pass').once('value', snap => {
                if (p === (snap.val() || "9924")) {
                    document.getElementById('adminAuthModal').style.display = 'none';
                    document.getElementById('fullAdminDashboard').style.display = 'block';
                    switchAdminTab('attendance');
                } else { alert("???"); }
            });
        }

        function switchAdminTab(tab) {
            document.getElementById('admin-attendance-tab').classList.add('hidden');
            document.getElementById('admin-trips-tab').classList.add('hidden');
            
            if (tab === 'attendance') {
                document.getElementById('admin-attendance-tab').classList.remove('hidden');
                loadAttendanceAdmin();
            } else {
                document.getElementById('admin-trips-tab').classList.remove('hidden');
                loadTripsAdmin();
            }
        }

        function loadAttendanceAdmin() {
            const today = new Date().toISOString().split('T')[0];
            db.ref('attendance/'+today).on('value', snap => {
                const tbody = document.getElementById('attendanceTableBody');
                tbody.innerHTML = "";
                snap.forEach(child => {
                    const a = child.val();
                    const color = a.status === 'red' ? 'bg-red' : (a.status === 'orange' ? 'bg-orange' : 'bg-green');
                    tbody.innerHTML += `<tr><td>${a.name}</td><td>${a.time}</td><td><span class="status-badge ${color}">${a.type}</span></td></tr>`;
                });
            });
        }

        function loadTripsAdmin() {
            const today = new Date().toISOString().split('T')[0];
            db.ref('history/'+today).on('value', snap => {
                const tbody = document.getElementById('tripsTableBody');
                tbody.innerHTML = "";
                snap.forEach(child => {
                    const t = child.val();
                    tbody.innerHTML += `<tr><td>${t.scooter}</td><td>${t.mins} ?</td><td>${t.final} ?</td><td>${t.staff}</td></tr>`;
                });
            });
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            db.ref('history/'+today).on('value', snap => {
                let total = 0;
                snap.forEach(c => total += c.val().final);
                document.getElementById('stat-income').innerText = total.toFixed(2);
            });
        }

        function sendTelegram(msg) {
            fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: msg })
            });
        }
    </script>
</body>
</html>
