<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Sovereign V60 | Tactical Core</title>
    
    <!-- Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #010409; --panel: #0d1117; --sidebar: #010409;
            --primary: #00f2ff; --accent: #7000ff; --danger: #ff004c; --warn: #ffea00;
            --text: #e6edf3; --border: #30363d; --terminal: #001a1a;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* --- Global Layout --- */
        .sidebar { width: 280px; background: var(--sidebar); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; }
        .main-stage { flex: 1; display: grid; grid-template-columns: 300px 1fr 350px; overflow: hidden; }
        
        /* Columns Style */
        .col-left { background: var(--sidebar); border-left: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .col-center { padding: 20px; overflow-y: auto; background: radial-gradient(circle at center, #0d1117, #010409); }
        .col-right { background: var(--panel); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }

        /* --- Components --- */
        .terminal { background: var(--terminal); border: 1px solid var(--primary); border-radius: 10px; padding: 10px; font-family: 'Orbitron', monospace; font-size: 10px; color: var(--primary); height: 200px; overflow-y: auto; box-shadow: inset 0 0 10px #00f2ff22; }
        .unit-card { background: #161b22; border: 1px solid var(--border); border-radius: 20px; padding: 20px; position: relative; margin-bottom: 15px; }
        .timer-xl { font-family: 'Orbitron'; font-size: 42px; text-align: center; color: #fff; margin: 10px 0; text-shadow: 0 0 15px var(--primary); }
        .id-img-frame { width: 100%; height: 120px; object-fit: cover; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; }
        
        .kpi-card { background: rgba(0, 242, 255, 0.03); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; }
        .kpi-card .val { font-family: 'Orbitron'; font-size: 20px; color: var(--primary); }

        /* Buttons */
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-close-shift { background: var(--danger); color: white; margin-top: auto; }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- 1. AUTH -->
    <div id="login-overlay">
        <div style="background:var(--panel); padding:40px; border-radius:30px; text-align:center; border:1px solid var(--primary); width:360px;">
            <h1 style="font-family:Orbitron; color:var(--primary); margin-bottom: 20px;">CORE ACCESS</h1>
            <input type="password" id="passInput" style="width:100%; padding:15px; background:#000; border:1px solid var(--border); color:var(--primary); font-size:32px; text-align:center; border-radius:15px; margin-bottom: 25px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary">AUTHORIZE</button>
        </div>
    </div>

    <!-- 2. SIDEBAR -->
    <aside class="sidebar">
        <div style="padding:25px; text-align:center; border-bottom:1px solid var(--border);">
            <h2 style="font-family:Orbitron; color:var(--primary); margin:0;">YALLA CORE</h2>
        </div>
        <div style="padding:15px; display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-primary" onclick="startTripFlow()"><i class="fas fa-qrcode"></i> ÙØªØ­ Ø³ÙƒÙˆØªØ± (QR)</button>
            <button class="btn" style="background:var(--warn);" onclick="startChargePopup()"><i class="fas fa-plug"></i> ÙˆØ¶Ø¹ ÙÙŠ Ø§Ù„Ø´Ø­Ù†</button>
            <button class="btn" style="background:var(--accent); color:white" onclick="expensePopup()"><i class="fas fa-wallet"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª</button>
        </div>
        <button class="btn btn-close-shift" onclick="closeShiftFlow()"><i class="fas fa-lock"></i> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</button>
    </aside>

    <!-- 3. MAIN STAGE -->
    <div class="main-stage">
        
        <!-- LEFT: SYSTEM LOGS & STATUS -->
        <section class="col-left">
            <div style="font-weight:900; color:var(--primary); font-size:12px;"><i class="fas fa-microchip"></i> LIVE SYSTEM LOGS</div>
            <div id="terminal" class="terminal">
                <div>[SYSTEM] Initializing core modules...</div>
                <div>[READY] Waiting for commands...</div>
            </div>
            <div class="kpi-card" style="border-color:var(--warn)">
                <small>Ø³ÙƒÙˆØªØ±Ø§Øª ØªØ­ØªØ§Ø¬ Ø´Ø­Ù†</small>
                <div class="val" id="k-low-bat" style="color:var(--warn)">0</div>
            </div>
            <div class="kpi-card" style="border-color:var(--danger)">
                <small>Ø¨Ù„Ø§ØºØ§Øª Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</small>
                <div class="val" id="k-maint" style="color:var(--danger)">0</div>
            </div>
        </section>

        <!-- CENTER: ACTIVE RADAR -->
        <section class="col-center">
            <div id="qr-box" style="display:none; width:100%; border-radius:15px; overflow:hidden; border:2px solid var(--primary); margin-bottom:20px;"></div>
            <div id="fleet-radar" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:20px;">
                <!-- Ø§Ù„Ø±Ø­Ù„Ø§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </section>

        <!-- RIGHT: FINANCIAL HUB & AI -->
        <section class="col-right">
            <div style="font-family:Orbitron; font-size:24px; text-align:center; color:var(--primary);" id="clock">00:00:00</div>
            
            <div class="kpi-card" style="background:rgba(0, 242, 255, 0.1);">
                <small>Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ÙƒØ§Ø´)</small>
                <div class="val" id="k-safe" style="font-size:32px;">0 Ø¬</div>
            </div>

            <div style="background:var(--panel); border:1px solid var(--primary); border-radius:15px; padding:15px;">
                <div style="font-weight:900; color:var(--primary); margin-bottom:10px;"><i class="fas fa-brain"></i> ØªØ­Ù„ÙŠÙ„ AI Ø§Ù„Ù„Ø­Ø¸ÙŠ</div>
                <div id="ai-response" style="font-size:12px; line-height:1.6;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ù†ÙŠØ©...</div>
            </div>

            <button class="btn" style="background:#161b22; border:1px solid var(--border); color:white;" onclick="checkAdmin()">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (9924)</button>
        </section>

    </div>

    <script>
        // --- 1. SETTINGS & AI ---
        const GEMINI_KEY = "AIzaSyAPWM-Ue8plkZqxkMn86Q0xwPWB6Cbczfw";
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        
        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();
        let tripsCache = {};

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG');
            refreshTimers();
        }, 1000);

        // --- 2. THE TACTICAL LOGIC ---
        function writeLog(msg) {
            const t = document.getElementById('terminal');
            const time = new Date().toLocaleTimeString();
            t.innerHTML += `<div>[${time}] ${msg}</div>`;
            t.scrollTop = t.scrollHeight;
        }

        async function startTripFlow() {
            const box = document.getElementById('qr-box'); box.style.display = 'block';
            const scanner = new Html5Qrcode("qr-box");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (sId) => {
                scanner.stop(); box.style.display = 'none';
                
                const { value: res } = await Swal.fire({
                    title: `ØªÙØ¹ÙŠÙ„ Ø³ÙƒÙˆØªØ± ${sId}`,
                    html: `
                        <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                        <input id="sw-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù† %">
                        <p style="color:var(--danger); font-size:11px;">Ø¥Ù„Ø²Ø§Ù…ÙŠ: ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
                        <input id="sw-img" type="file" accept="image/*" capture="environment" class="swal2-file">
                    `,
                    background: '#0d1117', color: '#fff',
                    preConfirm: () => {
                        const img = document.getElementById('sw-img').files[0];
                        if(!img) return Swal.showValidationMessage('Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©!');
                        return [document.getElementById('sw-ph').value, document.getElementById('sw-b').value, img];
                    }
                });

                if(res) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        db.ref('active_trips').push({ 
                            scooter:sId, phone:res[0], startBat:res[1], 
                            idPhoto: e.target.result, startTime:Date.now(), status:'active', pausedDuration:0 
                        });
                        writeLog(`Mission started: ${sId} for ${res[0]}`);
                        broadcastTG(`ğŸš€ <b>Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª</b>\nØ³ÙƒÙˆØªØ±: ${sId}\nØ¨Ø·Ø§Ø±ÙŠØ©: ${res[1]}%`);
                    };
                    reader.readAsDataURL(res[2]);
                }
            });
        }

        async function terminateTrip(key) {
            const d = tripsCache[key];
            const mins = Math.floor((Date.now() - d.startTime - (d.pausedDuration||0))/60000);
            let cost = Math.max(mins * 1.5, 40);

            const { value: fin } = await Swal.fire({
                title: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ØµÙŠÙ„',
                html: `<h1 style="color:var(--primary); font-size:50px;">${Math.round(cost)} Ø¬</h1><hr><input id="sw-bat" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© %"><input id="sw-d" type="number" class="swal2-input" placeholder="Ø®ØµÙ…"><input id="sw-y" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨">`,
                background: '#0d1117', color: '#fff',
                preConfirm: () => { return { b: document.getElementById('sw-bat').value, d: parseFloat(document.getElementById('sw-d').value)||0, y: document.getElementById('sw-y').value } }
            });

            if(fin) {
                const final = Math.round(cost) - fin.d;
                const today = new Date().toISOString().split('T')[0];
                db.ref(`history/${today}`).push({ scooter:d.scooter, final, mins, reason:fin.y });
                db.ref(`fleet_status/${d.scooter}`).update({ battery: fin.b });
                db.ref('active_trips/'+key).remove();
                writeLog(`Mission Terminated: ${d.scooter} | Net: ${final} EGP`);
                broadcastTG(`ğŸ <b>Ø§ÙƒØªÙ…Ø§Ù„ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ’° Ø§Ù„Ù…Ø­ØµÙ„: ${final} Ø¬\nğŸ”‹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${fin.b}%`);
                runAIAnalysis(); // ØªØ­Ø¯ÙŠØ« ØªØ­Ù„ÙŠÙ„ AI
            }
        }

        // --- 3. FINANCIAL ENGINE (THE SAFE) ---
        function initSync() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('fleet-radar'); grid.innerHTML = "";
                tripsCache = snap.val() || {};
                let count = 0;
                for(let k in tripsCache) {
                    count++; const d = tripsCache[k];
                    grid.innerHTML += `
                        <div class="unit-card">
                            <div style="display:flex; justify-content:space-between"><b>${d.scooter}</b><small>ğŸ”‹ ${d.startBat}%</small></div>
                            <img src="${d.idPhoto}" class="id-img-frame" onclick="Swal.fire({imageUrl:this.src, background:'#000'})">
                            <div class="timer-xl" id="timer-${k}">00:00:00</div>
                            <button class="btn btn-primary" onclick="terminateTrip('${k}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                        </div>`;
                }
                document.getElementById('k-active').innerText = count;
            });

            const t = new Date().toISOString().split('T')[0];
            db.ref(`history/${t}`).on('value', s => { 
                let rev = 0; s.forEach(x => rev += (x.val().final || 0));
                db.ref(`expenses/${t}`).on('value', ex => {
                    let cost = 0; ex.forEach(y => cost += (y.val().cost || 0));
                    document.getElementById('k-safe').innerText = (rev - cost) + " Ø¬";
                });
            });
        }

        async function runAIAnalysis() {
            const safe = document.getElementById('k-safe').innerText;
            const context = `Ø£Ù†Øª Ù…Ø±Ø§Ù‚Ø¨ Ù…Ø§Ù„ÙŠ Ù„Ù…Ø­Ù„ Ø³ÙƒÙˆØªØ± ÙƒÙ‡Ø±Ø¨Ø§Ø¡. Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‡Ùˆ ${safe}. Ø­Ù„Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙˆÙ‚Ø¯Ù… Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙƒØªÙŠÙƒÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø¯ÙŠØ±.`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: context }] }] })
                });
                const data = await res.json();
                document.getElementById('ai-response').innerText = data.candidates[0].content.parts[0].text;
            } catch(e) { document.getElementById('ai-response').innerText = "Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ© ØºÙŠØ± Ù‚Ø§Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹."; }
        }

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Ù…ØµØ§Ø±ÙŠÙØŒ Ø­Ø¶ÙˆØ±ØŒ Ø¥ØºÙ„Ø§Ù‚ ÙˆØ±Ø¯ÙŠØ©) ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚.
        function login() { document.getElementById('login-overlay').style.display='none'; initSync(); writeLog("User Authorized."); runAIAnalysis(); }
        function refreshTimers() {
            const now = Date.now();
            for(let k in tripsCache) {
                const d = tripsCache[k]; const el = document.getElementById(`timer-${k}`); if(!el) continue;
                const s = Math.floor((now - d.startTime - (d.pausedDuration||0)) / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }
        function broadcastTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }
    </script>
</body>
</html>
