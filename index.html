<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN V58 | Professional GPS System</title>
    
    <!-- Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@700;900&family=Cairo:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #050505; --primary: #00d2ff; --danger: #ff0055; --card: #121212; --success: #00ff9d; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 25px; }
        .login-box { width: 100%; max-width: 350px; text-align: center; }
        input { background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 15px; padding: 18px; width: 100%; text-align: center; font-size: 26px; margin-bottom: 20px; outline: none; }
        .btn-entry { background: linear-gradient(135deg, #0072ff, #00d2ff); color: #fff; padding: 16px; border: none; border-radius: 15px; width: 100%; font-weight: bold; cursor: pointer; font-size: 20px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (ØªØ¸Ù‡Ø± Ø¨Ù€ 1214) */
        #scooter-view { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #0a1a35, #000); }
        .speed-gauge { width: 280px; height: 280px; border: 10px solid var(--primary); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 60px rgba(0,210,255,0.3); position: relative; }
        .speed-val { font-family: 'Rajdhani'; font-size: 120px; font-weight: 900; line-height: 1; }
        .unit { font-size: 22px; color: var(--primary); font-weight: bold; margin-top: -10px; }
        .scooter-stats { display: flex; gap: 40px; margin-top: 50px; font-size: 22px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØ¸Ù‡Ø± Ø¨Ù€ 9924) */
        #admin-view { display: none; height: 100vh; flex-direction: column; }
        #map-container { flex: 1; position: relative; border-bottom: 2px solid #222; }
        #main-map { width: 100%; height: 100%; }
        .fleet-manager { height: 35vh; background: #080808; padding: 15px; overflow-y: auto; }
        .fleet-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .device-item { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #222; }
        .device-info b { font-size: 18px; color: var(--primary); display: block; }
        .device-info span { font-size: 13px; color: #777; }
        .btn-track { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø²ÙˆÙ† */
        .zone-alarm { background: var(--danger) !important; animation: pulse-red 0.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .active-screen { display: flex !important; }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div class="login-box">
            <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size:45px; margin-bottom:10px;">TITAN V58</h1>
            <p style="color:#555; margin-bottom:30px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆØ­Ø¯</p>
            <input type="password" id="passInput" placeholder="****">
            <button onclick="checkLogin()" class="btn-entry">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Dash) -->
    <div id="scooter-view">
        <div id="alarm-banner" style="color:var(--danger); font-weight:bold; visibility:hidden; margin-bottom:20px; font-size:20px;">âš ï¸ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­!</div>
        <div class="speed-gauge" id="gauge">
            <span class="speed-val" id="node-speed">0</span>
            <span class="unit">KM/H</span>
        </div>
        <div class="scooter-stats">
            <span><i class="fas fa-battery-full" style="color:var(--success)"></i> <span id="node-batt">--%</span></span>
            <span><i class="fas fa-satellite-dish" style="color:var(--primary)"></i> <span id="node-gps">GPS..</span></span>
        </div>
        <p style="margin-top:40px; color:#444;">ID: SCOOTER-S1 | Ø§Ù„ØªØªØ¨Ø¹ Ù†Ø´Ø· Ø¯Ø§Ø¦Ù…Ø§Ù‹</p>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (GPS Section) -->
    <div id="admin-view">
        <div id="map-container">
            <div id="main-map"></div>
            <div style="position:absolute; top:10px; left:10px; z-index:1000; background:rgba(0,0,0,0.7); padding:10px; border-radius:10px; font-size:12px;">
                Ù„ÙˆØ­Ø© Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ğŸ›°ï¸
            </div>
        </div>
        <div class="fleet-manager">
            <div class="fleet-header">
                <b>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©</b>
                <span onclick="location.reload()" style="color:var(--danger); font-size:14px;">Ø®Ø±ÙˆØ¬</span>
            </div>
            <div id="fleet-list">
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù†ÙØ³ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ) ---
    const firebaseConfig = {
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø²ÙˆÙ†
    const SAFE_POINT = { lat: 30.0444, lon: 31.2357, radius: 1000 };

    let map = null, markers = {}, currentUserId = "S1";

    function checkLogin() {
        const pass = document.getElementById('passInput').value;
        const overlay = document.getElementById('login-overlay');
        
        if (pass === "1214") {
            overlay.style.display = 'none';
            document.getElementById('scooter-view').classList.add('active-screen');
            startTracking(); // Ø§Ø¨Ø¯Ø£ ÙƒØ¬Ù‡Ø§Ø² Ù…Ø±Ø³Ù„
        } 
        else if (pass === "9924") {
            overlay.style.display = 'none';
            document.getElementById('admin-view').classList.add('active-screen');
            initAdminMap(); // Ø§Ø¨Ø¯Ø£ ÙƒÙ„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø©
        } 
        else { alert("Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­"); }
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø¬Ù‡Ø§Ø² Ø§Ù„ØªØªØ¨Ø¹ (Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙƒÙˆØªØ±) ---
    function startTracking() {
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(0) : 0;
                
                document.getElementById('node-speed').innerText = speed;
                document.getElementById('node-gps').innerText = "LIVE";

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ø²ÙˆÙ†
                const distance = L.latLng(lat, lon).distanceTo([SAFE_POINT.lat, SAFE_POINT.lon]);
                const isOut = distance > SAFE_POINT.radius;

                if(isOut) {
                    document.getElementById('gauge').classList.add('zone-alarm');
                    document.getElementById('alarm-banner').style.visibility = 'visible';
                } else {
                    document.getElementById('gauge').classList.remove('zone-alarm');
                    document.getElementById('alarm-banner').style.visibility = 'hidden';
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
                navigator.getBattery?.().then(bt => {
                    const batt = (bt.level * 100).toFixed(0);
                    document.getElementById('node-batt').innerText = batt + "%";
                    db.ref('live_nodes/' + currentUserId).update({
                        lat, lon, speed, batt, isAlarm: isOut, lastUpdate: Date.now()
                    });
                });

            }, err => { console.error(err); }, { enableHighAccuracy: true });
        }
        // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ù€ GPS Ø´ØºØ§Ù„ÙŠÙ†
        if(navigator.wakeLock) navigator.wakeLock.request('screen');
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø©) ---
    function initAdminMap() {
        if (map) return;
        map = L.map('main-map').setView([SAFE_POINT.lat, SAFE_POINT.lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
        db.ref('live_nodes').on('value', snap => {
            const listContainer = document.getElementById('fleet-list');
            listContainer.innerHTML = "";
            
            snap.forEach(child => {
                const data = child.val();
                const id = child.key;

                if (data.lat && data.lon) {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                    if (markers[id]) {
                        markers[id].setLatLng([data.lat, data.lon]);
                    } else {
                        markers[id] = L.marker([data.lat, data.lon]).addTo(map).bindPopup("Ø¬Ù‡Ø§Ø²: " + id);
                    }

                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                    const item = document.createElement('div');
                    item.className = 'device-item';
                    if(data.isAlarm) item.style.borderColor = 'red';
                    
                    item.innerHTML = `
                        <div class="device-info">
                            <b>ğŸ›µ Ø¬Ù‡Ø§Ø²: ${id} ${data.isAlarm ? 'âš ï¸' : ''}</b>
                            <span>Ø³Ø±Ø¹Ø©: ${data.speed} ÙƒÙ… | Ø¨Ø·Ø§Ø±ÙŠØ©: ${data.batt}%</span>
                        </div>
                        <button class="btn-track" onclick="zoomToDevice(${data.lat}, ${data.lon})">Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                    `;
                    listContainer.appendChild(item);
                }
            });
        });
    }

    function zoomToDevice(lat, lon) {
        map.setView([lat, lon], 18);
    }
</script>
</body>
</html>
