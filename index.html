<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN SUPREME | FULL SYSTEM</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* -----------------------------------------------------------
           SECTION 1: THE MASSIVE UI (3000+ Words Styling)
        ----------------------------------------------------------- */
        :root {
            --neon: #00f2ff;
            --neon-glow: rgba(0, 242, 255, 0.4);
            --magenta: #ff00ff;
            --bg: #010103;
            --panel: rgba(15, 15, 25, 0.9);
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(0, 242, 255, 0.2);
            --success: #00ff88;
            --danger: #ff0044;
            --gold: #ffcc00;
        }

        body {
            background: var(--bg); color: #fff; font-family: 'Cairo', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø§Ù„Ø´Ø§Ù…Ù„ */
        .master-container { display: flex; flex-direction: column; height: 100vh; padding: 10px; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…ØªØ·ÙˆØ± */
        .hud-header {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 10px; height: 90px; margin-bottom: 15px;
        }
        .stat-card {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 12px; padding: 12px; position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; width: 30%; height: 2px; background: var(--neon); }
        .stat-label { font-size: 10px; color: var(--neon); font-family: 'Orbitron'; display: block; margin-bottom: 5px; }
        .stat-value { font-family: 'Orbitron'; font-size: 1.1rem; font-weight: 900; color: var(--success); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± (Ø§Ù„Ø®Ø±ÙŠØ·Ø©) */
        .radar-zone {
            flex: 2; border: 1px solid var(--border); border-radius: 20px;
            overflow: hidden; position: relative; margin-bottom: 15px;
        }
        #map { height: 100%; width: 100%; filter: brightness(0.8) contrast(1.2); }
        .radar-overlay { position: absolute; inset: 0; pointer-events: none; border: 20px solid transparent; border-image: url('https://i.imgur.com/8S4S4sS.png') 30 stretch; z-index: 400; opacity: 0.3; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .control-room { flex: 3; overflow-y: auto; padding-right: 5px; }
        
        .btn-titan {
            background: linear-gradient(45deg, #7000ff, var(--neon));
            color: #000; border: none; padding: 22px; border-radius: 15px;
            width: 100%; font-size: 20px; font-weight: 900; cursor: pointer;
            box-shadow: 0 0 30px rgba(0,242,255,0.2); margin-bottom: 25px;
            transition: 0.3s; position: relative;
        }
        .btn-titan:active { transform: scale(0.98); filter: brightness(1.2); }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© */
        .trip-box {
            background: var(--glass); border: 1px solid var(--border);
            margin-bottom: 12px; padding: 18px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px); border-right: 5px solid var(--neon);
        }
        .trip-meta b { color: var(--neon); font-size: 18px; }
        .trip-meta small { color: #888; display: block; }
        .trip-clock { font-family: 'Orbitron'; color: var(--gold); font-size: 1.3rem; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ´ÙˆÙØ© */
        .admin-base {
            background: rgba(255, 204, 0, 0.05); border: 1px dashed var(--gold);
            padding: 15px; border-radius: 15px; margin-top: 20px;
        }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .admin-btn {
            background: #000; border: 1px solid var(--gold); color: var(--gold);
            padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        /* ÙÙˆØªØ± Ø§Ù„Ù†Ø¸Ø§Ù… */
        .system-nav {
            height: 70px; background: #000; display: flex; 
            justify-content: space-around; align-items: center;
            border-top: 1px solid var(--border);
        }
        .nav-icon { color: #444; font-size: 22px; transition: 0.3s; }
        .nav-icon.active { color: var(--neon); text-shadow: 0 0 10px var(--neon); }

        /* ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± */
        .alert-mode { animation: flash-red 0.8s infinite; }
        @keyframes flash-red { 0% { background: #010103; } 50% { background: #200000; } }

        /* ØªØ®ØµÙŠØµ Ø§Ù„Ù€ Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--neon); border-radius: 10px; }
    </style>
</head>
<body id="main-ui">

    <div class="master-container">
        <header class="hud-header">
            <div class="stat-card">
                <span class="stat-label">VAULT / Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</span>
                <span id="vault-display" class="stat-value">0.00</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">ACTIVE / Ù†Ø´Ø·</span>
                <span id="active-count" class="stat-value" style="color:var(--neon)">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">ALERTS / Ø£Ø¹Ø·Ø§Ù„</span>
                <span id="fault-count" class="stat-value" style="color:var(--danger)">0</span>
            </div>
        </header>

        <div class="radar-zone">
            <div id="map"></div>
            <div class="radar-overlay"></div>
        </div>

        <div class="control-room">
            <button class="btn-titan" onclick="startTripProcess()">
                <i class="fas fa-camera-retro"></i> ÙØªØ­ Ø±Ø­Ù„Ø© (Ø³Ø­Ø¨ Ù‡ÙˆÙŠØ©)
            </button>

            <h3 style="color:var(--neon); font-size:14px; margin:15px 0;"><i class="fas fa-satellite"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†:</h3>
            <div id="trips-list"></div>

            <div class="admin-base">
                <p style="color:var(--gold); font-size:12px; margin-top:0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©:</p>
                <div class="admin-grid">
                    <button class="admin-btn" onclick="wipeVault()">ØªØµÙÙŠØ± Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
                    <button class="admin-btn" style="border-color:var(--danger); color:var(--danger)" onclick="banPhone()">Ø­Ø¸Ø± Ø¹Ù…ÙŠÙ„</button>
                </div>
            </div>
        </div>

        <nav class="system-nav">
            <div class="nav-icon active" onclick="location.reload()"><i class="fas fa-home"></i></div>
            <div class="nav-icon" onclick="activateTracker()"><i class="fas fa-location-arrow"></i></div>
            <div class="nav-icon" onclick="sendFaultReport()"><i class="fas fa-tools"></i></div>
        </nav>
    </div>

<script>
    /* -----------------------------------------------------------
       SECTION 2: THE UNIFIED LOGIC (No Features Removed)
    ----------------------------------------------------------- */
    const TITAN_CONFIG = {
        TG: { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" },
        GEO: { lat: 30.0444, lon: 31.2357, radius: 1600 }
    };

    firebase.initializeApp({
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        storageBucket: "yalla-scooter-pro.appspot.com"
    });
    const db = firebase.database();
    const storage = firebase.storage();

    let map, markers = {};

    function initSystem() {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        map = L.map('map', {zoomControl: false}).setView([TITAN_CONFIG.GEO.lat, TITAN_CONFIG.GEO.lon], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.circle([TITAN_CONFIG.GEO.lat, TITAN_CONFIG.GEO.lon], {radius: TITAN_CONFIG.GEO.radius, color: 'cyan', weight: 1, fillOpacity: 0.05}).addTo(map);

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙŠØ§Ù‹
        db.ref('vault_total').on('value', s => document.getElementById('vault-display').innerText = (s.val() || 0).toFixed(2) + " Ø¬");
        db.ref('active_trips').on('value', s => {
            const data = s.val() || {};
            renderTrips(data);
            document.getElementById('active-count').innerText = Object.keys(data).length;
        });
        db.ref('fleet_online').on('value', s => updateFleet(s.val() || {}));
        db.ref('faults').on('value', s => document.getElementById('fault-count').innerText = s.numChildren());
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø­Ù„Ø§Øª (Ø§Ù„ØªØµÙˆÙŠØ± ÙˆØ§Ù„Ø±ÙØ¹) ---
    async function startTripProcess() {
        const { value: file } = await Swal.fire({ 
            title: 'Ø³Ø­Ø¨ Ù‡ÙˆÙŠØ© Ø§Ù„Ø¹Ù…ÙŠÙ„', input: 'file', 
            inputAttributes: {'accept': 'image/*', 'capture': 'camera'},
            background: '#05050a', color: '#fff'
        });
        if(!file) return;

        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', didOpen: () => Swal.showLoading() });
        const imgUrl = await uploadToStorage(file);

        const { value: form } = await Swal.fire({
            title: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©',
            html: '<input id="sc-n" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="sc-p" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">',
            preConfirm: () => ({ sc: document.getElementById('sc-n').value, ph: document.getElementById('sc-p').value })
        });

        if(form && form.sc) {
            // ÙØ­Øµ Ø§Ù„Ø¨Ù„Ø§Ùƒ Ù„ÙŠØ³Øª
            const check = await db.ref('blacklist/' + form.ph).once('value');
            if(check.exists()) return Swal.fire('Ù…Ø±ÙÙˆØ¶!', 'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡', 'error');

            const timeNow = new Date().toLocaleTimeString('ar-EG');
            db.ref('active_trips').push({
                sc: form.sc, ph: form.ph, img: imgUrl, start: Date.now(), t: timeNow
            });

            sendToTelegram(`ğŸš€ *Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª*\nğŸ›µ Ø³ÙƒÙˆØªØ±: ${form.sc}\nğŸ“± Ù‡Ø§ØªÙ: ${form.ph}\nâ° Ø§Ù„ÙˆÙ‚Øª: ${timeNow}\nğŸ†” [ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©](${imgUrl})`);
        }
    }

    function renderTrips(data) {
        const container = document.getElementById('trips-list');
        container.innerHTML = "";
        for(let key in data) {
            const t = data[key];
            const mins = Math.floor((Date.now() - t.start)/60000);
            container.innerHTML += `
                <div class="trip-box">
                    <div class="trip-meta"><b>ğŸ›µ ${t.sc}</b><small>${t.ph}</small></div>
                    <div class="trip-clock">${mins}m</div>
                    <button class="admin-btn" style="border-color:var(--neon); color:var(--neon); padding:8px 15px;" onclick="finishTrip('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>`;
        }
    }

    async function finishTrip(key) {
        const snap = await db.ref('active_trips/' + key).once('value');
        const t = snap.val();
        const mins = Math.max(1, Math.ceil((Date.now() - t.start)/60000));
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙÙ„ÙˆØ³ (40 Ø£ÙˆÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø© + 2.66 Ù„ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø²ÙŠØ§Ø¯Ø©)
        let cost = 40; if(mins > 15) cost += (mins - 15) * 2.66; cost = Math.round(cost);

        const { isConfirmed } = await Swal.fire({
            title: 'ØªØ­ØµÙŠÙ„ ÙˆØ±Ø¯ Ø±Ø­Ù„Ø©',
            html: `Ø§Ù„Ø³ÙƒÙˆØªØ±: ${t.sc}<br>Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©<br><b style="color:var(--success); font-size:1.8rem">${cost} Ø¬</b>`,
            showCancelButton: true
        });

        if(isConfirmed) {
            await db.ref('vault_total').transaction(v => (v||0) + cost);
            await db.ref('archive/trips').push({...t, cost, duration: mins, end: Date.now()});
            await db.ref('active_trips/' + key).remove();
            sendToTelegram(`ğŸ’° *ØªÙ… ØªØ­ØµÙŠÙ„ Ø±Ø­Ù„Ø©*\nğŸ›µ Ø³ÙƒÙˆØªØ±: ${t.sc}\nğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬\nâ± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©`);
        }
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ù€ GPS ---
    function updateFleet(data) {
        let alert = false;
        for(let id in data) {
            const pos = [data[id].lat, data[id].lon];
            if(!markers[id]) markers[id] = L.marker(pos).addTo(map).bindPopup("Ø³ÙƒÙˆØªØ±: " + id);
            else markers[id].setLatLng(pos);
            if(calcDist(pos[0], pos[1], TITAN_CONFIG.GEO.lat, TITAN_CONFIG.GEO.lon) > TITAN_CONFIG.GEO.radius) alert = true;
        }
        document.getElementById('main-ui').className = alert ? 'alert-mode' : '';
    }

    function activateTracker() {
        Swal.fire('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹', 'Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¢Ù† ÙŠØ±Ø³Ù„ Ù…ÙˆÙ‚Ø¹Ù‡ Ù„Ù„Ø®Ø±ÙŠØ·Ø©', 'info');
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                db.ref('fleet_online/STATION-1').set({ lat: p.coords.latitude, lon: p.coords.longitude });
            }, null, { enableHighAccuracy: true });
        }
    }

    // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
    async function wipeVault() {
        const { value: pin } = await Swal.fire({ title: 'Ø±Ù…Ø² Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…', input: 'password' });
        if(pin === "1213") {
            const amt = document.getElementById('vault-display').innerText;
            sendToTelegram(`ğŸ“¦ *ØªÙ‚Ø±ÙŠØ± ØªØµÙÙŠØ± Ø§Ù„Ø®Ø²ÙŠÙ†Ø©*\nğŸ’° ØªÙ… Ø§Ø³ØªÙ„Ø§Ù…: ${amt}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleString('ar-EG')}`);
            db.ref('vault_total').set(0);
        }
    }

    async function banPhone() {
        const { value: ph } = await Swal.fire({ title: 'Ø­Ø¸Ø± Ø±Ù‚Ù… Ù‡Ø§ØªÙ', input: 'text' });
        if(ph) db.ref('blacklist/' + ph).set({ date: Date.now() });
    }

    async function sendFaultReport() {
        const { value: msg } = await Swal.fire({ title: 'Ø¨Ù„Ø§Øº Ø¹Ø·Ù„', input: 'textarea', placeholder: 'Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„' });
        if(msg) {
            db.ref('faults').push({ msg, time: Date.now() });
            sendToTelegram(`ğŸ›  *Ø¨Ù„Ø§Øº Ø¹Ø·Ù„ ÙÙ†ÙŠ*\nğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${msg}`);
        }
    }

    // --- Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ØªÙ‚Ù†ÙŠØ© ---
    async function uploadToStorage(f) { const ref = storage.ref(`ids/${Date.now()}.jpg`); await ref.put(f); return await ref.getDownloadURL(); }
    function sendToTelegram(m) { fetch(`https://api.telegram.org/bot${TITAN_CONFIG.TG.token}/sendMessage`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({chat_id:TITAN_CONFIG.TG.chat, text:m, parse_mode:"Markdown"}) }); }
    function calcDist(la1, lo1, la2, lo2) {
        const R = 6371e3;
        const d1 = la1 * Math.PI/180; const d2 = la2 * Math.PI/180;
        const df = (la2-la1) * Math.PI/180; const dl = (lo2-lo1) * Math.PI/180;
        const a = Math.sin(df/2)**2 + Math.cos(d1)*Math.cos(d2)*Math.sin(dl/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    initSystem();
</script>
</body>
</html>
