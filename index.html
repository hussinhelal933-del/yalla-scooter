<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Command Center | Tactical V19</title>
    
    <!-- Scripts & Icons -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #020617; --panel: #0f172a; --sidebar: #020617;
            --primary: #2dd4bf; --accent: #3b82f6; --danger: #f43f5e; --warn: #fbbf24;
            --text: #f8fafc; --border: #1e293b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Nav */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; }
        .brand { padding: 25px; text-align: center; border-bottom: 1px solid var(--border); color: var(--primary); font-family: 'Orbitron'; font-size: 18px; font-weight: 900; letter-spacing: 2px; }
        .nav-item { padding: 18px 25px; cursor: pointer; color: #64748b; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        .nav-item:hover, .nav-item.active { background: #0f172a; color: var(--primary); border-right: 4px solid var(--primary); }

        /* Main Viewport */
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; background: radial-gradient(circle at 10% 10%, #0f172a, transparent); }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section { display: none; flex: 1; overflow-y: auto; padding-bottom: 50px; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }

        /* KPIs */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .kpi-card { background: var(--panel); padding: 12px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .kpi-val { font-family: 'Orbitron'; font-size: 20px; color: var(--primary); display: block; }

        /* Trip & Charging Cards */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .tactical-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 20px; position: relative; }
        .tactical-card.charging { border-color: var(--warn); box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        .timer-val { font-family: 'Orbitron'; font-size: 32px; text-align: center; color: #fff; margin: 10px 0; }
        
        /* Buttons */
        .btn { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-danger { background: var(--danger); color: white; flex: 1; }
        .btn-warn { background: var(--warn); color: #000; flex: 1; }
        .btn-accent { background: var(--accent); color: white; flex: 1; }

        #login-overlay { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media(max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 65px; flex-direction: row; border-top: 1px solid var(--border); border-left: none; }
            .brand { display: none; }
            .nav-item { flex-direction: column; font-size: 10px; flex: 1; padding: 10px; }
            .main-content { padding-bottom: 80px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- 1. AUTH -->
    <div id="login-overlay">
        <div style="background:var(--panel); padding:40px; border-radius:24px; text-align:center; width:340px; border:1px solid var(--border);">
            <h1 style="font-family:Orbitron; color:var(--primary)">SECURE ACCESS</h1>
            <input type="password" id="passInput" style="width:100%; padding:15px; background:#000; border:1px solid var(--border); color:var(--primary); font-size:28px; text-align:center; border-radius:12px; margin-bottom: 20px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- 2. SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">YALLA COMMAND</div>
        <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-satellite-dish"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
        <div class="nav-item" onclick="nav('charge')"><i class="fas fa-bolt"></i> Ø±ØµÙŠÙ Ø§Ù„Ø´Ø­Ù†</div>
        <div class="nav-item" onclick="nav('maint')"><i class="fas fa-tools"></i> Ø§Ù„ØµÙŠØ§Ù†Ø© & Ø§Ù„Ø­Ø¶ÙˆØ±</div>
        <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-user-shield"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger)" onclick="location.reload()"><i class="fas fa-power-off"></i></div>
    </nav>

    <!-- 3. MAIN CONTENT -->
    <main class="main-content">
        <div class="top-header">
            <h2 id="p-title" style="margin:0; font-weight:900;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</h2>
            <div id="live-clock" style="font-family:Orbitron; color:var(--primary); font-size:18px;">00:00:00</div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-val" id="k-active">0</span><small>Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-rev">0</span><small>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</small></div>
            <div class="kpi-card"><span class="kpi-val" style="color:var(--warn)" id="k-charging">0</span><small>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†</small></div>
            <div class="kpi-card"><span class="kpi-val" style="color:var(--danger)" id="k-trips">0</span><small>Ù…Ù‡Ù…Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</small></div>
        </div>

        <!-- Section: Trips -->
        <div id="sec-ops" class="section active">
            <button class="btn btn-primary" onclick="newTripPopup()" style="width:100%; margin-bottom:20px; font-size:16px;">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø±Ø³Ù…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <div id="active-trips-grid" class="grid-layout"></div>
        </div>

        <!-- Section: Charging Dock -->
        <div id="sec-charge" class="section">
            <button class="btn btn-warn" onclick="startChargePopup()" style="width:100%; margin-bottom:20px; font-size:16px;">+ ØªÙˆØµÙŠÙ„ Ø³ÙƒÙˆØªØ± Ø¨Ø§Ù„Ø´Ø§Ø­Ù†</button>
            <div id="charging-grid" class="grid-layout"></div>
        </div>

        <!-- Section: Attendance & Maint -->
        <div id="sec-maint" class="section">
            <div style="background:var(--panel); padding:20px; border-radius:15px; text-align:center; border:1px solid var(--accent); margin-bottom:20px;">
                <p>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (GPS)</p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-primary" style="width:120px" onclick="attendance('IN')">Ø­Ø¶ÙˆØ±</button>
                    <button class="btn btn-danger" style="width:120px" onclick="attendance('OUT')">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
            <button class="btn btn-warn" style="width:100%; margin-bottom:20px;" onclick="maintPopup()">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ Ù…ÙØ§Ø¬Ø¦</button>
            <table style="width:100%; background:var(--panel); border-radius:10px; font-size:12px;" cellpadding="10">
                <thead><tr style="color:var(--warn)"><th>Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="maint-list"></tbody>
            </table>
        </div>

        <!-- Section: Admin -->
        <div id="sec-admin" class="section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <input type="date" id="historyDate" onchange="loadHistory(this.value)" style="padding:10px; background:#000; color:white; border:1px solid var(--primary); border-radius:10px;">
                <div id="adm-total" style="color:var(--primary); font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¬</div>
            </div>
            <table style="width:100%; background:var(--panel); border-radius:10px; font-size:12px;" cellpadding="10">
                <thead><tr style="color:var(--primary)"><th>Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„ØµØ§ÙÙŠ</th></tr></thead>
                <tbody id="hist-list"></tbody>
            </table>
        </div>

    </main>

    <script>
        // --- Config ---
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 };
        const MIN_PRICE = 40; 

        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();
        let activeTrips = {};
        let activeCharging = {};

        setInterval(() => {
            document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG');
            refreshTimers();
        }, 1000);

        // --- Auth & Nav ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                if(p === "9924") document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                initSync();
            } else { Swal.fire('Error', 'Wrong Authorization Code', 'error'); }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'admin') { const t = new Date().toISOString().split('T')[0]; document.getElementById('historyDate').value = t; loadHistory(t); }
            if(id === 'maint') loadMaint();
        }

        // --- Core Sync ---
        function initSync() {
            // Trips
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('active-trips-grid'); grid.innerHTML = "";
                activeTrips = snap.val() || {};
                let count = 0;
                for(let key in activeTrips) {
                    count++; const d = activeTrips[key]; const isPaused = d.status === 'paused';
                    grid.innerHTML += `
                        <div class="tactical-card ${isPaused ? 'paused' : ''}">
                            <div style="display:flex; justify-content:space-between"><b>${d.scooter}</b><small>âš¡ ${d.startBat}%</small></div>
                            <div class="timer-val" id="timer-${key}">00:00:00</div>
                            <div style="display:flex; gap:10px;">
                                ${!isPaused ? `<button class="btn btn-warn" onclick="controlTrip('${key}', 'pause')">ÙˆÙ‚Ù</button>` : `<button class="btn btn-primary" onclick="controlTrip('${key}', 'resume')">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`}
                                <button class="btn btn-danger" onclick="endTripPopup('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('k-active').innerText = count;
            });

            // Charging
            db.ref('active_charging').on('value', snap => {
                const grid = document.getElementById('charging-grid'); grid.innerHTML = "";
                activeCharging = snap.val() || {};
                let count = 0;
                for(let key in activeCharging) {
                    count++; const d = activeCharging[key];
                    grid.innerHTML += `
                        <div class="tactical-card charging">
                            <div style="display:flex; justify-content:space-between"><b>${d.scooter}</b><small><i class="fas fa-plug"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†</small></div>
                            <div class="timer-val" style="color:var(--warn)" id="charge-${key}">00:00:00</div>
                            <button class="btn btn-primary" onclick="stopChargePopup('${key}')">ÙØµÙ„ Ø§Ù„Ø´Ø§Ø­Ù†</button>
                        </div>
                    `;
                }
                document.getElementById('k-charging').innerText = count;
            });

            const t = new Date().toISOString().split('T')[0];
            db.ref(`history/${t}`).on('value', snap => {
                let r = 0, c = 0; snap.forEach(x => { r += (x.val().final || 0); c++; });
                document.getElementById('k-rev').innerText = r; document.getElementById('k-trips').innerText = c;
            });
        }

        function refreshTimers() {
            const now = Date.now();
            // Trips
            for(let k in activeTrips) {
                const d = activeTrips[k]; const el = document.getElementById(`timer-${k}`); if(!el) continue;
                let diff = (d.status === 'active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
                const s = Math.floor(diff / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
            // Charging
            for(let k in activeCharging) {
                const d = activeCharging[k]; const el = document.getElementById(`charge-${k}`); if(!el) continue;
                const s = Math.floor((now - d.startTime) / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }

        // --- Logic Functions ---
        async function newTripPopup() {
            const { value: res } = await Swal.fire({
                title: 'Ø¨Ø¯Ø¡ Ù…Ù‡Ù…Ø© ØªÙƒØªÙŠÙƒÙŠØ©',
                html: '<input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="sw-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© %"><input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">',
                background: '#0f172a', color: '#fff',
                preConfirm: () => [document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-b').value, document.getElementById('sw-n').value]
            });
            if(res && res[0]) {
                const [s, b, n] = res;
                // ÙØ­Øµ ÙØ¬ÙˆØ© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
                const lastLog = await db.ref(`scoot_status/${s}`).once('value');
                const lastBat = lastLog.val()?.battery || 100;
                if(lastBat - b > 5) sendTG(`ğŸš¨ <b>ÙØ¬ÙˆØ© Ø¨Ø·Ø§Ø±ÙŠØ©!</b>\nØ³ÙƒÙˆØªØ± ${s} Ù†Ù‚Øµ ${lastBat - b}% Ø¨Ø¯ÙˆÙ† Ø±Ø­Ù„Ø©!`);
                
                db.ref('active_trips').push({ scooter:s, startBat:b, client:n||'Ø²Ø§Ø¦Ø±', startTime:Date.now(), status:'active', pausedDuration:0 });
                sendTG(`ğŸ›µ âš¡ <b>Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª</b>\nØ³ÙƒÙˆØªØ±: ${s}\nØ¨Ø·Ø§Ø±ÙŠØ©: ${b}%\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${n}`);
            }
        }

        async function endTripPopup(key) {
            const d = activeTrips[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            let cost = Math.round(mins > 15 ? 40 + (mins - 15) * 2.66 : 40);

            const { value: fin } = await Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨',
                html: `<h1 style="color:var(--primary); margin:0;">${cost} Ø¬.Ù…</h1><small>Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</small><hr><input id="sw-bat" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© %"><input id="sw-disc" type="number" class="swal2-input" placeholder="Ø®ØµÙ…"><input id="sw-why" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨">`,
                background: '#0f172a', color: '#fff',
                preConfirm: () => { return { bat: document.getElementById('sw-bat').value, disc: parseFloat(document.getElementById('sw-disc').value)||0, reason: document.getElementById('sw-why').value } }
            });

            if(fin) {
                const final = cost - fin.disc;
                const today = new Date().toISOString().split('T')[0];
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, mins, cost, disc:fin.disc, final, reason:fin.reason });
                db.ref(`scoot_status/${d.scooter}`).update({ battery: fin.bat });
                db.ref('active_trips/'+key).remove();
                sendTG(`ğŸ <b>Ø§ÙƒØªÙ…Ø§Ù„ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ•’ ${mins}m\nğŸ”‹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fin.bat}%\nğŸ’° Ø§Ù„Ù…Ø­ØµÙ„: ${final} Ø¬`);
            }
        }

        // --- Charging Logic ---
        async function startChargePopup() {
            const { value: res } = await Swal.fire({
                title: 'ØªÙˆØµÙŠÙ„ Ø§Ù„Ø´Ø§Ø­Ù†',
                html: '<input id="c-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="c-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© %">',
                background: '#0f172a', color: '#fff',
                preConfirm: () => [document.getElementById('c-s').value.toUpperCase(), document.getElementById('c-b').value]
            });
            if(res && res[0]) {
                db.ref('active_charging').push({ scooter: res[0], startBat: res[1], startTime: Date.now() });
                sendTG(`ğŸ”Œ <b>Ø¨Ø¯Ø¡ Ø´Ø­Ù†</b>\nØ³ÙƒÙˆØªØ±: ${res[0]}\nØ¨Ø·Ø§Ø±ÙŠØ©: ${res[1]}%`);
            }
        }

        async function stopChargePopup(key) {
            const d = activeCharging[key];
            const durationMins = Math.floor((Date.now() - d.startTime) / 60000);
            const { value: endBat } = await Swal.fire({
                title: 'ÙØµÙ„ Ø§Ù„Ø´Ø§Ø­Ù†',
                html: `<p>Ø§Ù„Ø³ÙƒÙˆØªØ±: ${d.scooter}</p><input id="c-e" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø­Ù† %">`,
                background: '#0f172a', color: '#fff',
                preConfirm: () => document.getElementById('c-e').value
            });
            if(endBat) {
                const gain = endBat - d.startBat;
                // ÙØ­Øµ ØªÙ„Ø§Ø¹Ø¨: Ø§Ù„Ø´Ø­Ù† Ø£Ø¨Ø·Ø£ Ù…Ù† 1% ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                if(gain > durationMins) sendTG(`âš ï¸ <b>ØªÙ„Ø§Ø¹Ø¨ Ø´Ø­Ù†!</b>\nØ§Ù„Ø³ÙƒÙˆØªØ± ${d.scooter} Ø²Ø§Ø¯ ${gain}% ÙÙŠ ${durationMins} Ø¯Ù‚ÙŠÙ‚Ø© (ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠ!)`);
                
                db.ref(`scoot_status/${d.scooter}`).update({ battery: endBat });
                db.ref('active_charging/'+key).remove();
                sendTG(`âœ… <b>ØªÙ… Ø§Ù„Ø´Ø­Ù†</b>\nØ³ÙƒÙˆØªØ±: ${d.scooter}\nØ§Ù„Ø²ÙŠØ§Ø¯Ø©: ${gain}%\nØ§Ù„ÙˆÙ‚Øª: ${durationMins}m`);
            }
        }

        // --- Utils ---
        function controlTrip(k, a) {
            if(a==='pause') db.ref(`active_trips/${k}`).update({ status:'paused', pauseStart:Date.now() });
            else db.ref(`active_trips/${k}`).once('value', s => { const d = s.val(); db.ref(`active_trips/${k}`).update({ status:'active', pausedDuration: (d.pausedDuration||0)+(Date.now()-d.pauseStart) }); });
        }
        function sendTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }
        function loadHistory(d) {
            db.ref(`history/${d}`).on('value', snap => {
                const tb = document.getElementById('hist-list'); tb.innerHTML = ""; let t = 0;
                snap.forEach(c => { const v = c.val(); t += (v.final||0); tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.client}</td><td>${v.mins}m</td><td>${v.cost}</td><td>${v.disc}</td><td>${v.final}</td></tr>`; });
                document.getElementById('adm-total').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t} Ø¬`;
            });
        }
        function attendance(type) {
            navigator.geolocation.getCurrentPosition(pos => {
                const d = getDist(pos.coords.latitude, pos.coords.longitude, SHOP_LOC.lat, SHOP_LOC.lng);
                if(d > 200) return Swal.fire('Error', 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                sendTG(`ğŸ“ <b>${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'}</b>\nğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ar-EG')}`);
                Swal.fire('ØªÙ…', '', 'success');
            });
        }
        function getDist(la1, lo1, la2, lo2) {
            const R = 6371e3; const dl = (la2-la1)*Math.PI/180, do1 = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dl/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(do1/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
