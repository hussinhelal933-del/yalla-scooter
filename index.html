<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Unified Command V80</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --card: #0a0a0a; --primary: #00d2ff; --danger: #ff0055; --success: #00ff9d; --gold: #ffcc00; --border: rgba(0, 210, 255, 0.1); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin:0; padding:0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Header & Sidebar */
        .app-header { height: 60px; background: #050505; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .sidebar { position: fixed; top: 0; right: -100%; width: 280px; height: 100%; background: #050505; z-index: 3000; transition: 0.4s; border-left: 1px solid #222; padding: 20px; }
        .sidebar.active { right: 0; }
        .nav-item { padding: 14px; color: #888; cursor: pointer; display: flex; align-items: center; gap: 10px; border-radius: 10px; }
        .nav-item.active { background: rgba(0,210,255,0.1); color: var(--primary); }

        /* Main Content */
        .app-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .trip-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; border-right: 4px solid var(--primary); position: relative; }
        .unit-timer { font-family: 'Rajdhani'; font-size: 35px; text-align: center; color: var(--primary); font-weight: 900; margin: 10px 0; }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 15px; text-align: center; }
        .kpi-val { font-family: 'Rajdhani'; font-size: 22px; font-weight: 700; color: var(--primary); }

        .btn { padding: 12px; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid var(--danger); }

        /* Scooter Display */
        .scooter-node { text-align: center; padding-top: 50px; }
        .speed { font-family: 'Rajdhani'; font-size: 120px; color: var(--primary); line-height: 1; }
        
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        input { width: 85%; background: #0a0a0a; border: 1px solid #333; color: #fff; padding: 18px; border-radius: 15px; text-align: center; font-size: 24px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ -->
    <div id="login-overlay">
        <h1 style="font-family:'Rajdhani'; color:var(--primary); font-size: 35px; margin-bottom:10px;">YALLA COMMAND</h1>
        <p style="color:#444; font-size:10px; letter-spacing:3px; margin-bottom:20px;">SECURITY PROTOCOL V80</p>
        <input type="password" id="passInput" placeholder="ENTER PIN">
        <button onclick="App.login()" class="btn btn-primary" style="width:85%">ACCESS SYSTEM</button>
    </div>

    <!-- Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <header id="app-header" class="app-header hidden">
        <div style="font-family:'Rajdhani'; font-weight:900; color:var(--primary);" id="role-label">YALLA COMMAND</div>
        <div id="clock" style="font-family:'Rajdhani'; color:#666;">00:00:00</div>
        <div onclick="App.toggleSidebar()" style="color:var(--primary); font-size:20px;"><i class="fas fa-bars"></i></div>
    </header>

    <!-- Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ -->
    <nav id="sidebar" class="sidebar">
        <div class="nav-item active" id="nav-ops" onclick="App.nav('ops')"><i class="fas fa-play"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
        <div class="nav-item" id="nav-fleet" onclick="App.nav('fleet')"><i class="fas fa-shield-alt"></i> Ø§Ù„ØªØ­ÙƒÙ…</div>
        <div class="nav-item" id="nav-history" onclick="App.nav('history')"><i class="fas fa-database"></i> Ø§Ù„Ø³Ø¬Ù„</div>
        <button onclick="location.reload()" class="btn btn-danger" style="margin-top:auto;">Ø®Ø±ÙˆØ¬</button>
    </nav>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main id="main-screen" class="app-content hidden">
        
        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØ¸Ù‡Ø± Ù„Ù€ 9924 ÙÙ‚Ø·) -->
        <div id="admin-stats" class="kpi-grid hidden">
            <div class="kpi-card"><small>Ø§Ù„Ø¯Ø±Ø¬</small><br><span id="cash-vault" class="kpi-val">0</span></div>
            <div class="kpi-card"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</small><br><span id="total-day" class="kpi-val">0</span></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
        <div id="sec-ops" class="section active">
            <div style="background:#0a0a0a; padding:15px; border-radius:15px; border:1px solid #222; margin-bottom:20px;">
                <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="font-size:16px; padding:12px; width:100%;">
                <input type="text" id="scoot-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±" style="font-size:16px; padding:12px; width:100%;">
                <button class="btn btn-primary" onclick="App.startTrip()">ğŸš€ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø©</button>
            </div>
            <div id="active-trips"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© -->
        <div id="sec-fleet" class="section hidden">
            <h3 style="color:var(--primary); margin-bottom:15px;">ğŸ¤– ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h3>
            <div id="remote-control-list"></div>
        </div>

        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (ØªØ¸Ù‡Ø± Ù„Ù€ 1214 ÙˆØ§Ù„Ù€ 2000 ÙƒÙˆØ¯) -->
        <div id="sec-node" class="section scooter-node hidden">
            <div class="speed" id="speed-val">00</div>
            <div style="color:var(--primary); font-family:'Rajdhani'; letter-spacing:5px;">KM/H</div>
            <h2 id="scooter-name" style="margin-top:30px; font-weight:900; color:#fff;">---</h2>
            <div id="battery-val" style="color:#555; margin-top:10px;">ğŸ”‹ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø·Ø§Ù‚Ø©...</div>
        </div>

    </main>

<script>
    const App = {
        db: null,
        role: '', // admin, staff, scooter
        scooterID: '',

        init: function() {
            firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
            this.db = firebase.database();
            this.sync();
            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); }, 1000);
        },

        login: function() {
            const pin = document.getElementById('passInput').value;
            const overlay = document.getElementById('login-overlay');
            const main = document.getElementById('main-screen');
            const header = document.getElementById('app-header');

            if(pin === "9924") { // Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                this.role = 'admin';
                document.getElementById('admin-stats').classList.remove('hidden');
                document.getElementById('role-label').innerText = "ADMIN PANEL";
            } 
            else if(pin === "1213") { // Ø§Ù„Ù…ÙˆØ¸Ù
                this.role = 'staff';
                document.getElementById('role-label').innerText = "STAFF MODE";
            } 
            else if(pin === "1214" || (parseInt(pin) >= 3000 && parseInt(pin) <= 5000)) { // Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª
                this.role = 'scooter';
                this.scooterID = "SCOOT-" + pin;
                this.nav('node');
                document.getElementById('scooter-name').innerText = this.scooterID;
                this.startScooterMode();
            } else {
                return Swal.fire('Error', 'Invalid PIN', 'error');
            }

            overlay.classList.add('hidden');
            main.classList.remove('hidden');
            header.classList.remove('hidden');
            this.init();
        },

        nav: function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(this.role !== 'scooter') this.toggleSidebar();
        },

        toggleSidebar: () => document.getElementById('sidebar').classList.toggle('active'),

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø§Ù„Ø¹Ø¯Ø§Ø¯) ---
        startScooterMode: async function() {
            const ref = this.db.ref('fleet_live/' + this.scooterID);
            navigator.geolocation.watchPosition(pos => {
                const spd = Math.round((pos.coords.speed || 0) * 3.6);
                document.getElementById('speed-val').innerText = spd.toString().padStart(2, '0');
                ref.update({ speed: spd, lastSeen: Date.now() });
            }, null, {enableHighAccuracy: true});
        },

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---
        startTrip: function() {
            const name = document.getElementById('cust-name').value;
            const scoot = document.getElementById('scoot-id').value;
            if(!name || !scoot) return;

            this.db.ref('active_trips').push({
                customer: name, scooter: scoot, start: Date.now()
            });
            document.getElementById('cust-name').value = "";
            document.getElementById('scoot-id').value = "";
        },

        finishTrip: function(id, start, scoot) {
            const mins = Math.max(0, Math.floor((Date.now() - start) / 60000)) || 0;
            const cost = mins * 2; // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ (2 Ø¬Ù†ÙŠÙ‡ Ù„Ù„Ø¯Ù‚ÙŠÙ‚Ø©)

            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø§Ù„Ø³ÙƒÙˆØªØ±: ${scoot} <br> Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬.Ù…</b>`,
                showCancelButton: true,
                confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ ÙˆÙ‚Ø¨Ø¶'
            }).then(r => {
                if(r.isConfirmed) {
                    this.db.ref('history').push({ scoot, cost, mins, date: Date.now() });
                    this.db.ref('vault').transaction(v => (v || 0) + cost);
                    this.db.ref('active_trips/' + id).remove();
                }
            });
        },

        sync: function() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª
            this.db.ref('active_trips').on('value', snap => {
                const data = snap.val() || {};
                const list = document.getElementById('active-trips');
                const fleet = document.getElementById('remote-control-list');
                list.innerHTML = ""; fleet.innerHTML = "";
                let count = 0;

                for(let id in data) {
                    count++;
                    const t = data[id];
                    const m = Math.floor((Date.now() - t.start) / 60000) || 0;
                    
                    list.innerHTML += `
                        <div class="trip-card">
                            <b>ğŸ›µ ${t.scooter}</b> | Ø§Ù„Ø¹Ù…ÙŠÙ„: ${t.customer}
                            <div class="unit-timer">${m} MIN</div>
                            <button class="btn btn-primary" onclick="App.finishTrip('${id}', ${t.start}, '${t.scooter}')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                        </div>`;
                    
                    fleet.innerHTML += `
                        <div class="trip-card" style="border-right-color:var(--gold)">
                            <b>ØªØ­ÙƒÙ… Ø¹Ù† Ø¨ÙØ¹Ø¯: ${t.scooter}</b>
                            <div class="grid" style="margin-top:10px;">
                                <button class="btn btn-primary" onclick="App.db.ref('commands/${t.scooter}').set({act:'UNLOCK', t:Date.now()})">ÙØªØ­</button>
                                <button class="btn btn-danger" onclick="App.db.ref('commands/${t.scooter}').set({act:'LOCK', t:Date.now()})">Ù‚ÙÙ„</button>
                            </div>
                        </div>`;
                }
                document.getElementById('active-count').innerText = count;
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¯Ø±Ø¬ (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
            if(this.role === 'admin') {
                this.db.ref('vault').on('value', s => {
                    document.getElementById('cash-vault').innerText = (s.val() || 0).toFixed(2);
                });
            }
        }
    };
</script>
</body>
</html>
