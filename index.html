<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter Ultimate v19 | Live Presence</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --p: #00d2ff; --s: #3a7bd5; --d: #060912;
            --ok: #00f2fe; --err: #ff4b2b; --wait: #f9d423;
            --glass: rgba(255, 255, 255, 0.05);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; }
        body { background: var(--d); color: #fff; min-height: 100vh; background-image: radial-gradient(circle at 50% 0%, #1a2a44 0%, #060912 85%); overflow-x: hidden; }
        .container { max-width: 1600px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }

        /* Admin Hub */
        .admin-hub { background: var(--glass); border: 2px solid var(--wait); border-radius: 25px; padding: 25px; margin-top: 30px; backdrop-filter: blur(15px); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 10px 20px; border-radius: 12px; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--wait); color: #000; font-weight: bold; }

        /* Status Light */
        .status-dot { width: 10px; height: 10px; background: var(--ok); border-radius: 50%; display: inline-block; margin-left: 8px; box-shadow: 0 0 10px var(--ok); animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .data-table th { background: rgba(255,255,255,0.1); padding: 12px; text-align: right; color: var(--p); }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Stats */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: var(--glass); padding: 20px; border-radius: 20px; text-align: center; border-bottom: 4px solid var(--p); }
        .stat-box b { display: block; font-size: 28px; font-family: 'Orbitron'; color: var(--p); margin-top: 5px; }

        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 25px; margin-bottom: 20px; }

        input { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; color: white; width: 100%; margin-bottom: 12px; }
        .btn { border: none; border-radius: 12px; padding: 14px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: linear-gradient(45deg, var(--p), var(--s)); }
        .btn-wait { background: var(--wait); color: #000; }

        .trips-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .trip-card { background: linear-gradient(145deg, #111b2d, #060912); border-radius: 25px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .timer { font-family: 'Orbitron'; font-size: 40px; text-align: center; margin: 15px 0; color: #fff; text-shadow: 0 0 10px var(--p); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); }
        #camera-preview { width: 100%; height: 200px; background: #000; border-radius: 15px; object-fit: cover; margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin Hub) -->
    <div id="adminHub" class="container admin-only hidden">
        <div class="admin-hub">
            <h2 style="color:var(--wait); margin-bottom:20px;"><i class="fas fa-eye"></i> Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Master Eye)</h2>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="App.switchTab('online')">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù† ğŸŸ¢</button>
                <button class="tab-btn" onclick="App.switchTab('attendance')">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ</button>
                <button class="tab-btn" onclick="App.switchTab('customers')">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="tab-btn" onclick="App.switchTab('scooters')">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª</button>
                <button class="tab-btn" onclick="App.switchTab('monthly')">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</button>
            </div>

            <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù† -->
            <div id="tab-online" class="tab-content">
                <div style="background:rgba(0,242,254,0.05); padding:15px; border-radius:15px; border:1px solid var(--ok)">
                    <p style="color:var(--ok); font-weight:bold; margin-bottom:10px;">Ø£Ø¬Ù‡Ø²Ø© Ù…ØªØµÙ„Ø© Ø¨Ø§Ù„Ù„ÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</p>
                    <table class="data-table">
                        <thead><tr><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</th></tr></thead>
                        <tbody id="online-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-attendance" class="tab-content hidden">
                <table class="data-table">
                    <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
                    <tbody id="attendance-list"></tbody>
                </table>
            </div>

            <div id="tab-customers" class="tab-content hidden">
                <table class="data-table">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</th><th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th><th>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</th></tr></thead>
                    <tbody id="customers-list"></tbody>
                </table>
            </div>

            <div id="tab-scooters" class="tab-content hidden">
                <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± Ù„Ù„ØªØ­Ù„ÙŠÙ„..." oninput="App.analyzeScooter(this.value)">
                <div id="scooter-analysis-result" style="margin-top:20px; display:grid; grid-template-columns: repeat(3, 1fr); gap:15px"></div>
            </div>

            <div id="tab-monthly" class="tab-content hidden">
                <div class="stat-grid">
                    <div class="stat-box" style="border-color:var(--ok)"><span>ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</span><b id="m-total-cash">0</b></div>
                    <div class="stat-box" style="border-color:var(--err)"><span>Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</span><b id="m-total-disc">0</b></div>
                    <div class="stat-box"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</span><b id="m-total-mins">0</b></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div id="finishModal" class="modal">
        <div class="modal-content" style="background:#0f172a; border:2px solid var(--p); padding:30px; border-radius:30px; width:450px;">
            <h1 id="finScooter" style="text-align:center; color:var(--p); font-family:'Orbitron'">S-01</h1>
            <div id="issueBox" class="hidden" style="border: 1px solid var(--err); padding: 15px; border-radius: 15px; margin: 15px 0;">
                <p style="color:var(--err); font-weight:bold">ğŸš¨ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ Ø£Ùˆ Ø®ØµÙ…</p>
                <input type="text" id="issueReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø·Ù„">
                <input type="number" id="issueDisc" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">
            </div>
            <div style="padding: 15px 0; border-top: 1px dashed #333;">
                <div style="display:flex; justify-content:space-between"><span>Ø§Ù„Ù…Ø¯Ø©:</span><b id="finMins">0 Ø¯Ù‚ÙŠÙ‚Ø©</b></div>
                <div style="display:flex; justify-content:space-between; color:var(--ok); font-size:24px; margin-top:10px"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (2.50Ø¬/Ø¯):</span><b id="finTotal">0</b></div>
            </div>
            <button class="btn btn-p" onclick="App.confirmFinish()">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø­Ù„Ø© âœ…</button>
            <button class="btn" onclick="App.closeModal()" style="background:none; margin-top:10px">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen" class="modal" style="display:flex">
        <div class="modal-content" style="text-align:center; background:#0f172a; border:2px solid var(--s); padding:40px; border-radius:35px;">
            <h1 style="font-family:'Orbitron'; letter-spacing: 3px; color:var(--p)">YALLA MASTER</h1>
            <p style="opacity:0.5; font-size:12px; margin-bottom:25px">SYSTEM VERSION 19.0 MASTER EYE</p>
            <input type="password" id="pass" placeholder="Password" style="text-align:center; font-size:24px; letter-spacing: 8px;">
            <button class="btn btn-p" onclick="App.login()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div id="app-screen" class="container hidden">
        <div class="stat-grid">
            <div class="stat-box"><span>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</span><b id="dayCash">0.00</b></div>
            <div class="stat-box"><span>Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span><b id="activeCount">0</b></div>
            <div class="stat-box"><span>Ø±Ø­Ù„Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</span><b id="tripCount">0</b></div>
            <div class="stat-box admin-only hidden" style="border-color:var(--wait)"><span>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±</span><b id="monthCash">0.00</b></div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <div class="card">
                    <button class="btn btn-wait" style="margin-bottom:15px" onclick="App.attendance()">
                        <i class="fas fa-id-badge"></i> ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± (GPS)
                    </button>
                    <h4 style="color:var(--p); margin-bottom:15px">ØªØ´ØºÙŠÙ„ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <input type="text" id="cust-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" oninput="App.checkCustomer(this.value)">
                    <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input type="text" id="scoot-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                    
                    <video id="camera-preview" autoplay playsinline></video>
                    <button class="btn btn-sec" onclick="App.takePhoto()" style="margin-bottom:10px">ğŸ“¸ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                    <img id="id-final" style="width:100%; border-radius:12px; margin-bottom:10px" class="hidden">

                    <button class="btn btn-p" onclick="App.startTrip()">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš€</button>
                    <button class="btn btn-err" style="margin-top:10px" onclick="App.closeShift()">ØªÙ‚ÙÙŠÙ„ Ø´ÙØª Ø§Ù„Ù…ÙˆØ¸Ù ğŸ”’</button>
                </div>
                
                <div class="card">
                    <h4>Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h4>
                    <input type="date" id="historyDate" onchange="App.loadHistory()">
                    <div id="logBody" style="max-height:200px; overflow-y:auto; font-size:11px"></div>
                </div>
                <button class="btn" style="background:none; color:var(--err)" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>

            <div id="trips-list" class="trips-container"></div>
        </div>
    </div>

<script>
    const TG_TOKEN = "7899750780:AAFL31roDUbqFDoP-iUL2dhNn4GtKFAPUD0"; 
    const TG_CHAT_IDS = ["5684905593", "1089983199"];
    const TARGET_LAT = 30.1430; const TARGET_LON = 31.4060;

    const firebaseConfig = {
        apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
        authDomain: "yalla-scooter-pro.firebaseapp.com",
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        projectId: "yalla-scooter-pro",
        storageBucket: "yalla-scooter-pro.firebasestorage.app",
        messagingSenderId: "185791475252",
        appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRole = "staff"; let capturedPhoto = "";

    const App = {
        sendTG: (msg) => TG_CHAT_IDS.forEach(id => fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${id}&text=${encodeURIComponent(msg)}`)),

        login: function() {
            const p = document.getElementById('pass').value;
            if(p === "9924") currentRole = "Admin ğŸ‘‘";
            else if(p === "1234") currentRole = "Staff ğŸ§‘â€ğŸ”§";
            else return alert("Ø®Ø·Ø£!");

            if(currentRole.includes("Admin")) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').classList.remove('hidden');
            this.init();
            this.trackPresence(); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙˆØ± Ø§Ù„Ø¯Ø®ÙˆÙ„
        },

        // --- Ù…ÙŠØ²Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø§Ù„Ø¢Ù† ---
        trackPresence: function() {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const sessionRef = db.ref('online_sessions').push();
            
            // Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©ØŒ ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            sessionRef.onDisconnect().remove();
            
            // ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
            sessionRef.set({
                user: currentRole,
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now()
            });
        },

        init: function() {
            this.initCamera(); this.syncTrips(); this.loadStats(); this.loadHistory();
            this.loadAdminData();
            setInterval(() => this.updateTimers(), 1000);
        },

        initCamera: async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('camera-preview').srcObject = stream;
            } catch(e) { console.log("Camera access denied"); }
        },

        takePhoto: function() {
            const video = document.getElementById('camera-preview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.5);
            document.getElementById('id-final').src = capturedPhoto;
            document.getElementById('id-final').classList.remove('hidden');
        },

        attendance: function() {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = this.getDist(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LON);
                if(dist > 0.6) return alert("Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ÙˆÙ‚Ø¹!");
                const day = new Date().toLocaleDateString('en-CA');
                db.ref(`attendance/${day}`).push({ role: currentRole, time: new Date().toLocaleTimeString() });
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± âœ…");
            }, () => alert("ÙØ¹Ù„ Ø§Ù„Ù€ GPS!"));
        },

        getDist: (l1, n1, l2, n2) => {
            const R = 6371;
            const dLat = (l2-l1) * Math.PI / 180; const dLon = (n2-n1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        },

        checkCustomer: function(ph) {
            if(ph.length >= 11) {
                db.ref(`customers/${ph}`).once('value', snap => {
                    if(snap.val()) {
                        document.getElementById('cust-name').value = snap.val().name;
                        if(snap.val().photo) {
                            document.getElementById('id-final').src = snap.val().photo;
                            document.getElementById('id-final').classList.remove('hidden');
                            capturedPhoto = snap.val().photo;
                        }
                    }
                });
            }
        },

        startTrip: async function() {
            const sid = document.getElementById('scoot-id').value.toUpperCase();
            const ph = document.getElementById('cust-phone').value;
            const name = document.getElementById('cust-name').value;
            if(!sid || !ph) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
            await db.ref(`customers/${ph}`).update({ name, photo: capturedPhoto, lastVisit: Date.now() });
            await db.ref('ongoing').push({ sid, ph, name, start: Date.now(), staff: currentRole });
            App.sendTG(`ğŸš€ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${sid}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}`);
            location.reload();
        },

        syncTrips: function() {
            db.ref('ongoing').on('value', snap => {
                const list = document.getElementById('trips-list'); list.innerHTML = "";
                if(snap.val()) {
                    document.getElementById('activeCount').innerText = Object.keys(snap.val()).length;
                    Object.entries(snap.val()).forEach(([id, t]) => {
                        list.innerHTML += `
                            <div class="trip-card">
                                <h2 style="color:var(--p)">${t.sid}</h2>
                                <p style="font-size:12px; opacity:0.6">${t.name}</p>
                                <div class="timer" id="timer-${id}">00:00</div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                                    <button class="btn btn-p" onclick="App.openInv('${id}', false)">Ø¥Ù†Ù‡Ø§Ø¡</button>
                                    <button class="btn btn-err" onclick="App.openInv('${id}', true)">Ø¹Ø·Ù„</button>
                                </div>
                            </div>`;
                    });
                } else document.getElementById('activeCount').innerText = 0;
            });
        },

        updateTimers: function() {
            db.ref('ongoing').once('value', snap => {
                if(snap.val()) Object.entries(snap.val()).forEach(([id, t]) => {
                    let diff = Date.now() - t.start;
                    let m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
                    const el = document.getElementById(`timer-${id}`);
                    if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                });
            });
        },

        openInv: function(id, isErr) {
            this.curId = id; this.curErr = isErr;
            db.ref(`ongoing/${id}`).once('value', snap => {
                const t = snap.val(); const mins = Math.max(1, Math.ceil((Date.now() - t.start)/60000));
                document.getElementById('finScooter').innerText = t.sid;
                document.getElementById('finMins').innerText = mins + " Ø¯Ù‚ÙŠÙ‚Ø©";
                document.getElementById('finTotal').innerText = (mins * 2.5).toFixed(2) + " Ø¬.Ù…";
                document.getElementById('issueBox').className = isErr ? "" : "hidden";
                document.getElementById('finishModal').style.display = 'flex';
            });
        },

        confirmFinish: function() {
            const mins = parseInt(document.getElementById('finMins').innerText);
            let disc = parseFloat(document.getElementById('issueDisc').value) || 0;
            const cost = Math.max(0, (mins * 2.5) - disc);
            db.ref(`ongoing/${this.curId}`).once('value', async snap => {
                const t = snap.val(); const day = new Date().toLocaleDateString('en-CA');
                await db.ref(`history/${day}`).push({ ...t, mins, cost, disc, timestamp: Date.now(), reason: this.curErr ? document.getElementById('issueReason').value : "Ø³Ù„ÙŠÙ… âœ…" });
                if(this.curErr) {
                    db.ref(`malfunctions/${t.sid}`).transaction(c => {
                        if((c||0)+1 >= 3) App.sendTG(`ğŸš¨ Ø§Ù„Ø³ÙƒÙˆØªØ± ${t.sid} ØªØ¹Ø·Ù„ 3 Ù…Ø±Ø§Øª!`);
                        return (c||0)+1;
                    });
                }
                await db.ref(`ongoing/${this.curId}`).remove();
                App.sendTG(`âœ… Ø±Ø­Ù„Ø© Ù…Ù†ØªÙ‡ÙŠØ©\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${t.sid}\nØ§Ù„Ù…Ø¯Ø©: ${mins}Ø¯\nØ§Ù„Ù…Ø¨Ù„Øº: ${cost}Ø¬`);
                this.closeModal();
            });
        },

        closeShift: function() {
            const day = new Date().toLocaleDateString('en-CA');
            db.ref(`history/${day}`).once('value', snap => {
                let sum = 0; if(snap.val()) Object.values(snap.val()).forEach(t => sum += t.cost);
                App.sendTG(`ğŸ”’ ØªÙ‚ÙÙŠÙ„ Ø´ÙØª\nØ§Ù„Ù…ÙˆØ¸Ù: ${currentRole}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${sum} Ø¬.Ù…`);
                alert("ØªÙ… Ø§Ù„ØªÙ‚ÙÙŠÙ„!");
            });
        },

        switchTab: function(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.target.classList.add('active');
        },

        loadAdminData: function() {
            // Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù† (Live)
            db.ref('online_sessions').on('value', snap => {
                const list = document.getElementById('online-list'); list.innerHTML = "";
                if(snap.val()) Object.values(snap.val()).forEach(s => {
                    list.innerHTML += `<tr>
                        <td><b>${s.user}</b></td>
                        <td>${s.time}</td>
                        <td><span class="status-dot"></span> Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</td>
                    </tr>`;
                });
            });

            // Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
            db.ref('attendance').on('value', snap => {
                const list = document.getElementById('attendance-list'); list.innerHTML = "";
                if(snap.val()) Object.entries(snap.val()).forEach(([day, users]) => {
                    Object.values(users).forEach(u => {
                        list.innerHTML += `<tr><td>${u.role}</td><td>Ø­Ø¶ÙˆØ±</td><td>${day}</td><td>${u.time}</td></tr>`;
                    });
                });
            });

            // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            db.ref('customers').on('value', snap => {
                const list = document.getElementById('customers-list'); list.innerHTML = "";
                if(snap.val()) Object.entries(snap.val()).forEach(([ph, c]) => {
                    list.innerHTML += `<tr><td>${c.name}</td><td>${ph}</td><td><img src="${c.photo}" style="width:40px; border-radius:5px" onclick="window.open(this.src)"></td><td>${new Date(c.lastVisit).toLocaleDateString()}</td></tr>`;
                });
            });

            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø±
            db.ref('history').on('value', snap => {
                let mCash = 0, mDisc = 0, mMins = 0; const m = new Date().toLocaleDateString('en-CA').substring(0,7);
                if(snap.val()) Object.entries(snap.val()).forEach(([d, v]) => {
                    if(d.startsWith(m)) Object.values(v).forEach(t => { mCash += t.cost; mDisc += (t.disc||0); mMins += t.mins; });
                });
                document.getElementById('m-total-cash').innerText = mCash.toFixed(2);
                document.getElementById('m-total-disc').innerText = mDisc.toFixed(2);
                document.getElementById('m-total-mins').innerText = mMins;
            });
        },

        analyzeScooter: function(sid) {
            if(!sid) return; const id = sid.toUpperCase();
            db.ref('history').once('value', snap => {
                let money = 0, trips = 0, mins = 0;
                if(snap.val()) Object.values(snap.val()).forEach(day => Object.values(day).forEach(t => {
                    if(t.sid === id) { money += t.cost; trips++; mins += t.mins; }
                }));
                document.getElementById('scooter-analysis-result').innerHTML = `
                    <div class="stat-box"><span>Ø§Ù„Ø¯Ø®Ù„</span><b>${money.toFixed(2)}</b></div>
                    <div class="stat-box"><span>Ø§Ù„Ø±Ø­Ù„Ø§Øª</span><b>${trips}</b></div>
                    <div class="stat-box"><span>Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</span><b>${mins}</b></div>
                `;
            });
        },

        loadStats: function() {
            const day = new Date().toLocaleDateString('en-CA');
            db.ref(`history/${day}`).on('value', snap => {
                let cash = 0, count = 0;
                if(snap.val()) Object.values(snap.val()).forEach(t => { cash += t.cost; count++; });
                document.getElementById('dayCash').innerText = cash.toFixed(2);
                document.getElementById('tripCount').innerText = count;
            });
            db.ref('history').on('value', snap => {
                let month = 0; const m = day.substring(0,7);
                if(snap.val()) Object.entries(snap.val()).forEach(([d,v]) => {
                    if(d.startsWith(m)) Object.values(v).forEach(t => month += t.cost);
                });
                document.getElementById('monthCash').innerText = month.toFixed(2);
            });
        },

        loadHistory: function() {
            const d = document.getElementById('historyDate').value || new Date().toLocaleDateString('en-CA');
            db.ref(`history/${d}`).on('value', snap => {
                const b = document.getElementById('logBody'); b.innerHTML = "";
                if(snap.val()) Object.values(snap.val()).reverse().forEach(t => {
                    b.innerHTML += `<div style="border-bottom:1px solid #222; padding:5px">${t.sid} | ${t.cost}Ø¬ | ${t.reason}</div>`;
                });
            });
        },

        closeModal: () => document.getElementById('finishModal').style.display = 'none'
    };
</script>
</body>
</html>
