<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Dashboard V45</title>
    
    <!-- Firebase & Tools -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #0f172a; --sidebar: #1e293b; --card: #334155; 
            --primary: #3b82f6; --accent: #8b5cf6; --danger: #ef4444; --success: #10b981; --warn: #f59e0b;
            --text: #f1f5f9; --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* --- 1. Login Screen --- */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .login-box { background: rgba(30, 41, 59, 0.9); padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #475569; box-shadow: 0 20px 50px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        .login-input { width: 100%; padding: 15px; margin: 20px 0; background: #0f172a; border: 1px solid #475569; color: white; border-radius: 10px; text-align: center; font-size: 24px; letter-spacing: 5px; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }

        /* --- 2. Sidebar Navigation --- */
        .sidebar { width: 250px; background: var(--sidebar); display: flex; flex-direction: column; padding: 20px; border-left: 1px solid #475569; transition: 0.3s; z-index: 100; }
        .brand { font-size: 24px; font-weight: 900; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; color: var(--text-muted); transition: 0.2s; display: flex; align-items: center; gap: 15px; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); }
        .nav-item i { width: 25px; text-align: center; font-size: 18px; }

        /* --- 3. Main Content Area --- */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-warn { background: var(--warn); color: #000; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Cards */
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--sidebar); border-radius: 16px; padding: 20px; border: 1px solid #334155; position: relative; overflow: hidden; }
        .trip-card { border-right: 5px solid var(--primary); }
        .trip-timer { font-size: 32px; font-weight: 800; font-family: monospace; color: var(--primary); margin: 10px 0; }

        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--sidebar); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #334155; }
        .stat-val { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: var(--text-muted); }

        /* Tables */
        .table-container { background: var(--sidebar); border-radius: 15px; overflow: hidden; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #0f172a; padding: 15px; text-align: right; color: var(--text-muted); }
        td { padding: 15px; border-bottom: 1px solid #334155; }
        tr:hover { background: #334155; }

        /* AI Chat */
        .ai-box { background: #151e2d; border-radius: 15px; height: 350px; display: flex; flex-direction: column; border: 1px solid #334155; margin-top: 20px; }
        .ai-logs { flex: 1; overflow-y: auto; padding: 15px; }
        .msg { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; max-width: 80%; }
        .msg.bot { background: #334155; color: #fbbf24; align-self: flex-start; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-right: auto; }

        /* Responsive */
        @media(max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 70px; flex-direction: row; justify-content: space-around; padding: 5px; border-top: 1px solid #334155; border-left: none; }
            .brand, .nav-text { display: none; }
            .nav-item { flex-direction: column; font-size: 10px; gap: 2px; padding: 5px; margin: 0; }
            .nav-item i { font-size: 20px; }
            .main-content { padding-bottom: 80px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom: 5px;">Yalla Scooter</h1>
            <p style="color:var(--text-muted); font-size:12px; margin-bottom:20px;">Ultimate Dashboard V45</p>
            <input type="password" id="passInput" class="login-input" placeholder="****" inputmode="numeric">
            <button onclick="login()" class="btn btn-primary" style="width:100%; justify-content:center; padding:15px; font-size:16px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- 2. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <nav class="sidebar">
        <div class="brand"><i class="fas fa-bolt"></i> Yalla Scooter</div>
        
        <div class="nav-item active" onclick="nav('rental')">
            <i class="fas fa-motorcycle"></i> <span class="nav-text">Ø§Ù„ØªØ£Ø¬ÙŠØ±</span>
        </div>
        <div class="nav-item" onclick="nav('maintenance')">
            <i class="fas fa-tools"></i> <span class="nav-text">Ø§Ù„ØµÙŠØ§Ù†Ø©</span>
        </div>
        <div class="nav-item" onclick="nav('attendance')">
            <i class="fas fa-fingerprint"></i> <span class="nav-text">Ø§Ù„Ø­Ø¶ÙˆØ±</span>
        </div>
        <div class="nav-item" onclick="nav('clients')">
            <i class="fas fa-users"></i> <span class="nav-text">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
        </div>
        <div class="nav-item" onclick="checkAdminAccess()">
            <i class="fas fa-chart-pie"></i> <span class="nav-text">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© & AI</span>
        </div>
        
        <div style="margin-top:auto">
            <div class="nav-item" style="color:var(--danger)" onclick="location.reload()">
                <i class="fas fa-sign-out-alt"></i> <span class="nav-text">Ø®Ø±ÙˆØ¬</span>
            </div>
        </div>
    </nav>

    <!-- 3. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="main-content">
        
        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ£Ø¬ÙŠØ± (Rental) -->
        <div id="sec-rental" class="section active">
            <div class="page-header">
                <h2>ğŸ›µ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>
                <button class="btn btn-primary" onclick="newTripPopup()"><i class="fas fa-plus"></i> Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
            <div id="rental-grid" class="grid-cards">
                <!-- Ø§Ù„ÙƒØ±ÙˆØª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© (Maintenance) -->
        <div id="sec-maintenance" class="section">
            <div class="page-header">
                <h2>ğŸ› ï¸ ÙˆØ±Ø´Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
                <button class="btn btn-warn" onclick="maintPopup()"><i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ø·Ù„</th><th>Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                    <tbody id="maint-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø­Ø¶ÙˆØ± (Attendance) -->
        <div id="sec-attendance" class="section">
            <div class="page-header">
                <h2>ğŸ“ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-success" onclick="attendance('IN')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
                    <button class="btn btn-danger" onclick="attendance('OUT')">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
            <div class="stats-row" style="grid-template-columns: 1fr;">
                <div class="stat-box">
                    <i class="fas fa-map-marker-alt" style="color:var(--warn); font-size:24px;"></i>
                    <p style="margin:10px 0;">ÙŠØ¬Ø¨ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (55RM+QM) Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.</p>
                    <small style="color:var(--text-muted)">Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„: Ø­Ø¶ÙˆØ± 3:00Ù… - ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø¯ 3:15Ù…</small>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Clients) -->
        <div id="sec-clients" class="section">
            <div class="page-header">
                <h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="filterClients(this.value)" style="padding:10px; border-radius:8px; border:none; width:200px;">
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ±Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                    <tbody id="clients-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin & AI) -->
        <div id="sec-admin" class="section">
            <div class="page-header">
                <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
                <div style="font-size:12px; color:var(--text-muted)">Welcome Admin</div>
            </div>

            <div class="stats-row">
                <div class="stat-box"><div id="admin-rev" class="stat-val" style="color:var(--success)">0</div><div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</div></div>
                <div class="stat-box"><div id="admin-exp" class="stat-val" style="color:var(--danger)">0</div><div class="stat-label">Ù…ØµØ±ÙˆÙØ§Øª ØµÙŠØ§Ù†Ø©</div></div>
                <div class="stat-box"><div id="admin-prof" class="stat-val" style="color:var(--warn)">0</div><div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div></div>
                <div class="stat-box"><div id="admin-trips" class="stat-val" style="color:var(--primary)">0</div><div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª</div></div>
            </div>

            <!-- AI Chat -->
            <div class="ai-box">
                <div style="padding:15px; border-bottom:1px solid #334155; display:flex; justify-content:space-between;">
                    <span style="color:var(--accent); font-weight:bold;"><i class="fas fa-brain"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ (AI)</span>
                    <span style="font-size:10px; background:rgba(139, 92, 246, 0.2); padding:2px 8px; border-radius:4px;">Gemini Live</span>
                </div>
                <div id="ai-logs" class="ai-logs">
                    <div class="msg bot">Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ Ù…Ø¯ÙŠØ±! Ø£Ù†Ø§ Ø­Ø³Ø¨ØªÙ„Ùƒ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ ØªÙØ§ØµÙŠÙ„.</div>
                </div>
                <div style="padding:10px; display:flex; gap:10px; border-top:1px solid #334155;">
                    <input type="text" id="ai-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." style="flex:1; background:#0f172a; border:1px solid #334155; color:white; padding:10px; border-radius:8px;">
                    <button class="btn btn-primary" onclick="askAI()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        const GEMINI_KEY = "AIzaSyA1gb1AcSvcHAuc8LfcHfDkGMdWZv95Ge8";
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 }; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª

        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yala-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.firebasestorage.app",
            messagingSenderId: "185791475252",
            appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null; // 'staff' or 'admin'

        // --- 1. Login Logic ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213") {
                currentUser = 'staff';
                document.getElementById('login-overlay').style.display = 'none';
                initRental();
            } else if(p === "9924") {
                currentUser = 'admin';
                document.getElementById('login-overlay').style.display = 'none';
                nav('admin');
                initAdmin();
            } else {
                Swal.fire({icon:'error', title:'ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦', background:'#1e293b', color:'#fff'});
            }
        }

        // --- 2. Navigation ---
        function nav(secId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('sec-'+secId).classList.add('active');
            
            // Highlight active nav
            const items = document.querySelectorAll('.nav-item');
            if(secId === 'rental') items[0].classList.add('active');
            if(secId === 'maintenance') { items[1].classList.add('active'); loadMaintTable(); }
            if(secId === 'attendance') items[2].classList.add('active');
            if(secId === 'clients') { items[3].classList.add('active'); loadClients(); }
            if(secId === 'admin') items[4].classList.add('active');
        }

        function checkAdminAccess() {
            if(currentUser === 'admin') {
                nav('admin');
                initAdmin();
            } else {
                Swal.fire({
                    title: 'ğŸ” Ù…Ø·Ù„ÙˆØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', input: 'password', background: '#1e293b', color: '#fff',
                    preConfirm: (p) => p !== "9924" ? Swal.showValidationMessage('Ø®Ø·Ø£') : true
                }).then(r => {
                    if(r.isConfirmed) {
                        currentUser = 'admin';
                        nav('admin');
                        initAdmin();
                    }
                });
            }
        }

        // --- 3. Rental System ---
        function initRental() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('rental-grid');
                grid.innerHTML = "";
                if(snap.exists()) {
                    snap.forEach(t => {
                        const trip = t.val();
                        const mins = Math.floor((Date.now() - trip.start)/60000);
                        grid.innerHTML += `
                            <div class="card trip-card">
                                <div style="display:flex; justify-content:space-between;">
                                    <h3>${trip.scooter}</h3>
                                    <span style="background:#0f172a; padding:5px 10px; border-radius:10px; font-size:12px;">${trip.client}</span>
                                </div>
                                <div class="trip-timer">${mins} <small style="font-size:14px">Ø¯Ù‚ÙŠÙ‚Ø©</small></div>
                                <button class="btn btn-danger" style="width:100%; justify-content:center;" onclick="endTrip('${t.key}', '${trip.scooter}', ${mins}, '${trip.phone}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                            </div>
                        `;
                    });
                } else {
                    grid.innerHTML = "<p style='color:#64748b; text-align:center; width:100%;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø©</p>";
                }
            });
        }

        async function newTripPopup() {
            const { value: form } = await Swal.fire({
                title: 'Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                html: `
                    <input id="sw-scooter" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±" style="text-transform:uppercase">
                    <input id="sw-phone" class="swal2-input" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ)" oninput="checkClient(this.value)">
                    <div id="client-status" style="font-size:12px; margin-bottom:10px; height:20px;"></div>
                    <input id="sw-name" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                `,
                background: '#1e293b', color: '#fff',
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('sw-scooter').value.toUpperCase(),
                        document.getElementById('sw-phone').value,
                        document.getElementById('sw-name').value
                    ]
                }
            });

            if (form) {
                const [s, p, n] = form;
                if(!s) return;
                
                // Check Maintenance Status
                const scootSnap = await db.ref('scooters/'+s).once('value');
                if(scootSnap.exists() && scootSnap.val().status === 'maint') {
                    return Swal.fire({icon:'warning', title:'ØªÙ†Ø¨ÙŠÙ‡', text:'Ø§Ù„Ø³ÙƒÙˆØªØ± Ø¯Ù‡ ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹!', background:'#1e293b', color:'#fff'});
                }

                db.ref('active_trips').push({ scooter:s, phone:p||'NoNum', client:n||'Ø²Ø§Ø¦Ø±', start:Date.now() });
                if(p) db.ref('clients/'+p).update({ name:n, lastVisit:Date.now() });
            }
        }

        function checkClient(phone) {
            if(phone.length < 10) return;
            db.ref('clients/'+phone).once('value', snap => {
                const div = document.getElementById('client-status');
                if(snap.exists()) {
                    const c = snap.val();
                    if(c.blocked) {
                        div.innerHTML = "<span style='color:red; font-weight:bold'>â›” Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ±!</span>";
                        document.getElementById('sw-name').disabled = true;
                    } else {
                        div.innerHTML = `<span style='color:#10b981'>âœ… Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„ (ØµØ±Ù: ${c.totalSpend||0} Ø¬)</span>`;
                        document.getElementById('sw-name').value = c.name;
                    }
                } else {
                    div.innerHTML = "<span style='color:#94a3b8'>Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</span>";
                }
            });
        }

        async function endTrip(key, scooter, mins, phone) {
            if(mins < 15) mins = 15;
            const baseCost = mins * 1; 

            const { value: result } = await Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `
                    <h2 style="color:#3b82f6">${baseCost} Ø¬.Ù…</h2>
                    <p>Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                    <hr style="border-color:#333">
                    <label><input type="checkbox" id="hasIssue"> âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ / Ø®ØµÙ…</label>
                    <div id="issueBox" style="display:none; margin-top:10px;">
                        <select id="issueType" class="swal2-input" style="width:80%"><option>Error 14</option><option>Error 15</option><option>Error 18</option><option>Battery</option><option>Tire</option></select>
                        <input id="issueCost" type="number" class="swal2-input" placeholder="ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ø·Ù„" style="width:80%">
                    </div>
                `,
                background: '#1e293b', color: '#fff',
                showCancelButton: true,
                confirmButtonText: 'ØªØ­ØµÙŠÙ„',
                didOpen: () => {
                    const chk = document.getElementById('hasIssue');
                    chk.onchange = () => document.getElementById('issueBox').style.display = chk.checked ? 'block' : 'none';
                },
                preConfirm: () => {
                    const hasIssue = document.getElementById('hasIssue').checked;
                    const dmg = hasIssue ? (parseFloat(document.getElementById('issueCost').value)||0) : 0;
                    const type = hasIssue ? document.getElementById('issueType').value : null;
                    return { hasIssue, dmg, type };
                }
            });

            if (result) {
                const total = baseCost + result.dmg;
                const today = new Date().toISOString().split('T')[0];

                db.ref(`history/${today}`).push({
                    scooter, cost: baseCost, dmg: result.dmg, total, duration: mins,
                    hasIssue: result.hasIssue, issueType: result.type, end: Date.now()
                });

                // Update Client
                if(phone !== 'NoNum') {
                    db.ref(`clients/${phone}`).transaction(c => {
                        return { ...c, totalSpend: (c?.totalSpend||0)+total, trips: (c?.trips||0)+1 };
                    });
                }

                // Update Scooter Stats
                db.ref(`scooters/${scooter}`).transaction(s => {
                    return { ...s, revenue: (s?.revenue||0)+total, issues: (s?.issues||0)+(result.hasIssue?1:0) };
                });

                // Notify if issue
                if(result.hasIssue) {
                    fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ chat_id: TELEGRAM.chat, text: `ğŸš¨ <b>Ø¹Ø·Ù„!</b>\nğŸ›µ ${scooter}\nğŸ› ï¸ ${result.type}\nğŸ’° ${result.dmg} Ø¬`, parse_mode: 'HTML' })
                    });
                }

                db.ref('active_trips/'+key).remove();
                Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„', text:`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø¬`, background:'#1e293b', color:'#fff'});
            }
        }

        // --- 4. Maintenance System ---
        async function maintPopup() {
            const { value: form } = await Swal.fire({
                title: 'ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©',
                html: `
                    <input id="mn-scooter" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±" style="text-transform:uppercase">
                    <input id="mn-part" class="swal2-input" placeholder="Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø± / Ø§Ù„Ø³Ø¨Ø¨">
                    <input id="mn-cost" class="swal2-input" type="number" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">
                `,
                background: '#1e293b', color: '#fff',
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('mn-scooter').value.toUpperCase(),
                    document.getElementById('mn-part').value,
                    document.getElementById('mn-cost').value
                ]
            });

            if (form) {
                const [s, p, c] = form;
                const cost = parseFloat(c) || 0;
                
                db.ref('maintenance_log').push({ scooter:s, part:p, cost, date: Date.now() });
                
                // Update Scooter Status
                db.ref(`scooters/${s}`).transaction(v => {
                    return { ...v, status:'maint', repairCost:(v?.repairCost||0)+cost };
                });

                Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', background:'#1e293b', color:'#fff'});
            }
        }

        function loadMaintTable() {
            db.ref('maintenance_log').limitToLast(20).on('value', snap => {
                const tb = document.getElementById('maint-table');
                tb.innerHTML = "";
                if(snap.exists()) {
                    snap.forEach(c => {
                        const v = c.val();
                        tb.innerHTML += `<tr><td>${v.scooter}</td><td>ØµÙŠØ§Ù†Ø©</td><td>${v.part}</td><td style="color:var(--danger)">${v.cost}</td><td>${new Date(v.date).toLocaleDateString()}</td></tr>`;
                    });
                }
            });
        }

        // --- 5. Attendance & GPS ---
        function attendance(type) {
            if(!navigator.geolocation) return Swal.fire('Error', 'GPS Required', 'error');
            
            Swal.fire({title:'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...', didOpen:()=>Swal.showLoading(), background:'#1e293b', color:'#fff'});
            
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, SHOP_LOC.lat, SHOP_LOC.lng);
                
                if(dist > 200) { // 200 Ù…ØªØ±
                    return Swal.fire({icon:'error', title:'Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹!', text:`Ø§Ù„Ù…Ø³Ø§ÙØ©: ${Math.floor(dist)} Ù…ØªØ±`, background:'#1e293b', color:'#fff'});
                }

                const now = new Date();
                const time = now.toLocaleTimeString('ar-EG');
                const today = now.toISOString().split('T')[0];
                const h = now.getHours();
                
                let status = 'âœ… Ø­Ø¶ÙˆØ±';
                if(type === 'IN') {
                    if(h > 15 || (h===15 && now.getMinutes()>30)) status = 'ğŸ›‘ ØªØ£Ø®ÙŠØ± (Ø®ØµÙ…)';
                    else if(h===15 && now.getMinutes()>15) status = 'âš ï¸ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·';
                }

                db.ref(`attendance/${today}`).push({ type, time, status });
                
                fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ chat_id: TELEGRAM.chat, text: `ğŸ“ <b>${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'}</b>\nğŸ•’ ${time}\n${status}`, parse_mode: 'HTML' })
                });

                Swal.fire({icon:'success', title:type==='IN'?'ØªÙ… Ø§Ù„Ø­Ø¶ÙˆØ±':'ØªÙ… Ø§Ù„Ø§Ù†ØµØ±Ø§Ù', text:status, background:'#1e293b', color:'#fff'});

            }, () => Swal.fire('Error', 'GPS Failed', 'error'));
        }

        // --- 6. Admin & AI ---
        function initAdmin() {
            const today = new Date().toISOString().split('T')[0];
            
            // Stats
            db.ref(`history/${today}`).on('value', snap => {
                let rev = 0, trips = 0;
                if(snap.exists()) snap.forEach(c => { rev += (c.val().total||0); trips++; });
                document.getElementById('admin-rev').innerText = rev;
                document.getElementById('admin-trips').innerText = trips;
                calcProfit(rev);
            });

            // Maintenance Cost Today (Approximation or fetch recent logs)
            // For simplicity, we calculate profit based on total tracked repair cost vs revenue
            // Better: fetch logs for today
        }

        function calcProfit(rev) {
            // Simplified for today logic
            document.getElementById('admin-prof').innerText = rev; // Needs expense integration per day logic
        }

        async function askAI() {
            const q = document.getElementById('ai-input').value;
            const log = document.getElementById('ai-logs');
            if(!q) return;

            log.innerHTML += `<div class="msg user">${q}</div>`;
            document.getElementById('ai-input').value = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...";

            const rev = document.getElementById('admin-rev').innerText;
            const context = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¯ÙŠØ±. Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…: ${rev} Ø¬Ù†ÙŠÙ‡. Ø¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰: ${q}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: context }] }] })
                });
                const d = await res.json();
                const reply = d.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                log.innerHTML += `<div class="msg bot">${reply}</div>`;
            } catch(e) {
                log.innerHTML += `<div class="msg bot" style="color:red">Ø®Ø·Ø£ Ø§ØªØµØ§Ù„</div>`;
            }
            
            document.getElementById('ai-input').value = "";
            log.scrollTop = log.scrollHeight;
        }

        // --- Helpers ---
        function loadClients() {
            db.ref('clients').limitToLast(50).on('value', snap => {
                const tb = document.getElementById('clients-table');
                tb.innerHTML = "";
                if(snap.exists()) {
                    snap.forEach(c => {
                        const v = c.val();
                        tb.innerHTML += `<tr><td>${v.name}</td><td>${c.key}</td><td>${v.trips||0}</td><td>${v.totalSpend||0}</td><td>${v.blocked?'â›”':'âœ…'}</td></tr>`;
                    });
                }
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

    </script>
</body>
</html>
