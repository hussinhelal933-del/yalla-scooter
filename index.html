<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Cyber Dashboard</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø´ÙŠÙƒ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a; --panel-bg: rgba(30, 41, 59, 0.7);
            --primary: #3b82f6; --accent: #f59e0b; --danger: #ef4444; --success: #10b981;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --glass: blur(12px);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); min-height: 100vh; background-image: radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 20%); }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; background-image: url('https://images.unsplash.com/photo-1558981806-ec527fa84f3d?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80'); background-size: cover; }
        .login-card { background: rgba(0,0,0,0.8); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); width: 90%; max-width: 350px; }
        .login-input { width: 100%; padding: 15px; margin: 20px 0; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; text-align: center; font-size: 20px; letter-spacing: 5px; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }

        /* --- Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        .app-layout { display: none; min-height: 100vh; }
        .sidebar { width: 80px; background: var(--panel-bg); backdrop-filter: var(--glass); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; padding-top: 20px; position: fixed; height: 100vh; z-index: 100; transition: 0.3s; }
        .sidebar:hover { width: 220px; }
        .nav-item { color: var(--text-muted); padding: 15px; width: 100%; cursor: pointer; display: flex; align-items: center; white-space: nowrap; overflow: hidden; transition: 0.2s; }
        .nav-item i { font-size: 24px; min-width: 80px; text-align: center; }
        .nav-item:hover, .nav-item.active { color: var(--primary); background: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--primary); }
        .nav-text { opacity: 0; transition: 0.2s; font-weight: bold; }
        .sidebar:hover .nav-text { opacity: 1; }

        .main-content { margin-right: 80px; padding: 20px; width: calc(100% - 80px); }
        @media (max-width: 768px) { 
            .sidebar { width: 100%; height: 60px; bottom: 0; top: auto; flex-direction: row; border-right: none; border-top: 1px solid rgba(255,255,255,0.1); justify-content: space-around; padding: 0; }
            .sidebar:hover { width: 100%; }
            .nav-item { flex-direction: column; font-size: 10px; padding: 5px; }
            .nav-item i { font-size: 20px; min-width: auto; margin-bottom: 2px; }
            .nav-text { opacity: 1; font-size: 10px; }
            .main-content { margin-right: 0; margin-bottom: 70px; width: 100%; }
        }

        /* --- ÙƒØ±ÙˆØª Ø§Ù„Ø§Ø³ÙƒÙˆØªØ± (Rental System) --- */
        .scooter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .scooter-card { background: var(--panel-bg); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; position: relative; overflow: hidden; transition: 0.3s; }
        .scooter-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .scooter-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .scooter-card.maintenance::before { background: var(--danger); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .scooter-id { font-size: 24px; font-weight: 800; color: white; }
        .client-info { font-size: 13px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 10px; }
        
        .timer-display { font-size: 36px; font-weight: 800; font-family: 'Courier New', monospace; color: var(--primary); text-align: center; margin: 15px 0; text-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        
        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), #2563eb); color: white; }
        .btn-danger { background: linear-gradient(45deg, var(--danger), #b91c1c); color: white; }
        .btn-glass { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-glass:hover { background: rgba(255,255,255,0.2); }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin) --- */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .stat-val { font-size: 28px; font-weight: bold; margin-top: 5px; }
        .stat-label { color: var(--text-muted); font-size: 14px; }
        .text-green { color: var(--success); } .text-blue { color: var(--primary); } .text-orange { color: var(--accent); }

        .data-table-container { background: var(--panel-bg); border-radius: 15px; overflow: hidden; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: rgba(0,0,0,0.3); padding: 15px; text-align: right; font-weight: bold; color: var(--text-muted); }
        .data-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* --- Ø²Ø±Ø§Ø± Ø¹Ø§Ø¦Ù… (Add Trip) --- */
        .fab { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); cursor: pointer; z-index: 200; transition: 0.3s; }
        .fab:hover { transform: scale(1.1); }
        @media(max-width:768px) { .fab { bottom: 80px; left: 20px; } }

        /* --- AI Window --- */
        .ai-window { display: none; position: fixed; bottom: 100px; left: 30px; width: 300px; background: #1e293b; border: 1px solid #334155; border-radius: 15px; z-index: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.5); overflow: hidden; }
        .ai-header { background: linear-gradient(45deg, #6366f1, #a855f7); padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .ai-body { height: 250px; padding: 15px; overflow-y: auto; font-size: 13px; color: #cbd5e1; }
        .ai-footer { padding: 10px; border-top: 1px solid #334155; display: flex; }
        .ai-input { flex: 1; background: #0f172a; border: none; color: white; padding: 8px; border-radius: 5px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div class="login-card">
            <i class="fas fa-bolt" style="font-size: 50px; color: var(--accent); margin-bottom: 20px;"></i>
            <h1 style="margin: 0;">Yalla Scooter</h1>
            <p style="color: var(--text-muted);">Ultimate System V34</p>
            <input type="password" id="loginPass" class="login-input" placeholder="Enter Code" inputmode="numeric">
            <button class="btn btn-primary" style="width: 100%; padding: 15px;" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- 2. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="app" class="app-layout">
        
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
        <nav class="sidebar">
            <div style="margin-bottom: 30px; font-size: 24px; color: var(--accent);"><i class="fas fa-bolt"></i></div>
            
            <div class="nav-item active" onclick="showPage('rental')">
                <i class="fas fa-motorcycle"></i> <span class="nav-text">Ø§Ù„ØªØ£Ø¬ÙŠØ±</span>
            </div>
            
            <div class="nav-item" id="adminLink" onclick="showPage('admin')">
                <i class="fas fa-chart-pie"></i> <span class="nav-text">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
            </div>
            
            <div class="nav-item" onclick="handleCheckIn()">
                <i class="fas fa-fingerprint"></i> <span class="nav-text">Ø­Ø¶ÙˆØ±</span>
            </div>

            <div class="nav-item" style="margin-top: auto; color: var(--danger);" onclick="location.reload()">
                <i class="fas fa-sign-out-alt"></i> <span class="nav-text">Ø®Ø±ÙˆØ¬</span>
            </div>
        </nav>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <main class="main-content">
            
            <!-- ØµÙØ­Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ± (Rental) -->
            <div id="page-rental">
                <h2 style="margin-bottom: 5px;">ğŸ›µ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>
                <p class="text-muted" style="font-size: 12px; color: #aaa;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ø³ÙƒÙˆØªØ±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
                
                <div class="scooter-grid" id="rentalGrid"></div>
            </div>

            <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin) -->
            <div id="page-admin" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ“Š Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
                    <button class="btn btn-glass" onclick="toggleAIWindow()"><i class="fas fa-robot"></i> AI Chat</button>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>
                        <div class="stat-val text-green" id="statRevenue">0 EGP</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
                        <div class="stat-val text-blue" id="statTrips">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</div>
                        <div class="stat-val text-orange" id="statIssues">0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h3>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>

                <!-- AI Window -->
                <div class="ai-window" id="aiWin">
                    <div class="ai-header">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ <i class="fas fa-times" style="cursor:pointer" onclick="toggleAIWindow()"></i></div>
                    <div class="ai-body" id="aiChatBody">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ø±ÙŠØ³! Ø§Ø·Ù„Ø¨ Ø£ÙŠ ØªÙ‚Ø±ÙŠØ±.</div>
                    <div class="ai-footer">
                        <input type="text" class="ai-input" id="aiInp" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ...">
                        <button onclick="askAI()" style="background:transparent; border:none; color:white; margin-right:5px;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø±Ø­Ù„Ø© -->
        <div class="fab" onclick="newTripPopup()">
            <i class="fas fa-plus"></i>
        </div>

    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        const SHOP_COORDS = { lat: 30.0444, lng: 31.2357 }; // âš ï¸ ØºÙŠØ± Ø§Ù„Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù‡Ù†Ø§
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        
        // --- Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yala-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.firebasestorage.app",
            messagingSenderId: "185791475252",
            appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isAdmin = false;

        // --- 1. Login Logic ---
        function attemptLogin() {
            const code = document.getElementById('loginPass').value;
            if(code === "1213") {
                isAdmin = false;
                enterApp();
                document.getElementById('adminLink').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…ÙˆØ¸Ù
            } else if(code === "9924") {
                isAdmin = true;
                enterApp();
                loadAdminStats();
            } else {
                Swal.fire({ icon: 'error', title: 'ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦', background: '#1e293b', color: '#fff' });
            }
        }

        function enterApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            loadRentalGrid();
        }

        function showPage(pageId) {
            document.getElementById('page-rental').classList.add('hidden');
            document.getElementById('page-admin').classList.add('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('page-'+pageId).classList.remove('hidden');
            // Highlight nav logic (simplified)
        }

        // --- 2. Rental System (The Cool Cards) ---
        function loadRentalGrid() {
            const grid = document.getElementById('rentalGrid');
            
            db.ref('active_trips').on('value', snap => {
                grid.innerHTML = "";
                if(!snap.exists()) {
                    grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:#555; margin-top:50px;'><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ˜´</h4></div>";
                    return;
                }

                snap.forEach(t => {
                    const trip = t.val();
                    const key = t.key;
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ù„Ø§ÙŠÙ
                    const startMs = trip.start;
                    const nowMs = Date.now();
                    const diffMins = Math.floor((nowMs - startMs) / 60000);

                    grid.innerHTML += `
                        <div class="scooter-card" id="card-${key}">
                            <div class="card-header">
                                <div class="scooter-id"><i class="fas fa-bolt text-blue"></i> ${trip.scooter}</div>
                                <div class="client-info"><i class="fas fa-user"></i> ${trip.client}</div>
                            </div>
                            
                            <div class="timer-display" id="timer-${key}">${diffMins} <span style="font-size:12px">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
                            
                            <div class="card-actions">
                                <button class="btn btn-glass" onclick="sendIssue('${trip.scooter}')"><i class="fas fa-wrench"></i> Ø¹Ø·Ù„</button>
                                <button class="btn btn-danger" onclick="finishTrip('${key}', '${trip.scooter}', ${diffMins})"><i class="fas fa-flag-checkered"></i> Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>
                    `;
                });
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
            setInterval(() => {
                // Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ DOM Ù‡Ù†Ø§ Ù„Ùˆ Ø¹Ø§ÙŠØ²ÙŠÙ† Ø¯Ù‚Ø© Ø¨Ø§Ù„Ø«Ø§Ù†ÙŠØ©
            }, 60000);
        }

        // --- 3. New Trip (SweetAlert2) ---
        async function newTripPopup() {
            const { value: formValues } = await Swal.fire({
                title: 'ğŸš€ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                background: '#1e293b', color: '#fff',
                html: `
                    <input id="swal-scooter" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± (S1)" style="text-transform:uppercase">
                    <input id="swal-phone" class="swal2-input" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
                    <input id="swal-name" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                `,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-scooter').value.toUpperCase(),
                        document.getElementById('swal-phone').value,
                        document.getElementById('swal-name').value
                    ]
                }
            });

            if (formValues) {
                const [scooter, phone, name] = formValues;
                if(!scooter) return;
                
                db.ref('active_trips').push({
                    scooter, phone: phone || 'NoNum', client: name || 'Ø²Ø§Ø¦Ø±', start: Date.now()
                });
                
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: `ØªÙ… Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© ${scooter}` });
            }
        }

        // --- 4. Finish Trip Logic ---
        function finishTrip(key, scooter, mins) {
            // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø±Ø¨Ø¹ Ø³Ø§Ø¹Ø©
            if(mins < 15) mins = 15;
            const cost = mins * 1; // Ø§Ù„Ø³Ø¹Ø±

            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ',
                html: `
                    <h2 style="color:#3b82f6">${cost} Ø¬.Ù…</h2>
                    <p>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­ØªØ³Ø¨Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                `,
                icon: 'question',
                background: '#1e293b', color: '#fff',
                showCancelButton: true,
                confirmButtonText: 'ØªØ­ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    db.ref('active_trips/'+key).once('value', snap => {
                        const t = snap.val();
                        const today = new Date().toISOString().split('T')[0];
                        
                        db.ref(`history/${today}`).push({ ...t, end: Date.now(), cost, duration: mins });
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙƒÙˆØªØ±
                        db.ref(`scooters/${scooter}/totalRevenue`).transaction(v => (v||0)+cost);

                        // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
                        if(t.phone !== 'NoNum') {
                            db.ref(`clients/${t.phone}`).update({ name: t.client, lastVisit: Date.now() });
                        }

                        db.ref('active_trips/'+key).remove();
                        Swal.fire({title:'ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„!', icon:'success', background:'#1e293b', color:'#fff', timer: 1500, showConfirmButton:false});
                    });
                }
            });
        }

        // --- 5. GPS Attendance ---
        function handleCheckIn() {
            if(!navigator.geolocation) return Swal.fire('Error', 'GPS not supported', 'error');
            
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...', didOpen: () => Swal.showLoading(), background: '#1e293b', color:'#fff' });
            
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, SHOP_COORDS.lat, SHOP_COORDS.lng);
                
                if(dist > 200) { // 200 Ù…ØªØ± Ø³Ù…Ø§Ø­ÙŠØ©
                    Swal.fire({icon:'error', title:'Ø£Ù†Øª Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø­Ù„!', text:`Ø§Ù„Ù…Ø³Ø§ÙØ©: ${Math.floor(dist)} Ù…ØªØ±`, background:'#1e293b', color:'#fff'});
                    return;
                }

                // Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆÙ‚Øª
                const now = new Date();
                const h = now.getHours();
                const timeStr = now.toLocaleTimeString('ar-EG');
                let status = "âœ… Ø­Ø¶ÙˆØ±";
                
                // Ø§Ù„Ø³Ø§Ø¹Ø© 3:00 Ù… = 15
                if(h > 15 || (h===15 && now.getMinutes() > 15)) status = "âš ï¸ ØªØ£Ø®ÙŠØ±";
                if(h > 15 && now.getMinutes() > 30) status = "ğŸ›‘ Ø®ØµÙ…";

                // Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ø¬Ø±Ø§Ù…
                fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: TELEGRAM.chat, text: `ğŸ“ <b>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</b>\nğŸ‘¤ Ù…ÙˆØ¸Ù\nğŸ•’ ${timeStr}\n${status}`, parse_mode: 'HTML' })
                });

                Swal.fire({icon:'success', title: status, text: timeStr, background:'#1e293b', color:'#fff'});

            }, () => Swal.fire('Error', 'ÙØ´Ù„ ÙÙŠ GPS', 'error'));
        }

        // --- 6. Admin Stats & History ---
        function loadAdminStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…
            db.ref(`history/${today}`).on('value', snap => {
                let total = 0;
                let trips = 0;
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = "";
                
                if(snap.exists()) {
                    snap.forEach(c => {
                        const r = c.val();
                        total += r.cost;
                        trips++;
                        // Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                        tbody.innerHTML += `
                            <tr>
                                <td style="color:var(--text-main); font-weight:bold">${r.scooter}</td>
                                <td>${r.client}</td>
                                <td>${r.duration}Ø¯</td>
                                <td class="text-green">${r.cost}</td>
                                <td style="font-size:10px; color:#aaa">${new Date(r.end).toLocaleTimeString('ar-EG')}</td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('statRevenue').innerText = total + ' EGP';
                document.getElementById('statTrips').innerText = trips;
            });
        }

        function sendIssue(scooter) {
            Swal.fire({
                title: `Ø¹Ø·Ù„ ÙÙŠ ${scooter}`,
                input: 'text',
                inputPlaceholder: 'ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„...',
                showCancelButton: true,
                background: '#1e293b', color: '#fff'
            }).then((res) => {
                if(res.value) {
                    db.ref(`scooters/${scooter}/issueCount`).transaction(v => {
                        const newVal = (v||0) + 1;
                        if(newVal >= 3) {
                             fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ chat_id: TELEGRAM.chat, text: `ğŸš¨ <b>ØªÙ†Ø¨ÙŠÙ‡ ØµÙŠØ§Ù†Ø©!</b>\nØ§Ù„Ø§Ø³ÙƒÙˆØªØ± ${scooter} ÙˆØµÙ„ 3 Ø£Ø¹Ø·Ø§Ù„.` , parse_mode: 'HTML'})
                            });
                        }
                        return newVal;
                    });
                    Swal.fire({icon:'warning', title:'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø·Ù„', background:'#1e293b', color:'#fff', timer:1500, showConfirmButton:false});
                }
            });
        }

        // --- Helpers ---
        function getDistance(lat1,lon1,lat2,lon2) {
            var R = 6371e3; 
            var dLat = (lat2-lat1) * Math.PI/180;
            var dLon = (lon2-lon1) * Math.PI/180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toggleAIWindow() {
            const w = document.getElementById('aiWin');
            w.style.display = (w.style.display === 'block') ? 'none' : 'block';
        }

        function askAI() {
            const i = document.getElementById('aiInp');
            const b = document.getElementById('aiChatBody');
            b.innerHTML += `<div style="text-align:left; color:#3b82f6; margin:5px 0;">You: ${i.value}</div>`;
            setTimeout(() => {
                let rep = "ØªØ­Øª Ø£Ù…Ø±Ùƒ ÙŠØ§ Ø±ÙŠØ³.";
                if(i.value.includes('Ø¯Ø®Ù„')) rep = `Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…: ${document.getElementById('statRevenue').innerText}`;
                b.innerHTML += `<div style="text-align:right; color:#f59e0b; margin:5px 0;">AI: ${rep}</div>`;
                b.scrollTop = b.scrollHeight;
            }, 600);
            i.value = "";
        }
    </script>
</body>
</html>
