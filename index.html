<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter Pro Control</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #00d2ff; --err: #ff4b2b; --ok: #00f2fe; --bg: #0b1120; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; }
        .hidden { display: none !important; }
        .admin-panel { background: #0f172a; border: 1px solid var(--p); border-radius: 20px; padding: 20px; margin: 15px; }
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; align-items: center; }
        .status-on { width: 10px; height: 10px; background: #00ff00; border-radius: 50%; display: inline-block; box-shadow: 0 0 10px #00ff00; }
        .btn-kick { background: var(--err); color: #fff; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-block { background: #000; color: var(--err); border: 1px solid var(--err); padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        table { width: 100%; text-align: right; margin-top: 10px; border-collapse: collapse; }
        th { color: var(--p); border-bottom: 2px solid #333; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div id="admin-advanced" class="admin-panel admin-only hidden">
        <h3 style="color:var(--ok)"><i class="fas fa-users-cog"></i> Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 15px;">
                <h4><span class="status-on"></span> Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h4>
                <div id="online-users-list"></div>
            </div>

            <div style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 15px;">
                <h4><i class="fas fa-user-slash"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø± (Block)</h4>
                <div id="blocked-users-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§)
        const TG_TOKEN = "7899750780:AAFL31roDUbqFDoP-iUL2dhNn4GtKFAPUD0";
        const TG_CHAT_ID = "5684905593"; 

        function sendToTelegram(msg) {
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${encodeURIComponent(msg)}`);
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. ØªØªØ¨Ø¹ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙˆØ·Ø±Ø¯Ù‡Ù…
        function trackPresence(userType) {
            const myPresenceRef = db.ref(`online_sessions/${userType}`);
            myPresenceRef.set({
                status: "online",
                last_seen: Date.now(),
                ip: "User-Session"
            });

            // Ù„Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø§Ù„Ù…ÙˆØ¸Ù ÙŠØ®Ø±Ø¬ ÙÙˆØ±Ø§Ù‹
            myPresenceRef.on('value', snap => {
                if(!snap.exists()) {
                    alert("Ù„Ù‚Ø¯ ØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!");
                    location.reload();
                }
            });

            myPresenceRef.onDisconnect().remove();
        }

        // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„ÙˆÙƒ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡
        function blockCustomer(phone, name) {
            if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ ${name} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) {
                db.ref(`blacklist/${phone}`).set({ name, date: Date.now() });
                sendToTelegram(`ğŸš« ØªÙ… Ø­Ø¸Ø± Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ø§Ø³Ù…: ${name}\nØ§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ${phone}`);
            }
        }

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
        async function startTrip() {
            const ph = document.getElementById('cust-phone').value;
            const snap = await db.ref(`blacklist/${ph}`).once('value');
            if(snap.exists()) {
                alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…!");
                sendToTelegram(`ğŸš¨ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªØ±Ø§Ù‚! Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ± Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ£Ø¬ÙŠØ±:\n${ph}`);
                return;
            }
            // ÙƒÙˆØ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠ...
        }

        // 4. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ù„Ù„Ø£Ø¯Ù…Ù†
        db.ref('online_sessions').on('value', snap => {
            const list = document.getElementById('online-users-list');
            list.innerHTML = "";
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([user, data]) => {
                    list.innerHTML += `
                        <div class="user-row">
                            <span><span class="status-on"></span> ${user}</span>
                            <button class="btn-kick" onclick="db.ref('online_sessions/${user}').remove()">Ø®Ø±ÙˆØ¬</button>
                        </div>`;
                });
            }
        });

        // 5. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø± Ù„Ù„Ø£Ø¯Ù…Ù†
        db.ref('blacklist').on('value', snap => {
            const list = document.getElementById('blocked-users-list');
            list.innerHTML = "";
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([ph, data]) => {
                    list.innerHTML += `
                        <div class="user-row">
                            <span style="color:var(--err)">${data.name} (${ph})</span>
                            <button class="btn-kick" style="background:#444" onclick="db.ref('blacklist/${ph}').remove()">ÙÙƒ Ø­Ø¸Ø±</button>
                        </div>`;
                });
            }
        });

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // App.login() -> trackPresence(userRole);
    </script>
</body>
</html>
