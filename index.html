<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Titan Dashboard</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --blue: #00f2ff; --bg: #000; --card: #0d0d0d; --red: #ff0055; --green: #0aff60; --border: rgba(0, 242, 255, 0.1); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin:0; padding:0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* Sidebar & Layout */
        .dashboard-container { display: flex; height: 100vh; }
        .sidebar { width: 260px; background: #050505; border-left: 1px solid #111; padding: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }

        /* Cards & KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 20px; text-align: center; border-bottom: 3px solid var(--blue); }
        .kpi-card small { color: #666; font-size: 11px; }
        .kpi-card h3 { font-family: 'Rajdhani'; color: var(--blue); font-size: 24px; }

        /* Forms */
        .glass-box { background: #080808; border: 1px solid #1a1a1a; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        input, select { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 12px; margin-bottom: 10px; text-align: center; }
        input:focus { border-color: var(--blue); }

        /* Buttons */
        .btn { padding: 12px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 14px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-blue { background: var(--blue); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: var(--red); border: 1px solid var(--red); }
        .btn-green { background: rgba(10,255,96,0.1); color: var(--green); border: 1px solid var(--green); }

        /* Active Trips Table */
        .live-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #050505; border-radius: 15px; overflow: hidden; }
        .live-table th { background: #111; padding: 12px; color: #555; font-size: 12px; }
        .live-table td { padding: 12px; text-align: center; border-bottom: 1px solid #111; }
        .timer-badge { font-family: 'Rajdhani'; color: var(--green); font-weight: bold; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .sidebar { position: fixed; right: -100%; z-index: 1000; height: 100%; }
            .sidebar.active { right: 0; }
            .kpi-row { grid-template-columns: 1fr 1fr; }
        }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© -->
    <div id="login-overlay">
        <h1 style="font-family:'Rajdhani'; font-size: 40px; color: var(--blue); margin-bottom: 10px;">TITAN DASHBOARD</h1>
        <p style="color: #444; font-size: 12px; letter-spacing: 2px; margin-bottom: 30px;">GLOBAL COMMAND CENTER</p>
        <input type="password" id="pin" placeholder="ENTER ACCESS CODE" style="width: 300px; font-size: 24px;">
        <button class="btn btn-blue" onclick="App.login()" style="width: 300px;">INITIALIZE</button>
    </div>

    <!-- 2. Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div id="app-shell" class="dashboard-container hidden">
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h2 style="color:var(--blue); font-family:'Rajdhani'; margin-bottom:30px;">COMMANDS</h2>
            <nav style="flex:1">
                <div style="padding:15px; cursor:pointer" onclick="App.nav('ops')"><i class="fas fa-bolt"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</div>
                <div style="padding:15px; cursor:pointer" onclick="App.nav('stats')"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ùˆ AI</div>
                <div style="padding:15px; cursor:pointer" onclick="App.nav('archive')"><i class="fas fa-history"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ…</div>
            </nav>
            <button class="btn btn-danger" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </aside>

        <!-- Main Area -->
        <main class="main-content">
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div onclick="App.toggleSidebar()" style="font-size:20px; color:var(--blue); cursor:pointer;"><i class="fas fa-bars"></i></div>
                <div id="role-label" style="font-family:'Rajdhani'; font-weight:900; letter-spacing:1px; color:var(--blue)">ADMIN CENTER</div>
                <div id="clock" style="font-family:'Rajdhani'; color:#666;">00:00:00</div>
            </header>

            <!-- KPIs -->
            <div class="kpi-row">
                <div class="kpi-card" id="vault-card"><small>Ø§Ù„Ø¯Ø±Ø¬ (Ø§Ù„ØµØ§ÙÙŠ)</small><h3 id="vault-val">0.00</h3></div>
                <div class="kpi-card"><small>Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</small><h3 id="active-val">0</h3></div>
                <div class="kpi-card"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</small><h3 id="count-val">0</h3></div>
            </div>

            <!-- Section: Operations -->
            <div id="sec-ops" class="viewport">
                <div class="glass-box">
                    <h4 style="margin-bottom:15px; color:var(--blue)">ğŸš€ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="text" id="c-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                        <input type="text" id="s-num" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                    </div>
                    <label style="font-size:11px; color:#555">ğŸªª ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</label>
                    <input type="file" accept="image/*" capture="camera" onchange="App.handleImg(this)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-blue" onclick="App.startTrip()">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
                        <button class="btn btn-green" onclick="App.setT('start-input')">Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†</button>
                    </div>
                </div>

                <h4 style="color:var(--blue); margin-bottom:10px;">ğŸ›µ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:</h4>
                <div id="active-grid"></div>
            </div>

            <!-- Section: Stats & AI -->
            <div id="sec-stats" class="viewport hidden">
                <div class="glass-box" style="border-color:var(--blue)">
                    <label>ğŸ” Ø¨Ø­Ø« Ø£Ø¯Ø§Ø¡ Ø³ÙƒÙˆØªØ± Ù…Ø­Ø¯Ø¯:</label>
                    <input type="text" id="search-box" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±..." oninput="App.filterStats()">
                    <div class="kpi-row" style="margin-top:10px;">
                        <div class="kpi-card" style="padding:10px"><small>Ø¯Ù‚Ø§Ø¦Ù‚</small><h3 id="res-mins">0</h3></div>
                        <div class="kpi-card" style="padding:10px"><small>ÙÙ„ÙˆØ³</small><h3 id="res-cash">0</h3></div>
                    </div>
                </div>
                <div id="ai-insight" class="glass-box" style="background:linear-gradient(45deg, #1a0033, #000); border-color:#a29bfe">
                    <h4 style="color:#a29bfe">ğŸ¤– Yalla AI Analysis:</h4>
                    <p id="ai-text" style="font-size:12px; color:#ccc; margin-top:5px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                </div>
            </div>

            <!-- Section: Archive -->
            <div id="sec-archive" class="viewport hidden">
                <input type="date" id="archive-date" onchange="App.loadHistory()">
                <table class="live-table">
                    <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
                <button class="btn btn-danger" style="margin-top:20px; font-size:10px;" onclick="App.clearVault()">ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø±Ø¬</button>
            </div>

        </main>
    </div>

<script>
    const App = {
        db: null, role: '', trips: [], img: '',

        init: function() {
            firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
            this.db = firebase.database();
            this.sync();
            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); }, 1000);
        },

        login: function() {
            const pin = document.getElementById('pin').value;
            if(pin === "9924") { this.role = 'admin'; }
            else if(pin === "1213") { this.role = 'staff'; document.getElementById('vault-card').classList.add('hidden'); }
            else if(pin === "1214") { return this.registerNode(); }
            else return alert("ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!");

            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-shell').classList.remove('hidden');
            this.init();
        },

        registerNode: function() {
            Swal.fire({ title: 'ØªØ³Ø¬ÙŠÙ„ Ø³ÙƒÙˆØªØ± Ø¬Ø¯ÙŠØ¯', input: 'text', inputPlaceholder: 'Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±...' }).then(r => {
                if(r.value) {
                    firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
                    firebase.database().ref('fleet/' + r.value).set({ name: r.value, status: 'Online' });
                    Swal.fire('ØªÙ…!', 'Ø§Ù„Ø³ÙƒÙˆØªØ± Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'success');
                }
            });
        },

        nav: function(id) {
            document.querySelectorAll('.viewport').forEach(v => v.classList.add('hidden'));
            document.getElementById('sec-' + id).classList.remove('hidden');
            this.toggleSidebar();
        },

        toggleSidebar: () => document.getElementById('sidebar').classList.toggle('active'),

        handleImg: function(input) {
            if (input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => { this.img = e.target.result; };
                r.readAsDataURL(input.files[0]);
            }
        },

        startTrip: function() {
            const scoot = document.getElementById('s-num').value;
            const name = document.getElementById('c-name').value;
            if(!scoot || !name) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            this.db.ref('active_trips/' + scoot).set({ scooter: scoot, customer: name, start: Date.now(), photo: this.img });
            document.getElementById('s-num').value = ""; document.getElementById('c-name').value = "";
        },

        finishTrip: function(scoot, start) {
            const mins = Math.max(0, Math.floor((Date.now() - start) / 60000)) || 0;
            const cost = mins * 2;
            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø§Ù„Ø³ÙƒÙˆØªØ±: ${scoot} | Ø§Ù„ÙˆÙ‚Øª: ${mins}Ø¯ <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬.Ù…</b> <br><input id="disc" type="number" class="swal2-input" placeholder="Ø®ØµÙ…ØŸ">`,
                confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸'
            }).then(r => {
                if(r.isConfirmed) {
                    const d = parseFloat(document.getElementById('disc').value || 0);
                    const final = Math.max(0, cost - d);
                    const day = new Date().toISOString().split('T')[0];
                    this.db.ref('history/' + day).push({ scooter: scoot, final, mins, timestamp: Date.now(), staff: localStorage.getItem('yStaff') });
                    this.db.ref('vault').transaction(v => (v || 0) + final);
                    this.db.ref('active_trips/' + scoot).remove();
                }
            });
        },

        remoteCmd: function(scoot, act) {
            this.db.ref('commands/' + scoot).set({ action: act, time: Date.now() });
            Swal.fire('ØªÙ…', `Ø£Ø±Ø³Ù„Øª Ø£Ù…Ø± ${act} Ù„Ù€ ${scoot}`, 'info');
        },

        sync: function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('archive-date').value = today;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¨Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­ÙƒÙ…
            this.db.ref('active_trips').on('value', snap => {
                const list = document.getElementById('active-grid');
                list.innerHTML = ""; let count = 0;
                snap.forEach(c => {
                    count++; const t = c.val();
                    const m = Math.floor((Date.now() - t.start) / 60000);
                    list.innerHTML += `
                        <div class="glass-box" style="border-right: 4px solid var(--green)">
                            <div style="display:flex; justify-content:space-between">
                                <b>ğŸ›µ Ø¥Ø³ÙƒÙˆØªØ± ${t.scooter}</b> <span>${t.customer}</span>
                            </div>
                            <div class="timer-badge" style="text-align:center; font-size:30px; margin:10px 0;">${m} MIN</div>
                            <div class="grid" style="display:flex; gap:5px;">
                                <button class="btn btn-blue" onclick="App.finishTrip('${t.scooter}', ${t.start})">Ø¥Ù†Ù‡Ø§Ø¡</button>
                                <button class="btn btn-green" onclick="App.remoteCmd('${t.scooter}','UNLOCK')">ğŸ”“</button>
                                <button class="btn btn-danger" onclick="App.remoteCmd('${t.scooter}','LOCK')">ğŸ”’</button>
                            </div>
                        </div>`;
                });
                document.getElementById('active-val').innerText = count;
                this.runAI(count);
            });

            this.db.ref('vault').on('value', s => document.getElementById('vault-val').innerText = (s.val()||0).toFixed(2));
            this.loadHistory();
        },

        loadHistory: function() {
            const d = document.getElementById('archive-date').value;
            this.db.ref('history/' + d).on('value', snap => {
                const body = document.getElementById('history-body'); body.innerHTML = "";
                this.trips = []; let total = 0;
                snap.forEach(c => {
                    const h = c.val(); this.trips.push(h);
                    body.innerHTML += `<tr><td>${h.scooter}</td><td>${h.mins}Ø¯</td><td>${h.final}Ø¬</td><td>${h.staff||'--'}</td></tr>`;
                    total += parseFloat(h.final || 0);
                });
                document.getElementById('count-val').innerText = this.trips.length;
            });
        },

        filterStats: function() {
            const s = document.getElementById('search-box').value.trim().toUpperCase();
            let m = 0, c = 0;
            this.trips.forEach(t => { if(t.scooter.toUpperCase().includes(s) && s !== "") { m += t.mins; c += t.final; } });
            document.getElementById('res-mins').innerText = m;
            document.getElementById('res-cash').innerText = c.toFixed(2);
        },

        runAI: function(active) {
            const msg = active > 3 ? "ğŸ”¥ Ø¶ØºØ· Ø¹Ù…Ù„ Ù…Ø±ØªÙØ¹: ÙŠØ±Ø¬Ù‰ ØªØ¬Ù‡ÙŠØ² ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø´Ø­Ù†." : "ğŸŸ¢ Ø§Ù„ÙˆØ¶Ø¹ Ù…Ø³ØªÙ‚Ø±: ÙˆÙ‚Øª Ø¬ÙŠØ¯ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©.";
            document.getElementById('ai-text').innerText = msg;
        },

        clearVault: () => { if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø±Ø¬ØŸ")) App.db.ref('vault').set(0); }
    };
</script>
</body>
</html>
