<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Titan V88 | Ultra Diamond Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00f2ff;
            --accent: #7000ff;
            --bg-dark: #020205;
            --card-bg: rgba(20, 20, 25, 0.8);
            --glass: rgba(255, 255, 255, 0.05);
            --success: #00ff88;
            --danger: #ff0055;
            --gold: #ffc107;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-dark); color: #fff; margin: 0; overflow: hidden; height: 100vh; }

        /* --- Animations --- */
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 242, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- Auth Screen --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #101025 0%, #020205 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .auth-box {
            width: 90%; max-width: 400px; padding: 40px;
            background: var(--card-bg); border-radius: 30px;
            border: 1px solid var(--glass); backdrop-filter: blur(20px);
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .auth-box h1 { font-family: 'Orbitron'; font-size: 35px; color: var(--primary); margin-bottom: 10px; letter-spacing: 2px; }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
        .pin-btn { background: var(--glass); border: 1px solid var(--glass); color: #fff; padding: 20px; border-radius: 15px; font-size: 20px; cursor: pointer; }
        .pin-btn:active { background: var(--primary); color: #000; }

        /* --- Global Dashboard Layout --- */
        #main-wrapper { display: none; height: 100vh; grid-template-columns: 280px 1fr; }
        
        /* Sidebar */
        .sidebar {
            background: rgba(10, 10, 15, 0.95); border-left: 1px solid var(--glass);
            display: flex; flex-direction: column; padding: 30px 20px;
        }
        .nav-link {
            padding: 15px 20px; border-radius: 15px; color: #888; text-decoration: none;
            display: flex; align-items: center; gap: 15px; margin-bottom: 10px; font-weight: 600;
        }
        .nav-link.active { background: linear-gradient(90deg, var(--accent), var(--primary)); color: #fff; box-shadow: 0 10px 20px rgba(112, 0, 255, 0.3); }

        /* Main View */
        .content-area { flex: 1; overflow-y: auto; padding: 30px; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }
        
        /* KPI Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--card-bg); padding: 25px; border-radius: 25px;
            border: 1px solid var(--glass); position: relative; overflow: hidden;
        }
        .stat-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(0,242,255,0.05) 0%, transparent 70%); }
        .stat-card h3 { color: #888; font-size: 14px; margin: 0; }
        .stat-card .val { font-family: 'Orbitron'; font-size: 30px; color: #fff; margin-top: 10px; display: block; }

        /* Trip Cards */
        .trips-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .trip-card {
            background: var(--card-bg); border-radius: 25px; border: 1px solid var(--glass);
            padding: 20px; transition: 0.4s; position: relative;
        }
        .trip-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .trip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .scooter-tag { background: var(--primary); color: #000; padding: 5px 15px; border-radius: 10px; font-weight: 900; font-family: 'Orbitron'; }
        
        .timer-display {
            font-family: 'Orbitron'; font-size: 45px; text-align: center; 
            margin: 15px 0; color: var(--primary); text-shadow: 0 0 20px rgba(0,242,255,0.3);
        }

        .img-preview {
            width: 100%; height: 180px; border-radius: 15px; object-fit: cover;
            cursor: pointer; border: 1px solid var(--glass); margin-bottom: 15px;
        }

        /* Buttons */
        .btn-action {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-main { background: linear-gradient(135deg, var(--accent), var(--primary)); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--danger); color: var(--danger); }

        /* Scooter HUD Mode */
        #scooter-hud {
            display: none; position: fixed; inset: 0; background: #000; z-index: 10000;
            flex-direction: column; align-items: center; justify-content: space-between; padding: 50px 20px;
        }
        .speedometer {
            width: 300px; height: 300px; border: 15px solid var(--glass);
            border-top-color: var(--primary); border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: pulse 2s infinite;
        }
        .speed-num { font-family: 'Orbitron'; font-size: 100px; font-weight: 900; color: #fff; }

        @media (max-width: 768px) {
            #main-wrapper { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* ÙŠÙØ¶Ù„ Ø¥Ø¶Ø§ÙØ© Menu Ù„Ù„Ù‡Ø§ØªÙ */
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1>TITAN CORE</h1>
            <p style="color: #666; font-weight: bold;">DIAMOND EDITION V88</p>
            <div id="pin-display" style="font-size: 40px; color: var(--primary); letter-spacing: 10px; margin: 20px 0;">****</div>
            <div class="pin-grid">
                <button class="pin-btn" onclick="pressPin(1)">1</button>
                <button class="pin-btn" onclick="pressPin(2)">2</button>
                <button class="pin-btn" onclick="pressPin(3)">3</button>
                <button class="pin-btn" onclick="pressPin(4)">4</button>
                <button class="pin-btn" onclick="pressPin(5)">5</button>
                <button class="pin-btn" onclick="pressPin(6)">6</button>
                <button class="pin-btn" onclick="pressPin(7)">7</button>
                <button class="pin-btn" onclick="pressPin(8)">8</button>
                <button class="pin-btn" onclick="pressPin(9)">9</button>
                <button class="pin-btn" onclick="pressPin('C')">C</button>
                <button class="pin-btn" onclick="pressPin(0)">0</button>
                <button class="pin-btn" onclick="handleLogin()"><i class="fas fa-check"></i></button>
            </div>
        </div>
    </div>

    <div id="scooter-hud">
        <div class="speedometer">
            <span class="speed-num" id="live-speed">0</span>
            <span style="color: var(--primary); letter-spacing: 5px;">KM/H</span>
        </div>
        <div style="text-align: center;">
            <h2 id="hud-unit-name" style="font-family:'Orbitron'; color: var(--primary); font-size: 40px;">UNIT-01</h2>
            <div style="display: flex; gap: 30px; margin-top: 20px;">
                <span style="font-size: 20px;">ğŸ”‹ <span id="hud-battery">--%</span></span>
                <span style="font-size: 20px;">ğŸ›°ï¸ <span style="color: var(--success);">ONLINE</span></span>
            </div>
        </div>
        <button class="btn-action btn-outline" style="width: 200px;" onclick="location.reload()">LOGOUT</button>
    </div>

    <div id="main-wrapper">
        <aside class="sidebar">
            <div style="font-family: 'Orbitron'; font-size: 24px; color: var(--primary); margin-bottom: 50px; text-align: center;">TITAN V88</div>
            <nav>
                <a href="#" class="nav-link active" onclick="showSec('ops')"><i class="fas fa-bolt"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©</a>
                <a href="#" class="nav-link" onclick="showSec('fleet')"><i class="fas fa-map-location-dot"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</a>
                <a href="#" class="nav-link" onclick="showSec('stats')"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
                <a href="#" class="nav-link" onclick="showSec('archive')"><i class="fas fa-history"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ</a>
            </nav>
            <div style="margin-top: auto; padding: 20px; background: var(--glass); border-radius: 20px;">
                <small style="color: #666;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</small>
                <div id="vault-total" style="font-family:'Orbitron'; font-size: 25px; color: var(--gold);">0.00 EGP</div>
            </div>
        </aside>

        <main class="content-area">
            <section id="sec-ops" class="dash-sec">
                <div class="stats-grid">
                    <div class="stat-card"><h3>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3><span class="val" id="kpi-active">0</span></div>
                    <div class="stat-card"><h3>Ø³ÙƒÙˆØªØ± Ù…ØªØ§Ø­</h3><span class="val" id="kpi-online">0</span></div>
                    <div class="stat-card"><h3>Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3><span class="val" id="kpi-today">0</span></div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="font-weight: 900;">âš¡ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                    <button class="btn-action btn-main" style="width: 250px;" onclick="initiateNewTrip()">
                        <i class="fas fa-plus-circle"></i> Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>

                <div id="active-trips-list" class="trips-container">
                    </div>
            </section>

            <section id="sec-fleet" class="dash-sec" style="display:none;">
                <div id="map-canvas" style="width: 100%; height: 500px; border-radius: 30px; border: 1px solid var(--glass);"></div>
                <div id="fleet-status-grid" class="stats-grid" style="margin-top: 20px;"></div>
            </section>
        </main>
    </div>

    <script>
        // --- Configuration ---
        const FB_CONFIG = {
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            storageBucket: "yalla-scooter-pro.appspot.com"
        };
        firebase.initializeApp(FB_CONFIG);
        const db = firebase.database();
        const storage = firebase.storage();

        let currentPin = "";
        let myUnitName = "";
        let fleetData = {};

        // --- Auth Logic ---
        function pressPin(n) {
            if(n === 'C') currentPin = "";
            else if(currentPin.length < 4) currentPin += n;
            document.getElementById('pin-display').innerText = "*".repeat(currentPin.length) || "****";
        }

        function handleLogin() {
            if(currentPin === "1214") {
                Swal.fire({ title: 'Ù…Ø¹Ø±Ù Ø§Ù„Ø³ÙƒÙˆØªØ±', input: 'text', inputPlaceholder: 'Ù…Ø«Ø§Ù„: TITAN-01' }).then(r => {
                    if(r.value) {
                        myUnitName = r.value;
                        startScooterMode();
                    }
                });
            } else if(currentPin === "1213" || currentPin === "9924") {
                startAdminMode();
            } else {
                Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù…Ø²');
                currentPin = "";
            }
        }

        // --- Image Compression (The Fix for Upload Issues) ---
        async function processImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 1000;
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7);
                    };
                };
            });
        }

        // --- Admin Operations ---
        function startAdminMode() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-wrapper').style.display = 'grid';
            
            // Listeners
            db.ref('active_trips').on('value', snap => renderTrips(snap.val() || {}));
            db.ref('vault_total').on('value', snap => document.getElementById('vault-total').innerText = (snap.val() || 0).toFixed(2) + " EGP");
            db.ref('fleet_online').on('value', snap => {
                fleetData = snap.val() || {};
                document.getElementById('kpi-online').innerText = Object.keys(fleetData).length;
            });
        }

        async function initiateNewTrip() {
            let options = "";
            for(let key in fleetData) options += `<option value="${key}">${key}</option>`;

            const { value: formValues } = await Swal.fire({
                title: 'ØªØ¬Ù‡ÙŠØ² Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                background: '#101015',
                color: '#fff',
                html: `
                    <select id="s-unit" class="swal2-input">${options}</select>
                    <input id="s-phone" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input id="s-id" type="file" accept="image/*" class="swal2-file">
                `,
                preConfirm: () => {
                    return {
                        unit: document.getElementById('s-unit').value,
                        phone: document.getElementById('s-phone').value,
                        file: document.getElementById('s-id').files[0]
                    }
                }
            });

            if(formValues && formValues.file) {
                Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                try {
                    const compressed = await processImage(formValues.file);
                    const fileName = `id_${Date.now()}.jpg`;
                    const ref = storage.ref().child('customers/' + fileName);
                    
                    // Ø§Ù„Ø±ÙØ¹ Ù…Ø¹ Metadata
                    await ref.put(compressed);
                    const url = await ref.getDownloadURL();

                    db.ref('active_trips').push({
                        scooterId: formValues.unit,
                        phone: formValues.phone,
                        photo: url,
                        startTime: Date.now(),
                        status: 'running'
                    });
                    
                    Swal.fire('ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ âœ…', '', 'success');
                } catch (e) {
                    Swal.fire('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹!', e.message, 'error');
                }
            }
        }

        function renderTrips(data) {
            const container = document.getElementById('active-trips-list');
            container.innerHTML = "";
            let count = 0;

            for(let id in data) {
                count++;
                const t = data[id];
                const mins = Math.floor((Date.now() - t.startTime) / 60000);
                
                container.innerHTML += `
                    <div class="trip-card">
                        <div class="trip-header">
                            <span class="scooter-tag">${t.scooterId}</span>
                            <span style="color: #666;">${t.phone}</span>
                        </div>
                        <img src="${t.photo}" class="img-preview" onclick="window.open('${t.photo}')">
                        <div class="timer-display" data-start="${t.startTime}">${mins}</div>
                        <div style="text-align:center; color:#888; margin-bottom:15px;">Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø³ØªÙ‡Ù„ÙƒØ©</div>
                        <button class="btn-action btn-main" onclick="closeTrip('${id}')">ØªØ­ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡</button>
                    </div>
                `;
            }
            document.getElementById('kpi-active').innerText = count;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        setInterval(() => {
            document.querySelectorAll('.timer-display').forEach(el => {
                const start = el.getAttribute('data-start');
                el.innerText = Math.floor((Date.now() - start) / 60000);
            });
        }, 30000);

        // --- Scooter Mode (HUD) ---
        function startScooterMode() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('scooter-hud').style.display = 'flex';
            document.getElementById('hud-unit-name').innerText = myUnitName;

            const unitRef = db.ref('fleet_online/' + myUnitName);
            unitRef.onDisconnect().remove();

            navigator.geolocation.watchPosition(pos => {
                const speed = Math.round((pos.coords.speed || 0) * 3.6);
                document.getElementById('live-speed').innerText = speed;
                unitRef.update({
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude,
                    speed: speed,
                    lastSeen: Date.now()
                });
            }, null, { enableHighAccuracy: true });

            navigator.getBattery?.().then(b => {
                const updateBatt = () => {
                    const level = Math.round(b.level * 100);
                    document.getElementById('hud-battery').innerText = level + "%";
                    unitRef.child('batt').set(level);
                };
                updateBatt();
                b.onlevelchange = updateBatt;
            });
        }

        function showSec(id) {
            document.querySelectorAll('.dash-sec').forEach(s => s.style.display = 'none');
            document.getElementById('sec-' + id).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ØªØ¹Ù…Ù„
        if ('wakeLock' in navigator) {
            setInterval(() => { navigator.wakeLock.request('screen').catch(()=>{}); }, 20000);
        }

    </script>
</body>
</html>
