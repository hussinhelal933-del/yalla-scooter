<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Command V30 | The Master Tactical OS</title>
    
    <!-- Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #020617;
            --panel-bg: #0f172a;
            --sidebar-bg: #070d19;
            --primary: #2dd4bf;
            --accent: #3b82f6;
            --danger: #f43f5e;
            --warn: #fbbf24;
            --text-main: #f1f5f9;
            --border-ui: #1e293b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.2s; outline: none; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar Premium --- */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-left: 1px solid var(--border-ui); display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-brand { padding: 30px; text-align: center; border-bottom: 1px solid var(--border-ui); }
        .sidebar-brand h1 { font-family: 'Orbitron'; font-size: 22px; color: var(--primary); margin: 0; text-shadow: 0 0 10px var(--primary); }
        
        .nav-list { flex: 1; padding: 20px 0; overflow-y: auto; }
        .nav-item { padding: 16px 30px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #64748b; font-weight: 700; }
        .nav-item:hover, .nav-item.active { background: rgba(45, 212, 191, 0.05); color: var(--primary); border-right: 4px solid var(--primary); }
        .nav-item i { width: 25px; font-size: 18px; }

        /* --- Main Viewport --- */
        .viewport { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 20px; background: radial-gradient(circle at top right, #0f172a, transparent); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-ui); padding-bottom: 15px; }
        .clock-digital { font-family: 'Orbitron'; font-size: 24px; color: var(--primary); }

        .dashboard-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeInUp 0.4s ease forwards; }

        /* --- KPI Widgets (Like the PPT Slide) --- */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--panel-bg); border: 1px solid var(--border-ui); border-radius: 12px; padding: 15px; text-align: center; }
        .kpi-card .val { font-family: 'Orbitron'; font-size: 26px; color: var(--primary); display: block; }
        .kpi-card .label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }

        /* --- Active Fleet Radar --- */
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .unit-card { background: var(--panel-bg); border: 1px solid var(--border-ui); border-radius: 20px; padding: 25px; position: relative; }
        .unit-card.paused { border-style: dashed; border-color: var(--warn); }
        .unit-id { font-family: 'Orbitron'; font-size: 18px; color: var(--primary); border-bottom: 1px solid var(--border-ui); padding-bottom: 10px; margin-bottom: 15px; }
        .timer-main { font-family: 'Orbitron'; font-size: 44px; text-align: center; color: #fff; margin: 15px 0; }
        .id-photo-box { width: 100%; height: 140px; border-radius: 12px; object-fit: cover; border: 2px solid var(--border-ui); cursor: pointer; }

        /* --- Tables --- */
        .master-table { width: 100%; border-collapse: collapse; background: var(--panel-bg); border-radius: 15px; overflow: hidden; font-size: 13px; }
        .master-table th { background: rgba(0,0,0,0.5); padding: 15px; text-align: right; color: #64748b; border-bottom: 1px solid var(--border-ui); }
        .master-table td { padding: 12px 15px; border-bottom: 1px solid var(--border-ui); }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* --- Buttons --- */
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #020617; width: 100%; }
        .btn-danger { background: var(--danger); color: white; flex:1; }
        .btn-warn { background: var(--warn); color: #000; flex:1; }

        /* --- UI Helpers --- */
        #login-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel-bg); padding: 50px; border-radius: 30px; border: 1px solid var(--border-ui); width: 400px; text-align: center; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Battery Health Color Scale */
        .bat-high { color: var(--primary); }
        .bat-mid { color: var(--warn); }
        .bat-low { color: var(--danger); }
    </style>
</head>
<body>

    <!-- 1. AUTHENTICATION -->
    <div id="login-overlay">
        <div class="auth-card">
            <h1 style="font-family:Orbitron; color:var(--primary); letter-spacing: 5px; margin-bottom: 40px;">AUTHORIZE ACCESS</h1>
            <input type="password" id="passInput" style="width:100%; padding:20px; background:#000; border:1px solid var(--border-ui); color:var(--primary); font-size:32px; text-align:center; border-radius:15px; margin-bottom: 30px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary" style="padding:18px; font-size: 18px;">ENTER COMMAND</button>
        </div>
    </div>

    <!-- 2. SIDEBAR -->
    <nav class="sidebar">
        <div class="sidebar-brand"><h1>YALLA COMMAND</h1></div>
        <div class="nav-list">
            <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-satellite-dish"></i> <span class="nav-text">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø±Ø­Ù„Ø§Øª</span></div>
            <div class="nav-item" onclick="nav('fleet')"><i class="fas fa-motorcycle"></i> <span class="nav-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</span></div>
            <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users-shield"></i> <span class="nav-text">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></div>
            <div class="nav-item" onclick="nav('charge')"><i class="fas fa-plug"></i> <span class="nav-text">Ø±ØµÙŠÙ Ø§Ù„Ø´Ø­Ù†</span></div>
            <div class="nav-item" onclick="nav('maint')"><i class="fas fa-tools"></i> <span class="nav-text">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ø­Ø¶ÙˆØ±</span></div>
            <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-shield-check"></i> <span class="nav-text">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></div>
        </div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger)" onclick="location.reload()"><i class="fas fa-power-off"></i> <span class="nav-text">Ø®Ø±ÙˆØ¬</span></div>
    </nav>

    <!-- 3. MAIN CONTENT -->
    <main class="viewport">
        <div class="top-bar">
            <h2 id="section-title" style="margin:0; font-weight:900;">Ù…Ø±ÙƒØ² Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù„Ø­Ø¸ÙŠ</h2>
            <div class="clock-digital" id="clock">00:00:00</div>
        </div>

        <div class="dashboard-scroll">
            
            <!-- GLOBAL KPI SUMMARY -->
            <div class="kpi-row">
                <div class="kpi-card"><span class="label">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span><span class="val" id="k-active">0</span></div>
                <div class="kpi-card"><span class="label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</span><span class="val" id="k-rev">0</span></div>
                <div class="kpi-card"><span class="label">ØµØ§ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø©</span><span class="val" style="color:var(--accent)" id="k-safe">0</span></div>
                <div class="kpi-card"><span class="label">ÙŠØ´Ø­Ù†</span><span class="val" style="color:var(--warn)" id="k-charge">0</span></div>
            </div>

            <!-- SECTION: OPERATIONS -->
            <div id="sec-ops" class="section active">
                <button class="btn btn-primary" onclick="startTripFlow()" style="width:100%; margin-bottom:25px; font-size:18px;">+ Ø¨Ø¯Ø¡ Ù…Ù‡Ù…Ø© Ø±Ø³Ù…ÙŠØ© (Ø¥Ù„Ø²Ø§Ù…ÙŠ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©)</button>
                <div id="fleet-monitor" class="fleet-grid"></div>
            </div>

            <!-- SECTION: FLEET MANAGEMENT -->
            <div id="sec-fleet" class="section">
                <div class="kpi-row">
                    <div class="kpi-card"><span class="label">Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©</span><span class="val">98%</span></div>
                    <div class="kpi-card"><span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„</span><span class="val" id="total-fleet-mins">0m</span></div>
                </div>
                <table class="master-table">
                    <thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„</th><th>Ø¢Ø®Ø± Ø¨Ø·Ø§Ø±ÙŠØ©</th><th>Ø§Ù„Ø£ÙˆØ¯ÙˆÙ…ÙŠØªØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                    <tbody id="fleet-table-body"></tbody>
                </table>
            </div>

            <!-- SECTION: CLIENTS -->
            <div id="sec-clients" class="section">
                <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ..." oninput="loadClients(this.value)" style="width:100%; padding:15px; background:#000; color:white; border:1px solid var(--border-ui); border-radius:12px; margin-bottom:20px;">
                <table class="master-table">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ±Ù</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="clients-table-body"></tbody>
                </table>
            </div>

            <!-- SECTION: ADMIN ANALYSIS -->
            <div id="sec-admin" class="section">
                <div style="background:var(--panel-bg); border:1px solid var(--border-ui); border-radius:15px; padding:20px; height:350px; margin-bottom:25px;">
                    <canvas id="mainChart"></canvas>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <input type="date" id="adminDate" onchange="loadAdminHistory(this.value)" style="padding:10px; background:#000; color:white; border:1px solid var(--primary); border-radius:10px;">
                    <div id="adm-summary" style="font-weight:900; font-size:20px; color:var(--primary);">Ø§Ù„ÙŠÙˆÙ…: 0 Ø¬</div>
                </div>
                <table class="master-table">
                    <thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø³Ø¨Ø¨</th></tr></thead>
                    <tbody id="admin-hist-body"></tbody>
                </table>
            </div>

            <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø«Ù„ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚ÙˆÙŠ) -->

        </div>
    </main>

    <script>
        // --- 1. CONFIGURATION & CORE ---
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_COORDS = { lat: 30.0444, lng: 31.2357 };
        const PRICING = { min: 40, base_mins: 15, per_min: 2.66 };

        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();
        let cachedTrips = {};
        let cachedCharge = {};

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG');
            refreshTimers();
        }, 1000);

        // --- 2. AUTH & NAVIGATION ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                if(p === "9924") document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                initRealtimeSync();
            } else { Swal.fire('Error', 'Unauthorized Access Code', 'error'); }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            
            const titles = {ops:'Ù…Ø±ÙƒØ² Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù„Ø­Ø¸ÙŠ', fleet:'Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡', clients:'Ø¯Ù„ÙŠÙ„ Ø¹Ù…Ù„Ø§Ø¡ ÙŠØ§Ù„Ø§ Ø³ÙƒÙˆØªØ±', admin:'Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠ', charge:'Ø±ØµÙŠÙ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø°ÙƒÙŠ', maint:'Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ'};
            document.getElementById('section-title').innerText = titles[id] || 'COMMAND';
            
            if(id === 'clients') loadClients();
            if(id === 'fleet') loadFleetAnalytics();
            if(id === 'admin') { const t = new Date().toISOString().split('T')[0]; document.getElementById('adminDate').value = t; loadAdminHistory(t); initMainChart(); }
        }

        // --- 3. TRIP ENGINE (THE COMMANDER) ---
        async function startTripFlow() {
            const { value: res } = await Swal.fire({
                title: 'ØªØ®ØµÙŠØµ Ù…Ù‡Ù…Ø© ØªÙƒØªÙŠÙƒÙŠØ©',
                html: `
                    <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="liveClientAudit(this.value)">
                    <div id="c-audit" style="font-size:11px; margin-top:5px;"></div>
                    <input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                    <input id="sw-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© %">
                    <input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <p style="font-size:12px; margin-top:10px; color:var(--danger)">Ø¥Ù„Ø²Ø§Ù…ÙŠ: ØªØµÙˆÙŠØ± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†</p>
                    <input id="sw-img" type="file" accept="image/*" capture="environment" class="swal2-file">
                `,
                background: '#0f172a', color: '#fff',
                preConfirm: () => {
                    const img = document.getElementById('sw-img').files[0];
                    if(!img) return Swal.showValidationMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©!');
                    return [document.getElementById('sw-ph').value, document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-b').value, document.getElementById('sw-n').value, img]
                }
            });

            if(res) {
                const [ph, s, bat, name, imgFile] = res;
                // ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø±
                const check = await db.ref('clients/'+ph).once('value');
                if(check.exists() && check.val().blocked) return Swal.fire('Ù…Ø±ÙÙˆØ¶!', 'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ± Ø£Ù…Ù†ÙŠØ§Ù‹!', 'error');

                // ÙØ­Øµ ÙØ¬ÙˆØ© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
                const lastSt = await db.ref(`fleet_status/${s}`).once('value');
                const lastKnownBat = lastSt.val()?.battery || 100;
                if(lastKnownBat - bat > 5) broadcastTG(`ğŸš¨ <b>Ø®Ø±Ù‚ Ø£Ù…Ù†ÙŠ / ØªÙ„Ø§Ø¹Ø¨!</b>\nØ§Ù„Ø³ÙƒÙˆØªØ± ${s} ØªÙ… ÙØªØ­Ù‡ Ø¨Ù€ ${bat}% (Ø§Ù„Ù…Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹ ${lastKnownBat}%)\nÙ‡Ù†Ø§Ùƒ ÙØ¬ÙˆØ© Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø©!`);

                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref('active_trips').push({ 
                        phone:ph, scooter:s, startBat:bat, client:name||'Ø²Ø§Ø¦Ø±', 
                        idPhoto: e.target.result, startTime:Date.now(), status:'active', pausedDuration:0 
                    });
                    broadcastTG(`ğŸš€ <b>Ù…Ù‡Ù…Ø© Ø¨Ø¯Ø£Øª</b>\nØ³ÙƒÙˆØªØ±: ${s}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}\nØ¨Ø·Ø§Ø±ÙŠØ©: ${bat}%`);
                };
                reader.readAsDataURL(imgFile);
            }
        }

        async function terminateTrip(key) {
            const d = cachedTrips[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            let cost = Math.round(mins > 15 ? 40 + (mins - 15) * 2.66 : 40);

            const { value: fin } = await Swal.fire({
                title: 'Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ',
                html: `
                    <h1 style="color:var(--primary); font-size:60px; margin:0;">${cost} Ø¬</h1>
                    <p style="font-weight:bold">Ù…Ø¯Ø© Ø§Ù„Ø±Ø­Ù„Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p><hr style="border-color:#1e293b">
                    <input id="sw-bat" type="number" class="swal2-input" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù† %">
                    <input id="sw-disc" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">
                    <input id="sw-why" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨ / Ø¹Ø·Ù„">
                `,
                background: '#0f172a', color: '#fff', showCancelButton: true,
                preConfirm: () => { return { bat: document.getElementById('sw-bat').value, disc: parseFloat(document.getElementById('sw-disc').value)||0, why: document.getElementById('sw-why').value } }
            });

            if(fin) {
                const final = cost - fin.disc;
                const today = new Date().toISOString().split('T')[0];
                
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, phone:d.phone, mins, cost, disc:fin.disc, final, reason:fin.why, idPhoto: d.idPhoto, time: new Date().toLocaleTimeString() });
                db.ref(`fleet_status/${d.scooter}`).transaction(s => { return { ...s, battery: fin.bat, total_mins: (s?.total_mins||0) + mins } });
                if(d.phone && d.phone !== '0') db.ref(`clients/${d.phone}`).transaction(c => { return { ...c, totalSpend:(c?.totalSpend||0)+final, trips:(c?.trips||0)+1, points:(c?.points||0)+Math.floor(final/20) } });
                
                db.ref('active_trips/'+key).remove();
                broadcastTG(`ğŸ <b>Ø§ÙƒØªÙ…Ø§Ù„ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ•’ ${mins}m\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬\nâœ… Ø§Ù„ØµØ§ÙÙŠ: ${final} Ø¬\nğŸ”‹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${fin.bat}%`);
                Swal.fire('ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„', `Ø§Ù„ØµØ§ÙÙŠ: ${final} Ø¬`, 'success');
            }
        }

        // --- 4. REALTIME SYNC ENGINE ---
        function initRealtimeSync() {
            // Live Trips
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('fleet-monitor'); grid.innerHTML = "";
                cachedTrips = snap.val() || {};
                let count = 0;
                for(let key in cachedTrips) {
                    count++; const d = cachedTrips[key]; const isP = d.status === 'paused';
                    grid.innerHTML += `
                        <div class="unit-card ${isP?'paused':''}">
                            <div class="unit-id">${d.scooter} <span style="float:left; font-size:10px; color:#64748b;">ğŸ”‹ ${d.startBat}%</span></div>
                            <img src="${d.idPhoto}" class="id-photo-box" onclick="Swal.fire({imageUrl:this.src, background:'#000'})">
                            <div class="timer-main" id="timer-${key}">00:00:00</div>
                            <div style="display:flex; gap:10px;">
                                ${!isP ? `<button class="btn btn-warn" onclick="controlTrip('${key}','pause')">ÙˆÙ‚Ù</button>`:`<button class="btn btn-primary" onclick="controlTrip('${key}','resume')">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`}
                                <button class="btn btn-danger" onclick="terminateTrip('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>`;
                }
                document.getElementById('k-active').innerText = count;
            });

            // Financial KPIs
            const today = new Date().toISOString().split('T')[0];
            db.ref(`history/${today}`).on('value', snap => {
                let rev = 0; snap.forEach(x => rev += (x.val().final || 0));
                document.getElementById('k-rev').innerText = rev + " Ø¬";
                updateDigitalSafe();
            });
            db.ref(`expenses/${today}`).on('value', snap => {
                let exp = 0; snap.forEach(x => exp += (x.val().cost || 0));
                updateDigitalSafe(exp);
            });
        }

        function updateDigitalSafe(expenses = 0) {
            const rev = parseInt(document.getElementById('k-rev').innerText) || 0;
            document.getElementById('k-safe').innerText = (rev - expenses) + " Ø¬";
        }

        function refreshTimers() {
            const now = Date.now();
            for(let key in cachedTrips) {
                const d = cachedTrips[key]; const el = document.getElementById(`timer-${key}`); if(!el) continue;
                let diff = (d.status === 'active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
                const s = Math.floor(diff / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }

        // --- 5. DATA TABLES & ANALYSIS ---
        function loadClients(search = "") {
            db.ref('clients').on('value', snap => {
                const tb = document.getElementById('clients-table-body'); tb.innerHTML = "";
                snap.forEach(c => {
                    if(search && !c.key.includes(search)) return;
                    const v = c.val();
                    let rank = v.totalSpend > 1000 ? 'ğŸ‘‘ VIP' : 'ğŸ‘¤ Ø¹Ù…ÙŠÙ„';
                    tb.innerHTML += `<tr><td>${v.name}</td><td>${c.key}</td><td>${rank}</td><td>${v.points||0}</td><td>${v.totalSpend||0} Ø¬</td><td><button onclick="toggleBlock('${c.key}', ${!v.blocked})" class="btn" style="background:${v.blocked?'var(--primary)':'var(--danger)'}; padding:5px 10px;">${v.blocked?'ÙÙƒ':'Ø­Ø¸Ø±'}</button></td></tr>`;
                });
            });
        }

        function loadFleetAnalytics() {
            db.ref('fleet_status').on('value', snap => {
                const tb = document.getElementById('fleet-table-body'); tb.innerHTML = "";
                let totalMins = 0;
                snap.forEach(s => {
                    const v = s.val(); totalMins += (v.total_mins || 0);
                    const km = (v.total_mins * 0.25).toFixed(1);
                    tb.innerHTML += `<tr><td>${s.key}</td><td>${v.total_mins||0}m</td><td class="${v.battery < 30 ? 'bat-low' : 'bat-high'}">${v.battery}%</td><td style="color:var(--accent)">${km} KM</td><td>âœ… Ù…ØªØ§Ø­</td></tr>`;
                });
                document.getElementById('total-fleet-mins').innerText = totalMins + "m";
            });
        }

        function loadAdminHistory(date) {
            db.ref(`history/${date}`).on('value', snap => {
                const tb = document.getElementById('admin-hist-body'); tb.innerHTML = ""; let t = 0;
                snap.forEach(c => { const v = c.val(); t += (v.final||0); tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.client}</td><td>${v.mins}m</td><td>${v.cost}</td><td>${v.final}</td><td>${v.disc}Ø¬ - ${v.reason||'-'}</td></tr>`; });
                document.getElementById('adm-summary').innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t} Ø¬`;
            });
        }

        // --- UTILS ---
        function controlTrip(k, a) {
            if(a==='pause') db.ref(`active_trips/${k}`).update({ status:'paused', pauseStart:Date.now() });
            else db.ref(`active_trips/${k}`).once('value', s => { const d = s.val(); db.ref(`active_trips/${k}`).update({ status:'active', pausedDuration: (d.pausedDuration||0)+(Date.now()-d.pauseStart) }); });
        }
        function broadcastTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }
        async function liveClientAudit(ph) { if(ph.length > 9) { const s = await db.ref('clients/'+ph).once('value'); if(s.
