<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter Pro | Security V29</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb; --dark: #1e293b; --light: #f8fafc;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--light); color: var(--dark); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }

        /* --- Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: #fff; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-card input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 16px; text-align: center; }
        
        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© --- */
        .navbar { background: var(--dark); color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .brand { font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success); }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        .container { padding: 15px; max-width: 800px; margin: 0 auto; width: 100%; }
        
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #fff; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 12px; color: #64748b; }

        /* --- ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø­Ù„Ø§Øª --- */
        .trip-card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-right: 5px solid var(--primary); box-shadow: 0 3px 6px rgba(0,0,0,0.05); position: relative; }
        .trip-card.paused { border-right-color: var(--warning); background: #fffbf0; }
        .timer-display { font-size: 32px; font-weight: 800; font-family: monospace; color: var(--dark); margin: 10px 0; }
        .trip-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; width: 100%; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-dark { background: var(--dark); color: #fff; }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„ÙƒØ§Ù…Ù„Ø© --- */
        #adminPanel { position: fixed; inset: 0; background: #f1f5f9; z-index: 5000; display: none; overflow-y: auto; padding: 20px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 15px; }
        .admin-table { width: 100%; background: #fff; border-radius: 10px; border-collapse: collapse; overflow: hidden; font-size: 13px; }
        .admin-table th { background: var(--dark); color: #fff; padding: 12px; }
        .admin-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

        /* --- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© --- */
        #idPreview { width: 100%; height: 150px; object-fit: contain; border: 2px dashed #cbd5e1; border-radius: 10px; margin: 10px 0; display: none; background: #f8fafc; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø£Ù…Ù†) -->
    <div id="security-screen" class="modal-overlay">
        <div class="modal-card">
            <i class="fas fa-shield-alt" style="font-size: 50px; color: var(--primary); margin-bottom: 15px;"></i>
            <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù† V29</h2>
            <p style="color:#64748b; font-size:12px; margin-bottom:20px;">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ù‡Ø§Ø²</p>
            <input type="password" id="passInput" placeholder="Passcode" inputmode="numeric">
            <button class="btn btn-primary" onclick="checkSecurity()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·) -->
    <div id="setup-screen" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>ğŸ‘‹ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯</h3>
            <p>Ù…Ù† ÙØ¶Ù„Ùƒ Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</p>
            <input type="text" id="staffNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø«Ù„Ø§Ø«ÙŠ)">
            <button class="btn btn-dark" onclick="registerDevice()">Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</button>
        </div>
    </div>

    <!-- 3. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="main-app" class="hidden">
        <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
        <div class="navbar">
            <div class="brand">
                <i class="fas fa-bolt" style="color:var(--warning)"></i> Yalla Scooter
            </div>
            <div style="font-size:12px;">
                ğŸ‘¤ <span id="displayStaffName">...</span> <span class="status-dot"></span>
            </div>
        </div>

        <div class="container">
            <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="stats-bar">
                <div class="stat-box">
                    <div class="stat-num" id="activeCount">0</div>
                    <div class="stat-label">Ø¬Ø§Ø±ÙŠØ©</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="todayIncome">0</div>
                    <div class="stat-label">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                <div class="stat-box" onclick="openAdminAuth()" style="cursor:pointer; background:var(--dark);">
                    <div class="stat-num" style="color:#fff;"><i class="fas fa-user-shield"></i></div>
                    <div class="stat-label" style="color:#94a3b8;">Ø¥Ø¯Ø§Ø±Ø©</div>
                </div>
            </div>

            <!-- Ø²Ø± ØªØ´ØºÙŠÙ„ Ø¬Ø¯ÙŠØ¯ -->
            <button class="btn btn-primary" onclick="document.getElementById('newTripModal').classList.remove('hidden')" style="margin-bottom: 20px; padding: 15px; font-size: 16px;">
                <i class="fas fa-plus-circle"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© -->
            <h3 style="margin-bottom:10px; font-size:14px; color:#64748b;">Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†:</h3>
            <div id="activeTripsList">
                <div style="text-align:center; color:#999; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
            </div>
            
            <!-- Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom:10px; font-size:14px; color:#64748b;">Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…:</h3>
                <div id="historyList" style="background:#fff; border-radius:10px; padding:10px;"></div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© -->
    <div id="newTripModal" class="modal-overlay hidden">
        <div class="modal-card" style="text-align:right;">
            <h3 style="text-align:center; margin-bottom:15px;">ØªØ³Ø¬ÙŠÙ„ Ø±Ø­Ù„Ø©</h3>
            
            <label style="font-size:12px; font-weight:bold;">Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±:</label>
            <input type="text" id="tripScooter" placeholder="Ù…Ø«Ø§Ù„: S1" style="text-transform:uppercase;">
            
            <label style="font-size:12px; font-weight:bold;">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="tel" id="tripPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" oninput="checkClientBase()">
            
            <div id="clientFoundBadge" class="hidden" style="text-align:center; color:var(--success); font-size:12px; margin-bottom:5px;">âœ¨ Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹</div>
            
            <input type="text" id="tripClient" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            
            <!-- Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
            <label class="btn btn-warning" style="margin-top:5px; text-align:center; display:block;">
                <i class="fas fa-camera"></i> ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© / Ø§Ù„Ø¹Ù…ÙŠÙ„
                <input type="file" id="tripImg" accept="image/*" style="display:none" onchange="previewImage(this)">
            </label>
            <img id="idPreview" src="">

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-primary" onclick="startTrip()">Ø¨Ø¯Ø¡</button>
                <button class="btn btn-dark" onclick="closeModal('newTripModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ -->
    <div id="finishModal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
            <div id="finishDetails"></div>
            
            <hr style="margin:15px 0; border-color:#eee;">
            
            <div style="text-align:right; font-size:14px;">
                <label><input type="checkbox" id="hasDamage" onchange="toggleDamageDiv()"> ÙŠÙˆØ¬Ø¯ Ø®ØµÙ… / Ø¹Ø·Ù„</label>
                <div id="damageDiv" class="hidden" style="margin-top:10px;">
                    <input type="text" id="damageReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø·Ù„">
                    <input type="number" id="damageCost" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…" oninput="updateFinalTotal()">
                </div>
            </div>
            
            <h1 id="finalPriceDisplay" style="color:var(--primary); margin:15px 0;">0.00</h1>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" id="confirmFinishBtn">ØªØ­ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡</button>
                <button class="btn btn-dark" onclick="closeModal('finishModal')">ØªØ±Ø§Ø¬Ø¹</button>
            </div>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
    <div id="adminPanel">
        <div class="admin-header">
            <h2>ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <button class="btn btn-dark" style="width:auto; padding:8px 20px;" onclick="document.getElementById('adminPanel').style.display='none'">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div style="background:#fff; padding:15px; border-radius:10px; margin-bottom:20px;">
            <h3>ğŸ”´ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (Live)</h3>
            <table class="admin-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                <tbody id="onlineStaffTable"></tbody>
            </table>
        </div>

        <div style="background:#fff; padding:15px; border-radius:10px;">
            <h3>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ÙƒÙˆØªØ±Ø§Øª</h3>
            <table class="admin-table">
                <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</th><th>Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</th></tr></thead>
                <tbody id="scooterReportTable"></tbody>
            </table>
        </div>
    </div>

    <!-- ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
        const TELEGRAM_TOKEN = "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs"; // Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const TELEGRAM_CHAT_ID = "5684905593"; // Ø§Ù„Ø£ÙŠ Ø¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
        const PRICE_PER_MINUTE = 1; // Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (60 Ø¬Ù†ÙŠÙ‡ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©)
        
        // --- ØªÙ‡ÙŠØ¦Ø© ÙØ§ÙŠØ±Ø¨ÙŠØ³ ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yalla-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.firebasestorage.app",
            messagingSenderId: "185791475252",
            appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let myDeviceId = localStorage.getItem('device_id');
        if (!myDeviceId) {
            myDeviceId = 'dev_' + Date.now() + Math.random().toString(36).substr(2, 5);
            localStorage.setItem('device_id', myDeviceId);
        }
        let myStaffName = localStorage.getItem('staff_name') || "";
        let currentImgBase64 = "";

        // --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ---
        function checkSecurity() {
            const pass = document.getElementById('passInput').value;
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¸Ø± Ø£ÙˆÙ„Ø§Ù‹
            db.ref('banned_devices/' + myDeviceId).once('value', snap => {
                if (snap.exists()) {
                    alert("ğŸš« ØªÙ… Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                    return;
                }

                if (pass === "9924" || pass === "1234") {
                    document.getElementById('security-screen').classList.add('hidden');
                    
                    if (!myStaffName) {
                        document.getElementById('setup-screen').classList.remove('hidden');
                    } else {
                        startShift();
                    }
                } else {
                    alert("âŒ ÙƒÙˆØ¯ Ø®Ø·Ø£");
                }
            });
        }

        function registerDevice() {
            const name = document.getElementById('staffNameInput').value;
            if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…");
            localStorage.setItem('staff_name', name);
            myStaffName = name;
            document.getElementById('setup-screen').classList.add('hidden');
            startShift();
        }

        function startShift() {
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('displayStaffName').innerText = myStaffName;
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
            db.ref('online_staff/' + myDeviceId).set({
                name: myStaffName,
                time: Date.now(),
                status: 'active'
            });
            db.ref('online_staff/' + myDeviceId).onDisconnect().remove();

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ù„Ø­Ø¸ÙŠ
            db.ref('banned_devices/' + myDeviceId).on('value', snap => {
                if(snap.exists()) {
                    alert("â›” ØªÙ… Ø­Ø¸Ø±Ùƒ Ø§Ù„Ø¢Ù†!");
                    location.reload();
                }
            });

            // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ø¬Ø±Ø§Ù… Ø¨Ø§Ù„Ø­Ø¶ÙˆØ±
            sendTelegram(`ğŸŸ¢ <b>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</b>\nØ§Ù„ÙƒØ§Ø¨ØªÙ†: ${myStaffName}\nØ§Ù„Ø³Ø§Ø¹Ø©: ${new Date().toLocaleTimeString('ar-EG')}`);

            initApp();
        }

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª ---
        function initApp() {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            db.ref('active_trips').on('value', snap => {
                const list = document.getElementById('activeTripsList');
                list.innerHTML = "";
                let count = 0;
                
                if (snap.exists()) {
                    const trips = snap.val();
                    Object.keys(trips).forEach(key => {
                        count++;
                        const t = trips[key];
                        list.innerHTML += `
                            <div class="trip-card ${t.status === 'paused' ? 'paused' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <h2 style="margin:0;">${t.scooter}</h2>
                                    <span style="font-size:12px; background:#eee; padding:5px 10px; border-radius:10px;">${t.client}</span>
                                </div>
                                <div class="timer-display" id="timer-${key}">00:00</div>
                                <div class="trip-actions">
                                    <button class="btn btn-warning" onclick="togglePause('${key}', '${t.status}')">
                                        ${t.status === 'paused' ? '<i class="fas fa-play"></i> Ø§Ø³ØªÙƒÙ…Ø§Ù„' : '<i class="fas fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª'}
                                    </button>
                                    <button class="btn btn-danger" onclick="prepareFinish('${key}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨</button>
                                </div>
                                <div style="font-size:10px; color:#aaa; margin-top:5px;">Ø¨ÙˆØ§Ø³Ø·Ø©: ${t.staff}</div>
                            </div>
                        `;
                        updateTimerUI(key, t);
                    });
                } else {
                    list.innerHTML = "<div style='text-align:center; color:#999; padding:20px;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>";
                }
                document.getElementById('activeCount').innerText = count;
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            setInterval(() => {
                db.ref('active_trips').once('value', snap => {
                    if(snap.exists()) {
                        const trips = snap.val();
                        Object.keys(trips).forEach(key => updateTimerUI(key, trips[key]));
                    }
                });
            }, 1000);

            // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…
            loadHistory();
        }

        function startTrip() {
            const scooter = document.getElementById('tripScooter').value.toUpperCase();
            const client = document.getElementById('tripClient').value;
            const phone = document.getElementById('tripPhone').value;
            
            if (!scooter || !client) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            if(phone.length > 5) {
                db.ref('clients/' + phone).set({ name: client, phone: phone, img: currentImgBase64 });
            }

            const tripData = {
                scooter, client, phone, 
                staff: myStaffName,
                startTime: Date.now(),
                status: 'running',
                totalPaused: 0,
                img: currentImgBase64
            };

            db.ref('active_trips').push(tripData);
            sendTelegram(`ğŸš€ <b>Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</b>\nğŸ›µ ${scooter}\nğŸ‘¤ ${client}\nğŸ‘® ${myStaffName}`);
            
            closeModal('newTripModal');
            document.getElementById('tripScooter').value = "";
            document.getElementById('tripPhone').value = "";
            document.getElementById('tripClient').value = "";
            document.getElementById('idPreview').classList.add('hidden');
            currentImgBase64 = "";
        }

        // --- 3. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ ---
        function updateTimerUI(key, t) {
            const el = document.getElementById(`timer-${key}`);
            if (!el) return;

            let diff;
            if (t.status === 'running') {
                diff = Date.now() - t.startTime - (t.totalPaused || 0);
            } else {
                diff = t.lastPauseTime - t.startTime - (t.totalPaused || 0);
            }

            const totalSecs = Math.floor(diff / 1000);
            const m = Math.floor(totalSecs / 60).toString().padStart(2, '0');
            const s = (totalSecs % 60).toString().padStart(2, '0');
            el.innerText = `${m}:${s}`;
        }

        function togglePause(key, currentStatus) {
            if (currentStatus === 'running') {
                db.ref(`active_trips/${key}`).update({
                    status: 'paused',
                    lastPauseTime: Date.now()
                });
            } else {
                db.ref(`active_trips/${key}`).once('value', snap => {
                    const t = snap.val();
                    const pauseDuration = Date.now() - t.lastPauseTime;
                    db.ref(`active_trips/${key}`).update({
                        status: 'running',
                        totalPaused: (t.totalPaused || 0) + pauseDuration
                    });
                });
            }
        }

        // --- 4. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰) ---
        let finishKeyTemp = null;
        let finishBaseCost = 0;

        function prepareFinish(key) {
            finishKeyTemp = key;
            db.ref(`active_trips/${key}`).once('value', snap => {
                const t = snap.val();
                let diff = Date.now() - t.startTime - (t.totalPaused || 0);
                if (t.status === 'paused') diff = t.lastPauseTime - t.startTime - (t.totalPaused || 0);
                
                let mins = Math.ceil(diff / 60000);
                
                // ğŸ”¥ ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ 15 Ø¯Ù‚ÙŠÙ‚Ø©
                let billableMins = mins;
                let note = "";
                if (mins < 15) {
                    billableMins = 15;
                    note = "(Ø­Ø¯ Ø£Ø¯Ù†Ù‰)";
                }

                finishBaseCost = billableMins * PRICE_PER_MINUTE; // Ø§Ù„Ø³Ø¹Ø±
                
                document.getElementById('finishDetails').innerHTML = `
                    <div style="background:#f8fafc; padding:10px; border-radius:10px; font-size:14px;">
                        <p>ğŸ›µ <b>${t.scooter}</b> | ğŸ‘¤ ${t.client}</p>
                        <p>â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                        <p>ğŸ’µ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©: <b>${billableMins} Ø¯Ù‚ÙŠÙ‚Ø©</b> <span style="color:red; font-size:10px;">${note}</span></p>
                    </div>
                `;
                document.getElementById('finalPriceDisplay').innerText = finishBaseCost.toFixed(2) + " Ø¬.Ù…";
                document.getElementById('finishModal').classList.remove('hidden');

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
                document.getElementById('confirmFinishBtn').onclick = () => confirmFinish(key, t, billableMins, finishBaseCost);
            });
        }

        function updateFinalTotal() {
            const disc = parseFloat(document.getElementById('damageCost').value) || 0;
            const final = finishBaseCost - disc; // Ù„Ø§Ø­Ø¸: Ù‡Ù†Ø§ Ø§Ù„Ø®ØµÙ… Ø¨ÙŠØ·Ø±Ø­ Ù…Ù† Ø§Ù„Ø¯Ø®Ù„ Ù…Ø´ Ø¨ÙŠØ²ÙˆØ¯Ù‡ (Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒØŒ Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„Ø¹Ø·Ù„ ÙŠØ¶Ø§Ù Ø¹Ø¯Ù„ (-) Ù„Ù€ (+))
            document.getElementById('finalPriceDisplay').innerText = final.toFixed(2) + " Ø¬.Ù…";
        }

        function confirmFinish(key, t, mins, cost) {
            const hasDamage = document.getElementById('hasDamage').checked;
            const damageReason = document.getElementById('damageReason').value;
            const damageCost = parseFloat(document.getElementById('damageCost').value) || 0;
            const finalTotal = cost - damageCost; // ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨ØªØ§Ø¹Ùƒ

            // ØªØ±Ø­ÙŠÙ„ Ù„Ù„ØªØ§Ø±ÙŠØ®
            const today = new Date().toISOString().split('T')[0];
            const record = {
                ...t,
                endTime: Date.now(),
                duration: mins,
                baseCost: cost,
                finalTotal: finalTotal,
                hasDamage, damageReason, damageCost
            };

            db.ref(`history/${today}`).push(record);
            
            // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙƒÙˆØªØ±
            db.ref(`scooters/${t.scooter}`).transaction(current => {
                return {
                    totalRevenue: (current?.totalRevenue || 0) + finalTotal,
                    issues: (current?.issues || 0) + (hasDamage ? 1 : 0)
                };
            });

            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù†Ø´Ø·
            db.ref(`active_trips/${key}`).remove();

            sendTelegram(`ğŸ <b>Ø¥Ù†Ù‡Ø§Ø¡ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${t.scooter}\nâ±ï¸ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©\nğŸ’° Ø§Ù„ØµØ§ÙÙŠ: ${finalTotal} Ø¬.Ù…\n${hasDamage ? 'âš ï¸ Ø¹Ø·Ù„: '+damageReason : ''}`);

            closeModal('finishModal');
            document.getElementById('hasDamage').checked = false;
            toggleDamageDiv();
        }

        // --- 5. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function checkClientBase() {
            const ph = document.getElementById('tripPhone').value;
            if(ph.length < 6) return;
            db.ref('clients/' + ph).once('value', snap => {
                if(snap.exists()) {
                    const c = snap.val();
                    document.getElementById('tripClient').value = c.name;
                    document.getElementById('clientFoundBadge').classList.remove('hidden');
                    if(c.img) {
                        document.getElementById('idPreview').src = c.img;
                        document.getElementById('idPreview').classList.remove('hidden');
                        currentImgBase64 = c.img;
                    }
                }
            });
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 500;
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        currentImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('idPreview').src = currentImgBase64;
                        document.getElementById('idPreview').classList.remove('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function loadHistory() {
            const today = new Date().toISOString().split('T')[0];
            db.ref(`history/${today}`).on('value', snap => {
                const list = document.getElementById('historyList');
                list.innerHTML = "";
                let total = 0;
                if(snap.exists()) {
                    const data = snap.val();
                    Object.values(data).reverse().forEach(r => {
                        total += r.finalTotal;
                        list.innerHTML += `
                            <div style="border-bottom:1px solid #eee; padding:10px; display:flex; justify-content:space-between;">
                                <span>${r.scooter} (${r.duration} Ø¯)</span>
                                <span style="font-weight:bold; color:var(--success)">${r.finalTotal} Ø¬</span>
                            </div>
                        `;
                    });
                }
                document.getElementById('todayIncome').innerText = total.toFixed(0);
            });
        }

        function openAdminAuth() {
            const p = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø£Ø¯Ù…Ù†:");
            if(p === "9924") {
                loadAdminData();
                document.getElementById('adminPanel').style.display = 'block';
            } else {
                alert("â›” ØºÙŠØ± Ù…ØµØ±Ø­");
            }
        }

        function loadAdminData() {
            // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            db.ref('online_staff').on('value', snap => {
                const t = document.getElementById('onlineStaffTable');
                t.innerHTML = "";
                snap.forEach(c => {
                    const u = c.val();
                    t.innerHTML += `
                        <tr>
                            <td>${u.name}</td>
                            <td><span style="color:green">Online</span></td>
                            <td><button class="btn btn-danger" style="padding:5px;" onclick="banUser('${c.key}')">Ø­Ø¸Ø±</button></td>
                        </tr>
                    `;
                });
            });

            // Ø§Ù„Ø§Ø³ÙƒÙˆØªØ±Ø§Øª
            db.ref('scooters').once('value', snap => {
                const t = document.getElementById('scooterReportTable');
                t.innerHTML = "";
                if(snap.exists()) {
                    snap.forEach(c => {
                        const s = c.val();
                        t.innerHTML += `<tr><td>${c.key}</td><td>${s.totalRevenue}</td><td>${s.issues}</td></tr>`;
                    });
                }
            });
        }

        function banUser(key) {
            if(confirm("Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                db.ref(`banned_devices/${key}`).set(true);
                db.ref(`online_staff/${key}`).remove();
            }
        }

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleDamageDiv() { 
            const chk = document.getElementById('hasDamage').checked;
            document.getElementById('damageDiv').classList.toggle('hidden', !chk);
        }
        function sendTelegram(msg) {
            fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({chat_id: TELEGRAM_CHAT_ID, text: msg, parse_mode: 'HTML'})
            });
        }

    </script>
</body>
</html>
