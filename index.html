<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Titan V88 | Diamond Edition</title>
    
    <!-- Ø§Ù„Ù…ÙƒØ§ØªØ¨ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #050505; --card: #0f0f0f; --glass: rgba(255, 255, 255, 0.03);
            --primary: #00d2ff; --accent: #0072ff; --success: #00ffa3;
            --danger: #ff0055; --warn: #ffcc00; --text: #e0e0e0;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø®Ø±Ø© --- */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 90%; max-width: 380px; background: var(--card); padding: 40px; border-radius: 40px; border: 1px solid var(--primary); text-align: center; box-shadow: 0 0 50px rgba(0,210,255,0.2); }
        .auth-card input { width: 100%; background: #000; border: 1px solid #222; color: var(--primary); padding: 20px; border-radius: 20px; font-size: 32px; text-align: center; margin-bottom: 25px; outline: none; font-family: 'Rajdhani'; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Phone HUD) --- */
        #scooter-layout { display: none; position: fixed; inset: 0; background: radial-gradient(circle, #0a1a35, #000); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .speed-ring { width: 280px; height: 280px; border: 10px solid var(--primary); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 80px rgba(0, 210, 255, 0.4); position: relative; }
        .speed-ring::after { content: ''; position: absolute; inset: -15px; border: 2px dashed var(--primary); border-radius: 50%; opacity: 0.3; animation: rotate 10s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .speed-val { font-family: 'Rajdhani'; font-size: 110px; font-weight: 900; color: #fff; line-height: 1; text-shadow: 0 0 20px var(--primary); }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Admin Dashboard) --- */
        #admin-panel { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 280px; background: #000; border-left: 1px solid #111; display: flex; flex-direction: column; padding: 20px; }
        .nav-item { padding: 16px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #666; margin-bottom: 10px; font-weight: bold; }
        .nav-item.active { background: var(--glass); color: var(--primary); border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(0,210,255,0.1); }
        
        .main-view { flex: 1; overflow-y: auto; padding: 25px; background: linear-gradient(135deg, #050505, #0a0a0a); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background: var(--glass); padding: 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .kpi-card b { font-family: 'Rajdhani'; font-size: 26px; color: #fff; display: block; }

        .trip-card { background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 30px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .trip-card::before { content: ''; position: absolute; top: 0; right: 0; width: 6px; height: 100%; background: var(--primary); }
        .trip-timer { font-family: 'Rajdhani'; font-size: 50px; font-weight: 900; text-align: center; color: var(--primary); margin: 10px 0; }
        .id-img { width: 100%; height: 140px; border-radius: 20px; object-fit: cover; margin: 10px 0; border: 2px solid #222; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ®Ù…Ø© */
        .btn { padding: 15px; border: none; border-radius: 15px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 15px; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--primary)); color: #fff; box-shadow: 0 10px 20px rgba(0, 114, 255, 0.3); }
        .btn-danger { background: rgba(255, 0, 85, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #admin-map { width: 100%; height: 350px; border-radius: 30px; border: 2px solid #111; margin-top: 20px; }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="font-family:'Rajdhani'; font-size: 45px; color: var(--primary); font-weight: 900;">YALLA TITAN</h1>
            <p style="color: #555; margin-bottom: 30px; font-weight: bold; letter-spacing: 2px;">V88 DIAMOND</p>
            <input type="password" id="pinInput" placeholder="****" inputmode="numeric">
            <button class="btn btn-primary" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- 2. ÙˆØ§Ø¬Ù‡Ø© ØªÙ„ÙŠÙÙˆÙ† Ø§Ù„Ø³ÙƒÙˆØªØ± -->
    <div id="scooter-layout">
        <div class="speed-ring">
            <span class="speed-val" id="hud-speed">0</span>
            <span style="color:var(--primary); font-weight:bold;">KM/H</span>
        </div>
        <h2 id="hud-name" style="font-family:'Rajdhani'; font-size:45px; color:var(--primary); margin-top: 25px;">-</h2>
        <div style="display:flex; gap:40px; font-size:24px; margin-top: 20px; font-weight: bold;">
            <span>ğŸ”‹ <span id="hud-batt">--%</span></span>
            <span id="hud-gps" style="color:var(--success)">ğŸ›°ï¸ LIVE GPS</span>
        </div>
        <button class="btn btn-danger" style="width: 150px; margin-top: 60px; border-radius: 40px;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- 3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div id="admin-panel">
        <nav class="sidebar">
            <div style="font-family:'Rajdhani'; font-size:28px; font-weight:900; color:var(--primary); margin-bottom:40px; text-align:center;">TITAN CORE</div>
            <div class="nav-item active" onclick="nav('ops', this)"><i class="fas fa-play"></i> Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
            <div class="nav-item" onclick="nav('fleet', this)"><i class="fas fa-map-marked-alt"></i> Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
            <div class="nav-item" onclick="nav('analysis', this)"><i class="fas fa-chart-line"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø£Ø¹Ø·Ø§Ù„</div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fas fa-history"></i> Ø§Ù„Ø³Ø¬Ù„</div>
            <button class="btn btn-danger" style="margin-top:auto;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        </nav>

        <main class="main-view">
            <div class="kpi-grid">
                <div class="kpi-card"><small>Ø§Ù„Ø¯Ø±Ø¬</small><b id="kpi-vault">0</b></div>
                <div class="kpi-card"><small>Ø§Ù„Ù†Ø´Ø·</small><b id="kpi-active">0</b></div>
                <div class="kpi-card"><small>Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</small><b id="kpi-online">0</b></div>
            </div>

            <div id="sec-ops" class="section active">
                <button class="btn btn-primary" onclick="openStartTripPopup()" style="height: 60px; font-size: 18px;">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©</button>
                <div id="trip-list" style="margin-top: 25px;"></div>
            </div>

            <div id="sec-fleet" class="section">
                <div id="admin-map"></div>
                <div id="fleet-list" style="margin-top: 20px;"></div>
            </div>

            <div id="sec-analysis" class="section">
                <h2 style="color:var(--primary); margin-bottom: 20px;">ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h2>
                <div id="analysis-list"></div>
            </div>

            <div id="sec-history" class="section">
                <div id="history-list"></div>
            </div>
        </main>
    </div>

<script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
    const CONFIG = { basePrice: 40, freeMins: 15, pricePerMin: 2.66, shop: { lat: 30.0444, lon: 31.2357 } };

    firebase.initializeApp({ 
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        storageBucket: "yalla-scooter-pro.appspot.com"
    });
    const db = firebase.database();
    const storage = firebase.storage();

    let myScooterName = "", map = null, markers = {}, onlineFleet = {}, scooterRegistry = {};

    // --- Ø¶Ø§ØºØ· Ø§Ù„ØµÙˆØ± (Image Compression) ---
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; // ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.6); // Ø¬ÙˆØ¯Ø© 60%
                };
            };
        });
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    function handleAuth() {
        const pin = document.getElementById('pinInput').value;
        if(pin === "1214") {
            Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±', input: 'text', confirmButtonText: 'Ø¯Ø®ÙˆÙ„' }).then(r => {
                if(r.value) {
                    myScooterName = r.value;
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('scooter-layout').style.display = 'flex';
                    runScooterMode();
                }
            });
        } else if(pin === "1213" || pin === "9924") {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'flex';
            runAdminMode();
        } else { Swal.fire('Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£'); }
    }

    // --- ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆØªØ± ---
    function runScooterMode() {
        const ref = db.ref('fleet_online/' + myScooterName);
        ref.onDisconnect().remove();

        navigator.geolocation.watchPosition(pos => {
            const data = {
                name: myScooterName, lat: pos.coords.latitude, lon: pos.coords.longitude,
                speed: Math.round((pos.coords.speed || 0) * 3.6), lastSeen: Date.now()
            };
            ref.update(data);
            document.getElementById('hud-speed').innerText = data.speed;
            document.getElementById('hud-name').innerText = myScooterName;
            db.ref('scooter_registry/'+myScooterName+'/totalKm').transaction(v => (v||0) + 0.01);
        }, null, { enableHighAccuracy: true });

        navigator.getBattery?.().then(bt => {
            const up = () => { document.getElementById('hud-batt').innerText = Math.round(bt.level*100)+"%"; ref.child('batt').set(Math.round(bt.level*100)); };
            up(); bt.onlevelchange = up;
        });
    }

    // --- ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
    function runAdminMode() {
        db.ref('active_trips').on('value', snap => renderTrips(snap.val() || {}));
        db.ref('vault_total').on('value', snap => document.getElementById('kpi-vault').innerText = (snap.val() || 0) + " Ø¬");
        db.ref('fleet_online').on('value', snap => {
            onlineFleet = snap.val() || {};
            document.getElementById('kpi-online').innerText = Object.keys(onlineFleet).length;
            if(map) updateMap();
        });
        db.ref('scooter_registry').on('value', snap => {
            scooterRegistry = snap.val() || {};
            renderAnalysis();
        });
        db.ref('history').limitToLast(15).on('value', snap => renderHistory(snap.val() || {}));
    }

    // --- Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ù…Ø¹ Ø¶ØºØ· Ø§Ù„ØµÙˆØ± ---
    async function openStartTripPopup() {
        let fleetOptions = "";
        for(let key in onlineFleet) fleetOptions += `<option value="${key}">${key}</option>`;

        const { value: res } = await Swal.fire({
            title: 'Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            html: `
                <select id="sw-sc" class="swal2-input">${fleetOptions || '<option>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙƒÙˆØªØ± Ù…ØªØ§Ø­</option>'}</select>
                <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input id="sw-fi" type="file" accept="image/*" class="swal2-file">
            `,
            preConfirm: () => ({ sc: document.getElementById('sw-sc').value, ph: document.getElementById('sw-ph').value, fi: document.getElementById('sw-fi').files[0] })
        });

        if(res && res.fi && res.ph) {
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ø±ÙØ¹...', didOpen: () => Swal.showLoading() });
            
            // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
            const compressedBlob = await compressImage(res.fi);
            const sRef = storage.ref(`ids/${Date.now()}.jpg`);
            await sRef.put(compressedBlob);
            const url = await sRef.getDownloadURL();

            db.ref('active_trips').push({
                scooterId: res.sc, clientPhone: res.ph, idPhoto: url,
                startTime: Date.now(), totalPausedTime: 0, status: 'running'
            });

            sendTG(`ğŸš€ *Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø©*\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${res.sc}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${res.ph}\n[Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©](${url})`);
            Swal.fire('ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù†Ø¬Ø§Ø­ âœ…', '', 'success');
        }
    }

    // --- Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ ÙƒØ´Ù Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ ---
    async function finishTrip(id) {
        db.ref('active_trips/'+id).once('value', async s => {
            const t = s.val();
            const live = onlineFleet[t.scooterId];
            let isFraud = false;
            if(live) {
                const dist = calcDist(live.lat, live.lon, CONFIG.shop.lat, CONFIG.shop.lon);
                if(dist > 150) isFraud = true;
            }

            const mins = calculateMins(t);
            let cost = Math.round(CONFIG.basePrice + (mins > CONFIG.freeMins ? (mins - CONFIG.freeMins) * CONFIG.pricePerMin : 0));

            const { value: res } = await Swal.fire({
                title: isFraud ? 'ğŸš¨ Ø§Ù„Ø³ÙƒÙˆØªØ± Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø­Ù„!' : 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬</b><br><input id="d-amt" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">`,
                confirmButtonText: 'ØªØ­ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡',
                background: isFraud ? '#300' : '#0f0f0f'
            });

            if(res !== undefined) {
                const final = cost - parseFloat(document.getElementById('d-amt').value || 0);
                db.ref('vault_total').transaction(v => (v||0) + final);
                db.ref('scooter_registry/'+t.scooterId+'/totalEarnings').transaction(v => (v||0) + final);
                db.ref('history').push({ ...t, final, mins, date: Date.now() });
                db.ref('active_trips/'+id).remove();
                sendTG(`${isFraud?'ğŸš¨ *ØªÙ„Ø§Ø¹Ø¨:*':'ğŸ *Ø¥Ù†Ù‡Ø§Ø¡:*'} ${t.scooterId} | Ø§Ù„ØµØ§ÙÙŠ: ${final} Ø¬`);
            }
        });
    }

    // --- Ø§Ù„Ø±Ù†Ø¯Ø±Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ---
    function renderTrips(data) {
        const list = document.getElementById('trip-list'); list.innerHTML = "";
        let count = 0;
        for(let id in data) {
            count++; const t = data[id];
            list.innerHTML += `
                <div class="trip-card">
                    <div style="display:flex; justify-content:space-between;"><b>ğŸ›µ ${t.scooterId}</b> <span>${t.clientPhone}</span></div>
                    <img src="${t.idPhoto}" class="id-img" onclick="window.open('${t.idPhoto}')">
                    <div class="trip-timer">${calculateMins(t)} <small>Ø¯</small></div>
                    <button class="btn btn-primary" onclick="finishTrip('${id}')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                </div>`;
        }
        document.getElementById('kpi-active').innerText = count;
    }

    function renderAnalysis() {
        const list = document.getElementById('analysis-list'); list.innerHTML = "";
        for(let id in scooterRegistry) {
            const s = scooterRegistry[id];
            list.innerHTML += `
                <div class="kpi-card" style="text-align:right; margin-bottom:15px; border-right:5px solid var(--primary);">
                    <b>ğŸ›µ ${id}</b>
                    <div style="display:grid; grid-template-columns:1fr 1fr; margin:10px 0; font-size:12px;">
                        <div>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${(s.totalKm || 0).toFixed(2)} ÙƒÙ…</div>
                        <div>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: ${s.totalEarnings || 0} Ø¬</div>
                    </div>
                    <button class="btn btn-danger" style="font-size:10px; padding:5px;" onclick="addFault('${id}')">ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„/ØµÙŠØ§Ù†Ø©</button>
                </div>`;
        }
    }

    function addFault(id) {
        Swal.fire({ title: 'ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©', input: 'text' }).then(r => {
            if(r.value) {
                db.ref('scooter_registry/'+id+'/faults').push({ msg: r.value, date: Date.now() });
                sendTG(`ğŸ› ï¸ *Ø¹Ø·Ù„:* ${id} - ${r.value}`);
            }
        });
    }

    // --- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„ÙˆÙ‚Øª ---
    function nav(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
        el.classList.add('active');
        if(id === 'fleet' && !map) {
            setTimeout(() => {
                map = L.map('admin-map').setView([CONFIG.shop.lat, CONFIG.shop.lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }, 500);
        }
    }

    function updateMap() {
        for(let id in onlineFleet) {
            const s = onlineFleet[id];
            if(markers[id]) markers[id].setLatLng([s.lat, s.lon]);
            else markers[id] = L.marker([s.lat, s.lon]).addTo(map).bindPopup(id);
        }
    }

    function calculateMins(t) {
        let total = Date.now() - t.startTime;
        let paused = t.totalPausedTime || 0;
        if(t.status === 'paused') paused += (Date.now() - t.lastPauseStart);
        return Math.max(0, Math.floor((total - paused) / 60000));
    }

    function calcDist(la1, lo1, la2, lo2) {
        const R = 6371e3; const dLat = (la2-la1)*Math.PI/180; const dLon = (lo2-lo1)*Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function renderHistory(data) {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        Object.values(data).reverse().forEach(h => {
            list.innerHTML += `<div style="padding:15px; background:var(--glass); border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between;">
                <span>${h.scooterId} | ${h.mins}Ø¯</span> <b>${h.final} Ø¬</b>
            </div>`;
        });
    }

    function sendTG(msg) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage?chat_id=${TELEGRAM.chat}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`); }
    setInterval(() => { if('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(()=>{}); }, 30000);
</script>
</body>
</html>
