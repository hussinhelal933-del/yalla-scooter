<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Blue Edition</title>
    
    <!-- الموارد -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* تغيير اللون الأساسي إلى اللبني النيون */
            --yalla-blue: #00d2ff; 
            --yalla-dark-blue: #0072ff;
            --rabbit-gray: #f4f4f4;
            --text-dark: #333;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: white; }

        /* --- الخريطة --- */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; filter: grayscale(0.5) brightness(1.02); }

        /* --- القائمة الجانبية --- */
        #side-menu {
            position: fixed; top: 0; right: -100%; width: 85%; height: 100%;
            background: white; z-index: 5000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -5px 0 20px rgba(0,0,0,0.1); padding: 40px 25px;
            display: flex; flex-direction: column;
        }
        #side-menu.open { right: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 4999; display: none; }

        /* مكان اللوجو الجديد */
        .user-profile { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .user-logo { 
            width: 60px; height: 60px; 
            border-radius: 15px; 
            overflow: hidden; /* عشان اللوجو ميتخطاش الحدود */
            display: flex; align-items: center; justify-content: center; 
            background: #f0f0f0;
            border: 2px solid var(--yalla-blue);
        }
        .user-logo img { width: 100%; height: 100%; object-fit: cover; } /* اللوجو يملأ المربع */

        .user-info b { font-size: 20px; color: var(--text-dark); display: block; }
        .user-info span { font-size: 14px; color: #888; }

        .prime-btn {
            background: #fff; border: 2px solid var(--yalla-blue); color: var(--yalla-blue);
            padding: 12px; border-radius: 12px; font-weight: bold; font-size: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin: 10px 0 30px 0; cursor: pointer;
        }

        .menu-link i { font-size: 20px; width: 25px; color: var(--yalla-blue); }

        /* --- الأزرار العائمة --- */
        .fab-container { position: absolute; z-index: 1000; width: 100%; height: 100%; pointer-events: none; }
        .fab-container button { pointer-events: auto; cursor: pointer; border: none; box-shadow: 0 4px 15px rgba(0,210,255,0.2); }

        .btn-menu, .btn-locate { 
            position: absolute; bottom: 40px; width: 60px; height: 60px; 
            background: white; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 22px; 
        }
        .btn-menu { right: 25px; color: var(--yalla-blue); }
        .btn-locate { left: 25px; color: var(--yalla-blue); }

        /* زر Scan to Ride (أزرق نيون) */
        .btn-scan {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, var(--yalla-blue), var(--yalla-dark-blue));
            color: white; padding: 15px 35px; border-radius: 50px;
            font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px;
            width: 220px; justify-content: center;
        }

        /* الماركر على الخريطة باللون الأزرق */
        .marker-pin { 
            width: 45px; height: 45px; background: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px rgba(0,210,255,0.4); border: 3px solid var(--yalla-blue);
        }
        
        #wallet-modal { position: fixed; inset: 0; background: white; z-index: 6000; display: none; flex-direction: column; padding: 30px; }
    </style>
</head>
<body>

    <div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
    
    <!-- القائمة الجانبية -->
    <div id="side-menu">
        <div class="user-profile">
            <div class="user-logo">
                <!-- ضع رابط اللوجو الخاص بك هنا مكان "YOUR_LOGO_URL" -->
                <img src="https://via.placeholder.com/60x60/00d2ff/ffffff?text=Yalla" id="app-logo-img" alt="Yalla Logo">
            </div>
            <div class="user-info">
                <b id="display-name">Hassan</b>
                <span id="display-phone">+201153243863</span>
            </div>
        </div>
        
        <div class="prime-btn">
            <i class="fas fa-crown"></i> Yalla Prime Plus
        </div>

        <div class="menu-items">
            <div class="menu-link" onclick="showHistory()"><i class="fas fa-history"></i> سجل الرحلات</div>
            <div class="menu-link" onclick="openWallet()"><i class="fas fa-wallet"></i> المحفظة</div>
            <div class="menu-link"><i class="fas fa-gift"></i> رصيد مجاني</div>
            <div class="menu-link"><i class="fas fa-info-circle"></i> كيف تستخدم التطبيق</div>
            <div class="menu-link"><i class="fas fa-language"></i> Language / اللغة</div>
        </div>

        <div class="menu-link" onclick="logout()" style="border:none; color:red; margin-top: auto;">
            <i class="fas fa-sign-out-alt" style="color:red;"></i> تسجيل الخروج
        </div>
    </div>

    <!-- الخريطة -->
    <div id="map"></div>

    <!-- الأزرار -->
    <div class="fab-container">
        <button class="btn-menu" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </button>

        <button class="btn-scan" onclick="openScanner()">
            <i class="fas fa-qrcode"></i> Scan to Ride
        </button>

        <button class="btn-locate" onclick="locateMe()">
            <i class="fas fa-location-arrow"></i>
        </button>
    </div>

    <!-- المحفظة -->
    <div id="wallet-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
            <h2>المحفظة</h2>
            <i class="fas fa-times" onclick="closeWallet()" style="font-size:24px;"></i>
        </div>
        <div style="background: linear-gradient(135deg, #f0faff, #ffffff); padding:40px; border-radius:30px; text-align:center; border: 1px solid #e0f0f5;">
            <small style="color:#888">الرصيد المتاح</small>
            <h1 id="balance-val" style="font-size:45px; margin:10px 0; color:var(--yalla-blue)">0.00 ج.م</h1>
        </div>
        <button class="btn-scan" style="position:static; width:100%; margin-top:25px;" onclick="topUp()">إضافة رصيد</button>
    </div>

<script>
    // --- نفس منطق الـ Firebase السابق بدون مسح ---
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, userMarker, scooterMarkers = {};
    let userPhone = localStorage.getItem('yalla_user_ph') || "";

    window.onload = () => { if(!userPhone) askForLogin(); else initApp(); };

    function initApp() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([30.0444, 31.2357], 16);
        // خريطة بتدرجات رمادية خفيفة تبرز اللون اللبني
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        db.ref('live_nodes').on('value', snap => {
            snap.forEach(child => {
                const d = child.val();
                if(!scooterMarkers[child.key]) {
                    const icon = L.divIcon({
                        className: 'sc-icon-wrapper',
                        html: `<div class="marker-pin"><i class="fas fa-motorcycle" style="color:var(--yalla-blue)"></i></div>`
                    });
                    scooterMarkers[child.key] = L.marker([d.lat, d.lon], {icon}).addTo(map);
                } else {
                    scooterMarkers[child.key].setLatLng([d.lat, d.lon]);
                }
            });
        });

        db.ref('users/' + userPhone).on('value', s => {
            if(s.exists()){
                document.getElementById('balance-val').innerText = (s.val().balance || 0).toFixed(2) + " ج.م";
                document.getElementById('display-name').innerText = s.val().name || "عميل يلا";
            }
        });
        locateMe();
    }

    // وظائف الواجهة
    function toggleMenu() {
        const menu = document.getElementById('side-menu');
        const overlay = document.getElementById('overlay');
        menu.classList.toggle('open');
        overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
    }

    function locateMe() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const p = [pos.coords.latitude, pos.coords.longitude];
                map.flyTo(p, 17);
                if(!userMarker) userMarker = L.circleMarker(p, { radius: 10, color: '#00d2ff', fillColor: '#00d2ff', fillOpacity: 0.3 }).addTo(map);
                else userMarker.setLatLng(p);
            });
        }
    }

    async function openScanner() {
        const { value: scId } = await Swal.fire({
            title: 'Scan QR Code',
            input: 'text',
            inputPlaceholder: 'أدخل رقم السكوتر',
            confirmButtonColor: '#00d2ff'
        });
        if(scId) {
            db.ref('active_trips').push({ phone: userPhone, scooterId: scId, start: Date.now() });
            Swal.fire('رحلة سعيدة', 'تم فتح السكوتر بنجاح!', 'success');
        }
    }

    function openWallet() { document.getElementById('wallet-modal').style.display = 'flex'; toggleMenu(); }
    function closeWallet() { document.getElementById('wallet-modal').style.display = 'none'; }

    async function topUp() {
        const { value: amt } = await Swal.fire({ title: 'شحن رصيد', input: 'number', confirmButtonColor: '#00d2ff' });
        if(amt) db.ref('users/' + userPhone + '/balance').transaction(v => (v||0) + parseFloat(amt));
    }

    function askForLogin() {
        Swal.fire({ title: 'مرحباً بك في Yalla', input: 'tel', inputPlaceholder: 'رقم الموبايل', allowOutsideClick: false }).then(res => {
            if(res.value) { userPhone = res.value; localStorage.setItem('yalla_user_ph', userPhone); location.reload(); }
        });
    }

    function logout() { localStorage.clear(); location.reload(); }
</script>

</body>
</html>
