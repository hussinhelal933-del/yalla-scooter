<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Command V27 | Full System</title>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script> <!-- Added Storage -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ (Glassmorphism) */
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass-bg: rgba(17, 25, 40, 0.75);
            --glass-border: rgba(255, 255, 255, 0.125);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --primary: #00d2ff; --secondary: #928DAB; --accent: #3a7bd5;
            --danger: #ff0055; --warn: #ffcc00; --text: #ffffff; --text-muted: #a3a3a3;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: all 0.3s; outline: none; }
        body { margin: 0; background: var(--bg-gradient); background-attachment: fixed; color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); }
        
        .sidebar { width: 280px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(20px); border-left: 1px solid var(--glass-border); display: flex; flex-direction: column; z-index: 1000; }
        .brand { padding: 30px 20px; text-align: center; color: var(--primary); font-family: 'Rajdhani'; font-size: 26px; font-weight: 700; text-shadow: 0 0 15px rgba(0,210,255,0.5); border-bottom: 1px solid var(--glass-border); }
        
        /* Shift Status Widget */
        .shift-widget { padding: 15px; margin: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid var(--glass-border); text-align: center; }
        .shift-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 5px; }
        .shift-on { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
        .shift-off { background: var(--danger); }

        .nav-group { flex: 1; padding: 10px; overflow-y: auto; }
        .nav-item { padding: 14px 20px; margin-bottom: 5px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 15px; font-weight: 500; border-radius: 12px; }
        .nav-item:hover, .nav-item.active { background: rgba(0, 210, 255, 0.1); color: var(--primary); }
        .nav-item.active { border-right: 3px solid var(--primary); }

        .main-content { flex: 1; padding: 25px; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        
        .section { display: none; flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .section.active { display: block; animation: slideIn 0.4s ease; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); padding: 15px; border-radius: 18px; text-align: center; }
        .kpi-val { font-family: 'Rajdhani'; font-size: 28px; font-weight: 700; color: var(--text); display: block; }
        
        /* Unit Card */
        .unit-card { background: rgba(20, 20, 30, 0.4); border: 1px solid var(--glass-border); border-radius: 20px; padding: 15px; margin-bottom: 15px; position: relative; }
        .unit-card.paused { border-color: var(--warn); background: rgba(255, 204, 0, 0.05); }
        .unit-timer { font-family: 'Rajdhani'; font-size: 36px; text-align: center; color: var(--primary); margin: 10px 0; font-weight: 700; }
        .id-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; border: 1px solid var(--glass-border); filter: brightness(0.8); }

        /* Tables & Inputs */
        .glass-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; margin-top: 10px; font-size: 14px; }
        .glass-table th { padding: 12px; text-align: right; color: var(--text-muted); }
        .glass-table td { background: rgba(255,255,255,0.03); padding: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .glass-table tr td:first-child { border-radius: 0 10px 10px 0; }
        .glass-table tr td:last-child { border-radius: 10px 0 0 10px; }

        input, select { background: rgba(0, 0, 0, 0.4) !important; border: 1px solid var(--glass-border) !important; color: #fff !important; border-radius: 10px !important; padding: 12px !important; width: 100%; margin-bottom: 10px; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }
        .btn-primary { background: linear-gradient(45deg, var(--accent), var(--primary)); color: #fff; box-shadow: 0 4px 15px rgba(0, 210, 255, 0.2); }
        .btn-danger { background: linear-gradient(45deg, #ff416c, #ff4b2b); color: white; }
        .btn-warn { background: linear-gradient(45deg, #f7971e, #ffd200); color: #000; }

        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-overlay">
        <div class="glass-panel" style="padding:40px; border-radius:24px; text-align:center; width:350px;">
            <h1 style="font-family:'Rajdhani'; color:var(--primary); margin:0 0 20px;">YALLA COMMAND</h1>
            <input type="password" id="passInput" style="text-align:center; font-size:20px; letter-spacing:4px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary" style="width:100%; margin-top:10px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="brand"><i class="fas fa-layer-group"></i> YALLA</div>
        
        <!-- Shift Status -->
        <div class="shift-widget">
            <div id="shift-status-text" style="font-size:12px; color:var(--text-muted); margin-bottom:5px;">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù…ØºÙ„Ù‚Ø©</div>
            <button id="shift-btn" onclick="toggleShift()" class="btn btn-primary" style="width:100%">Ø¨Ø¯Ø¡ ÙˆØ±Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <div class="nav-group">
            <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-satellite-dish"></i> <span>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span></div>
            <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></div>
            <div class="nav-item" onclick="nav('maint')"><i class="fas fa-tools"></i> <span>Ø§Ù„ØµÙŠØ§Ù†Ø©</span></div>
            <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-chart-line"></i> <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></div>
            <div id="set-nav" class="nav-item" style="display:none" onclick="nav('settings')"><i class="fas fa-cog"></i> <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
        </div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger);" onclick="location.reload()">
            <i class="fas fa-power-off"></i> <span>Ø®Ø±ÙˆØ¬</span>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <h2 id="p-title" style="margin:0; font-family:'Rajdhani'; text-transform: uppercase;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <div id="clock" style="font-family:'Rajdhani'; color:var(--primary); font-size:20px; font-weight:bold;">00:00:00</div>
        </div>

        <!-- KPI -->
        <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-val" id="k-active" style="color:var(--primary)">0</span><small>Ø³ÙƒÙˆØªØ± Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-shift-cash" style="color:#2ecc71">0</span><small>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-avail">0</span><small>Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ø¶</small></div>
            <div class="kpi-card"><span class="kpi-val" style="color:var(--danger)" id="k-blocked">0</span><small>Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</small></div>
        </div>

        <!-- 1. Operations Section -->
        <div id="sec-ops" class="section active">
            <button class="btn btn-primary" onclick="startTripPopup()" style="width:100%; margin-bottom:20px; padding:15px; font-size:16px;">
                <i class="fas fa-plus-circle"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </button>
            <div id="fleet-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;"></div>
        </div>

        <!-- 2. Clients Section -->
        <div id="sec-clients" class="section">
            <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ..." oninput="loadClients(this.value)">
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th></th></tr></thead>
                <tbody id="clients-list"></tbody>
            </table>
        </div>

        <!-- 3. Admin Section -->
        <div id="sec-admin" class="section">
            <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:15px; margin-bottom:20px;">
                <canvas id="revChart" height="200"></canvas>
            </div>
            <h3>Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø©</h3>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¨Ø¯Ø£Øª</th><th>Ø§Ù†ØªÙ‡Øª</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th><th>Ø±Ø­Ù„Ø§Øª</th></tr></thead>
                <tbody id="shifts-list"></tbody>
            </table>
        </div>

        <!-- 4. Settings Section (New) -->
        <div id="sec-settings" class="section">
            <div class="kpi-card" style="text-align:right; margin-bottom:20px;">
                <h3 style="margin-top:0; color:var(--primary)">ğŸ’° Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
                <label>Ø³Ø¹Ø± ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ø¬Ù†ÙŠÙ‡)</label>
                <input type="number" id="conf-baseCost" onchange="saveConfig()">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„ÙØªØ­ (Ù…Ø«Ù„Ø§Ù‹ 15 Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                <input type="number" id="conf-baseMins" onchange="saveConfig()">
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</label>
                <input type="number" id="conf-pricePerMin" onchange="saveConfig()">
            </div>

            <div class="kpi-card" style="text-align:right;">
                <h3 style="margin-top:0; color:var(--primary)">ğŸ›µ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Inventory)</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new-scooter-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± (Ù…Ø«Ù„Ø§Ù‹ S5)">
                    <button class="btn btn-primary" onclick="addNewScooter()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="scooter-mngt-list" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px;"></div>
            </div>
        </div>

        <!-- Maint Placeholder -->
        <div id="sec-maint" class="section">
             <div style="text-align:center; padding:50px;">
                <i class="fas fa-wrench" style="font-size:40px; color:var(--text-muted)"></i>
                <p>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</p>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIG & INIT ---
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        
        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yalla-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.appspot.com", // ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Storage ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
        });

        const db = firebase.database();
        const storage = firebase.storage();
        
        let activeTrips = {};
        let config = { baseCost: 40, baseMins: 15, pricePerMin: 2.66 }; // Default values
        let currentShiftId = null;
        let currentUser = "Admin"; 
        let availableScooters = [];

        // --- AUTH & SYSTEM ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                currentUser = (p==="9924") ? "Ø§Ù„Ù…Ø¯ÙŠØ±" : "Ù…ÙˆØ¸Ù";
                if(p === "9924") {
                    document.getElementById('adm-nav').style.display = 'flex';
                    document.getElementById('set-nav').style.display = 'flex';
                }
                document.getElementById('login-overlay').style.display = 'none';
                initSystem();
            } else { Swal.fire('Ø®Ø·Ø£', 'Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); }
        }

        function initSystem() {
            // Load Config
            db.ref('settings').on('value', s => { 
                if(s.exists()) config = s.val();
                document.getElementById('conf-baseCost').value = config.baseCost;
                document.getElementById('conf-baseMins').value = config.baseMins;
                document.getElementById('conf-pricePerMin').value = config.pricePerMin;
            });

            // Load Shift Status
            const today = new Date().toISOString().split('T')[0];
            db.ref('shifts/current').on('value', s => {
                const btn = document.getElementById('shift-btn');
                const txt = document.getElementById('shift-status-text');
                const kpi = document.getElementById('k-shift-cash');
                
                if(s.exists() && s.val().status === 'open') {
                    currentShiftId = s.key;
                    btn.innerText = "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© (ØªØ³Ù„ÙŠÙ…)";
                    btn.classList.replace('btn-primary', 'btn-danger');
                    txt.innerText = `Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù…ÙØªÙˆØ­Ø©: ${s.val().user}`;
                    txt.style.color = "#2ecc71";
                    kpi.innerText = s.val().totalCash + " Ø¬";
                } else {
                    currentShiftId = null;
                    btn.innerText = "Ø¨Ø¯Ø¡ ÙˆØ±Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©";
                    btn.classList.replace('btn-danger', 'btn-primary');
                    txt.innerText = "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù…ØºÙ„Ù‚Ø©";
                    txt.style.color = "var(--text-muted)";
                    kpi.innerText = "0";
                }
            });

            // Load Inventory (Available Scooters)
            db.ref('inventory').on('value', snap => {
                availableScooters = [];
                const list = document.getElementById('scooter-mngt-list');
                list.innerHTML = '';
                let availCount = 0;
                
                snap.forEach(doc => {
                    const s = doc.val();
                    if(s.status === 'available') {
                        availableScooters.push(doc.key);
                        availCount++;
                    }
                    // For Settings List
                    list.innerHTML += `<div style="padding:5px 10px; background:rgba(255,255,255,0.1); border-radius:5px;">${doc.key} (${s.status})</div>`;
                });
                document.getElementById('k-avail').innerText = availCount;
            });

            // Load Trips
            db.ref('active_trips').on('value', snap => {
                activeTrips = snap.val() || {};
                renderTrips();
            });

            // Admin Charts
            loadAdminData();
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- 1. SHIFT SYSTEM ---
        function toggleShift() {
            if(!currentShiftId) {
                // Start Shift
                db.ref('shifts/current').set({
                    user: currentUser,
                    start: Date.now(),
                    status: 'open',
                    totalCash: 0,
                    tripsCount: 0
                });
                Swal.fire('ØªÙ…', 'ØªÙ… ÙØªØ­ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                // End Shift
                db.ref('shifts/current').once('value', s => {
                    const data = s.val();
                    const summary = {
                        ...data,
                        end: Date.now(),
                        status: 'closed'
                    };
                    // Save to history
                    db.ref('shifts/history').push(summary);
                    // Clear current
                    db.ref('shifts/current').remove();
                    Swal.fire('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ©', `Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯: ${data.totalCash} Ø¬ | Ø§Ù„Ø±Ø­Ù„Ø§Øª: ${data.tripsCount}`, 'info');
                });
            }
        }

        // --- 2. SETTINGS & INVENTORY ---
        function saveConfig() {
            const newConf = {
                baseCost: parseFloat(document.getElementById('conf-baseCost').value),
                baseMins: parseFloat(document.getElementById('conf-baseMins').value),
                pricePerMin: parseFloat(document.getElementById('conf-pricePerMin').value)
            };
            db.ref('settings').set(newConf);
            Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±', 'success');
        }

        function addNewScooter() {
            const name = document.getElementById('new-scooter-name').value.toUpperCase();
            if(!name) return;
            db.ref('inventory/'+name).set({ status: 'available' });
            document.getElementById('new-scooter-name').value = '';
        }

        // --- 3. TRIP LOGIC (Enhanced with Select & Storage) ---
        async function startTripPopup() {
            if(!currentShiftId) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!', 'warning');
            
            // Build Options
            let options = availableScooters.map(s => `<option value="${s}">${s}</option>`).join('');
            if(availableScooters.length === 0) options = `<option disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙƒÙˆØªØ± Ù…ØªØ§Ø­</option>`;

            const { value: res } = await Swal.fire({
                title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `
                    <select id="sw-s" class="swal2-input">${options}</select>
                    <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input id="sw-b" type="number" class="swal2-input" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© %">
                    <p style="font-size:12px; margin-top:10px;">ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Upload)</p>
                    <input id="sw-img" type="file" accept="image/*" class="swal2-file">
                `,
                customClass: { popup: 'glass-panel' },
                background: 'transparent',
                preConfirm: () => {
                    const img = document.getElementById('sw-img').files[0];
                    const sc = document.getElementById('sw-s').value;
                    if(!img) return Swal.showValidationMessage('Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©!');
                    if(!sc) return Swal.showValidationMessage('Ø§Ø®ØªØ± Ø³ÙƒÙˆØªØ±!');
                    return [document.getElementById('sw-ph').value, sc, document.getElementById('sw-b').value, document.getElementById('sw-n').value, img];
                }
            });

            if(res) {
                Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...', didOpen: () => Swal.showLoading() });
                const [ph, s, bat, name, file] = res;
                
                // 1. Upload Image to Firebase Storage
                const ref = storage.ref(`ids/${Date.now()}_${ph}`);
                const snapshot = await ref.put(file);
                const url = await snapshot.ref.getDownloadURL();

                // 2. Create Trip
                const tripData = {
                    phone: ph, scooter: s, startBat: bat, client: name||'Ø²Ø§Ø¦Ø±',
                    idPhoto: url, // URL link, not Base64!
                    startTime: Date.now(), status: 'active', pausedDuration: 0,
                    shiftId: currentShiftId
                };
                
                db.ref('active_trips').push(tripData);
                db.ref('inventory/'+s).update({ status: 'active' }); // Mark as busy
                
                Swal.close();
                sendTG(`ğŸš€ <b>Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</b>\nØ³ÙƒÙˆØªØ±: ${s}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}`);
            }
        }

        async function terminateTrip(key) {
            const d = activeTrips[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            
            // Dynamic Pricing Calculation
            let cost = config.baseCost;
            if (mins > config.baseMins) {
                cost += (mins - config.baseMins) * config.pricePerMin;
            }
            cost = Math.round(cost);

            const { value: fin } = await Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨',
                html: `
                    <h1 style="color:var(--primary); font-size:50px;">${cost} Ø¬</h1>
                    <p>Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                    <input id="sw-disc" type="number" class="swal2-input" placeholder="Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    <input id="sw-bat" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© %">
                `,
                customClass: { popup: 'glass-panel' },
                background: 'transparent',
                preConfirm: () => { 
                    return { 
                        disc: parseFloat(document.getElementById('sw-disc').value)||0,
                        bat: document.getElementById('sw-bat').value 
                    } 
                }
            });

            if(fin) {
                const final = cost - fin.disc;
                const today = new Date().toISOString().split('T')[0];

                // Update Shift
                if(currentShiftId) {
                    db.ref('shifts/current').transaction(s => {
                        if(s) { s.totalCash += final; s.tripsCount += 1; }
                        return s;
                    });
                }

                // Archive
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, mins, final, endBat: fin.bat });
                
                // Free Scooter
                db.ref('inventory/'+d.scooter).update({ status: 'available' });
                
                // Remove Trip
                db.ref('active_trips/'+key).remove();
                sendTG(`ğŸ <b>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ’° ${final} Ø¬`);
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderTrips() {
            const grid = document.getElementById('fleet-grid'); 
            grid.innerHTML = "";
            let count = 0;
            for(let k in activeTrips) {
                count++; const d = activeTrips[k];
                grid.innerHTML += `
                    <div class="unit-card ${d.status==='paused'?'paused':''}">
                        <div style="display:flex; justify-content:space-between; color:white;">
                            <b>${d.scooter}</b> <span>${d.client}</span>
                        </div>
                        <img src="${d.idPhoto}" class="id-preview">
                        <div class="unit-timer" id="timer-${k}">00:00:00</div>
                        <div style="display:flex; gap:10px;">
                            ${d.status==='active'?`<button class="btn btn-warn" onclick="controlTrip('${k}','pause')" style="flex:1">Ø¥ÙŠÙ‚Ø§Ù</button>`:`<button class="btn btn-primary" onclick="controlTrip('${k}','resume')" style="flex:1">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`}
                            <button class="btn btn-danger" onclick="terminateTrip('${k}')" style="flex:1">Ø¥Ù†Ù‡Ø§Ø¡</button>
                        </div>
                    </div>`;
            }
            document.getElementById('k-active').innerText = count;
        }

        function controlTrip(k, a) {
            if(a==='pause') db.ref(`active_trips/${k}`).update({ status:'paused', pauseStart:Date.now() });
            else db.ref(`active_trips/${k}`).once('value', s => { 
                const d = s.val(); 
                db.ref(`active_trips/${k}`).update({ status:'active', pausedDuration: (d.pausedDuration||0)+(Date.now()-d.pauseStart) }); 
            });
        }

        function refreshTimers() {
            const now = Date.now();
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG');
            for(let k in activeTrips) {
                const d = activeTrips[k]; const el = document.getElementById(`timer-${k}`); if(!el) continue;
                let diff = (d.status==='active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
                const s = Math.floor(diff / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }

        function loadClients(q) {
            db.ref('clients').on('value', snap => {
                const tb = document.getElementById('clients-list'); tb.innerHTML='';
                snap.forEach(c => {
                    const v = c.val();
                    if(q && !c.key.includes(q)) return;
                    tb.innerHTML += `<tr><td>${v.name||'Ø²Ø§Ø¦Ø±'}</td><td>${c.key}</td><td>${v.points||0}</td><td>${v.totalSpend||0}</td><td>${v.blocked?'Ù…Ø­Ø¸ÙˆØ±':'Ù†Ø´Ø·'}</td><td></td></tr>`;
                });
            });
        }

        function loadAdminData() {
            db.ref('shifts/history').limitToLast(10).on('value', snap => {
                const tb = document.getElementById('shifts-list'); tb.innerHTML='';
                snap.forEach(s => {
                    const v = s.val();
                    const date = new Date(v.start).toLocaleDateString();
                    tb.innerHTML += `<tr><td>${v.user}</td><td>${new Date(v.start).toLocaleTimeString()}</td><td>${new Date(v.end).toLocaleTimeString()}</td><td style="color:#2ecc71">${v.totalCash} Ø¬</td><td>${v.tripsCount}</td></tr>`;
                });
            });
        }
        
        function sendTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }

    </script>
</body>
</html>
