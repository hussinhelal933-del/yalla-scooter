<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter V66.2 | Professional UI</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #050a14; --sidebar: #0a101e; --card: #0d1629;
            --primary: #00d4ff; --neon-purple: #bc13fe; --neon-red: #ff3d3d;
            --neon-green: #00f2ff; --border: rgba(0, 212, 255, 0.1);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 400px; text-align: center; padding: 50px; border-radius: 30px; border: 2px solid var(--primary); background: var(--card); box-shadow: 0 0 30px var(--primary); }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© --- */
        #app-ui { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #1a253a; display: flex; flex-direction: column; padding: 20px; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; color: #5c6b89; font-weight: bold; font-size: 14px; }
        .nav-item.active { color: #fff; background: linear-gradient(90deg, rgba(0,212,255,0.2), transparent); border-right: 3px solid var(--primary); }
        
        .main-container { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); }

        /* --- Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .stat-box h4 { color: #5c6b89; font-size: 14px; margin-bottom: 10px; }
        .stat-box span { color: var(--primary); font-family: 'Orbitron'; font-size: 28px; font-weight: 900; }

        /* --- ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø·ÙˆØ± (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©) --- */
        #active-trips-list { display: flex; flex-wrap: wrap; gap: 20px; }
        .trip-card { 
            width: 280px; background: var(--card); border-radius: 25px; padding: 25px; 
            display: flex; flex-direction: column; align-items: center; text-align: center;
            border: 1px solid var(--border); position: relative;
        }
        .trip-card .scooter-id { color: var(--primary); font-family: 'Orbitron'; font-size: 35px; font-weight: 900; margin-bottom: 5px; }
        .trip-card .responsible { color: #5c6b89; font-size: 12px; margin-bottom: 20px; }
        .trip-card .timer { font-family: 'Orbitron'; font-size: 45px; font-weight: 900; color: #fff; margin-bottom: 25px; letter-spacing: 2px; }
        
        .trip-card .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .btn-action { padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-timer { background: #1a253a; color: #ffcc00; border: 1px solid #ffcc00; }
        .btn-finish { background: var(--primary); color: #000; }
        .btn-emergency { background: #ff3d3d; color: #fff; grid-column: span 2; margin-top: 10px; }

        .trip-card.fallen { border-color: var(--neon-purple); box-shadow: 0 0 20px var(--neon-purple); animation: shake 0.5s infinite; }
        @keyframes shake { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(-1deg)} 75%{transform:rotate(1deg)} }

        /* --- Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± --- */
        .btn-add { background: linear-gradient(to right, #00d4ff, #0055ff); color: white; padding: 15px; border-radius: 15px; border: none; width: 100%; font-weight: 900; cursor: pointer; margin-bottom: 25px; }
        .section { display: none; }
        .section.active { display: block; }
        .admin-only { display: none; }
        input { width: 100%; padding: 15px; background: #08101f; border: 1px solid #1a253a; color: #fff; border-radius: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h1 style="color:var(--primary); font-family:'Orbitron';">YALLA SYSTEM</h1>
            <input type="password" id="passInput" placeholder="Password">
            <button onclick="handleAuth()" class="btn-add" style="margin-top:20px">LOGIN</button>
        </div>
    </div>

    <div id="app-ui">
        <nav class="sidebar">
            <h2 style="color:var(--primary); text-align:center; margin-bottom:30px; font-family:Orbitron;">YALLA</h2>
            <div class="nav-item active" onclick="nav('trips')"><i class="fas fa-play"></i> Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="nav-item" onclick="nav('fleet')"><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
            <div class="nav-item" onclick="nav('finance')"><i class="fas fa-wallet"></i> Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</div>
            <div class="nav-item admin-only" onclick="nav('settings')"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        </nav>

        <main class="main-container">
            <div id="sec-trips" class="section active">
                <div class="stats-grid">
                    <div class="stat-box"><h4>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h4><span id="k-cash">0</span></div>
                    <div class="stat-box"><h4>Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</h4><span id="k-active">0</span></div>
                    <div class="stat-box"><h4>Ù…ÙƒØªÙ…Ù„ Ø§Ù„ÙŠÙˆÙ…</h4><span id="k-done">0</span></div>
                </div>

                <button class="btn-add" onclick="openNewTrip()">+ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ðŸš€</button>
                
                <div id="active-trips-list">
                    </div>
            </div>

            <div id="sec-fleet" class="section"><div id="fleet-list"></div></div>
            <div id="sec-finance" class="section"><div id="finance-logs"></div></div>
            <div id="sec-settings" class="section admin-only">
                <div class="stat-box">
                    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø©</h3>
                    <input type="number" id="set-base" onchange="saveConfig()" placeholder="ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯">
                    <input type="number" id="set-min" onchange="saveConfig()" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©">
                </div>
            </div>
        </main>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let isAdmin = false, config = { base: 40, min: 2.66 }, activeTrips = {};

    function handleAuth() {
        const p = document.getElementById('passInput').value;
        if(p === "1214" || p === "1213" || p === "9924") {
            isAdmin = (p === "9924");
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('app-ui').style.display='flex';
            runApp();
        }
    }

    function runApp() {
        if(isAdmin) document.querySelectorAll('.admin-only').forEach(e=>e.style.display='block');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        db.ref('shifts/current/cash').on('value', s => document.getElementById('k-cash').innerText = (s.val()||0) + " Ø¬");
        db.ref('settings').on('value', s => { if(s.exists()) config = s.val(); });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        db.ref('active_trips').on('value', s => {
            activeTrips = s.val() || {};
            renderTrips();
        });
        setInterval(updateTimers, 1000);
    }

    function renderTrips() {
        const list = document.getElementById('active-trips-list');
        list.innerHTML = "";
        let count = 0;
        
        for(let k in activeTrips) {
            count++;
            const t = activeTrips[k];
            const card = document.createElement('div');
            card.className = 'trip-card';
            card.id = `card-${k}`;
            
            card.innerHTML = `
                <div class="scooter-id">${t.scooterId}</div>
                <div class="responsible">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${t.phone}</div>
                <div class="timer" id="timer-${k}">00:00</div>
                <div class="btn-group">
                    <button class="btn-action btn-timer">Ù…Ø¤Ù‚Øª</button>
                    <button class="btn-action btn-finish" onclick="finishTrip('${k}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                    <button class="btn-action btn-emergency" onclick="finishTrip('${k}', true)">ðŸš¨ Ø¥Ù†Ù‡Ø§Ø¡ Ø¨Ø¹Ø·Ù„ Ø£Ùˆ Ø®ØµÙ…</button>
                </div>
            `;
            list.appendChild(card);
            
            // Ø±Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù‚ÙˆØ·
            db.ref('live_nodes/'+t.scooterId+'/fallen').on('value', s => {
                if(s.val()) card.classList.add('fallen'); else card.classList.remove('fallen');
            });
        }
        document.getElementById('k-active').innerText = count;
    }

    function updateTimers() {
        for(let k in activeTrips) {
            const start = activeTrips[k].start;
            const diff = Math.floor((Date.now() - start) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            const el = document.getElementById(`timer-${k}`);
            if(el) el.innerText = `${m}:${s}`;
        }
    }

    async function finishTrip(key, isEmergency = false) {
        const t = activeTrips[key];
        const mins = Math.max(1, Math.floor((Date.now() - t.start) / 60000));
        let cost = Math.max(config.base, Math.round(config.base + (mins - 15) * config.min));
        
        const { value: res } = await Swal.fire({
            title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
            html: `<h2 style="color:var(--primary)">Ø§Ù„Ø­Ø³Ø§Ø¨: ${cost} Ø¬</h2><p>Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                   <input id="disc" class="swal2-input" placeholder="Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ">`,
            background: '#0d1629', color: '#fff',
            confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„'
        });

        if(res !== undefined) {
            const final = cost - (parseFloat(document.getElementById('disc').value) || 0);
            db.ref('shifts/history').push({ ...t, final, end: Date.now() });
            db.ref('shifts/current/cash').transaction(v => (v||0) + final);
            db.ref('active_trips/'+key).remove();
        }
    }

    async function openNewTrip() {
        const { value: res } = await Swal.fire({
            title: 'ØªØ´ØºÙŠÙ„ Ø¬Ø¯ÙŠØ¯',
            html: '<input id="sw-name" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Hussin)"><input id="sw-id" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">',
            background: '#0d1629', color: '#fff',
            preConfirm: () => [document.getElementById('sw-name').value, document.getElementById('sw-id').value]
        });
        if(res && res[1]) {
            db.ref('active_trips').push({ phone: res[0], scooterId: res[1], start: Date.now() });
        }
    }

    function nav(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
