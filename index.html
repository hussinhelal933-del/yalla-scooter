<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Wallet & Payment Edition</title>
    
    <!-- الموارد الأساسية -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Rajdhani:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --yalla-blue: #00d2ff;
            --yalla-brown: #5D4037;
            --yalla-light-brown: #8D6E63;
            --bg-dark: #0a0a0c;
            --card-inner: rgba(93, 64, 55, 0.15);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg-dark); color: white; }

        /* --- شاشة الدخول --- */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1a110f 0%, #000 100%); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .auth-input { width: 100%; padding: 18px; border-radius: 15px; border: 1.5px solid var(--yalla-brown); margin-bottom: 12px; font-size: 18px; text-align: center; background: var(--card-inner); color: white; }

        /* --- الخريطة --- */
        #map { position: absolute; inset: 0; z-index: 1; filter: sepia(0.2) brightness(0.9); }

        /* --- المنيو الجانبي --- */
        #side-menu { 
            position: fixed; top: 0; right: -100%; width: 82%; height: 100%; 
            background: var(--yalla-brown); z-index: 5000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            padding: 60px 25px; display: flex; flex-direction: column;
            border-left: 2px solid var(--yalla-blue);
        }
        #side-menu.open { right: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 4999; display: none; backdrop-filter: blur(4px); }

        /* --- الأزرار العائمة (HUD) --- */
        .btn-fab { position: absolute; z-index: 1000; background: var(--yalla-brown); border: 1.5px solid var(--yalla-blue); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--yalla-blue); box-shadow: 0 8px 20px rgba(0,0,0,0.5); cursor: pointer; }
        .btn-menu { bottom: 40px; right: 25px; }
        .btn-locate { bottom: 40px; left: 25px; }
        .btn-scan-main { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, var(--yalla-brown), #3E2723); color: var(--yalla-blue); padding: 18px 50px; border-radius: 50px; font-weight: 900; font-size: 20px; width: 250px; z-index: 1000; border: 2px solid var(--yalla-blue); box-shadow: 0 10px 30px rgba(0,210,255,0.2); }

        /* --- شاشة المحفظة والدفع الاحترافية --- */
        .full-page { position: fixed; inset: 0; background: var(--bg-dark); z-index: 6000; display: none; flex-direction: column; animation: slideIn 0.4s ease; overflow-y: auto; }
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .pg-header { padding: 25px; display: flex; align-items: center; justify-content: space-between; background: var(--yalla-brown); border-bottom: 2px solid var(--yalla-blue); }
        
        .balance-section { background: linear-gradient(135deg, var(--yalla-brown), #2c1e1a); margin: 20px; padding: 30px; border-radius: 25px; border: 1px solid var(--yalla-blue); text-align: center; }
        .balance-section h1 { font-family: 'Rajdhani'; font-size: 45px; margin: 10px 0; color: var(--yalla-blue); }

        .payment-method-card {
            background: var(--card-inner); border: 1px solid var(--yalla-brown); border-radius: 20px;
            padding: 20px; margin: 0 20px 15px 20px; display: flex; align-items: center; justify-content: space-between;
            transition: 0.3s; cursor: pointer;
        }
        .payment-method-card:active { border-color: var(--yalla-blue); background: rgba(0,210,255,0.05); }
        .method-info { display: flex; align-items: center; gap: 15px; }
        .method-info i { font-size: 24px; color: var(--yalla-blue); width: 30px; text-align: center; }

        /* نموذج الفيزا */
        .visa-form { padding: 20px; background: #15151a; border-radius: 20px; margin: 20px; border: 1px solid #333; display: none; }
        .visa-input { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #444; color: white; border-radius: 10px; }

        /* تصميم الماركر */
        .bike-marker { background: none; border: none; }
        .marker-inner { width: 48px; height: 48px; background: var(--yalla-brown); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.4); border: 2.5px solid var(--yalla-blue); }
    </style>
</head>
<body>

    <!-- 1. شاشة الدخول -->
    <div id="auth-screen">
        <svg style="width:120px; margin-bottom:20px;" viewBox="0 0 100 100">
            <path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#00d2ff" stroke-width="12" fill="none" stroke-linecap="round"/>
            <circle cx="40" cy="85" r="8" fill="#5D4037"/>
        </svg>
        <h1 style="font-family:'Rajdhani'; color:var(--yalla-blue); margin:0;">YALLA SCOOTER</h1>
        <p style="color:var(--yalla-light-brown); margin-bottom:30px;">Premium Ride Experience</p>
        <input type="tel" id="loginPhone" class="auth-input" placeholder="رقم الهاتف">
        <button onclick="handleLogin()" class="btn-scan-main" style="position:static; transform:none; width:100%;">دخول</button>
    </div>

    <!-- 2. المنيو الجانبي -->
    <div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
    <nav id="side-menu">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <div style="width:60px; height:60px; border-radius:15px; background:var(--bg-dark); border:2px solid var(--yalla-blue); display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-user-astronaut" style="color:var(--yalla-blue); font-size:25px;"></i>
            </div>
            <div>
                <b id="u-name" style="color:var(--yalla-blue); font-size:20px;">Hassan</b><br>
                <small id="u-phone" style="color:#ccc;">+201153243863</small>
            </div>
        </div>
        <div class="menu-item" onclick="openPage('wallet')"><i class="fas fa-wallet"></i> المحفظة <i class="fas fa-chevron-left" style="margin-right:auto; font-size:12px;"></i></div>
        <div class="menu-item"><i class="fas fa-history"></i> السجل <i class="fas fa-chevron-left" style="margin-right:auto; font-size:12px;"></i></div>
        <div class="menu-item" onclick="logout()" style="margin-top:auto; color:var(--yalla-blue);"><i class="fas fa-sign-out-alt"></i> خروج</div>
    </nav>

    <!-- 3. الخريطة والأزرار -->
    <div id="map"></div>
    <button class="btn-fab btn-menu" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    <button class="btn-fab btn-locate" onclick="locateMe()"><i class="fas fa-crosshairs"></i></button>
    <button class="btn-scan-main" onclick="openScanner()"><i class="fas fa-qrcode"></i> SCAN TO RIDE</button>

    <!-- 4. شاشة المحفظة (الجديدة كلياً) -->
    <div id="pg-wallet" class="full-page">
        <div class="pg-header">
            <i class="fas fa-chevron-right" onclick="closePage('wallet')" style="font-size:20px; cursor:pointer;"></i>
            <b style="font-size:18px;">المحفظة الرقمية</b>
            <i></i>
        </div>

        <div class="balance-section">
            <small style="color:var(--yalla-blue); font-weight:bold;">الرصيد المتاح</small>
            <h1 id="balance-txt">0.00 ج.م</h1>
            <p style="font-size:12px; color:#aaa;">رصيدك آمن ومشفر بالكامل</p>
        </div>

        <div style="padding:0 20px;">
            <p style="color:var(--yalla-light-brown); font-weight:bold; margin-bottom:15px;">اختر طريقة الشحن:</p>
            
            <!-- محفظة إلكترونية -->
            <div class="payment-method-card" onclick="showWalletInfo()">
                <div class="method-info">
                    <i class="fas fa-mobile-alt"></i>
                    <div>
                        <b>محفظة إلكترونية</b><br>
                        <small style="color:#888;">فودافون كاش / إنستا باي</small>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="font-size:12px; color:#555;"></i>
            </div>

            <!-- بطاقة بنكية -->
            <div class="payment-method-card" onclick="toggleVisaForm()">
                <div class="method-info">
                    <i class="fas fa-credit-card"></i>
                    <div>
                        <b>بطاقة بنكية</b><br>
                        <small style="color:#888;">Visa / Mastercard</small>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="font-size:12px; color:#555;"></i>
            </div>

            <!-- نموذج الفيزا -->
            <div id="visa-form" class="visa-form">
                <input type="text" class="visa-input" placeholder="اسم صاحب الكارت">
                <input type="number" class="visa-input" placeholder="رقم الكارت (16 رقم)">
                <div style="display:flex; gap:10px;">
                    <input type="text" class="visa-input" placeholder="MM/YY">
                    <input type="password" class="visa-input" placeholder="CVV">
                </div>
                <button class="btn-scan-main" style="position:static; transform:none; width:100%; font-size:16px;" onclick="Swal.fire('عذراً', 'جاري ربط بوابة الدفع البنكية مع البنك المركزي', 'warning')">تأكيد وحفظ البطاقة</button>
            </div>

        </div>
    </div>

<script>
    // --- الربط مع Firebase ---
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, scooterMarkers = {}, userPhone = localStorage.getItem('yalla_verified_phone');
    let shopLoc = { lat: 30.0444, lon: 31.2357 };

    window.onload = () => { if(userPhone) { document.getElementById('auth-screen').style.display='none'; initApp(); } };

    function handleLogin() {
        const ph = document.getElementById('loginPhone').value;
        if(ph.length < 11) return Swal.fire('خطأ', 'رقم الهاتف غير صحيح', 'error');
        userPhone = ph; localStorage.setItem('yalla_verified_phone', ph);
        location.reload();
    }

    function initApp() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([shopLoc.lat, shopLoc.lon], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        db.ref('live_nodes').on('value', snap => {
            const data = snap.val() || {};
            for (let id in scooterMarkers) { if (!data[id]) { map.removeLayer(scooterMarkers[id]); delete scooterMarkers[id]; } }
            for (let id in data) {
                const d = data[id];
                if (d.status === 'available') {
                    if (!scooterMarkers[id]) {
                        const icon = L.divIcon({ className: 'bike-marker', html: `<div class="marker-inner"><svg width="24" viewBox="0 0 100 100"><path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#00d2ff" stroke-width="15" fill="none" stroke-linecap="round"/></svg></div>` });
                        scooterMarkers[id] = L.marker([d.lat, d.lon], {icon}).addTo(map);
                    } else { scooterMarkers[id].setLatLng([d.lat, d.lon]); }
                } else if (scooterMarkers[id]) { map.removeLayer(scooterMarkers[id]); delete scooterMarkers[id]; }
            }
        });

        db.ref('users/' + userPhone + '/balance').on('value', s => {
            document.getElementById('balance-txt').innerText = (s.val()||0).toFixed(2) + " ج.م";
            document.getElementById('u-phone').innerText = userPhone;
        });
        locateMe();
    }

    // --- وظائف الدفع والمحفظة ---
    function showWalletInfo() {
        Swal.fire({
            title: 'الشحن عبر المحفظة',
            background: '#1a110f', color: '#fff',
            html: `
                <div style="text-align:right; font-size:14px;">
                    <p>1. قم بتحويل المبلغ للرقم:</p>
                    <h2 style="color:var(--yalla-blue); text-align:center; letter-spacing:2px;">01014004125</h2>
                    <p>2. متاح (فودافون كاش / إنستا باي).</p>
                    <p>3. بعد التحويل، أدخل المبلغ هنا لطلب التفعيل:</p>
                    <input id="topup-amt" type="number" class="swal2-input" placeholder="المبلغ المحول">
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'إرسال طلب شحن',
            preConfirm: () => document.getElementById('topup-amt').value
        }).then(res => {
            if(res.value) {
                db.ref('topup_requests').push({ phone: userPhone, amount: parseFloat(res.value), status: 'pending', time: Date.now() });
                Swal.fire('تم استلام طلبك', 'سيتم مراجعة التحويل وإضافة الرصيد فوراً', 'success');
            }
        });
    }

    function toggleVisaForm() {
        const form = document.getElementById('visa-form');
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }

    function toggleMenu() {
        const m = document.getElementById('side-menu');
        const o = document.getElementById('overlay');
        const open = m.classList.toggle('open');
        o.style.display = open ? 'block' : 'none';
    }

    function openPage(id) { document.getElementById('pg-'+id).style.display='flex'; toggleMenu(); }
    function closePage(id) { document.getElementById('pg-'+id).style.display='none'; }

    async function openScanner() {
        const { value: scId } = await Swal.fire({ title: 'Scan to Ride', input: 'text', inputPlaceholder: 'رقم السكوتر', confirmButtonColor: '#5D4037', background: '#0a0a0c', color: '#fff' });
        if(scId) {
            db.ref('users/'+userPhone+'/balance').once('value', s => {
                if((s.val()||0) < 40) return Swal.fire('رصيد ضعيف', 'يرجى شحن المحفظة بـ 40 ج كحد أدنى', 'warning');
                db.ref('active_trips').push({ phone: userPhone, scooterId: scId, start: Date.now() });
                Swal.fire('رحلة سعيدة!', 'تم الاتصال بالسكوتر بنجاح', 'success');
            });
        }
    }

    function locateMe() { if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 17)); }
    function logout() { localStorage.clear(); location.reload(); }
</script>

</body>
</html>
