<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN GOLD V76 | Ultimate Dashboard</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #0062ff; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --danger: #ff4757; --success: #2ed573; --border: rgba(255,255,255,0.1);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Pro */
        aside { width: 280px; background: #080d1a; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .nav-item { padding: 16px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #64748b; transition: 0.3s; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: rgba(0,98,255,0.1); color: var(--primary); border-right: 4px solid var(--primary); }
        
        /* Main Layout */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 80px; background: #080d1a; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 30px; justify-content: space-between; }
        .content { flex: 1; overflow-y: auto; padding: 25px; background: radial-gradient(circle at top right, #1e293b, #0f172a); }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from {opacity:0; transform: translateY(20px)} to {opacity:1; transform: translateY(0)} }

        /* Trip Card Modern */
        .trip-card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); transition: 0.3s; }
        .trip-card.alert-zone { border: 2px solid var(--danger); box-shadow: 0 0 20px rgba(255, 71, 87, 0.2); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.8; } }

        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-pause { background: #f59e0b; color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .id-badge { width: 60px; height: 40px; border-radius: 8px; object-fit: cover; border: 2px solid var(--primary); }
        
        /* Map UI */
        #map-wrapper { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 600px; }
        #live-map { border-radius: 20px; border: 1px solid var(--border); }
        .device-item { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; }
        .device-item:hover { border-color: var(--primary); }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h1 style="color:var(--primary); font-weight:900; letter-spacing:3px;">TITAN ENTERPRISE</h1>
        <input type="password" id="pinInput" placeholder="ENTER PIN" style="background:#111; border:1px solid #333; color:#fff; padding:20px; width:320px; border-radius:15px; text-align:center; font-size:24px; margin-bottom:20px;">
        <button onclick="checkLogin()" class="btn btn-primary" style="width:320px; justify-content:center;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>

    <aside>
        <div style="padding:40px 30px; font-size:24px; font-weight:900; color:var(--primary);"><i class="fas fa-shield-alt"></i> TITAN OS</div>
        <div class="nav-item active" onclick="nav('trips', this)"><i class="fas fa-play-circle"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
        <div class="nav-item" onclick="nav('tracking', this)"><i class="fas fa-satellite"></i> Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªØªØ¨Ø¹</div>
        <div class="nav-item" onclick="nav('customers', this)"><i class="fas fa-address-book"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav-item" onclick="nav('faults', this)"><i class="fas fa-tools"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</div>
        <div class="nav-item" onclick="nav('scooter-mode', this)" style="margin-top:auto; background:rgba(255,255,255,0.05)"><i class="fas fa-mobile-alt"></i> ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆØªØ±</div>
    </aside>

    <main>
        <header>
            <h2 id="page-title" style="margin:0">Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>
            <div style="display:flex; align-items:center; gap:20px;">
                <div id="w-vault" style="background:rgba(46,213,115,0.1); color:var(--success); padding:10px 20px; border-radius:12px; font-weight:bold;">Ø§Ù„Ø®Ø²ÙŠÙ†Ø©: 0 Ø¬.Ù…</div>
                <div id="live-clock" style="font-weight:900; font-size:20px;">00:00:00</div>
            </div>
        </header>

        <div class="content">
            <div id="sec-trips" class="section active">
                <button class="btn btn-primary" onclick="openTripModal()" style="margin-bottom:25px;"><i class="fas fa-plus"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø·Ø§Ù‚Ø© + ÙˆÙ‚Øª)</button>
                <div id="active-trips-list"></div>
            </div>

            <div id="sec-tracking" class="section">
                <div id="map-wrapper">
                    <div id="fleet-list-sidebar" style="overflow-y:auto; padding-right:5px;">
                        <h4 style="margin-top:0">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©</h4>
                        <div id="fleet-items-container"></div>
                    </div>
                    <div id="live-map"></div>
                </div>
            </div>

            <div id="sec-scooter-mode" class="section">
                <div style="text-align:center; padding:50px;">
                    <div id="node-speed" style="font-size:120px; font-weight:900; color:var(--primary);">0</div>
                    <div style="font-size:20px; opacity:0.6">KM/H</div>
                    <h1 id="node-name-label" style="margin:20px 0;">-</h1>
                    <div id="node-battery" style="color:var(--success); font-size:24px;"><i class="fas fa-battery-full"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
                </div>
            </div>

            <div id="sec-customers" class="section"><h2>Ù‚Ø±ÙŠØ¨Ø§Ù‹.. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2></div>
            <div id="sec-faults" class="section"><h2>Ù‚Ø±ÙŠØ¨Ø§Ù‹.. Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</h2></div>
        </div>
    </main>

<script>
    const TG = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
    const RATES = { base: 40, free: 15, perMin: 2.66, shop: {lat: 30.0444, lon: 31.2357} };
    
    firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    
    let map = null, markers = {}, onlineFleet = {}, scooterName = "";

    function checkLogin() {
        const pin = document.getElementById('pinInput').value;
        if(pin === "1214") { 
            Swal.fire({title:'Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±', input:'text'}).then(r => {
                if(r.value) { 
                    scooterName = r.value; 
                    document.getElementById('login-overlay').style.display='none'; 
                    nav('scooter-mode'); 
                    initScooterBeacon(); 
                }
            });
        } else if(pin === "1213" || pin === "9924") { 
            document.getElementById('login-overlay').style.display='none'; 
            initAdmin(); 
        }
    }

    function initAdmin() {
        db.ref('active_trips').on('value', snap => renderTrips(snap.val() || {}));
        db.ref('fleet_online').on('value', snap => {
            onlineFleet = snap.val() || {};
            renderFleetSidebar();
            updateMapMarkers();
        });
        db.ref('vault_total').on('value', snap => document.getElementById('w-vault').innerText = `Ø§Ù„Ø®Ø²ÙŠÙ†Ø©: ${snap.val() || 0} Ø¬.Ù…`);
    }

    function initMap() {
        if(!map) {
            map = L.map('live-map', {zoomControl: false}).setView([RATES.shop.lat, RATES.shop.lon], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.circle([RATES.shop.lat, RATES.shop.lon], {radius: 150, color: '#0062ff', fillOpacity: 0.1}).addTo(map);
        }
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ---
    function openTripModal() {
        Swal.fire({
            title: 'Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            html: `
                <input id="sw-scoot" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                <input id="sw-phone" class="swal2-input" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input id="sw-id" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø£Ùˆ ØµÙˆØ±Ø©)">
            `,
            confirmButtonText: 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª',
            preConfirm: () => {
                const s = document.getElementById('sw-scoot').value;
                const p = document.getElementById('sw-phone').value;
                const id = document.getElementById('sw-id').value;
                if(!s || !p) return Swal.showValidationMessage('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©');
                db.ref('active_trips').push({
                    scooterId: s, clientPhone: p, idCard: id,
                    startTime: Date.now(), status: 'running', pauseTotal: 0
                });
                sendTG(`ğŸš€ *Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø©*\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${s}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${p}`);
            }
        });
    }

    function renderTrips(data) {
        const container = document.getElementById('active-trips-list');
        container.innerHTML = "";
        for(let id in data) {
            const t = data[id];
            const live = onlineFleet[t.scooterId];
            let dist = 0, isOut = false;
            
            if(live) {
                dist = calculateDistance(live.lat, live.lon, RATES.shop.lat, RATES.shop.lon);
                if(dist > 150) isOut = true;
            }

            const mins = Math.floor((Date.now() - t.startTime - (t.pauseTotal || 0)) / 60000);

            container.innerHTML += `
                <div class="trip-card ${isOut ? 'alert-zone' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:15px; align-items:center;">
                            <div style="background:var(--primary); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ›µ</div>
                            <div>
                                <b style="font-size:18px;">${t.scooterId}</b><br>
                                <small>${t.clientPhone} | Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${t.idCard || '--'}</small>
                            </div>
                        </div>
                        <div style="text-align:center;">
                            <h1 style="margin:0; color:${isOut ? 'var(--danger)' : 'var(--success)'}">${mins} <small>Ø¯Ù‚ÙŠÙ‚Ø©</small></h1>
                            <small>${isOut ? 'âš ï¸ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø²ÙˆÙ†' : 'âœ… Ø¢Ù…Ù†'}</small>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-pause" onclick="togglePause('${id}', '${t.status}')">${t.status === 'paused' ? 'Ø§Ø³ØªØ¦Ù†Ø§Ù' : 'ÙˆÙ‚Ù Ù…Ø¤Ù‚Øª'}</button>
                            <button class="btn btn-danger" onclick="finishTrip('${id}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ­ØµÙŠÙ„</button>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ---
    function renderFleetSidebar() {
        const cont = document.getElementById('fleet-items-container');
        cont.innerHTML = "";
        for(let id in onlineFleet) {
            const s = onlineFleet[id];
            cont.innerHTML += `
                <div class="device-item" onclick="focusDevice('${id}')">
                    <div style="display:flex; justify-content:space-between"><b>${s.name}</b> <span style="color:var(--success)">${s.speed} km/h</span></div>
                    <div style="font-size:11px; opacity:0.6; margin-top:5px;">Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${s.battery || '--'}</div>
                </div>
            `;
        }
    }

    function focusDevice(id) {
        const s = onlineFleet[id];
        map.setView([s.lat, s.lon], 18);
        markers[id].openPopup();
    }

    function updateMapMarkers() {
        if(!map) return;
        for(let id in onlineFleet) {
            const s = onlineFleet[id];
            if(!markers[id]) {
                markers[id] = L.marker([s.lat, s.lon]).addTo(map).bindPopup(`<b>${s.name}</b><br>Ø§Ù„Ø³Ø±Ø¹Ø©: ${s.speed}`);
            } else {
                markers[id].setLatLng([s.lat, s.lon]);
            }
        }
    }

    // --- ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†) ---
    async function initScooterBeacon() {
        const ref = db.ref('fleet_online/' + scooterName);
        ref.onDisconnect().remove();
        document.getElementById('node-name-label').innerText = scooterName;

        let battery = "100%";
        if(navigator.getBattery) { const b = await navigator.getBattery(); battery = Math.round(b.level*100) + "%"; }

        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const speed = Math.round((pos.coords.speed || 0)*3.6);
            
            ref.set({ name: scooterName, lat, lon, speed, battery, lastSeen: Date.now() });
            document.getElementById('node-speed').innerText = speed;
            document.getElementById('node-battery').innerHTML = `<i class="fas fa-battery-three-quarters"></i> Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${battery}`;
        }, null, {enableHighAccuracy: true});

        window.addEventListener('beforeunload', () => sendTG(`ğŸš¨ *ØªØ­Ø°ÙŠØ±:* Ø§Ù„Ø³ÙƒÙˆØªØ± (${scooterName}) Ø£ØºÙ„Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!`));
    }

    // --- Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function nav(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('page-title').innerText = el.innerText;
        }
        if(id === 'tracking') setTimeout(initMap, 300);
    }

    function finishTrip(id) {
        db.ref('active_trips/'+id).once('value', snap => {
            const t = snap.val();
            const mins = Math.floor((Date.now() - t.startTime) / 60000);
            const cost = Math.round(RATES.base + (mins > RATES.free ? (mins - RATES.free) * RATES.perMin : 0));
            Swal.fire({ title: 'ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº', text: `Ø§Ù„Ø­Ø³Ø§Ø¨: ${cost} Ø¬.Ù…`, showCancelButton: true }).then(r => {
                if(r.isConfirmed) {
                    db.ref('vault_total').transaction(v => (v || 0) + cost);
                    db.ref('active_trips/'+id).remove();
                    sendTG(`âœ… *Ø¥Ù†Ù‡Ø§Ø¡ Ø±Ø­Ù„Ø©*\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${t.scooterId}\nØ§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬.Ù…`);
                }
            });
        });
    }

    function sendTG(m) { fetch(`https://api.telegram.org/bot${TG.token}/sendMessage?chat_id=${TG.chat}&text=${encodeURIComponent(m)}&parse_mode=Markdown`); }
    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG'); }, 1000);
</script>
</body>
</html>
