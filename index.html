<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Emperor | Tactical OS V50</title>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #010409; --panel: #0d1117; --sidebar: #010409;
            --primary: #00f2ff; --accent: #7000ff; --danger: #ff004c; --warn: #ffea00;
            --text: #e6edf3; --border: #30363d;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* --- Unified UI Layout --- */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header { padding: 30px; text-align: center; border-bottom: 1px solid var(--border); }
        .sidebar-header h1 { font-family: 'Orbitron'; font-size: 20px; color: var(--primary); margin: 0; text-shadow: 0 0 15px var(--primary); }
        
        .main-stage { flex: 1; display: grid; grid-template-columns: 1fr 380px; overflow: hidden; }
        .work-zone { padding: 20px; overflow-y: auto; background: radial-gradient(circle at center, #0d1117, #010409); }
        .info-zone { background: var(--panel); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        /* --- Global Sections --- */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }

        /* --- Tactical Components --- */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .kpi-box { background: rgba(0, 242, 255, 0.05); border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; }
        .kpi-box .val { font-family: 'Orbitron'; font-size: 22px; color: var(--primary); display: block; }

        .radar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .unit-card { background: #161b22; border: 1px solid var(--border); border-radius: 15px; padding: 15px; position: relative; }
        .timer-xl { font-family: 'Orbitron'; font-size: 38px; text-align: center; color: #fff; margin: 10px 0; }
        .id-photo { width: 100%; height: 110px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); }

        /* --- AI Assistant Style --- */
        .ai-box { background: linear-gradient(135deg, #0d1117 0%, #161b22 100%); border: 1px solid var(--primary); border-radius: 15px; padding: 15px; }
        .ai-chat { height: 200px; overflow-y: auto; font-size: 13px; color: var(--primary); margin-bottom: 10px; padding: 5px; }
        .msg-ai { background: rgba(0, 242, 255, 0.1); padding: 8px; border-radius: 8px; border-right: 3px solid var(--primary); }

        /* --- Buttons --- */
        .btn { padding: 10px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-action { background: var(--panel); border: 1px solid var(--border); color: #64748b; font-size: 13px; margin-bottom: 5px; }
        .btn-action:hover, .btn-action.active { color: var(--primary); border-color: var(--primary); background: rgba(0,242,255,0.05); }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid var(--primary); width: 350px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- 1. AUTH -->
    <div id="login-screen">
        <div class="auth-card">
            <h1 style="font-family:Orbitron; color:var(--primary); margin-bottom: 20px;">EMPEROR ACCESS</h1>
            <input type="password" id="passInput" style="width:100%; padding:15px; background:#000; border:1px solid var(--border); color:var(--primary); font-size:28px; text-align:center; border-radius:10px; margin-bottom: 20px;" placeholder="****">
            <button onclick="login()" class="btn btn-primary">AUTHORIZE</button>
        </div>
    </div>

    <!-- 2. SIDEBAR -->
    <nav class="sidebar">
        <div class="sidebar-header"><h1>YALLA V50</h1></div>
        <div style="padding: 15px; display: flex; flex-direction: column;">
            <button class="btn btn-action active" onclick="showSec('ops')"><i class="fas fa-satellite-dish"></i> Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            <button class="btn btn-action" onclick="showSec('clients')"><i class="fas fa-users-cog"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            <button class="btn btn-action" onclick="showSec('finance')"><i class="fas fa-vault"></i> Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
            <button class="btn btn-action" onclick="showSec('maint')"><i class="fas fa-tools"></i> Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø­Ø¶ÙˆØ±</button>
        </div>
        <div style="margin-top:auto; padding:15px;">
            <button class="btn btn-primary" onclick="startTripFlow()">+ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (QR)</button>
        </div>
    </nav>

    <!-- 3. UNIFIED STAGE -->
    <div class="main-stage">
        
        <!-- Center Zone: Operation Area -->
        <main class="work-zone">
            
            <div id="sec-ops" class="section active">
                <div class="kpi-row">
                    <div class="kpi-box"><span class="val" id="k-active">0</span><small>Ù†Ø´Ø·</small></div>
                    <div class="kpi-box"><span class="val" id="k-rev">0</span><small>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</small></div>
                    <div class="kpi-box"><span class="val" id="k-charge">0</span><small>ÙŠØ´Ø­Ù†</small></div>
                    <div class="kpi-box"><span class="val" id="k-trips">0</span><small>Ù…Ù‡Ù…Ø§Øª</small></div>
                </div>
                <div id="qr-reader-box" style="display:none; width:100%; max-width:400px; margin-bottom:20px; border:2px solid var(--primary); border-radius:15px; overflow:hidden;"></div>
                <div id="fleet-radar" class="radar-grid"></div>
            </div>

            <div id="sec-clients" class="section">
                <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ..." oninput="loadClients(this.value)" style="width:100%; padding:15px; background:#000; border:1px solid var(--border); color:white; border-radius:10px; margin-bottom:20px;">
                <table style="width:100%; font-size:13px; background:var(--panel); border-radius:10px; overflow:hidden;" cellpadding="12">
                    <thead><tr style="color:var(--primary)"><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="clients-list"></tbody>
                </table>
            </div>

            <div id="sec-finance" class="section">
                <input type="date" id="adminDate" onchange="loadHistory(this.value)" style="padding:10px; background:#000; color:white; border:1px solid var(--primary); border-radius:8px; margin-bottom:20px;">
                <table style="width:100%; font-size:12px; background:var(--panel); border-radius:10px;" cellpadding="10">
                    <thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead>
                    <tbody id="hist-list"></tbody>
                </table>
            </div>

        </main>

        <!-- Right Zone: Intelligence & Summaries -->
        <aside class="info-zone">
            
            <!-- AI ANALYST -->
            <div class="ai-box">
                <div style="font-weight:900; color:var(--primary); font-size:14px; margin-bottom:10px;"><i class="fas fa-brain"></i> Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„ØªÙƒØªÙŠÙƒÙŠ (AI)</div>
                <div id="ai-messages" class="ai-chat">
                    <div class="msg-ai">Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø¬Ø§Ù‡Ø². Ù‚Ù…Øª Ø¨ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙˆØªØ£ÙƒØ¯Øª Ù…Ù† Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø·ÙˆÙ„. Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±ØŸ</div>
                </div>
                <button class="btn btn-primary" style="font-size:11px;" onclick="runAIAnalysis()">Ø·Ù„Ø¨ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ©</button>
            </div>

            <!-- QUICK ACTIONS -->
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn" style="background:var(--warn); color:#000;" onclick="startChargePopup()">+ ØªÙˆØµÙŠÙ„ Ø´Ø§Ø­Ù†</button>
                <button class="btn" style="background:var(--danger); color:#fff;" onclick="expensePopup()">- ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª</button>
                <button class="btn" style="background:var(--accent); color:#fff;" onclick="attendancePopup()">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± (GPS)</button>
            </div>

            <!-- Performance Graph -->
            <div style="height:180px; border:1px solid var(--border); border-radius:15px; padding:10px;">
                <canvas id="miniChart"></canvas>
            </div>

        </aside>
    </div>

    <script>
        // --- 1. CONFIGURATION (AIZA) ---
        const GEMINI_KEY = "AIzaSyAPWM-Ue8plkZqxkMn86Q0xwPWB6Cbczfw";
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        
        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        });
        const db = firebase.database();
        let tripsCache = {};
        let qrScanner;

        setInterval(() => refreshTimers(), 1000);

        // --- 2. AUTH & ENGINE ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                document.getElementById('login-screen').style.display = 'none';
                initEmperorSync();
            } else { Swal.fire('Error', 'Invalid Authorization', 'error'); }
        }

        function showSec(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.btn-action').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- 3. THE SECURE TRIP FLOW ---
        async function startTripFlow() {
            // ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…Ø³Ø­ QR
            const reader = document.getElementById('qr-reader-box'); reader.style.display = 'block';
            qrScanner = new Html5Qrcode("qr-reader-box");
            qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (id) => {
                qrScanner.stop(); reader.style.display = 'none';
                launchTripProcess(id);
            });
        }

        async function launchTripProcess(sId) {
            const { value: res } = await Swal.fire({
                title: `Ø¥ØµØ¯Ø§Ø± Ù…Ù‡Ù…Ø© Ù„Ù€ ${sId}`,
                html: `
                    <input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input id="sw-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù† %">
                    <p style="color:var(--danger); font-size:12px;">Ø¥Ù„Ø²Ø§Ù…ÙŠ: ØªØµÙˆÙŠØ± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</p>
                    <input id="sw-img" type="file" accept="image/*" capture="environment" class="swal2-file">
                `,
                background: '#0d1117', color: '#fff',
                preConfirm: () => {
                    const img = document.getElementById('sw-img').files[0];
                    if(!img) return Swal.showValidationMessage('ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©!');
                    return [document.getElementById('sw-ph').value, document.getElementById('sw-n').value, document.getElementById('sw-b').value, img];
                }
            });

            if(res) {
                const [ph, name, bat, imgFile] = res;
                // ÙØ­Øµ ÙØ¬ÙˆØ© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© (Security Check)
                const lastLog = await db.ref(`fleet_status/${sId}`).once('value');
                const lastBat = lastLog.val()?.battery || 100;
                if(lastBat - bat > 5) broadcastTG(`ğŸš¨ <b>Ø®Ø±Ù‚ Ø£Ù…Ù†ÙŠ!</b>\nØ³ÙƒÙˆØªØ± ${sId} Ù†Ù‚Øµ ${lastBat - bat}% Ø®Ø§Ø±Ø¬ Ø§Ù„Ø±Ø­Ù„Ø©!`);

                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref('active_trips').push({ 
                        scooter:sId, phone:ph, client:name||'Ø²Ø§Ø¦Ø±', startBat:bat, 
                        idPhoto: e.target.result, startTime:Date.now(), status:'active', pausedDuration:0 
                    });
                    broadcastTG(`ğŸš€ <b>Ù…Ù‡Ù…Ø© Ø¨Ø¯Ø£Øª</b>\nØ³ÙƒÙˆØªØ±: ${sId}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}\nØ¨Ø·Ø§Ø±ÙŠØ©: ${bat}%`);
                };
                reader.readAsDataURL(imgFile);
            }
        }

        async function terminateTrip(key) {
            const d = tripsCache[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            let cost = Math.max(mins * 1.5, 40);

            const { value: fin } = await Swal.fire({
                title: 'Ø¥ØºÙ„Ø§Ù‚ ÙˆØ­Ø³Ø§Ø¨',
                html: `<h1 style="color:var(--primary); font-size:50px; margin:0;">${Math.round(cost)} Ø¬</h1><hr><input id="sw-bat" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© %"><input id="sw-d" type="number" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø®ØµÙ…"><input id="sw-w" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨">`,
                background: '#0d1117', color: '#fff',
                preConfirm: () => { return { bat: document.getElementById('sw-bat').value, disc: parseFloat(document.getElementById('sw-d').value)||0, why: document.getElementById('sw-w').value } }
            });

            if(fin) {
                const final = Math.round(cost) - fin.disc;
                const today = new Date().toISOString().split('T')[0];
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, mins, cost:Math.round(cost), disc:fin.disc, final, reason:fin.why, time: new Date().toLocaleTimeString() });
                db.ref(`fleet_status/${d.scooter}`).update({ battery: fin.bat });
                db.ref('active_trips/'+key).remove();
                broadcastTG(`ğŸ <b>Ø§ÙƒØªÙ…Ø§Ù„ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ•’ ${mins}m\nğŸ’° Ø§Ù„Ù…Ø­ØµÙ„: ${final} Ø¬\nğŸ”‹ Ø¨Ø·Ø§Ø±ÙŠØ©: ${fin.bat}%`);
            }
        }

        // --- 4. DATA SYNC & ANALYTICS ---
        function initEmperorSync() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('fleet-radar'); grid.innerHTML = "";
                tripsCache = snap.val() || {};
                let count = 0;
                for(let key in tripsCache) {
                    count++; const d = tripsCache[key]; const isP = d.status === 'paused';
                    grid.innerHTML += `
                        <div class="unit-card ${isP?'paused':''}">
                            <div style="display:flex; justify-content:space-between"><b>${d.scooter}</b><small>ğŸ”‹ ${d.startBat}% | ${d.client}</small></div>
                            <img src="${d.idPhoto}" class="id-photo" onclick="Swal.fire({imageUrl:this.src, background:'#000'})">
                            <div class="timer-xl" id="timer-${key}">00:00:00</div>
                            <div style="display:flex; gap:10px;">
                                ${!isP ? `<button class="btn btn-warn" onclick="controlTrip('${key}','pause')">ÙˆÙ‚Ù</button>`:`<button class="btn btn-primary" onclick="controlTrip('${key}','resume')">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>`}
                                <button class="btn btn-danger" onclick="terminateTrip('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                            </div>
                        </div>`;
                }
                document.getElementById('k-active').innerText = count;
            });

            const t = new Date().toISOString().split('T')[0];
            db.ref(`history/${t}`).on('value', s => { let r=0; s.forEach(x => r+=(x.val().final||0)); document.getElementById('k-rev').innerText = r; });
        }

        function refreshTimers() {
            const now = Date.now();
            for(let key in tripsCache) {
                const d = tripsCache[key]; const el = document.getElementById(`timer-${key}`); if(!el) continue;
                let diff = (d.status === 'active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0));
                const s = Math.floor(diff / 1000);
                el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
            }
        }

        // --- 5. REAL AI ANALYST (GEMINI) ---
        async function runAIAnalysis() {
            const rev = document.getElementById('k-rev').innerText;
            const active = document.getElementById('k-active').innerText;
            const chat = document.getElementById('ai-messages');
            
            chat.innerHTML = `<div class="msg-ai">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>`;
            
            const context = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø¯ÙŠØ± ØªÙƒØªÙŠÙƒÙŠ Ù„Ù…Ø­Ù„ Ø³ÙƒÙˆØªØ± ÙƒÙ‡Ø±Ø¨Ø§Ø¡. Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ ${rev} Ø¬Ù†ÙŠÙ‡Ø§Ù‹ØŒ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ${active}. Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ ÙˆÙ‚Ø¯Ù… Ù†ØµÙŠØ­Ø© ÙˆØ§Ø­Ø¯Ø© ØªÙƒØªÙŠÙƒÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: context }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                chat.innerHTML = `<div class="msg-ai">${reply}</div>`;
            } catch(e) { chat.innerHTML = `<div class="msg-ai" style="color:red">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ø°ÙƒÙŠØ©.</div>`; }
        }

        // --- Utils (Charging, Expenses, Etc) ---
        function controlTrip(k, a) {
            if(a==='pause') db.ref(`active_trips/${k}`).update({ status:'paused', pauseStart:Date.now() });
            else db.ref(`active_trips/${k}`).once('value', s => { const d = s.val(); db.ref(`active_trips/${k}`).update({ status:'active', pausedDuration: (d.pausedDuration||0)+(Date.now()-d.pauseStart) }); });
        }
        function broadcastTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }
        
        async function expensePopup() {
            const { value: f } = await Swal.fire({ title:'Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø­Ù„', html:'<input id="ex-n" class="swal2-input" placeholder="Ø§Ù„ÙˆØµÙ"><input id="ex-c" type="number" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">', background:'#0d1117', color:'#fff', preConfirm:()=>[document.getElementById('ex-n').value, document.getElementById('ex-c').value] });
            if(f && f[1]) { const t = new Date().toISOString().split('T')[0]; db.ref(`expenses/${t}`).push({ name: f[0], cost: parseFloat(f[1]), date: Date.now() }); broadcastTG(`ğŸ’¸ <b>Ù…ØµØ±ÙˆÙØ§Øª</b>\nğŸ“ ${f[0]}\nğŸ’° ${f[1]} Ø¬`); }
        }

        // Initialize Chart
        const ctx = document.getElementById('miniChart').getContext('2d');
        new Chart(ctx, { type:'bar', data: { labels:['S','M','T','W','T','F','S'], datasets:[{ data:[12, 19, 3, 5, 2, 3, 10], backgroundColor:'#00f2ff' }] }, options: { maintainAspectRatio:false, plugins:{legend:{display:false}} } });

    </script>
</body>
</html>
