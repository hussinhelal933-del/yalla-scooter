<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Tactical Command V6</title>
    
    <!-- Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #020617; --card: #0f172a; --sidebar: #020617;
            --primary: #2dd4bf; --accent: #3b82f6; --danger: #f43f5e; --warn: #fbbf24;
            --text: #f8fafc; --text-muted: #64748b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar & Nav --- */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #1e293b; display: flex; flex-direction: column; z-index: 1000; transition: 0.3s; }
        .brand { padding: 25px; text-align: center; border-bottom: 1px solid #1e293b; color: var(--primary); font-family: 'Orbitron'; font-size: 18px; font-weight: 900; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 12px; font-weight: 700; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #0f172a; color: var(--primary); border-right: 4px solid var(--primary); }

        /* --- Layout --- */
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; background: radial-gradient(circle at 10% 10%, #0f172a, transparent); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }

        /* --- KPI Cards --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #1e293b; position: relative; }
        .kpi-card::after { content: ''; position: absolute; bottom: 0; left: 10%; width: 80%; height: 2px; background: var(--primary); opacity: 0.5; }
        .kpi-val { font-family: 'Orbitron'; font-size: 24px; color: var(--primary); display: block; margin-top: 5px; }

        /* --- Cards & Tables --- */
        .scooter-card { background: var(--card); border: 1px solid #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 15px; transition: 0.3s; }
        .scooter-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .glass-table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; font-size: 13px; }
        th { background: #020617; padding: 12px; text-align: right; color: var(--text-muted); }
        td { padding: 12px; border-bottom: 1px solid #1e293b; }

        /* --- AI System --- */
        #ai-trigger { position: fixed; bottom: 25px; left: 25px; width: 60px; height: 60px; background: var(--primary); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 2000; box-shadow: 0 0 20px var(--primary); }
        .ai-drawer { position: fixed; top: 0; left: -400px; width: 380px; height: 100%; background: #020617; border-right: 2px solid var(--primary); z-index: 2001; transition: 0.4s; display: flex; flex-direction: column; }
        .ai-drawer.open { left: 0; }
        .ai-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 10px; font-size: 13px; max-width: 85%; }
        .msg.bot { background: #1e293b; color: var(--primary); align-self: flex-start; }
        .msg.user { background: var(--accent); color: white; align-self: flex-end; }

        /* Responsive */
        @media(max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 65px; flex-direction: row; border-top: 1px solid #1e293b; border-left: none; }
            .brand { display: none; }
            .nav-item { flex-direction: column; font-size: 10px; padding: 10px; flex: 1; text-align: center; }
            .main-content { padding-bottom: 80px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .ai-drawer { width: 100%; left: -100%; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="login-overlay">
        <div style="background:var(--card); padding:40px; border-radius:20px; text-align:center; width:340px; border:1px solid #1e293b;">
            <h1 style="font-family:Orbitron; color:var(--primary)">AUTHENTICATE</h1>
            <input type="password" id="passInput" style="width:100%; padding:15px; margin:20px 0; background:#000; border:1px solid #1e293b; color:var(--primary); font-size:24px; text-align:center; border-radius:10px;" placeholder="****">
            <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); border:none; border-radius:10px; font-weight:bold; cursor:pointer;">ACCESS COMMAND</button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar">
        <div class="brand">YALLA COMMAND</div>
        <div class="nav-item active" onclick="nav('rental')"><i class="fas fa-satellite"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª</div>
        <div class="nav-item" onclick="nav('maintenance')"><i class="fas fa-tools"></i> Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
        <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav-item" onclick="nav('attendance')"><i class="fas fa-fingerprint"></i> Ø§Ù„Ø­Ø¶ÙˆØ±</div>
        <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger)" onclick="location.reload()"><i class="fas fa-power-off"></i></div>
    </nav>

    <main class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h2 id="page-title" style="margin:0">Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
            <div id="live-clock" style="font-family:Orbitron; color:var(--primary); font-size:14px;">00:00:00</div>
        </div>

        <!-- KPI Area -->
        <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-val" id="kpi-active">0</span><small>Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹</small></div>
            <div class="kpi-card"><span class="kpi-val" id="kpi-rev">0</span><small>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</small></div>
            <div class="kpi-card"><span class="kpi-val" id="kpi-trips">0</span><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</small></div>
            <div class="kpi-card"><span class="kpi-val" id="kpi-maint" style="color:var(--warn)">0</span><small>ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</small></div>
        </div>

        <!-- Section: Rental -->
        <div id="sec-rental" class="section active">
            <button onclick="newTripPopup()" style="width:100%; background:var(--primary); border:none; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; margin-bottom:20px;">+ ÙØªØ­ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <div id="fleet-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px;"></div>
        </div>

        <!-- Section: Maintenance -->
        <div id="sec-maintenance" class="section">
            <button onclick="maintPopup()" style="width:100%; background:var(--warn); border:none; padding:12px; border-radius:10px; font-weight:bold; margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø¥ØµÙ„Ø§Ø­ Ø¬Ø¯ÙŠØ¯</button>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø§Ù„Ø¹Ø·Ù„/Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="maint-list"></tbody>
            </table>
        </div>

        <!-- Section: Clients -->
        <div id="sec-clients" class="section">
            <input type="text" id="cSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ..." oninput="loadClients(this.value)" style="width:100%; padding:12px; background:#000; border:1px solid #1e293b; color:white; border-radius:10px; margin-bottom:20px;">
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±Ø­Ù„Ø§Øª</th><th>Ø§Ù„ØµØ±Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="clients-list"></tbody>
            </table>
        </div>

        <!-- Section: Attendance -->
        <div id="sec-attendance" class="section">
            <div class="scooter-card" style="text-align:center; border-color:var(--accent);">
                <i class="fas fa-location-arrow" style="font-size:30px; color:var(--accent); margin-bottom:10px;"></i>
                <p>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ù€ GPS</p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button onclick="attendance('IN')" style="background:var(--primary); border:none; padding:10px 20px; border-radius:8px;">Ø­Ø¶ÙˆØ±</button>
                    <button onclick="attendance('OUT')" style="background:var(--danger); color:white; border:none; padding:10px 20px; border-radius:8px;">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <!-- Section: Admin -->
        <div id="sec-admin" class="section">
            <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-val" id="adm-profit">0</span><small>ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</small></div>
                <div class="kpi-card"><span class="kpi-val" id="adm-exp" style="color:var(--danger)">0</span><small>Ù…ØµØ±ÙˆÙØ§Øª</small></div>
            </div>
        </div>
    </main>

    <!-- AI -->
    <div id="ai-trigger" onclick="toggleAI()">ğŸ§ </div>
    <div id="ai-drawer" class="ai-drawer">
        <div style="padding:20px; border-bottom:1px solid #1e293b; display:flex; justify-content:space-between; align-items:center;">
            <b style="color:var(--primary)">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØªÙƒØªÙŠÙƒÙŠ AI</b>
            <i class="fas fa-times" onclick="toggleAI()" style="cursor:pointer"></i>
        </div>
        <div id="ai-messages" class="ai-body"></div>
        <div class="ai-footer" style="padding:15px; border-top:1px solid #1e293b; display:flex; gap:10px;">
            <input type="text" id="ai-inp" style="flex:1; background:#000; border:1px solid #1e293b; color:white; padding:10px; border-radius:8px;">
            <button onclick="askAI()" style="background:var(--primary); border:none; padding:10px; border-radius:8px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- Config ---
        const GEMINI_KEY = "AIzaSyAPWM-Ue8plkZqxkMn86Q0xwPWB6Cbczfw";
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 };

        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        setInterval(() => document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG'), 1000);

        // --- Auth & Nav ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                if(p === "9924") document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                initSync();
            } else { Swal.fire('Error', 'Wrong Code', 'error'); }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'maintenance') loadMaint();
            if(id === 'clients') loadClients();
        }

        // --- Core Rental Logic ---
        function initSync() {
            // Active Trips
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('fleet-grid'); grid.innerHTML = "";
                let count = 0;
                snap.forEach(t => {
                    count++; const d = t.val(); const mins = Math.floor((Date.now() - d.start)/60000);
                    grid.innerHTML += `
                        <div class="scooter-card">
                            <div style="display:flex; justify-content:space-between"><b>${d.scooter}</b><small>${d.client}</small></div>
                            <div style="font-family:Orbitron; font-size:28px; color:var(--primary); margin:15px 0;">${mins}m</div>
                            <button onclick="endTrip('${t.key}', ${mins}, '${d.phone}', '${d.scooter}')" style="width:100%; border:1px solid var(--danger); background:transparent; color:var(--danger); padding:8px; border-radius:8px; cursor:pointer;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                        </div>
                    `;
                });
                document.getElementById('kpi-active').innerText = count;
            });

            // Revenue Today
            const today = new Date().toISOString().split('T')[0];
            db.ref(`history/${today}`).on('value', snap => {
                let rev = 0, trips = 0;
                snap.forEach(c => { rev += (c.val().total||0); trips++; });
                document.getElementById('kpi-rev').innerText = rev;
                document.getElementById('kpi-trips').innerText = trips;
                document.getElementById('adm-profit').innerText = rev;
            });
        }

        async function newTripPopup() {
            const { value: form } = await Swal.fire({
                title: 'ØªØ®ØµÙŠØµ Ø±Ø­Ù„Ø©',
                html: `
                    <input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                    <input id="sw-p" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" oninput="checkClientStatus(this.value)">
                    <div id="c-status" style="font-size:12px; margin-top:5px;"></div>
                    <input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                `,
                background: '#020617', color: '#fff',
                preConfirm: () => [document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-p').value, document.getElementById('sw-n').value]
            });

            if(form && form[0]) {
                const [s, p, n] = form;
                // Check Maintenance
                const scoot = await db.ref('scooters/'+s).once('value');
                if(scoot.exists() && scoot.val().status === 'maint') {
                    return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø³ÙƒÙˆØªØ± ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©!', 'warning');
                }
                db.ref('active_trips').push({ scooter:s, phone:p||'0', client:n||'Ø²Ø§Ø¦Ø±', start:Date.now() });
                if(p!=='0') db.ref('clients/'+p).update({ name:n, lastVisit:Date.now() });
            }
        }

        async function checkClientStatus(phone) {
            if(phone.length < 10) return;
            const snap = await db.ref('clients/'+phone).once('value');
            const div = document.getElementById('c-status');
            if(snap.exists()) {
                const c = snap.val();
                if(c.blocked) { div.innerHTML = "<span style='color:red'>â›” Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¸ÙˆØ±!</span>"; }
                else { 
                    div.innerHTML = `<span style='color:var(--primary)'>âœ… Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„ (ØµØ±Ù: ${c.totalSpend||0})</span>`;
                    document.getElementById('sw-n').value = c.name;
                }
            }
        }

        async function endTrip(key, mins, phone, scooter) {
            const base = Math.max(mins * 1.5, 15);
            const { value: res } = await Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ­Ø³Ø§Ø¨',
                html: `
                    <h2 style="color:var(--primary)">${base} Ø¬.Ù…</h2>
                    <hr>
                    <label><input type="checkbox" id="hasIssue"> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ / Ø®ØµÙ…</label>
                    <div id="issueBox" style="display:none; margin-top:10px">
                        <select id="issueType" class="swal2-input"><option>Error 14</option><option>Battery</option><option>Tire</option><option>Other</option></select>
                        <input id="issueCost" type="number" class="swal2-input" placeholder="ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ø·Ù„">
                    </div>
                `,
                background:'#020617', color:'#fff', showCancelButton:true,
                didOpen: () => {
                    const chk = document.getElementById('hasIssue');
                    chk.onchange = () => document.getElementById('issueBox').style.display = chk.checked ? 'block' : 'none';
                },
                preConfirm: () => {
                    const has = document.getElementById('hasIssue').checked;
                    return { has, cost: has ? (parseFloat(document.getElementById('issueCost').value)||0) : 0, type: document.getElementById('issueType').value }
                }
            });

            if(res) {
                const total = base + res.cost;
                const today = new Date().toISOString().split('T')[0];
                db.ref(`history/${today}`).push({ scooter, total, duration:mins, end:Date.now(), issue:res.has });
                
                if(phone !== '0') {
                    db.ref(`clients/${phone}`).transaction(c => {
                        return { ...c, totalSpend: (c?.totalSpend||0)+total, trips: (c?.trips||0)+1 };
                    });
                }

                if(res.has) {
                    db.ref(`scooters/${scooter}`).transaction(s => { return { ...s, status:'maint', issues:(s?.issues||0)+1 } });
                    fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ chat_id: TELEGRAM.chat, text: `ğŸš¨ Ø¹Ø·Ù„ Ø¨Ø³ÙƒÙˆØªØ± ${scooter}\nÙ†ÙˆØ¹: ${res.type}\nØªÙƒÙ„ÙØ©: ${res.cost} Ø¬`, parse_mode:'HTML' })
                    });
                }
                db.ref('active_trips/'+key).remove();
            }
        }

        // --- Maintenance ---
        async function maintPopup() {
            const { value: f } = await Swal.fire({
                title: 'ØµÙŠØ§Ù†Ø©',
                html: '<input id="ms" class="swal2-input" placeholder="Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="mp" class="swal2-input" placeholder="Ø§Ù„Ù‚Ø·Ø¹Ø©"><input id="mc" class="swal2-input" type="number" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">',
                background:'#020617', color:'#fff', preConfirm: () => [document.getElementById('ms').value.toUpperCase(), document.getElementById('mp').value, document.getElementById('mc').value]
            });
            if(f) {
                db.ref('maintenance_log').push({ scooter:f[0], part:f[1], cost:parseFloat(f[2])||0, date:Date.now() });
                db.ref(`scooters/${f[0]}`).update({ status:'ready' });
            }
        }

        function loadMaint() {
            db.ref('maintenance_log').limitToLast(15).on('value', snap => {
                const list = document.getElementById('maint-list'); list.innerHTML = "";
                snap.forEach(c => {
                    const v = c.val();
                    list.innerHTML += `<tr><td>${v.scooter}</td><td>${v.part}</td><td style="color:red">${v.cost}</td><td>${new Date(v.date).toLocaleDateString()}</td></tr>`;
                });
            });
        }

        // --- Clients ---
        function loadClients(search = "") {
            db.ref('clients').on('value', snap => {
                const list = document.getElementById('clients-list'); list.innerHTML = "";
                snap.forEach(c => {
                    const v = c.val();
                    if(search && !c.key.includes(search)) return;
                    list.innerHTML += `<tr><td>${v.name}</td><td>${c.key}</td><td>${v.trips||0}</td><td>${v.totalSpend||0}</td><td>${v.blocked?'â›”':'âœ…'}</td></tr>`;
                });
            });
        }

        // --- AI ---
        function toggleAI() { document.getElementById('ai-drawer').classList.toggle('open'); }
        async function askAI() {
            const inp = document.getElementById('ai-inp'); const q = inp.value; if(!q) return;
            const box = document.getElementById('ai-messages'); box.innerHTML += `<div class="msg user">${q}</div>`;
            inp.value = ""; box.scrollTop = box.scrollHeight;
            const rev = document.getElementById('kpi-rev').innerText;
            const ctx = `Ù†Ø¸Ø§Ù… ÙŠØ§Ù„Ø§ Ø³ÙƒÙˆØªØ±. Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ… ${rev} Ø¬.Ù…. Ø±Ø¯ Ø¨Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆØªÙƒØªÙŠÙƒÙŠØ©: ${q}`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: ctx }] }] })
                });
                const d = await res.json();
                box.innerHTML += `<div class="msg bot">${d.candidates[0].content.parts[0].text}</div>`;
            } catch(e) { box.innerHTML += `<div class="msg bot">ERROR CONNECTION</div>`; }
            box.scrollTop = box.scrollHeight;
        }

        // --- Attendance & Utils ---
        function attendance(type) {
            if(!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                const d = getDist(pos.coords.latitude, pos.coords.longitude, SHOP_LOC.lat, SHOP_LOC.lng);
                if(d > 200) return Swal.fire('Error', 'Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ', 'error');
                const t = new Date().toLocaleTimeString();
                db.ref(`attendance/${new Date().toISOString().split('T')[0]}`).push({ type, time:t });
                Swal.fire('Done', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'} ÙÙŠ ${t}`, 'success');
            });
        }

        function getDist(la1, lo1, la2, lo2) {
            const R = 6371e3; const d1 = la1*Math.PI/180, d2 = la2*Math.PI/180;
            const dl = (la2-la1)*Math.PI/180, do1 = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dl/2)**2 + Math.cos(d1)*Math.cos(d2)*Math.sin(do1/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

    </script>
</body>
</html>
