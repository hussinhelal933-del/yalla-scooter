<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN MASTER CORE V78 | Unified Fleet OS</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00d2ff; --danger: #ff0055; --success: #00ff9d;
            --bg: #05070a; --surface: #0f1219; --border: rgba(255,255,255,0.08);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: #fff; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar UI */
        aside { width: 280px; background: #080d1a; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .nav-link { padding: 18px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #64748b; transition: 0.3s; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: rgba(0,210,255,0.1); color: var(--primary); border-right: 4px solid var(--primary); }

        /* Main Workspace */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 80px; background: #080d1a; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 30px; justify-content: space-between; }
        .content { flex: 1; overflow-y: auto; padding: 25px; background: radial-gradient(circle at top right, #1e293b, #05070a); }

        /* Dynamic Sections */
        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from {opacity:0; transform: translateY(15px)} to {opacity:1; transform: translateY(0)} }

        /* KPI & Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--surface); padding: 20px; border-radius: 15px; border-bottom: 3px solid var(--primary); }
        .trip-card { background: var(--surface); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid var(--border); position: relative; }
        .trip-card.alarm-active { border: 2px solid var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { box-shadow: 0 0 20px rgba(255,0,85,0.4); } }

        /* Map & Radar */
        #radar-box { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 600px; }
        #map { border-radius: 20px; border: 1px solid var(--border); }
        
        /* Buttons */
        .btn { padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-stop { background: var(--danger); color: #fff; }

        /* Authentication Overlay */
        #auth-gate { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="auth-gate">
        <h1 style="font-family:'Orbitron'; color:var(--primary); font-size:40px; margin-bottom:20px;">TITAN MASTER</h1>
        <input type="password" id="gate-pin" placeholder="Enter PIN" style="background:#111; border:1px solid #333; color:#fff; padding:20px; width:320px; border-radius:15px; text-align:center; font-size:24px;">
        <button onclick="unlock()" class="btn btn-main" style="margin-top:20px; width:320px; justify-content:center;">LOGIN</button>
    </div>

    <aside>
        <div style="padding:40px 30px;"><h2 style="font-family:'Orbitron'; color:var(--primary); margin:0;">TITAN OS</h2></div>
        <div class="nav-link active" onclick="nav('dash', this)"><i class="fas fa-th-large"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        <div class="nav-link" onclick="nav('trips', this)"><i class="fas fa-play"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="nav-link" onclick="nav('radar', this)"><i class="fas fa-satellite-dish"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±</div>
        <div class="nav-link" onclick="nav('customers', this)"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav-link" onclick="nav('scooter', this)" style="margin-top:auto; border-top:1px solid var(--border);"><i class="fas fa-mobile-alt"></i> ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆØªØ±</div>
    </aside>

    <main>
        <header>
            <h2 id="view-name">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
            <div style="display:flex; align-items:center; gap:25px;">
                <div id="v-vault" style="color:var(--success); font-weight:bold; font-size:18px;">Ø§Ù„Ø®Ø²ÙŠÙ†Ø©: 0 Ø¬.Ù…</div>
                <div id="clock" style="font-family:'Orbitron'; font-size:20px;">00:00:00</div>
            </div>
        </header>

        <div class="content">
            <div id="sec-dash" class="section active">
                <div class="kpi-row">
                    <div class="kpi-card"><small>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</small><h2 id="st-active">0</h2></div>
                    <div class="kpi-card"><small>Ø£Ø¬Ù‡Ø²Ø© Ù…ØªØµÙ„Ø©</small><h2 id="st-online">0</h2></div>
                    <div class="kpi-card" style="border-color:var(--danger)"><small>Ø®Ø§Ø±Ø¬ Ø§Ù„Ø²ÙˆÙ†</small><h2 id="st-out">0</h2></div>
                </div>
                <div style="background:var(--surface); padding:20px; border-radius:15px;">
                    <h3>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Titan AI ğŸ¤–</h3>
                    <div id="ai-logs">Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠØ±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹...</div>
                </div>
            </div>

            <div id="sec-trips" class="section">
                <button class="btn btn-main" onclick="startNewTripModal()" style="margin-bottom:20px;"><i class="fas fa-plus"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© (Ù…ÙˆÙ‚Øª + Ø¨Ø·Ø§Ù‚Ø©)</button>
                <div id="trips-list"></div>
            </div>

            <div id="sec-radar" class="section">
                <div id="radar-box">
                    <div id="radar-sidebar" style="background:var(--surface); border-radius:15px; padding:15px; overflow-y:auto;">
                        <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h4>
                        <div id="device-names"></div>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <div id="sec-scooter" class="section">
                <div style="text-align:center; padding-top:50px;">
                    <div style="font-family:'Orbitron'; font-size:120px; color:var(--primary);" id="sc-speed-val">0</div>
                    <div style="opacity:0.5; letter-spacing:5px;">SPEED KM/H (LIMIT: 25)</div>
                    <h2 id="sc-name-tag">--</h2>
                    <div id="sc-battery-tag" style="font-size:22px; color:var(--success);">ğŸ”‹ --</div>
                    <div id="sc-alarm" style="display:none; background:rgba(255,0,85,0.2); padding:20px; border-radius:15px; margin-top:20px;">
                        <h2 style="color:var(--danger)">âš ï¸ Ø¥Ù†Ø°Ø§Ø±: Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚</h2>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- Configuration ---
    const CONFIG = { 
        base: 40, free: 15, rate: 2.66, limit: 25, 
        shop: {lat: 30.0444, lon: 31.2357},
        tgBot: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs",
        tgChat: "5684905593"
    };

    firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    
    let map = null, markers = {}, fleet = {}, scooterName = "";
    const alertSound = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');

    // --- Core Functions ---
    function unlock() {
        const pin = document.getElementById('gate-pin').value;
        if(pin === "1214") { 
            Swal.fire({title: 'Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©', input: 'text'}).then(r => {
                if(r.value) { scooterName = r.value; document.getElementById('auth-gate').style.display='none'; nav('scooter'); initScooterUnit(); }
            });
        } else if(pin === "1213" || pin === "9924") {
            document.getElementById('auth-gate').style.display='none'; initAdmin();
        }
    }

    function initAdmin() {
        db.ref('active_trips').on('value', snap => renderTrips(snap.val() || {}));
        db.ref('fleet_online').on('value', snap => {
            fleet = snap.val() || {};
            document.getElementById('st-online').innerText = Object.keys(fleet).length;
            renderRadarList();
        });
        db.ref('vault_total').on('value', snap => document.getElementById('v-vault').innerText = `Ø§Ù„Ø®Ø²ÙŠÙ†Ø©: ${snap.val() || 0} Ø¬.Ù…`);
    }

    function renderTrips(data) {
        const list = document.getElementById('trips-list');
        list.innerHTML = "";
        let count = 0, outCount = 0;
        for(let id in data) {
            count++;
            const t = data[id];
            const live = fleet[t.scooterId];
            let isOut = false;
            if(live) {
                const d = calcDist(live.lat, live.lon, CONFIG.shop.lat, CONFIG.shop.lon);
                if(d > 150) { isOut = true; outCount++; }
            }
            const mins = Math.floor((Date.now() - t.startTime) / 60000);
            const cost = Math.round(CONFIG.base + (mins > CONFIG.free ? (mins - CONFIG.free) * CONFIG.rate : 0));

            list.innerHTML += `
                <div class="trip-card ${isOut ? 'alarm-active' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b style="font-size:20px;">ğŸ›µ ${t.scooterId}</b><br>
                            <small>ğŸ“ ${t.clientPhone} | Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ${t.idCard || '--'}</small>
                        </div>
                        <div style="text-align:center">
                            <h1 style="margin:0; font-family:'Orbitron'; color:${isOut ? 'var(--danger)' : 'var(--primary)'}">${mins}m</h1>
                            <small>${cost} EGP</small>
                        </div>
                        <button class="btn btn-stop" onclick="endTrip('${id}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                    </div>
                </div>`;
        }
        document.getElementById('st-active').innerText = count;
        document.getElementById('st-out').innerText = outCount;
    }

    // --- Radar & Map ---
    function initMap() {
        if(!map) {
            map = L.map('map', {zoomControl: false}).setView([CONFIG.shop.lat, CONFIG.shop.lon], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.circle([CONFIG.shop.lat, CONFIG.shop.lon], {radius: 150, color: '#00d2ff', fillOpacity: 0.1}).addTo(map);
        }
    }

    function renderRadarList() {
        const devList = document.getElementById('device-names');
        devList.innerHTML = "";
        for(let id in fleet) {
            const s = fleet[id];
            devList.innerHTML += `
                <div onclick="focusS('${id}')" style="padding:10px; background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px; cursor:pointer;">
                    <b>${s.name}</b><br><small style="color:var(--success)">${s.speed} km/h</small>
                </div>`;
            if(!markers[id]) markers[id] = L.marker([s.lat, s.lon]).addTo(map).bindPopup(s.name);
            else markers[id].setLatLng([s.lat, s.lon]);
        }
    }

    function focusS(id) { const s = fleet[id]; map.setView([s.lat, s.lon], 18); markers[id].openPopup(); }

    // --- Scooter Mode ---
    function initScooterUnit() {
        document.getElementById('sc-name-tag').innerText = scooterName;
        const ref = db.ref('fleet_online/' + scooterName);
        ref.onDisconnect().remove();

        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const speed = Math.round((pos.coords.speed || 0) * 3.6);
            const dist = calcDist(lat, lon, CONFIG.shop.lat, CONFIG.shop.lon);

            document.getElementById('sc-speed-val').innerText = speed;
            if(speed > CONFIG.limit) document.getElementById('sc-speed-val').style.color = 'var(--danger)';
            else document.getElementById('sc-speed-val').style.color = 'var(--primary)';

            if(dist > 150) { 
                document.getElementById('sc-alarm').style.display='block'; 
                alertSound.play();
            } else { 
                document.getElementById('sc-alarm').style.display='none'; 
            }

            ref.update({ name: scooterName, lat, lon, speed, lastSeen: Date.now() });
        }, null, {enableHighAccuracy: true});
    }

    // --- Helpers ---
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function startNewTripModal() {
        Swal.fire({
            title: 'Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            html: `<input id="sw-s" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="sw-p" class="swal2-input" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„"><input id="sw-i" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">`,
            preConfirm: () => {
                const s = document.getElementById('sw-s').value, p = document.getElementById('sw-p').value, i = document.getElementById('sw-i').value;
                if(!s || !p) return Swal.showValidationMessage('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');
                db.ref('active_trips').push({ scooterId: s, clientPhone: p, idCard: i, startTime: Date.now() });
                tg(`ğŸš€ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${s}`);
            }
        });
    }

    function endTrip(id) {
        db.ref('active_trips/'+id).once('value', snap => {
            const t = snap.val();
            const mins = Math.floor((Date.now() - t.startTime) / 60000);
            const cost = Math.round(CONFIG.base + (mins > CONFIG.free ? (mins - CONFIG.free) * CONFIG.rate : 0));
            Swal.fire({title: 'ØªØ­ØµÙŠÙ„', text: `Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬.Ù…`, showCancelButton: true}).then(r => {
                if(r.isConfirmed) {
                    db.ref('vault_total').transaction(v => (v || 0) + cost);
                    db.ref('active_trips/'+id).remove();
                    tg(`âœ… ØªÙ… ØªØ­ØµÙŠÙ„ ${cost} Ø¬.Ù… Ù…Ù† ${t.scooterId}`);
                }
            });
        });
    }

    function nav(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id === 'radar') setTimeout(initMap, 300);
    }

    function tg(m) { fetch(`https://api.telegram.org/bot${CONFIG.tgBot}/sendMessage?chat_id=${CONFIG.tgChat}&text=${encodeURIComponent(m)}`); }
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12: false}); }, 1000);
</script>
</body>
</html>
