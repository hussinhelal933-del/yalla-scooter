<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN OS V100 | Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #00f2ff; --danger: #ff4d4d; --success: #00ff88; --dark: #05050a; --glass: rgba(255,255,255,0.05); }
        body { background: var(--dark); color: #fff; font-family: 'Cairo', sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .top-bar { background: #0c0c16; padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .logo { font-family: 'Orbitron'; font-size: 1.2rem; color: var(--primary); letter-spacing: 2px; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .card { background: #11111d; border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--glass); position: relative; }

        /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        #map { height: 300px; border-radius: 20px; border: 2px solid #1a1a2e; margin-bottom: 10px; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { border: none; border-radius: 12px; padding: 15px; font-weight: 900; cursor: pointer; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main { background: linear-gradient(90deg, #7000ff, #00f2ff); color: #000; width: 100%; }
        .btn-action { background: var(--glass); color: #fff; font-size: 13px; }

        /* Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© */
        .trip-active { background: #1a1a2e; border-right: 4px solid var(--primary); padding: 15px; border-radius: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .timer { font-family: 'Orbitron'; color: var(--primary); font-size: 1.5rem; }

        /* Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ AI */
        .ai-report { background: rgba(0, 255, 136, 0.05); border: 1px dashed var(--success); border-radius: 15px; padding: 15px; font-size: 13px; line-height: 1.6; }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ */
        .alarm-bg { animation: alarm-pulse 0.6s infinite; }
        @keyframes alarm-pulse { 0% { background: #05050a; } 50% { background: #300000; } 100% { background: #05050a; } }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ù„Ù„Ù‡Ø§ØªÙ */
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: #0c0c16; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--glass); z-index: 1000; }
        .nav-icon { color: #666; font-size: 20px; text-align: center; }
        .nav-icon.active { color: var(--primary); }
    </style>
</head>
<body id="titanBody">

    <div class="top-bar">
        <div class="logo">TITAN V100</div>
        <div id="vault" style="color:var(--success); font-weight:bold; font-family:'Orbitron'">0.00 Ø¬</div>
    </div>

    <div class="main-container" id="scrollContainer">
        
        <div class="card" id="gps-sec">
            <div id="map"></div>
            <div id="gps-status" style="font-size:11px; color:#888; text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ©...</div>
        </div>

        <div class="card">
            <div class="ai-report" id="ai-brain">
                <i class="fas fa-brain"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø£Ø¹Ø·Ø§Ù„...
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
            <button class="btn btn-main" onclick="startNewTrip()">
                <i class="fas fa-camera"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© (Ø³Ø­Ø¨ Ù‡ÙˆÙŠØ©)
            </button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-action" onclick="showSection('faults')"><i class="fas fa-tools"></i> Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</button>
                <button class="btn btn-action" onclick="showSection('clients')"><i class="fas fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            </div>
        </div>

        <h4 style="margin-top:20px; color:var(--primary)"><i class="fas fa-bolt"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†</h4>
        <div id="active-trips-list"></div>

    </div>

    <div class="nav-bottom">
        <div class="nav-icon active" onclick="location.reload()"><i class="fas fa-home"></i><div style="font-size:10px">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></div>
        <div class="nav-icon" onclick="endShiftReport()"><i class="fas fa-file-invoice-dollar"></i><div style="font-size:10px">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</div></div>
        <div class="nav-icon" onclick="showSettings()"><i class="fas fa-cog"></i><div style="font-size:10px">Ø§Ù„Ù†Ø¸Ø§Ù…</div></div>
    </div>

<script>
    // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ø¨Ø· ---
    const TG_TOKEN = "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs";
    const TG_CHAT = "5684905593";
    const GEO_LIMIT = 2000; // 2 ÙƒÙ… Ù†Ø·Ø§Ù‚ Ø£Ù…Ø§Ù†
    const HOME = { lat: 30.0444, lon: 31.2357 };

    firebase.initializeApp({
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        storageBucket: "yalla-scooter-pro.appspot.com"
    });
    const db = firebase.database();
    const storage = firebase.storage();

    let map, markers = {};

    // --- 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ ---
    window.onload = () => {
        initMap();
        startSync();
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([HOME.lat, HOME.lon], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.circle([HOME.lat, HOME.lon], { radius: GEO_LIMIT, color: 'cyan', fillOpacity: 0.05 }).addTo(map);
    }

    function startSync() {
        // ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø±
        db.ref('fleet_online').on('value', s => {
            const data = s.val() || {};
            let isWarning = false;
            for(let id in data) {
                const dist = getDistance(data[id].lat, data[id].lon, HOME.lat, HOME.lon);
                if(!markers[id]) markers[id] = L.marker([data[id].lat, data[id].lon]).addTo(map).bindPopup(id);
                else markers[id].setLatLng([data[id].lat, data[id].lon]);

                if(dist > GEO_LIMIT) {
                    isWarning = true;
                    markers[id]._icon.style.filter = "hue-rotate(280deg) contrast(200%)";
                }
            }
            document.getElementById('titanBody').className = isWarning ? 'alarm-bg' : '';
        });

        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        db.ref('vault_total').on('value', s => document.getElementById('vault').innerText = (s.val() || 0).toFixed(2) + " Ø¬");
        
        // Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙˆØ§Ù„Ù€ AI
        db.ref('active_trips').on('value', s => renderActive(s.val() || {}));
        db.ref('archive/trips').limitToLast(20).on('value', s => runAI(s.val() || {}));
    }

    // --- 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ AI ---
    function runAI(data) {
        const trips = Object.values(data);
        if(trips.length === 0) return;
        
        let total = 0; let scooters = {};
        trips.forEach(t => {
            total += (t.cost || 0);
            scooters[t.scId] = (scooters[t.scId] || 0) + 1;
        });
        const top = Object.keys(scooters).reduce((a, b) => scooters[a] > scooters[b] ? a : b);

        document.getElementById('ai-brain').innerHTML = `
            <b>ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ TITAN ÙŠØ­Ù„Ù„ Ø§Ù„Ù€ 20 Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©:</b><br>
            â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø­Ù„Ù„: ${total} Ø¬.Ù…<br>
            â€¢ Ø§Ù„Ø³ÙƒÙˆØªØ± Ø§Ù„Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø©: ${top}<br>
            â€¢ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©: Ù…Ø³ØªÙ‚Ø±Ø© âœ…
        `;
    }

    // --- 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¨Ø¯Ø¡ ÙˆØ¥Ù†Ù‡Ø§Ø¡) ---
    async function startNewTrip() {
        const { value: file } = await Swal.fire({ 
            title: 'ØµÙˆØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¢Ù†', 
            input: 'file', 
            inputAttributes: { 'accept': 'image/*', 'capture': 'camera' },
            confirmButtonText: 'Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©'
        });
        
        if(!file) return;
        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„Ø±Ø¨Ø·...', didOpen: () => Swal.showLoading() });

        const url = await uploadToCloud(file);
        
        const { value: form } = await Swal.fire({
            title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©',
            html: '<input id="i-sc" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="i-ph" class="swal2-input" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„">',
            preConfirm: () => ({ sc: document.getElementById('i-sc').value, ph: document.getElementById('i-ph').value })
        });

        if(form && form.sc) {
            db.ref('active_trips').push({ scId: form.sc, phone: form.ph, img: url, start: Date.now() });
            // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„
            db.ref(`clients/${form.ph}`).transaction(c => {
                if(!c) return { trips: 1, totalSpent: 0 };
                c.trips += 1; return c;
            });
            // ØªÙ„ÙŠØ¬Ø±Ø§Ù…
            sendTelegram(`ğŸš€ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©\nğŸ›µ Ø³ÙƒÙˆØªØ±: ${form.sc}\nğŸ“± Ø¹Ù…ÙŠÙ„: ${form.ph}\nğŸ†” Ø§Ù„ØµÙˆØ±Ø©: ${url}`);
        }
    }

    function renderActive(data) {
        const list = document.getElementById('active-trips-list');
        list.innerHTML = "";
        for(let key in data) {
            const t = data[key];
            const mins = Math.floor((Date.now() - t.start)/60000);
            list.innerHTML += `
                <div class="trip-active">
                    <div><b>ğŸ›µ ${t.scId}</b><br><small>${t.phone}</small></div>
                    <div class="timer">${mins} <span style="font-size:10px">Ø¯</span></div>
                    <button class="btn btn-main" style="width:80px; padding:8px;" onclick="endTrip('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>`;
        }
    }

    async function endTrip(key) {
        db.ref('active_trips/' + key).once('value', async s => {
            const t = s.val();
            const mins = Math.max(1, Math.ceil((Date.now() - t.start)/60000));
            const cost = Math.round(40 + (mins > 15 ? (mins-15)*2.66 : 0));

            const { isConfirmed } = await Swal.fire({ title: 'ØªØ­ØµÙŠÙ„ Ù…Ø¨Ù„Øº', text: `Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${cost} Ø¬ Ø¹Ù† ${mins} Ø¯Ù‚ÙŠÙ‚Ø©`, showCancelButton: true });
            if(isConfirmed) {
                await db.ref('archive/trips').push({ ...t, cost, mins, end: Date.now() });
                await db.ref('vault_total').transaction(v => (v||0) + cost);
                await db.ref(`clients/${t.phone}/totalSpent`).transaction(s => (s||0) + cost);
                await db.ref('active_trips/' + key).remove();
                Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
            }
        });
    }

    // --- 5. Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    async function uploadToCloud(file) {
        const ref = storage.ref(`ids/${Date.now()}.jpg`);
        await ref.put(file);
        return await ref.getDownloadURL();
    }

    function sendTelegram(msg) {
        fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT}&text=${encodeURIComponent(msg)}`);
    }

    function getDistance(la1, lo1, la2, lo2) {
        const R = 6371e3;
        const d1 = la1 * Math.PI/180; const d2 = la2 * Math.PI/180;
        const df = (la2-la1) * Math.PI/180; const dl = (lo2-lo1) * Math.PI/180;
        const a = Math.sin(df/2)**2 + Math.cos(d1)*Math.cos(d2)*Math.sin(dl/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function endShiftReport() {
        const total = document.getElementById('vault').innerText;
        Swal.fire('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ©', `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø¢Ù† Ù‡Ùˆ: ${total}\nÙŠØ±Ø¬Ù‰ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù‚Ø¨Ù„ ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø¯ÙŠØ©.`, 'info');
    }
</script>
</body>
</html>
