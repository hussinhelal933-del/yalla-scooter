<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Command V34 | Premium Speed</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (Ù†ÙØ³ Ù…ÙƒØªØ¨Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ÙØ®Ù… (Ø£Ø³ÙˆØ¯ ÙˆØ£Ø²Ø±Ù‚ Ø²Ø¬Ø§Ø¬ÙŠ) --- */
        :root {
            --bg-deep: #020408;
            --main-blue: #00d2ff;
            --dark-blue: #0033ff;
            --glass: rgba(10, 15, 30, 0.85);
            --glass-border: rgba(0, 210, 255, 0.3);
            --neon-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
            --danger: #ff0055; --success: #00ff9d; --warn: #ffcc00;
            --text: #ffffff;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); outline: none; }
        
        body { 
            margin: 0; 
            background: radial-gradient(circle at top left, #051937, #000); 
            background-attachment: fixed; 
            color: var(--text); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø§Ù„ÙØ®Ù…Ø© */
        .sidebar { 
            width: 290px; 
            background: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(30px); 
            border-left: 1px solid var(--glass-border); 
            display: flex; 
            flex-direction: column; 
            z-index: 1000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }

        .brand { 
            padding: 40px 20px; 
            text-align: center; 
            color: var(--main-blue); 
            font-family: 'Rajdhani'; 
            font-size: 32px; 
            font-weight: 900; 
            text-shadow: var(--neon-shadow);
            letter-spacing: 3px;
        }

        .nav-item { 
            padding: 16px 25px; 
            margin: 5px 15px; 
            cursor: pointer; 
            color: #8892b0; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            font-weight: 700; 
            border-radius: 15px;
        }

        .nav-item:hover, .nav-item.active { 
            background: linear-gradient(90deg, rgba(0,210,255,0.15), transparent); 
            color: var(--main-blue); 
            border-right: 4px solid var(--main-blue); 
            box-shadow: -5px 0 15px rgba(0,210,255,0.1);
        }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid rgba(0,210,255,0.1); 
        }

        /* Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„Ø´Ø¨ÙƒØ© */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .kpi-card { 
            background: var(--glass); 
            backdrop-filter: blur(15px); 
            border: 1px solid var(--glass-border); 
            padding: 25px; 
            border-radius: 25px; 
            text-align: center;
            position: relative;
        }
        .kpi-card::before {
            content: ''; position: absolute; inset: 0; border-radius: 25px; padding: 1px;
            background: linear-gradient(135deg, var(--main-blue), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }

        .kpi-val { font-family: 'Rajdhani'; font-size: 38px; font-weight: 900; color: #fff; display: block; text-shadow: var(--neon-shadow); }

        .unit-card { 
            background: var(--glass); 
            border: 1px solid var(--glass-border); 
            border-radius: 28px; 
            padding: 20px; 
            transition: 0.4s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .unit-card:hover { border-color: var(--main-blue); transform: translateY(-8px); box-shadow: 0 15px 40px rgba(0,210,255,0.2); }

        .unit-timer { font-family: 'Rajdhani'; font-size: 45px; color: var(--main-blue); font-weight: 700; text-shadow: var(--neon-shadow); margin: 15px 0; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙØ®Ù…Ø© */
        .btn { 
            border-radius: 15px; padding: 14px; font-weight: 900; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 15px; 
        }
        .btn-primary { background: linear-gradient(135deg, var(--dark-blue), var(--main-blue)); color: white; box-shadow: var(--neon-shadow); }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-danger { background: rgba(255, 0, 85, 0.15); border: 1px solid var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .glass-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .glass-table th { padding: 15px; text-align: right; color: var(--main-blue); font-weight: 900; text-transform: uppercase; font-size: 13px; }
        .glass-table td { background: rgba(255,255,255,0.03); padding: 18px; color: #fff; border-top: 1px solid rgba(0,210,255,0.05); }
        .glass-table tr td:first-child { border-radius: 0 20px 20px 0; }
        .glass-table tr td:last-child { border-radius: 20px 0 0 20px; }

        /* ØªØ®ØµÙŠØµ Ø§Ù„Ù€ SweetAlert Ù„ÙŠÙƒÙˆÙ† Ø²Ø¬Ø§Ø¬ÙŠ ÙØ®Ù… */
        .swal-custom-popup {
            background: rgba(5, 10, 20, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid var(--main-blue) !important;
            border-radius: 30px !important;
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.2) !important;
        }
        .swal-custom-title { color: var(--main-blue) !important; font-family: 'Rajdhani' !important; font-weight: 900 !important; }
        .swal-custom-input { background: rgba(255,255,255,0.05) !important; border: 1px solid var(--glass-border) !important; border-radius: 12px !important; color: #fff !important; }

        input, select, textarea { 
            background: rgba(255,255,255,0.05) !important; 
            border: 1px solid var(--glass-border) !important; 
            color: #fff !important; 
            border-radius: 15px !important; 
            padding: 15px !important;
        }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        
        .plate-badge { 
            background: #000; color: var(--main-blue); border: 1px solid var(--main-blue); 
            border-radius: 8px; padding: 5px 12px; font-family: 'Rajdhani'; font-weight: 900; font-size: 20px;
        }

        .section { display: none; animation: fadeIn 0.6s ease forwards; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div style="background: var(--glass); padding:60px; border-radius:40px; text-align:center; width:420px; border: 1px solid var(--glass-border); box-shadow: var(--neon-shadow);">
            <h1 style="font-family:'Rajdhani'; color:var(--main-blue); margin:0 0 10px; font-size: 42px; letter-spacing: 5px;">YALLA V34</h1>
            <p style="color:#666; margin-bottom: 40px; font-weight: bold;">PREMIUM FLEET MANAGEMENT</p>
            <input type="password" id="passInput" style="text-align:center; font-size:28px; letter-spacing:8px; width:100%" placeholder="****">
            <button onclick="login()" class="btn btn-primary" style="margin-top:30px; width:100%; font-size:18px;">ENTER COMMAND</button>
        </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <nav class="sidebar">
        <div class="brand"><i class="fas fa-bolt"></i> YALLA</div>
        
        <div style="padding: 15px; margin: 0 15px 20px; background: rgba(0,210,255,0.05); border-radius: 20px; border: 1px solid var(--glass-border); text-align: center;">
            <div style="font-size:11px; color:var(--main-blue); margin-bottom:10px; font-weight:900;">ATTENDANCE SYSTEM</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="recordAttendance('in')"><i class="fas fa-sign-in-alt"></i></button>
                <button class="btn btn-danger" style="flex:1" onclick="recordAttendance('out')"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="nav-group">
            <div class="nav-item active" onclick="nav('ops')"><i class="fas fa-rocket"></i> <span>Ø§Ù„Ø±Ø­Ù„Ø§Øª</span></div>
            <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></div>
            <div class="nav-item" onclick="nav('maint')"><i class="fas fa-tools"></i> <span>Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©</span></div>
            <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-chart-line"></i> <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span></div>
            <div id="set-nav" class="nav-item" style="display:none" onclick="nav('settings')"><i class="fas fa-sliders-h"></i> <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
        </div>

        <div style="margin-top:auto; padding:25px; border-top:1px solid rgba(0,210,255,0.1);">
            <div id="shift-status-text" style="text-align:center; font-size:13px; margin-bottom:12px; font-weight:bold; color:#666">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù…ØºÙ„Ù‚Ø©</div>
            <button id="shift-btn" onclick="toggleShift()" class="btn btn-primary" style="width:100%">ÙØªØ­ ÙˆØ±Ø¯ÙŠØ©</button>
            <button class="btn btn-danger" onclick="addExpensePopup()" style="margin-top:12px; width:100%;"><i class="fas fa-receipt"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
        </div>
    </nav>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="main-content">
        <div class="top-bar">
            <h2 id="p-title" style="margin:0; font-family:'Rajdhani'; color:var(--text); text-transform: uppercase; font-size:28px; letter-spacing: 2px;">DASHBOARD</h2>
            <div id="clock" style="font-family:'Rajdhani'; color:var(--main-blue); font-size:24px; font-weight:900; background:rgba(0,210,255,0.1); padding:8px 20px; border-radius:15px; border:1px solid var(--glass-border); text-shadow: var(--neon-shadow);">00:00:00</div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
        <div class="kpi-grid">
            <div class="kpi-card"><span class="kpi-val" id="k-active" style="color:var(--main-blue)">0</span><small>Ø³ÙƒÙˆØªØ± Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-net-cash" style="color:var(--success)">0</span><small>ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-maint" style="color:var(--danger)">0</span><small>Ø£Ø¹Ø·Ø§Ù„</small></div>
            <div class="kpi-card"><span class="kpi-val" id="k-avail" style="color:var(--warn)">0</span><small>Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ù…Ù„</small></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
        <div id="sec-ops" class="section active">
            <button class="btn btn-primary" onclick="startTripPopup()" style="padding:22px; font-size:20px; width:100%; margin-bottom:40px; box-shadow: 0 0 30px rgba(0,210,255,0.2);">
                <i class="fas fa-play-circle"></i> Ø¨Ø¯Ø¡ Ù…Ù‡Ù…Ø© ØªØ´ØºÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©
            </button>
            <div id="fleet-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap:30px;"></div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div id="sec-clients" class="section">
            <input type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." oninput="loadClients(this.value)" style="margin-bottom:20px;">
            <div class="kpi-card" style="padding:0; overflow:hidden;">
                <table class="glass-table">
                    <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                    <tbody id="clients-list"></tbody>
                </table>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© -->
        <div id="sec-maint" class="section">
            <div style="display:flex; gap:30px;">
                <div style="flex:1.5">
                    <h3 style="color:var(--main-blue); margin-bottom:20px;"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                    <div id="maint-list"></div>
                </div>
                <div style="flex:1">
                    <h3 style="color:var(--danger); margin-bottom:20px;"><i class="fas fa-plus-circle"></i> Ø¥Ø¨Ù„Ø§Øº ÙÙˆØ±ÙŠ</h3>
                    <div class="kpi-card" style="text-align:right;">
                        <select id="maint-select-scooter"><option>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</option></select>
                        <textarea id="maint-reason" rows="4" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø·Ù„ Ù‡Ù†Ø§..." style="margin: 15px 0;"></textarea>
                        <button class="btn btn-danger" onclick="sendToMaint()" style="width:100%; padding:18px;">ØªØ£ÙƒÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ÙƒÙˆØªØ±</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
        <div id="sec-admin" class="section">
            <div class="kpi-card" style="display:flex; gap:20px; align-items:center; margin-bottom:30px;">
                <input type="date" id="admin-date-picker" onchange="loadDailyStats(this.value)" style="flex:1; margin-bottom:0 !important;">
                <button class="btn btn-primary" onclick="loadDailyStats(document.getElementById('admin-date-picker').value)" style="flex:0.3">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:40px;">
                <div class="kpi-card" style="border-bottom: 4px solid var(--success);"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3><span id="day-rev" class="kpi-val" style="color:var(--success)">0 Ø¬</span></div>
                <div class="kpi-card" style="border-bottom: 4px solid var(--danger);"><h3>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3><span id="day-exp" class="kpi-val" style="color:var(--danger)">0 Ø¬</span></div>
                <div class="kpi-card" style="border-bottom: 4px solid var(--main-blue);"><h3>ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</h3><span id="day-net" class="kpi-val">0 Ø¬</span></div>
            </div>
            <h3 style="color:var(--main-blue);"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</h3>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¨Ø¯Ø£Øª</th><th>Ø§Ù†ØªÙ‡Øª</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th><th>Ø§Ù„ØµØ§ÙÙŠ</th></tr></thead>
                <tbody id="day-shifts-list"></tbody>
            </table>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="sec-settings" class="section">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div class="kpi-card">
                    <h3 style="color:var(--main-blue); margin-top:0;">ğŸ’° ØªØ¹Ø±ÙŠÙØ© Ø§Ù„Ø±Ø­Ù„Ø§Øª</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; text-align:right;">
                        <div><label>ÙØªØ­ Ø§Ù„Ø¹Ø¯Ø§Ø¯</label><input type="number" id="conf-baseCost" onchange="saveConfig()"></div>
                        <div><label>Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ÙØªØ­</label><input type="number" id="conf-baseMins" onchange="saveConfig()"></div>
                        <div><label>Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©</label><input type="number" id="conf-pricePerMin" onchange="saveConfig()"></div>
                    </div>
                </div>
                <div class="kpi-card">
                    <h3 style="color:var(--main-blue); margin-top:0;">ğŸ›µ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h3>
                    <div style="display:flex; gap:15px; margin-bottom:20px;">
                        <input type="text" id="new-scooter-name" maxlength="2" placeholder="S1" style="font-family:'Rajdhani'; font-weight:bold; text-align:center;">
                        <button class="btn btn-primary" onclick="addNewScooter()">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                    <div id="scooter-mngt-list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†Ø·Ù‚ (Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ Ø¯ÙˆÙ† Ø­Ø°Ù Ø­Ø±Ù) -->
    <script>
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        firebase.initializeApp({
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yalla-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.appspot.com",
        });
        const db = firebase.database();
        const storage = firebase.storage();
        
        let activeTrips = {};
        let config = { baseCost: 40, baseMins: 15, pricePerMin: 2.66 };
        let currentShiftId = null;
        let currentUser = "Guest";
        let isAdmin = false;
        let availableScooters = [];

        // ØªØ®ØµÙŠØµ SweetAlert Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ÙØ®Ù…
        const CustomSwal = Swal.mixin({
            customClass: {
                popup: 'swal-custom-popup',
                title: 'swal-custom-title',
                input: 'swal-custom-input',
                confirmButton: 'btn btn-primary',
                cancelButton: 'btn btn-danger'
            },
            background: 'transparent',
            buttonsStyling: false
        });

        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213") {
                currentUser = "Ù…ÙˆØ¸Ù"; isAdmin = false;
                document.getElementById('login-overlay').style.display = 'none'; initSystem();
            } else if(p === "9924") {
                currentUser = "Ø§Ù„Ù…Ø¯ÙŠØ±"; isAdmin = true;
                document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('set-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none'; initSystem();
            } else { CustomSwal.fire('Ø®Ø·Ø£', 'Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); }
        }

        function initSystem() {
            db.ref('settings').on('value', s => { 
                if(s.exists()) config = s.val();
                if(isAdmin) {
                    document.getElementById('conf-baseCost').value = config.baseCost;
                    document.getElementById('conf-baseMins').value = config.baseMins;
                    document.getElementById('conf-pricePerMin').value = config.pricePerMin;
                }
            });

            db.ref('shifts/current').on('value', s => {
                const btn = document.getElementById('shift-btn');
                const txt = document.getElementById('shift-status-text');
                const kpiNet = document.getElementById('k-net-cash');
                if(s.exists() && s.val().status === 'open') {
                    const v = s.val(); currentShiftId = s.key;
                    btn.innerText = "ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø¯ÙŠØ©"; btn.classList.replace('btn-primary', 'btn-danger');
                    txt.innerText = `ÙˆØ±Ø¯ÙŠØ© Ù…ÙØªÙˆØ­Ø©: ${v.user}`; txt.style.color = "#00ff9d";
                    kpiNet.innerText = ((v.totalCash||0) - (v.totalExpenses||0)) + " Ø¬";
                } else {
                    currentShiftId = null;
                    btn.innerText = "ÙØªØ­ ÙˆØ±Ø¯ÙŠØ©"; btn.classList.replace('btn-danger', 'btn-primary');
                    txt.innerText = "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù…ØºÙ„Ù‚Ø©"; txt.style.color = "#666";
                    kpiNet.innerText = "0";
                }
            });

            db.ref('inventory').on('value', snap => {
                availableScooters = [];
                const list = document.getElementById('scooter-mngt-list');
                const maintSelect = document.getElementById('maint-select-scooter');
                const maintList = document.getElementById('maint-list');
                list.innerHTML = ''; maintSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙƒÙˆØªØ±...</option>'; maintList.innerHTML = '';
                let availC = 0, maintC = 0;
                
                snap.forEach(doc => {
                    const s = doc.val(); const key = doc.key;
                    list.innerHTML += `<div style="text-align:center;" onclick="${isAdmin ? `manageScooter('${key}', '${s.status}')` : ''}" class="admin-badge"><div class="plate-badge" style="border-color:${s.status==='available'?'#00ff9d':(s.status==='maintenance'?'#ff0055':'#444')}">${key}</div><div style="font-size:10px; margin-top:5px; color:#666">${s.status}</div></div>`;
                    if(s.status === 'available') { availableScooters.push(key); maintSelect.innerHTML += `<option value="${key}">${key}</option>`; availC++; }
                    else if (s.status === 'maintenance') {
                        maintC++;
                        maintList.innerHTML += `<div class="kpi-card" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; padding:15px; border-color:var(--danger);"><div><b style="color:#fff; font-size:20px;">${key}</b><br><small style="color:#888">${s.issue}</small></div>${isAdmin ? `<button class="btn btn-primary" style="padding:5px 15px;" onclick="restoreScooter('${key}')">Ø¥ØµÙ„Ø§Ø­</button>` : ''}</div>`;
                    }
                });
                document.getElementById('k-avail').innerText = availC; document.getElementById('k-maint').innerText = maintC;
            });

            db.ref('active_trips').on('value', snap => { activeTrips = snap.val() || {}; renderTrips(); });
            if(isAdmin) { document.getElementById('admin-date-picker').valueAsDate = new Date(); loadDailyStats(new Date().toISOString().split('T')[0]); }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            document.getElementById('p-title').innerText = id;
        }

        window.manageScooter = async function(key, currentStatus) {
            if(!isAdmin) return;
            const { isConfirmed, isDenied, dismiss } = await CustomSwal.fire({
                title: `ØªØ­ÙƒÙ…: ${key}`, html: `Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${currentStatus}</b>`,
                showConfirmButton: true, confirmButtonText: 'ğŸŸ¢ ØªÙØ¹ÙŠÙ„ (Ù…ØªØ§Ø­)',
                showDenyButton: true, denyButtonText: 'ğŸ”´ ØµÙŠØ§Ù†Ø©',
                showCancelButton: true, cancelButtonText: 'ğŸ—‘ï¸ Ø­Ø°Ù'
            });
            if (isConfirmed) { db.ref('inventory/'+key).update({ status: 'available', issue: null }); CustomSwal.fire('ØªÙ…', 'Ø§Ù„Ø³ÙƒÙˆØªØ± Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†', 'success'); }
            else if (isDenied) { const { value: r } = await CustomSwal.fire({ input: 'text', title: 'Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø·Ù„ØŸ' }); db.ref('inventory/'+key).update({ status: 'maintenance', issue: r || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }); }
            else if (dismiss === Swal.DismissReason.cancel) { const { isConfirmed: del } = await CustomSwal.fire({ title: 'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ', icon:'warning', showCancelButton:true }); if(del) db.ref('inventory/'+key).remove(); }
        }

        function sendToMaint() {
            const sc = document.getElementById('maint-select-scooter').value; const issue = document.getElementById('maint-reason').value;
            if(!sc || !issue) return CustomSwal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'Ø§Ø®ØªØ± Ø§Ù„Ø³ÙƒÙˆØªØ± ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨', 'warning');
            db.ref('inventory/'+sc).update({ status: 'maintenance', issue: issue, issueTime: Date.now() });
            CustomSwal.fire('ØªÙ… Ø§Ù„ØªØ¨Ù„ÙŠØº', `ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ${sc}`, 'success'); document.getElementById('maint-reason').value = '';
        }

        function restoreScooter(sc) { db.ref('inventory/'+sc).update({ status: 'available', issue: null }); CustomSwal.fire('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', '', 'success'); }

        async function startTripPopup() {
            if(!currentShiftId) return CustomSwal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!', 'warning');
            let options = availableScooters.map(s => `<option value="${s}">${s}</option>`).join('');
            if(availableScooters.length === 0) options = `<option disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙƒÙˆØªØ± Ù…ØªØ§Ø­</option>`;

            const { value: res } = await CustomSwal.fire({
                title: 'Ø¥Ø·Ù„Ø§Ù‚ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                html: `<select id="sw-s" class="swal2-input">${options}</select><input id="sw-ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„"><input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"><input id="sw-b" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© %"><div style="text-align:right; font-size:12px; margin:10px 0; color:var(--main-blue);">ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¶Ù…Ø§Ù†</div><input id="sw-img" type="file" accept="image/*" class="swal2-file">`,
                preConfirm: () => {
                    const img = document.getElementById('sw-img').files[0]; const sc = document.getElementById('sw-s').value;
                    if(!img || !sc) return Swal.showValidationMessage('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙƒÙˆØªØ± ÙˆØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©');
                    return [document.getElementById('sw-ph').value, sc, document.getElementById('sw-b').value, document.getElementById('sw-n').value, img];
                }
            });

            if(res) {
                const [ph, s, bat, name, file] = res;
                const newRef = db.ref('active_trips').push();
                newRef.set({ phone: ph, scooter: s, startBat: bat, client: name||'Ø²Ø§Ø¦Ø±', idPhoto: "https://i.gifer.com/ZZ5H.gif", startTime: Date.now(), status: 'active', pausedDuration: 0, shiftId: currentShiftId });
                db.ref('inventory/'+s).update({ status: 'active' });
                CustomSwal.fire({ icon:'success', title:'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', text:'Ø§Ù„Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†', timer: 2000 });
                sendTG(`ğŸš€ <b>Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª</b>\nğŸ›µ ${s}\nğŸ‘¤ ${name}`);
                const ref = storage.ref(`ids/${Date.now()}_${ph}`);
                ref.put(file).then(snap => snap.ref.getDownloadURL()).then(url => { newRef.update({ idPhoto: url }); });
            }
        }

        async function terminateTrip(key) {
            const d = activeTrips[key];
            const diff = (d.status==='active'?Date.now():d.pauseStart) - d.startTime - (d.pausedDuration||0);
            const mins = Math.floor(diff / 60000);
            let cost = config.baseCost; if (mins > config.baseMins) cost += (mins - config.baseMins) * config.pricePerMin;
            cost = Math.round(cost);

            const { value: fin } = await CustomSwal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `<h1 style="color:var(--main-blue); font-family:Rajdhani; font-size:70px; margin:15px 0;">${cost} Ø¬</h1><p style="color:#888; font-weight:bold;">Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©</p><input id="sw-disc" type="number" class="swal2-input" placeholder="Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"><input id="sw-bat" type="number" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© %">`,
                preConfirm: () => { return { disc: parseFloat(document.getElementById('sw-disc').value)||0, bat: document.getElementById('sw-bat').value } }
            });

            if(fin) {
                const final = cost - fin.disc; const today = new Date().toISOString().split('T')[0];
                if(currentShiftId) db.ref('shifts/current').transaction(s => { if(s) { s.totalCash = (s.totalCash||0) + final; } return s; });
                db.ref(`history/${today}`).push({ scooter:d.scooter, client:d.client, mins, final, endBat: fin.bat, time: Date.now() });
                db.ref('inventory/'+d.scooter).update({ status: 'available' });
                db.ref('active_trips/'+key).remove();
                CustomSwal.fire('ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„', `Ø§Ù„Ù…Ø¨Ù„Øº: ${final} Ø¬`, 'success');
                sendTG(`ğŸ <b>Ø¥Ù†Ù‡Ø§Ø¡ Ø±Ø­Ù„Ø©</b>\nğŸ›µ ${d.scooter}\nğŸ’° Ø§Ù„Ø­Ø³Ø§Ø¨: ${final} Ø¬`);
            }
        }

        function renderTrips() {
            const grid = document.getElementById('fleet-grid'); grid.innerHTML = ""; let count = 0;
            for(let k in activeTrips) {
                count++; const d = activeTrips[k];
                grid.innerHTML += `<div class="unit-card"><div style="display:flex; justify-content:space-between; align-items:center;"><span class="plate-badge">${d.scooter}</span><span style="font-weight:900; color:#888;">${d.client}</span></div><img src="${d.idPhoto}" style="width:100%; height:140px; object-fit:cover; border-radius:20px; margin:15px 0; border:1px solid rgba(255,255,255,0.05);"><div class="unit-timer" id="timer-${k}">00:00:00</div><div style="display:flex; gap:10px;">${d.status==='active'?`<button class="btn btn-primary" style="flex:0.3; background:var(--warn); color:#000" onclick="controlTrip('${k}','pause')"><i class="fas fa-pause"></i></button>`:`<button class="btn btn-primary" style="flex:0.3; background:var(--success); color:#000" onclick="controlTrip('${k}','resume')"><i class="fas fa-play"></i></button>`}<button class="btn btn-danger" style="flex:1" onclick="terminateTrip('${k}')"><i class="fas fa-flag-checkered"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button></div></div>`;
            }
            document.getElementById('k-active').innerText = count;
        }

        function controlTrip(k, a) { if(a==='pause') db.ref(`active_trips/${k}`).update({ status:'paused', pauseStart:Date.now() }); else db.ref(`active_trips/${k}`).once('value', s => { const d = s.val(); db.ref(`active_trips/${k}`).update({ status:'active', pausedDuration: (d.pausedDuration||0)+(Date.now()-d.pauseStart) }); }); }

        function refreshTimers() { const now = Date.now(); document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); for(let k in activeTrips) { const d = activeTrips[k]; const el = document.getElementById(`timer-${k}`); if(!el) continue; let diff = (d.status==='active') ? (now - d.startTime - (d.pausedDuration || 0)) : (d.pauseStart - d.startTime - (d.pausedDuration || 0)); const s = Math.floor(diff / 1000); el.innerText = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; } }
        setInterval(refreshTimers, 1000);

        function recordAttendance(type) { const msg = type === 'in' ? `ğŸ”´ Ø­Ø¶ÙˆØ±: ${currentUser}` : `ğŸŸ¢ Ø§Ù†ØµØ±Ø§Ù: ${currentUser}`; db.ref(`attendance/${new Date().toISOString().split('T')[0]}`).push({ user: currentUser, type: type, time: Date.now() }); sendTG(msg); CustomSwal.fire({icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', timer:1500, showConfirmButton:false}); }
        function toggleShift() { if(!currentShiftId) { db.ref('shifts/current').set({ user: currentUser, start: Date.now(), status: 'open', totalCash: 0, totalExpenses: 0 }); CustomSwal.fire('Ø¨Ø¯Ø£Øª Ø§Ù„ÙˆØ±Ø¯ÙŠØ©', 'Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙÙŠ Ø¹Ù…Ù„Ùƒ', 'success'); } else { CustomSwal.fire({ title: 'ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø¯ÙŠØ©ØŸ', text: "ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø¬ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚", icon: 'warning', showCancelButton: true }).then(res => { if(res.isConfirmed) { db.ref('shifts/current').once('value', s => { const v = s.val(); const net = (v.totalCash||0) - (v.totalExpenses||0); db.ref('shifts/history').push({ ...v, end: Date.now(), status: 'closed', netCash: net }); db.ref('shifts/current').remove(); CustomSwal.fire('ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', `ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯: ${net} Ø¬`, 'success'); sendTG(`ğŸ <b>Ø¥ØºÙ„Ø§Ù‚ ÙˆØ±Ø¯ÙŠØ©</b>\nğŸ‘¤ Ø§Ù„Ù…ÙˆØ¸Ù: ${v.user}\nğŸ’° Ø§Ù„ØµØ§ÙÙŠ: ${net} Ø¬`); }); } }); } }
        async function addExpensePopup() { if(!currentShiftId) return CustomSwal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ±Ø¯ÙŠØ© Ù…ÙØªÙˆØ­Ø©', 'error'); const { value: form } = await CustomSwal.fire({ title: 'ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø®Ø§Ø±Ø¬ÙŠ', html: `<input id="ex-amount" type="number" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¬"><input id="ex-desc" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ø¨Ù†Ø¯">`, preConfirm: () => { return [document.getElementById('ex-amount').value, document.getElementById('ex-desc').value] } }); if(form && form[0]) { const amt = parseFloat(form[0]); db.ref(`expenses/${new Date().toISOString().split('T')[0]}`).push({ amount: amt, desc: form[1], time: Date.now(), user: currentUser }); db.ref('shifts/current').transaction(s => { if(s) s.totalExpenses = (s.totalExpenses || 0) + amt; return s; }); CustomSwal.fire('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', '', 'success'); } }
        function loadDailyStats(dateStr) { if(!isAdmin || !dateStr) return; db.ref(`history/${dateStr}`).once('value', snap => { let rev = 0; snap.forEach(t => rev += (t.val().final || 0)); document.getElementById('day-rev').innerText = rev + " Ø¬"; db.ref(`expenses/${dateStr}`).once('value', exSnap => { let exp = 0; exSnap.forEach(e => exp += (e.val().amount || 0)); document.getElementById('day-exp').innerText = exp + " Ø¬"; document.getElementById('day-net').innerText = (rev - exp) + " Ø¬"; }); }); db.ref('shifts/history').once('value', snap => { const tb = document.getElementById('day-shifts-list'); tb.innerHTML = ""; snap.forEach(s => { const v = s.val(); if(new Date(v.start).toISOString().split('T')[0] === dateStr) { tb.innerHTML += `<tr><td>${v.user}</td><td>${new Date(v.start).toLocaleTimeString()}</td><td>${new Date(v.end).toLocaleTimeString()}</td><td>${v.totalCash}</td><td>${v.netCash}</td></tr>`; } }); }); }
        function addNewScooter() { if(!isAdmin) return; const name = document.getElementById('new-scooter-name').value.toUpperCase().trim(); if(name.length > 2 || !name) return CustomSwal.fire('Ø®Ø·Ø£', 'Ø­Ø±ÙÙŠÙ† ÙÙ‚Ø· Ù…Ø«Ù„ S1', 'warning'); db.ref('inventory/'+name).set({ status: 'available' }); document.getElementById('new-scooter-name').value = ''; }
        function saveConfig() { if(!isAdmin) return; db.ref('settings').set({ baseCost: parseFloat(document.getElementById('conf-baseCost').value), baseMins: parseFloat(document.getElementById('conf-baseMins').value), pricePerMin: parseFloat(document.getElementById('conf-pricePerMin').value) }); }
        function loadClients(q) { db.ref('active_trips').on('value', tripsSnap => { const activePhones = []; tripsSnap.forEach(t => activePhones.push(t.val().phone)); db.ref('history').once('value', snap => { const tb = document.getElementById('clients-list'); tb.innerHTML=''; const clients = {}; snap.forEach(day => { day.forEach(t => { const d = t.val(); if(!clients[d.phone]) clients[d.phone] = { name: d.client, points: 0, phone: d.phone }; clients[d.phone].points += Math.floor(d.final/10); }); }); for(let ph in clients) { if(q && !ph.includes(q)) continue; const c = clients[ph]; tb.innerHTML += `<tr><td>${c.name}</td><td>${c.phone}</td><td><span style="color:var(--main-blue); font-weight:bold;">${c.points}</span></td><td>${activePhones.includes(ph)?'<span style="color:var(--success)">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>':'<span style="color:#666">ØºÙŠØ± Ù†Ø´Ø·</span>'}</td></tr>`; } }); }); }
        function sendTG(t) { fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: TELEGRAM.chat, text: t, parse_mode: 'HTML' }) }); }
    </script>
</body>
</html>
