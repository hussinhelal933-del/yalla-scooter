<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN Enterprise | Fleet Management OS</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --brand: #0062ff;
            --surface: #ffffff;
            --background: #f4f7fa;
            --text-main: #1a1d23;
            --text-sub: #64748b;
            --sidebar: #0f172a;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--background); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Sidebar Pro */
        aside {
            width: 280px; background: var(--sidebar); display: flex; flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000;
        }
        .aside-header { padding: 30px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .aside-header .logo-box { width: 40px; height: 40px; background: var(--brand); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .aside-header h1 { color: white; font-size: 20px; font-weight: 800; letter-spacing: 1px; }

        .menu-list { flex: 1; padding: 20px 15px; }
        .menu-item {
            padding: 14px 18px; border-radius: 12px; display: flex; align-items: center; gap: 15px;
            color: #94a3b8; cursor: pointer; text-decoration: none; margin-bottom: 5px; transition: 0.2s;
        }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.05); color: white; }
        .menu-item.active { background: var(--brand); color: white; box-shadow: 0 10px 15px -3px rgba(0, 98, 255, 0.4); }

        /* Main Workspace */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Top Navigation */
        .top-nav {
            height: 75px; background: var(--surface); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 40px;
        }
        .search-bar { background: #f1f5f9; padding: 10px 20px; border-radius: 10px; width: 300px; color: var(--text-sub); display: flex; gap: 10px; }
        
        /* Content Grid */
        .workspace-scroll { flex: 1; overflow-y: auto; padding: 35px; }
        .page-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .page-header h2 { font-weight: 800; font-size: 28px; }

        /* Professional Cards (KPIs) */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 35px; }
        .kpi-card {
            background: var(--surface); padding: 25px; border-radius: 20px; border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px; position: relative;
        }
        .kpi-card .icon { position: absolute; top: 25px; left: 25px; font-size: 24px; color: var(--brand); opacity: 0.2; }
        .kpi-card .label { color: var(--text-sub); font-size: 14px; font-weight: 600; }
        .kpi-card .value { font-size: 26px; font-weight: 900; }

        /* Table Design */
        .data-panel { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .table-header { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 18px 30px; background: #f8fafc; color: var(--text-sub); font-weight: 600; font-size: 13px; }
        td { padding: 18px 30px; border-bottom: 1px solid var(--border); font-size: 15px; }
        
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; }
        .badge-active { background: #dcfce7; color: var(--success); }
        
        /* Radar Overlay */
        #radar-overlay {
            position: fixed; inset: 0; background: var(--sidebar); z-index: 2000;
            display: none; flex-direction: column;
        }
        .radar-header { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #main-radar-map { flex: 1; }

        /* Login */
        #auth-screen { position: fixed; inset: 0; background: #f4f7fa; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 50px; border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); width: 450px; text-align: center; }
        
        .btn-pro {
            background: var(--brand); color: white; padding: 14px 28px; border-radius: 12px;
            border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <div style="width:70px; height:70px; background:var(--brand); border-radius:20px; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; color:white; font-size:30px;">
                <i class="fas fa-terminal"></i>
            </div>
            <h2 style="font-weight:900; margin-bottom:10px;">TITAN ENTERPRISE</h2>
            <p style="color:var(--text-sub); margin-bottom:30px;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© V74</p>
            <input type="password" id="entryPin" placeholder="Enter Administrator PIN" style="width:100%; padding:18px; border-radius:12px; border:2px solid var(--border); margin-bottom:20px; text-align:center; font-size:20px; font-family:'Inter'">
            <button onclick="checkAuth()" class="btn-pro" style="width:100%; justify-content:center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <aside>
        <div class="aside-header">
            <div class="logo-box"><i class="fas fa-bolt"></i></div>
            <h1>TITAN<span style="font-weight:300; opacity:0.6">OS</span></h1>
        </div>
        <div class="menu-list">
            <div class="menu-item active" onclick="nav('dash')"><i class="fas fa-grid-2"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</div>
            <div class="menu-item" onclick="nav('live')"><i class="fas fa-satellite"></i> Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„ØªØ¹Ù‚Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
            <div class="menu-item" onclick="nav('fleet')"><i class="fas fa-motorcycle"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
            <div class="menu-item" onclick="nav('money')"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚</div>
        </div>
        <div style="padding:20px;">
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; text-align:center;">
                <p style="color:#64748b; font-size:11px;">Server Status</p>
                <p style="color:var(--success); font-size:12px; font-weight:700;">â— Online 100%</p>
            </div>
        </div>
    </aside>

    <main>
        <nav class="top-nav">
            <div class="search-bar"><i class="fas fa-search"></i> Ø¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©ØŒ Ø³ÙƒÙˆØªØ±ØŒ Ø£Ùˆ Ø¹Ù…ÙŠÙ„...</div>
            <div style="display:flex; align-items:center; gap:25px;">
                <div id="liveClock" style="font-weight:700; font-family:'Inter'; font-size:18px;">00:00:00</div>
                <div style="width:40px; height:40px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user"></i></div>
            </div>
        </nav>

        <div class="workspace-scroll">
            
            <div id="sec-dash" class="section-content active">
                <div class="page-header">
                    <div>
                        <h2>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                        <p style="color:var(--text-sub)">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</p>
                    </div>
                    <button class="btn-pro" onclick="createNewTrip()"><i class="fas fa-plus"></i> Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© ÙÙˆØ±ÙŠØ©</button>
                </div>

                <div class="kpi-row">
                    <div class="kpi-card"><i class="fas fa-cash-register icon"></i><span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©</span><span class="value" id="val-cash">0.00</span></div>
                    <div class="kpi-card"><i class="fas fa-route icon"></i><span class="label">Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</span><span class="value" id="val-active">0</span></div>
                    <div class="kpi-card"><i class="fas fa-plug icon"></i><span class="label">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©</span><span class="value" id="val-online">0</span></div>
                    <div class="kpi-card"><i class="fas fa-exclamation-triangle icon"></i><span class="label">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†</span><span class="value" id="val-warn">0</span></div>
                </div>

                <div class="data-panel">
                    <div class="table-header">
                        <h3 style="font-weight:700">Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
                        <span style="color:var(--brand); cursor:pointer">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ <i class="fas fa-arrow-left"></i></span>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø¨Ø¯Ø£Øª Ù…Ù†Ø°</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¯Ø§Ø±Ø©</th></tr>
                        </thead>
                        <tbody id="live-trips-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-fleet" class="section-content" style="display:none">
                <div class="page-header"><h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h2></div>
                <div id="fleet-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;"></div>
            </div>

        </div>
    </main>

    <div id="radar-overlay">
        <div class="radar-header">
            <h2 style="color:white; font-weight:900;">RADAR LIVE TRACKING</h2>
            <button class="btn-pro" style="background:var(--danger)" onclick="toggleRadar()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± <i class="fas fa-times"></i></button>
        </div>
        <div id="main-radar-map"></div>
    </div>

<script>
    // System Config
    const SHOP = { lat: 30.0444, lon: 31.2357 };
    const RATES = { base: 40, free: 15, perMin: 2.66 };
    
    firebase.initializeApp({ databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    
    let map = null, markers = {};

    function checkAuth() {
        const pin = document.getElementById('entryPin').value;
        if(pin === "1213" || pin === "9924") {
            document.getElementById('auth-screen').style.opacity = '0';
            setTimeout(()=> document.getElementById('auth-screen').remove(), 500);
            initSystem();
        } else {
            Swal.fire({ title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', text: 'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ§Ù„Ø­', icon: 'error' });
        }
    }

    function initSystem() {
        initRadarMap();
        
        db.ref('active_trips').on('value', snap => renderTripsTable(snap.val() || {}));
        db.ref('fleet_online').on('value', snap => {
            const data = snap.val() || {};
            document.getElementById('val-online').innerText = Object.keys(data).length;
            updateMapMarkers(data);
        });
        db.ref('vault_total').on('value', snap => {
            document.getElementById('val-cash').innerText = (snap.val() || 0).toLocaleString() + " Ø¬.Ù…";
        });
        db.ref('scooter_stats').on('value', snap => renderFleetCards(snap.val() || {}));
    }

    function initRadarMap() {
        map = L.map('main-radar-map', {zoomControl: false}).setView([SHOP.lat, SHOP.lon], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.circle([SHOP.lat, SHOP.lon], {radius: 150, color: '#0062ff', fillOpacity: 0.1}).addTo(map);
    }

    function nav(id) {
        if(id === 'live') { toggleRadar(); return; }
        document.querySelectorAll('.section-content').forEach(s => s.style.display = 'none');
        document.getElementById('sec-'+id).style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function toggleRadar() {
        const ov = document.getElementById('radar-overlay');
        ov.style.display = (ov.style.display === 'flex') ? 'none' : 'flex';
        if(ov.style.display === 'flex') {
            setTimeout(() => map.invalidateSize(), 200);
        }
    }

    function renderTripsTable(data) {
        const body = document.getElementById('live-trips-body');
        body.innerHTML = "";
        let activeCount = 0;
        
        for(let id in data) {
            activeCount++;
            const t = data[id];
            const mins = Math.floor((Date.now() - t.startTime) / 60000);
            const cost = Math.round(RATES.base + (mins > RATES.free ? (mins - RATES.free) * RATES.perMin : 0));
            
            body.innerHTML += `
                <tr>
                    <td><div style="display:flex; align-items:center; gap:10px;"><i class="fas fa-motorcycle" style="color:var(--brand)"></i> <b>${t.scooterId}</b></div></td>
                    <td>${t.clientPhone}</td>
                    <td>${mins} Ø¯Ù‚ÙŠÙ‚Ø©</td>
                    <td style="font-weight:800; color:var(--brand)">${cost} Ø¬.Ù…</td>
                    <td><span class="badge badge-active">â— ÙŠØ¬Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</span></td>
                    <td><button class="btn-pro" style="padding:8px 15px; font-size:12px; background:#f1f5f9; color:var(--text-main)" onclick="completeTrip('${id}')">ØªØ­ØµÙŠÙ„</button></td>
                </tr>
            `;
        }
        document.getElementById('val-active').innerText = activeCount;
    }

    function updateMapMarkers(fleet) {
        for(let id in fleet) {
            const s = fleet[id];
            if(!markers[id]) {
                markers[id] = L.marker([s.lat, s.lon]).addTo(map).bindPopup(s.name);
            } else {
                markers[id].setLatLng([s.lat, s.lon]);
            }
        }
    }

    function renderFleetCards(stats) {
        const cont = document.getElementById('fleet-container');
        cont.innerHTML = "";
        let totalFaults = 0;
        for(let id in stats) {
            const s = stats[id];
            totalFaults += (s.faultCount || 0);
            cont.innerHTML += `
                <div class="kpi-card">
                    <h3 style="margin-bottom:15px; display:flex; justify-content:space-between"><span>ğŸ›µ ${id}</span> <i class="fas fa-ellipsis-v" style="font-size:14px; color:#cbd5e1"></i></h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div style="background:#f8fafc; padding:10px; border-radius:10px;"><small>Ø§Ù„Ù…Ø³Ø§ÙØ©</small><br><b>${(s.totalKm || 0).toFixed(1)} ÙƒÙ…</b></div>
                        <div style="background:#f8fafc; padding:10px; border-radius:10px;"><small>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</small><br><b>${s.totalEarnings || 0} Ø¬</b></div>
                    </div>
                    <div style="margin-top:10px; font-size:12px; color:${s.faultCount > 0 ? 'var(--danger)' : 'var(--success)'}">Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ${s.faultCount || 0}</div>
                </div>
            `;
        }
        document.getElementById('val-warn').innerText = totalFaults;
    }

    function createNewTrip() {
        Swal.fire({
            title: 'ÙØªØ­ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
            html: `<input id="sw-id" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="sw-ph" class="swal2-input" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„">`,
            confirmButtonText: 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©',
            confirmButtonColor: '#0062ff',
            preConfirm: () => {
                const scooterId = document.getElementById('sw-id').value;
                const clientPhone = document.getElementById('sw-ph').value;
                if(!scooterId) return Swal.showValidationMessage('Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± Ù…Ø·Ù„ÙˆØ¨');
                db.ref('active_trips').push({ scooterId, clientPhone, startTime: Date.now() });
            }
        });
    }

    function completeTrip(id) {
        db.ref('active_trips/'+id).once('value', s => {
            const t = s.val();
            const mins = Math.floor((Date.now() - t.startTime) / 60000);
            let cost = Math.round(RATES.base + (mins > RATES.free ? (mins - RATES.free) * RATES.perMin : 0));
            
            Swal.fire({
                title: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ',
                html: `Ø³ÙƒÙˆØªØ±: ${t.scooterId}<br>Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©<br><h1 style="color:var(--brand)">${cost} Ø¬.Ù…</h1>`,
                showCancelButton: true,
                confirmButtonText: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº',
                confirmButtonColor: '#10b981'
            }).then(r => {
                if(r.isConfirmed) {
                    db.ref('vault_total').transaction(v => (v || 0) + cost);
                    db.ref('scooter_stats/'+t.scooterId+'/totalEarnings').transaction(v => (v || 0) + cost);
                    db.ref('history').push({...t, final: cost, date: Date.now()});
                    db.ref('active_trips/'+id).remove();
                }
            });
        });
    }

    setInterval(() => {
        document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false});
    }, 1000);
</script>
</body>
</html>
