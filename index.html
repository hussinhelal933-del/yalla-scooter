<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Yalla Scooter Master Full</title>

<!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --bg:#000; --sidebar:#050505; --card:#0d1117; --primary:#00d2ff; --accent:#0072ff;
  --danger:#ff0055; --success:#00ff9d; --warn:#ffcc00; --border:rgba(0,210,255,0.2);
  --glass:rgba(15,20,30,0.95);
}
* {box-sizing:border-box; font-family:'Cairo',sans-serif; transition:0.3s; margin:0; padding:0;}
body {background:var(--bg); color:#fff; height:100vh; display:flex; flex-direction:column; overflow:hidden;}
/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
#login-overlay {position:fixed; inset:0; background:#000; z-index:10000; display:flex; align-items:center; justify-content:center;}
.login-card {width:90%; max-width:380px; text-align:center; padding:50px 40px; border-radius:35px; border:1px solid var(--primary); background:var(--card); box-shadow:0 0 50px rgba(0,210,255,0.2);}
.app-title {font-family:'Rajdhani'; font-size:45px; font-weight:900; color:var(--primary); text-shadow:0 0 15px var(--primary); margin-bottom:10px;}
input {background:#000 !important; border:1px solid #333 !important; color:var(--primary) !important; border-radius:15px !important; padding:18px !important; width:100%; text-align:center; font-size:32px !important; margin-bottom:25px; outline:none; font-family:'Rajdhani';}

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± */
#scooter-ui {display:none; height:100vh; flex-direction:column; align-items:center; justify-content:center; background:radial-gradient(circle,#0a1a35,#000);}
.speed-ring {width:280px; height:280px; border:10px solid var(--primary); border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 0 50px var(--primary); position:relative;}
.speed-ring::after {content:''; position:absolute; inset:-15px; border:2px dashed var(--primary); border-radius:50%; opacity:0.3; animation:rotate 15s linear infinite;}
@keyframes rotate {from{transform:rotate(0deg);} to{transform:rotate(360deg);}}
.speed-val {font-family:'Rajdhani'; font-size:110px; font-weight:900; line-height:1;}
.scooter-stats {display:flex; gap:40px; margin-top:50px; font-size:22px; font-weight:700;}

/* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ */
#app-ui {display:none; height:100vh; flex-direction:row;}
.sidebar {width:280px; background:var(--sidebar); border-left:1px solid #222; display:flex; flex-direction:column; padding:20px; z-index:1000;}
.nav-item {padding:15px 20px; border-radius:15px; cursor:pointer; display:flex; align-items:center; gap:15px; margin-bottom:8px; color:#666; font-weight:bold;}
.nav-item.active {background:rgba(0,210,255,0.1); color:var(--primary); border-right:5px solid var(--primary);}
.main-container {flex:1; overflow-y:auto; padding:25px; background:#010409;}

/* GPS ÙƒØ§Ù…Ù„ */
#gps-page {display:none; position:fixed; inset:0; background:#000; z-index:2000; flex-direction:column;}
#full-map {flex:1;width:100%;}
.gps-footer {height:120px; background:var(--card); padding:15px; display:flex; justify-content:space-around; align-items:center; border-top:2px solid var(--primary);}
.stat-v{text-align:center;}
.stat-v b{font-family:'Rajdhani'; font-size:30px; color:var(--primary); display:block;}

/* Ø§Ù„ÙƒØ±ÙˆØª */
.kpi-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:15px; margin-bottom:30px;}
.kpi-card {background:var(--card); padding:20px; border-radius:20px; border:1px solid var(--border); text-align:center;}
.kpi-val {font-family:'Rajdhani'; font-size:32px; font-weight:700; color:#fff;}
.trip-card {background:var(--glass); border:1px solid var(--border); border-radius:25px; padding:20px; margin-bottom:20px; border-right:6px solid var(--primary);}
.btn {padding:15px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; width:100%; font-size:16px;}
.btn-primary {background:var(--primary); color:#000;}
.btn-danger {background:rgba(255,0,85,0.1); border:1px solid var(--danger); color:var(--danger);}
.section {display:none;}
.section.active {display:block; animation:fadeIn 0.4s ease;}
@keyframes fadeIn {from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);}}
.admin-only {display:none;}
.debt-msg {background:var(--danger); color:#fff; padding:5px; border-radius:8px; font-size:12px; margin-bottom:10px; text-align:center;}

/* Lock Overlay */
#lockOverlay {position:fixed; inset:0; background:black; display:flex; align-items:center; justify-content:center; z-index:9999; font-size:24px; color:#fff; display:none;}
</style>
</head>
<body>

<!-- Ø¯Ø®ÙˆÙ„ -->
<div id="login-overlay">
  <div class="login-card">
    <div class="app-title">YALLA</div>
    <p style="color:#666; margin-bottom:30px; font-weight:bold;">SCOOTER FULL SYSTEM</p>
    <input type="password" id="passInput" placeholder="****">
    <button onclick="handleAuth()" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
  </div>
</div>

<!-- Lock Overlay -->
<div id="lockOverlay">ğŸ”’ Ù…Ù‚ÙÙˆÙ„</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± -->
<div id="scooter-ui">
  <div id="stolen-msg" style="color:var(--danger); font-weight:bold; visibility:hidden; margin-bottom:15px;">ğŸš¨ Ø­Ø±ÙƒØ© Ù…Ø±ÙŠØ¨Ø©!</div>
  <div class="speed-ring">
    <span class="speed-val" id="node-speed">0</span>
    <span style="color:var(--primary); font-weight:bold;">KM/H</span>
  </div>
  <div class="scooter-stats">
    <span><i class="fas fa-battery-full"></i> <span id="node-batt">--%</span></span>
    <span><i class="fas fa-satellite-dish"></i> <span id="node-gps">GPS</span></span>
  </div>
  <div id="my-dev-id" style="margin-top:40px; color:#222; font-size:12px; font-family:'Rajdhani';">DEV-ID: --</div>
  <div id="price" style="font-size:24px; margin-top:15px;">ğŸ’° 0 Ø¬</div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„ -->
<div id="app-ui">
<nav class="sidebar">
  <div style="font-family:'Rajdhani'; font-size:26px; color:var(--primary); padding:20px 0; text-align:center; font-weight:900;">YALLA CORE</div>
  <div class="nav-item active" onclick="nav('trips')"><i class="fas fa-rocket"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</div>
  <div class="nav-item" onclick="nav('fleet')"><i class="fas fa-map-marked-alt"></i> ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
  <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
  <div class="nav-item" onclick="nav('finance')"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ÙˆØ±Ø¯ÙŠØ©</div>
  <div class="nav-item admin-only" id="nav-settings" onclick="nav('settings')"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²Ù†</div>
</nav>

<main class="main-container">
  <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø­Ù„Ø§Øª -->
  <div id="sec-trips" class="section active">
    <div class="kpi-grid">
      <div class="kpi-card"><span class="kpi-val" id="k-active">0</span><br><small>Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©</small></div>
      <div class="kpi-card admin-only"><span class="kpi-val" id="k-cash" style="color:var(--success)">0 Ø¬</span><br><small>ØµØ§ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬</small></div>
    </div>
    <button class="btn btn-primary" onclick="openNewTrip()" style="padding:20px; font-size:18px; margin-bottom:30px;">+ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</button>
    <div id="active-trips-list"></div>
  </div>

  <!-- Fleet -->
  <div id="sec-fleet" class="section">
    <h3 style="margin-bottom:20px;">ğŸ“ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Live)</h3>
    <div id="fleet-devices-list"></div>
  </div>

  <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <div id="sec-clients" class="section">
    <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." oninput="searchClients(this.value)">
    <div id="clients-list"></div>
  </div>

  <!-- Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
  <div id="sec-finance" class="section">
    <div class="kpi-card" style="margin-bottom:20px;">
      <h3 id="shift-status-txt">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù…ØºÙ„Ù‚Ø©</h3>
      <button id="shift-btn" class="btn btn-primary" onclick="toggleShift()">ÙØªØ­ ÙˆØ±Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    <button class="btn btn-danger" onclick="expensePopup()">+ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
    <div id="finance-logs" style="margin-top:20px;"></div>
  </div>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div id="sec-settings" class="section admin-only">
    <div class="kpi-grid">
      <div class="kpi-card"><h3>Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©</h3><input type="number" id="set-min" onchange="saveConfig()"></div>
      <div class="kpi-card"><h3>ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯</h3><input type="number" id="set-base" onchange="saveConfig()"></div>
    </div>
    <h3>ğŸ›µ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø²Ù†</h3>
    <div id="stock-list"></div>
    <button class="btn btn-primary" onclick="addScooterToStock()">Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ± Ø¬Ø¯ÙŠØ¯</button>
  </div>
</main>
</div>

<!-- GPS Full -->
<div id="gps-page">
  <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; background:#000;">
    <b id="gps-target" style="color:var(--primary); font-size:22px;">ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙƒÙˆØªØ±</b>
    <button onclick="closeGps()" class="btn btn-danger" style="width:100px; margin:0;">Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div id="full-map"></div>
  <div class="gps-footer">
    <div class="stat-v">Ø³Ø±Ø¹Ø© Ø­ÙŠØ©<b id="tr-speed">0</b></div>
    <div class="stat-v">Ø¨Ø·Ø§Ø±ÙŠØ©<b id="tr-batt">--</b></div>
    <div class="stat-v">Ø­Ø§Ù„Ø©<b style="color:var(--success)">Ù†Ø´Ø·</b></div>
  </div>
</div>

<script>
// Firebase
const firebaseConfig={databaseURL:"https://yalla-scooter-pro-default-rtdb.firebaseio.com"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// Device
let myId = localStorage.getItem('yalla_full_id') || "Y-" + Math.floor(1000+Math.random()*9000);
localStorage.setItem('yalla_full_id', myId);
document.getElementById('my-dev-id').innerText="DEVICE-ID: "+myId;

// State
let activeTrips={}, markers={}, gMap=null, gMarker=null, trackedId=null, isAdmin=false;
let config={base:40,min:2.66};
let tripActive=false, tripStart=0;

// Authentication
function handleAuth(){
  const p=document.getElementById('passInput').value;
  const overlay=document.getElementById('login-overlay');
  if(p==="1214"){overlay.style.display='none'; document.getElementById('scooter-ui').style.display='flex'; runScooterNode();}
  else if(p==="1213"){isAdmin=false; overlay.style.display='none'; document.getElementById('app-ui').style.display='flex'; runApp();}
  else if(p==="9924"){isAdmin=true; overlay.style.display='none'; document.getElementById('app-ui').style.display='flex'; runApp();}
  else{Swal.fire('Ø®Ø·Ø£','Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙ„Ø·','error');}
}

// Scooter Node (GPS + pricing)
function runScooterNode(){
  tripStart = Date.now();
  tripActive = true;
  updateLockUI();

  if(navigator.geolocation){
    navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      const speed=Math.round((pos.coords.speed||0)*3.6);
      document.getElementById('node-speed').innerText=speed;
      document.getElementById('node-gps').innerText=`GPS OK`;
      navigator.getBattery?.().then(bt=>{
        const batt=(bt.level*100).toFixed(0);
        document.getElementById('node-batt').innerText=batt+"%";
        db.ref('live_nodes/'+myId).update({lat,lon,speed,batt,lastUpdate:Date.now()});
      });
    },null,{enableHighAccuracy:true});
  }

  // Pricing auto update
  setInterval(()=>{
    if(!tripActive) return;
    const mins=Math.ceil((Date.now()-tripStart)/60000);
    document.getElementById("price").innerText=`ğŸ’° ${mins*config.min} Ø¬`;
  },5000);

  // Motion theft alert
  window.addEventListener('devicemotion',e=>{
    if(Math.abs(e.acceleration.x)>8){document.getElementById('stolen-msg').style.visibility='visible';
    setTimeout(()=>document.getElementById('stolen-msg').style.visibility='hidden',3000);}
  });
  if(navigator.wakeLock) navigator.wakeLock.request('screen');
}

function updateLockUI(){document.getElementById("lockOverlay").style.display=tripActive?"none":"flex";}

// ----------------- Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ø¨Ø§Ù‚ÙŠ App UI Ùˆ Fleet Ùˆ Trips Ùˆ GPS ... Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø£ÙŠ ÙƒÙˆØ¯ -----------------
// ÙŠÙ…ÙƒÙ† Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„ÙŠ ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŒ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© tripActive, GPS, Pricing

</script>
</body>
</html>
