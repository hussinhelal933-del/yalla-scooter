<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©</title>
    
    <!-- Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø­Ø°Ù) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css"> <!-- Ø³ÙŠØªÙ… Ø³Ø­Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->

    <style>
        /* Ø¥Ø¶Ø§ÙØ§Øª ØªØµÙ…ÙŠÙ… Ù…ÙƒØ«ÙØ© Ù„Ù€ index.html ÙÙ‚Ø· Ù„ØªÙƒÙˆÙ† Ù…Ø®Ø¯ÙˆÙ…Ø© */
        .scooter-card-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; border-radius: 35px 35px 0 0; padding: 30px; z-index: 5000; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .scooter-card-sheet.active { bottom: 0; }
        .sheet-line { width: 40px; height: 5px; background: #eee; border-radius: 10px; margin: -15px auto 20px auto; }
        
        .batt-pill { background: #f2f2f7; padding: 5px 12px; border-radius: 20px; font-weight: 900; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .batt-pill.high { color: var(--success); }
        .batt-pill.low { color: var(--danger); }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…Ø·ÙˆØ± */
        .custom-bike-marker { width: 45px; height: 45px; background: white; border-radius: 50%; border: 2.5px solid #0066ff; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±ÙƒÙˆØ¨ Ø³Ù„Ø§ÙŠØ¯Ø± */
        .guide-modal { position: fixed; inset: 0; background: white; z-index: 9000; display: none; flex-direction: column; }
        .step-img { flex: 1; background-size: cover; background-position: center; position: relative; }
        .step-img::after { content:''; position:absolute; inset:0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); }
        .step-content { padding: 40px 30px; text-align: right; background: white; border-radius: 35px 35px 0 0; margin-top: -40px; position: relative; z-index: 10; }
        
        /* ØªØ§Ù‚ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø­Ø¸ÙŠ */
        .live-bal-hud { position: absolute; top: 60px; right: 25px; background: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 1000; display: flex; align-items: center; gap: 8px; border: 1.5px solid #f2f2f7; pointer-events: auto; }
    </style>
</head>
<body>

    <!-- 1. Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© (Login) -->
    <div id="auth-screen" style="position:fixed; inset:0; background:white; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px;">
        <svg width="100" viewBox="0 0 100 100"><path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#0066ff" stroke-width="12" fill="none" stroke-linecap="round"/></svg>
        <h1 style="color:#0066ff; font-family:Orbitron; letter-spacing:2px; margin:20px 0 40px 0;">YALLA</h1>
        <input type="tel" id="uPhoneInp" class="auth-input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button onclick="handleLogin()" class="btn-scan-main" style="position:static; width:100%; transform:none;">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Main App) -->
    <div id="app-container" style="display:none; height:100vh;">
        <div id="map"></div>
        
        <div class="hud">
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø±ØµÙŠØ¯ -->
            <div class="mins-tag"><i class="fas fa-walking"></i> <span id="walk-eta">--</span> Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ</div>
            <div class="live-bal-hud" onclick="openPage('wallet')">
                <i class="fas fa-wallet" style="color:#0066ff"></i> <span id="hud-bal">0.00</span> Ø¬
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© -->
            <button class="fab btn-help" style="top:60px; left:25px;" onclick="openPage('chat')"><i class="fas fa-comment-dots"></i></button>
            <button class="fab btn-menu" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            <button class="fab btn-locate" onclick="locateMe()"><i class="fas fa-crosshairs"></i></button>
            
            <!-- Ø²Ø± Scan to Ride Ø§Ù„Ù…Ø·ÙˆØ± -->
            <button class="btn-scan-main" onclick="openPage('guide')">
                <i class="fas fa-expand"></i> SCAN TO RIDE
            </button>
        </div>

        <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ù…Ù†Ø²Ù„Ù‚Ø© (Scooter Info Sheet) -->
        <div id="scooter-sheet" class="scooter-card-sheet">
            <div class="sheet-line"></div>
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px;">
                <div>
                    <h2 id="sh-id" style="color:#0066ff; font-family:Orbitron; margin:0;">ğŸ›µ Y-101</h2>
                    <div id="sh-batt-pill" class="batt-pill high"><i class="fas fa-battery-full"></i> <span id="sh-batt">--</span>%</div>
                </div>
                <div style="text-align:left">
                    <b style="font-size:24px;">40.00 Ø¬</b><br><small style="color:#8e8e93">Ø£ÙˆÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©</small>
                </div>
            </div>
            <button class="btn-scan-main" style="position:static; width:100%; transform:none;" onclick="openPage('scanner')">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
        </div>

        <!-- Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø±Ø§Ø¨ÙŠØª Ø³ØªØ§ÙŠÙ„ -->
        <div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
        <nav id="side-menu">
            <div class="profile-section">
                <div class="profile-img"><i class="fas fa-user-astronaut"></i></div>
                <div><b id="disp-phone">--</b><br><small style="color:#0066ff">Ø­Ø³Ø§Ø¨ Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ… âœ“</small></div>
            </div>
            <div class="prime-btn" onclick="Swal.fire('Ø¨Ø§Ù‚Ø© Prime Plus', 'Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ø­Ù„Ø§Øª Ø¨Ù€ 15 Ø¬Ù†ÙŠÙ‡ ÙÙ‚Ø·!', 'info')">Yalla Prime Plus <i class="fas fa-crown"></i></div>
            <div class="menu-link" onclick="openPage('history')"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø±Ø­Ù„Ø§ØªÙƒ</div>
            <div class="menu-link" onclick="openPage('wallet')"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø´Ø­Ù†</div>
            <div class="menu-link" onclick="openPage('chat')"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
            <div class="menu-link" onclick="logout()" style="margin-top:auto; color:red; border:none;"><i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬</div>
        </nav>
    </div>

    <!-- 3. Ø´Ø§Ø´Ø§Øª ÙƒØ§Ù…Ù„Ø© Ù…Ø®Ø¯ÙˆÙ…Ø© -->
    <!-- Ø´Ø§Ø´Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±ÙƒÙˆØ¨ (Steps) -->
    <div id="pg-guide" class="guide-modal">
        <div id="guide-step-box" class="step-img" style="background-image:url('https://images.unsplash.com/photo-1558981403-c5f9199a28bd?q=80&w=1000');"></div>
        <div class="step-content">
            <h1 id="guide-title">1. Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ ğŸ“</h1>
            <p id="guide-desc">Ø§ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ´ÙˆÙ Ø£Ù‚Ø±Ø¨ Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ Ù…ØªØ§Ø­ Ù„ÙŠÙƒØŒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡ÙŠÙ‚ÙˆÙ„Ùƒ Ù‡Ùˆ Ø¨Ø¹ÙŠØ¯ ÙƒØ§Ù… Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø´ÙŠ Ø¨Ø§Ù„Ø¸Ø¨Ø·.</p>
            <div style="display:flex; gap:10px; margin-top:30px;">
                <button class="btn-scan-main" style="position:static; flex:2; transform:none;" onclick="nextGuideStep()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="btn-scan-main" style="position:static; flex:1; transform:none; background:#f2f2f7; color:#888;" onclick="closePage('guide')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ¨Ø§Ù‚Ø§Øª ÙÙˆØ±ÙŠ -->
    <div id="pg-wallet" class="full-page">
        <div class="pg-header"><i class="fas fa-chevron-left" onclick="closePage('wallet')"></i> Ø§Ù„Ù…Ø­ÙØ¸Ø© <i></i></div>
        <div class="wallet-banner">
            <small>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ (ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ)</small>
            <h1 style="font-family:Orbitron; font-size:55px;"><span class="live-bal-val">0.00</span> Ø¬</h1>
        </div>
        <div style="padding:25px;">
            <h3>Ø¨Ø§Ù‚Ø§Øª Ø´Ø­Ù† Ø±ØµÙŠØ¯</h3>
            <div class="menu-link" onclick="fawryPayment(50)"><b>Ø´Ø­Ù† 50 Ø¬</b> <span>50.00 Ø¬</span></div>
            <div class="menu-link" onclick="fawryPayment(100)"><b>Ø´Ø­Ù† 100 Ø¬</b> <span>100.00 Ø¬</span></div>
            <div class="menu-link" onclick="fawryPayment(200)"><b>Ø´Ø­Ù† 200 Ø¬</b> <span>200.00 Ø¬</span></div>
            <hr style="margin:20px 0; border:none; border-top:1px solid #eee;">
            <div class="menu-link" onclick="Swal.fire('ÙƒØ§Ø´', 'Ø­ÙˆÙ„ Ù„Ù€ 01014004125 ÙˆØ§Ø¨Ø¹Øª Ø³ÙƒØ±ÙŠÙ† Ø´Ø§Øª', 'info')"><i class="fas fa-mobile-alt"></i> ØªØ­ÙˆÙŠÙ„ ÙƒØ§Ø´ Ù…Ø¨Ø§Ø´Ø±</div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù€ QR (Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©) -->
    <div id="pg-scanner" class="full-page">
        <div class="pg-header"><i class="fas fa-times" onclick="closePage('scanner')"></i> Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ <i></i></div>
        <div id="qr-reader" style="width:100%; height:400px; background:black;"></div>
        <div style="padding:30px; text-align:center;">
            <input type="text" id="manualInput" placeholder="Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± ÙŠØ¯ÙˆÙŠØ§Ù‹" class="auth-input">
            <button class="btn-scan-main" style="position:static; width:100%; transform:none; margin-top:15px;" onclick="startRideManual()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¨Ø¯Ø¡</button>
        </div>
    </div>

<script src="app-core.js"></script>
<script>
    /* 
       YALLA SOVEREIGN CLIENT ENGINE V210.0
       Logic to tie index.html with app-core.js
    */

    let map, userMarker, scooterMarkers = {}, myLoc = [30.0444, 31.2357];
    let userPhone = localStorage.getItem('y_titan_verified');

    window.onload = () => { if(userPhone) { document.getElementById('auth-screen').style.display='none'; initClientApp(); } };

    function handleLogin() {
        const ph = document.getElementById('uPhoneInp').value;
        if(ph.length < 11) return Swal.fire('Ø®Ø·Ø£', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
        localStorage.setItem('y_titan_verified', ph);
        location.reload();
    }

    function initClientApp() {
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('disp-phone').innerText = userPhone;

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Rabbit Style)
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView(myLoc, 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù€ GPS ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ù„Ø£Ù‚Ø±Ø¨ Ø³ÙƒÙˆØªØ±
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                myLoc = [pos.coords.latitude, pos.coords.longitude];
                if(!userMarker) userMarker = L.circleMarker(myLoc, { radius: 10, color: '#fff', fillColor: '#0066ff', fillOpacity: 1, weight: 3 }).addTo(map);
                else userMarker.setLatLng(myLoc);
                updateNearestMins();
            });
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ§Ù‹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        YallaBrain.db.ref('live_nodes').on('value', snap => {
            const data = snap.val() || {};
            for(let id in scooterMarkers) map.removeLayer(scooterMarkers[id]);
            scooterMarkers = {};

            for(let id in data) {
                const d = data[id];
                if(d.status === 'available') {
                    const icon = L.divIcon({ className:'m', html:`
                        <div style="position:relative">
                            <div class="marker-bike"><svg width="22" viewBox="0 0 100 100"><path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#0066ff" stroke-width="15" fill="none" stroke-linecap="round"/></svg></div>
                        </div>` 
                    });
                    const m = L.marker([d.lat, d.lon], {icon}).addTo(map);
                    m.on('click', () => showScooterSheet(id, d));
                    scooterMarkers[id] = m;
                }
            }
            updateNearestMins();
        });

        // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ø§Ù„Ù…Ø±Ø¨ÙˆØ· Ø¨Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯
        YallaBrain.db.ref('users/'+userPhone+'/balance').on('value', s => {
            const val = (s.val()||0).toFixed(2);
            document.getElementById('hud-bal').innerText = val;
            document.querySelectorAll('.live-bal-val').forEach(el => el.innerText = val);
        });
    }

    function showScooterSheet(id, data) {
        const sheet = document.getElementById('scooter-sheet');
        sheet.classList.add('active');
        document.getElementById('sh-id').innerText = "ğŸ›µ " + id;
        document.getElementById('sh-batt').innerText = data.batt;
        YallaBrain.aiSpeak("Ø³ÙƒÙˆØªØ± Ø±Ù‚Ù… " + id + " Ù…ØªØ§Ø­ Ù„Ù„Ø±ÙƒÙˆØ¨ Ø§Ù„Ø¢Ù†");
    }

    function updateNearestMins() {
        let minD = Infinity;
        for(let id in scooterMarkers) {
            let d = map.distance(myLoc, scooterMarkers[id].getLatLng());
            if(d < minD) minD = d;
        }
        document.getElementById('walk-eta').innerText = (minD === Infinity) ? "--" : Math.round(minD/80);
    }

    // Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ØµÙˆØ± (Next Step Logic)
    let guideStep = 1;
    function nextGuideStep() {
        guideStep++;
        const titles = ["", "1. Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ ğŸ“", "2. Ø³ÙƒØ§Ù† Ø§Ù„Ù€ QR ÙƒÙˆØ¯ ğŸ”’", "3. Ø§Ù†Ø·Ù„Ù‚ ÙˆØ§Ø³ØªÙ…ØªØ¹ ğŸ‘Œ"];
        const descs = ["", "Ø§ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ´ÙˆÙ Ø£Ù‚Ø±Ø¨ Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ Ù…ØªØ§Ø­ Ù„ÙŠÙƒ.", "Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒÙˆØªØ± Ù„ÙØªØ­ Ø§Ù„Ù‚ÙÙ„.", "Ø§Ø±ÙØ¹ Ø§Ù„Ø³Ù†Ø§Ø¯Ø©ØŒ Ø§Ù„Ø¨Ø³ Ø§Ù„Ø®ÙˆØ°Ø©ØŒ ÙˆØ§Ù†Ø·Ù„Ù‚ Ø¨Ø£Ù…Ø§Ù†."];
        const imgs = ["", "https://images.unsplash.com/photo-1558981403-c5f9199a28bd?q=80&w=1000", "https://images.unsplash.com/photo-1600132806370-bf17e65e942f?q=80&w=1000", "https://images.unsplash.com/photo-1519608487913-d9d9b90083cc?q=80&w=1000"];
        
        if(guideStep <= 3) {
            document.getElementById('guide-title').innerText = titles[guideStep];
            document.getElementById('guide-desc').innerText = descs[guideStep];
            document.getElementById('guide-step-box').style.backgroundImage = `url('${imgs[guideStep]}')`;
        } else {
            closePage('guide');
            openPage('scanner');
        }
    }

    // Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); document.getElementById('overlay').style.display = document.getElementById('side-menu').classList.contains('open') ? 'block' : 'none'; }
    function openPage(id) { document.getElementById('pg-'+id).style.display='flex'; if(id!=='scanner') toggleMenu(); }
    function closePage(id) { document.getElementById('pg-'+id).style.display='none'; }
    function locateMe() { map.flyTo(myLoc, 18); }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
