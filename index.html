<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter Master OS | V120 PRO</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --blue: #00f2ff; 
            --bg: #000; 
            --card: #0d0d0d; 
            --red: #ff0055; 
            --green: #0aff60; 
            --border: rgba(0, 242, 255, 0.15); 
        }
        
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin:0; padding:0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: var(--card); padding: 40px; border-radius: 30px; border: 1px solid var(--blue); text-align: center; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(0,242,255,0.2); }
        
        header { height: 60px; background: #050505; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        h1 { color: var(--blue); font-family: 'Rajdhani'; font-weight: 900; font-size: 24px; }

        .app-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 30px; }
        .glass-box { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        
        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø§Ù„Ø¹Ù…ÙŠÙ„) --- */
        .speed-display { text-align: center; padding: 30px 0; border-radius: 50%; border: 4px solid #111; border-top-color: var(--blue); width: 250px; height: 250px; margin: 20px auto; display: flex; flex-direction: column; justify-content: center; position: relative; box-shadow: 0 0 40px rgba(0,242,255,0.1); }
        .speed-val { font-family: 'Rajdhani'; font-size: 100px; color: var(--blue); line-height: 1; font-weight: 900; }
        
        .trip-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .stat-item { background: #080808; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #1a1a1a; }
        .stat-item small { color: #555; display: block; margin-bottom: 5px; font-size: 12px; }
        .stat-item span { font-family: 'Rajdhani'; font-size: 26px; color: var(--blue); font-weight: 700; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± --- */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: #080808; padding: 15px; border-radius: 15px; text-align: center; border-bottom: 3px solid var(--blue); }
        .trip-card { background: #0a0a0a; border-radius: 18px; padding: 15px; margin-bottom: 12px; border-right: 5px solid var(--blue); position: relative; }
        .live-tag { position: absolute; top: 10px; left: 10px; background: var(--red); color: #fff; font-size: 9px; padding: 2px 6px; border-radius: 4px; animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0.3; } }
        input { width: 100%; background: #000; border: 1px solid #222; color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: center; font-size: 16px; outline: none; }
        input:focus { border-color: var(--blue); }
        button { cursor: pointer; border: none; border-radius: 12px; font-weight: 800; padding: 16px; transition: 0.3s; width: 100%; }
        .btn-blue { background: var(--blue); color: #000; }
        .btn-blue:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-overlay">
        <div class="login-card">
            <h1 style="letter-spacing: 2px;">YALLA COMMAND</h1>
            <p style="color:#444; font-size:10px; letter-spacing:4px; margin-bottom:25px;">SYSTEM OS V120</p>
            <input type="password" id="pinInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">
            <button onclick="App.login()" class="btn-blue">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <header id="app-header" class="hidden">
        <h1 id="user-label">YALLA SCOOTER</h1>
        <div id="clock" style="font-family:'Rajdhani'; color:#555; font-weight: 700;">00:00:00</div>
    </header>

    <main class="app-content hidden" id="main-content">
        
        <!-- 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„) -->
        <div id="scooter-view" class="hidden">
            <div class="speed-display">
                <div class="speed-val" id="live-speed">00</div>
                <div style="color:var(--blue); font-family:'Rajdhani'; letter-spacing:5px; font-size: 12px;">KM/H</div>
            </div>
            
            <!-- Ø³ØªØ¸Ù‡Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªØ¨Ø¯Ø£ Ø£Ù†Øª Ø§Ù„Ø±Ø­Ù„Ø© -->
            <div id="rider-ui" class="hidden">
                <div class="trip-stats-grid">
                    <div class="stat-item">
                        <small>ÙˆÙ‚Øª Ø§Ù„Ø±Ø­Ù„Ø©</small>
                        <span id="rider-timer">00:00</span>
                    </div>
                    <div class="stat-item">
                        <small>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
                        <span id="rider-cost">0.00</span>
                    </div>
                </div>
                <div class="glass-box" style="margin-top:20px; text-align:center; border-color: var(--green);">
                    <p style="color:var(--green); font-weight:900;">Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù† âœ“</p>
                </div>
            </div>

            <div id="standby-ui" class="glass-box" style="text-align:center; margin-top:20px; color:#444;">
                <i class="fas fa-satellite-dish"></i>
                <p>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©...</p>
                <div id="my-id-display" style="font-family:'Rajdhani'; margin-top:10px; color:var(--blue);">ID: A11</div>
            </div>
        </div>

        <!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (ØªØ¸Ù‡Ø± Ù„Ùƒ Ø£Ù†Øª) -->
        <div id="admin-view" class="hidden">
            <div class="kpi-grid">
                <div class="kpi-card"><small>Ø§Ù„Ø®Ø²Ù†Ø© (Ø¬.Ù…)</small><br><span id="vault" style="color:var(--green); font-family:'Rajdhani'; font-size:24px;">0.00</span></div>
                <div class="kpi-card"><small>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</small><br><span id="active-count" style="font-family:'Rajdhani'; font-size:24px;">0</span></div>
            </div>

            <div class="glass-box">
                <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input type="text" id="scoot-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± (Ù…Ø«Ù„ A11)">
                <button class="btn-blue" onclick="App.startTrip()">ğŸš€ Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>

            <h3 style="color:var(--blue); margin-bottom:15px; font-size:14px; border-right: 3px solid var(--blue); padding-right: 10px;">ğŸ“¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ø±Ø­Ù„Ø§Øª:</h3>
            <div id="active-list"></div>
        </div>

    </main>

<script>
    // Ù†Ø¸Ø§Ù… ÙŠÙ„Ø§ Ø³ÙƒÙˆØªØ± Ø§Ù„Ù…ÙˆØ­Ø¯
    const App = {
        db: null,
        role: '',
        scooterID: 'A11', // Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø³ÙƒÙˆØªØ± (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„ÙƒÙ„ Ù‡Ø§ØªÙ)
        pricePerMin: 2.5, // Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)

        init: function() {
            // Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
            const config = { databaseURL: "https://yalla-scooter-default-rtdb.firebaseio.com" };
            if (!firebase.apps.length) firebase.initializeApp(config);
            this.db = firebase.database();
            
            this.syncData();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø©
            setInterval(() => { 
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); 
            }, 1000);
        },

        login: function() {
            const pin = document.getElementById('pinInput').value;
            if(pin === "9924") {
                this.role = 'admin';
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('user-label').innerText = "YALLA ADMIN";
            } else if(pin === "1214") {
                this.role = 'scooter';
                document.getElementById('scooter-view').classList.remove('hidden');
                document.getElementById('user-label').innerText = "SCOOTER MODE";
                this.runScooterLogic();
            } else {
                return Swal.fire("Ø®Ø·Ø£", "ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­", "error");
            }

            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            this.init();
        },

        // --- Ù…Ù†Ø·Ù‚ Ù‡Ø§ØªÙ Ø§Ù„Ø³ÙƒÙˆØªØ± (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„) ---
        runScooterLogic: function() {
            document.getElementById('my-id-display').innerText = "ID: " + this.scooterID;

            // 1. ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø³Ø±Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø¯ÙŠØ±
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const speed = Math.round((pos.coords.speed || 0) * 3.6);
                    document.getElementById('live-speed').innerText = speed.toString().padStart(2,'0');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒÙˆØªØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØ±Ø§Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±
                    this.db.ref('nodes/' + this.scooterID).update({
                        speed: speed,
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        lastActive: Date.now()
                    });
                }, null, { enableHighAccuracy: true });
            }

            // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ± (Ù‡Ù„ Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©ØŸ)
            this.db.ref('active_trips/' + this.scooterID).on('value', snap => {
                if(snap.exists()) {
                    document.getElementById('rider-ui').classList.remove('hidden');
                    document.getElementById('standby-ui').classList.add('hidden');
                    this.startRiderTimer(snap.val().start);
                } else {
                    document.getElementById('rider-ui').classList.add('hidden');
                    document.getElementById('standby-ui').classList.remove('hidden');
                    if(this.timerInt) clearInterval(this.timerInt);
                }
            });
        },

        startRiderTimer: function(startTime) {
            if(this.timerInt) clearInterval(this.timerInt);
            this.timerInt = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const mins = Math.floor(elapsed / 60000);
                const secs = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('rider-timer').innerText = 
                    mins.toString().padStart(2,'0') + ":" + secs.toString().padStart(2,'0');
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…Ø«Ø§Ù„: 2.5 Ø¬Ù†ÙŠÙ‡ Ù„Ù„Ø¯Ù‚ÙŠÙ‚Ø©)
                const currentCost = (mins * this.pricePerMin).toFixed(2);
                document.getElementById('rider-cost').innerText = currentCost;
            }, 1000);
        },

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©) ---
        startTrip: function() {
            const name = document.getElementById('cust-name').value;
            const scoot = document.getElementById('scoot-id').value;
            if(!name || !scoot) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±", "warning");

            this.db.ref('active_trips/' + scoot).set({
                customer: name,
                scooter: scoot,
                start: Date.now()
            });

            document.getElementById('cust-name').value = "";
            document.getElementById('scoot-id').value = "";
            Swal.fire("ØªÙ…Øª", "ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØªÙØ¹ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„", "success");
        },

        finishTrip: function(scootId, startTime) {
            const mins = Math.max(1, Math.floor((Date.now() - startTime) / 60000));
            const finalCost = mins * this.pricePerMin;

            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø³ÙƒÙˆØªØ±: ${scootId} <br> Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <b>${finalCost} Ø¬.Ù…</b>`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then(result => {
                if(result.isConfirmed) {
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø®Ø²Ù†Ø©
                    this.db.ref('vault').transaction(current => (current || 0) + finalCost);
                    // Ù…Ø³Ø­ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ù†Ø´Ø·
                    this.db.ref('active_trips/' + scootId).remove();
                }
            });
        },

        syncData: function() {
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø³Ø±Ø¹Ø© ÙƒÙ„ ÙˆØ§Ø­Ø¯
            this.db.ref('active_trips').on('value', snap => {
                const list = document.getElementById('active-list');
                if(!list) return;
                list.innerHTML = "";
                let count = 0;

                snap.forEach(child => {
                    count++;
                    const trip = child.val();
                    const card = document.createElement('div');
                    card.className = 'trip-card';
                    card.innerHTML = `
                        <div class="live-tag">LIVE</div>
                        <div style="font-weight:900; color:var(--blue); font-size:18px;">ğŸ›µ ${trip.scooter}</div>
                        <div style="font-size:13px; color:#777; margin-bottom:10px;">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${trip.customer}</div>
                        <div style="text-align:center; background:#000; padding:10px; border-radius:10px;">
                            <small style="color:#444">Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                            <div id="admin-speed-${trip.scooter}" style="font-family:'Rajdhani'; font-size:30px; color:var(--blue);">00</div>
                        </div>
                        <button class="btn-blue" style="margin-top:10px; padding:10px; font-size:12px;" 
                                onclick="App.finishTrip('${trip.scooter}', ${trip.start})">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ­ØµÙŠÙ„</button>
                    `;
                    list.appendChild(card);

                    // Ø±Ø¨Ø· Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù€ nodes Ù„ÙƒÙ„ Ø³ÙƒÙˆØªØ±
                    this.db.ref('nodes/' + trip.scooter + '/speed').on('value', s => {
                        const speedEl = document.getElementById('admin-speed-' + trip.scooter);
                        if(speedEl) speedEl.innerText = (s.val() || 0).toString().padStart(2,'0');
                    });
                });
                document.getElementById('active-count').innerText = count;
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø®Ø²Ù†Ø©
            this.db.ref('vault').on('value', s => {
                const vaultEl = document.getElementById('vault');
                if(vaultEl) vaultEl.innerText = (s.val() || 0).toFixed(2);
            });
        }
    };
</script>
</body>
</html>
