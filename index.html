// ... (نفس إعدادات Firebase السابقة)

// تحديث عداد الرحلات النشطة كل دقيقة تلقائياً
setInterval(() => {
    if (document.getElementById('sec-rental').classList.contains('active')) {
        renderActiveTrips();
    }
}, 60000);

let activeTripsData = {}; // لتخزين البيانات محلياً للسرعة

function renderActiveTrips() {
    db.ref('active_trips').once('value', snap => {
        const list = document.getElementById('active-list');
        list.innerHTML = "";
        let count = 0;
        
        snap.forEach(t => {
            const trip = t.val();
            const mins = Math.max(1, Math.floor((Date.now() - trip.start) / 60000));
            count++;
            list.innerHTML += `
                <div class="trip-item" style="border-right-color: ${mins > 60 ? '#ef4444' : '#0ea5e9'}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b><i class="fas fa-scooter"></i> ${trip.scooter}</b>
                        <span class="trip-timer">${mins} <small>دقيقة</small></span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:5px;">
                        <span><i class="fas fa-user"></i> ${trip.client}</span>
                        <span style="color:#64748b">${new Date(trip.start).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <button onclick="endTrip('${t.key}', '${trip.scooter}', ${mins})" 
                            style="width:100%; border:none; background:#fee2e2; color:#ef4444; margin-top:10px; border-radius:6px; padding:6px; cursor:pointer; font-weight:bold;">
                        إنهاء وتحصيل
                    </button>
                </div>
            `;
        });
        document.getElementById('stat-active').innerText = count;
    });
}

// تعديل وظيفة الـ AI لتبدو حقيقية
async function askAI() {
    const input = document.getElementById('ai-input');
    const log = document.getElementById('ai-logs');
    const q = input.value.trim();
    if(!q) return;

    log.innerHTML += `<div style="margin-bottom:8px; color:var(--accent-teal)"><strong>أنت:</strong> ${q}</div>`;
    input.value = "";

    // محاكاة تفكير الـ AI
    const responseDiv = document.createElement('div');
    responseDiv.style.marginBottom = "15px";
    responseDiv.innerHTML = `<strong>المساعد:</strong> جاري فحص السجلات...`;
    log.appendChild(responseDiv);
    log.scrollTop = log.scrollHeight;

    setTimeout(() => {
        const revenue = document.getElementById('stat-revenue').innerText;
        const active = document.getElementById('stat-active').innerText;
        
        let answer = "بناءً على البيانات الحالية، ";
        if(q.includes("أرباح") || q.includes("كم") || q.includes("فلوس")) {
            answer += `إجمالي إيرادات اليوم هو ${revenue}. هل ترغب في تحليل أوقات الذروة؟`;
        } else if(q.includes("شغال") || q.includes("رحلات")) {
            answer += `يوجد حالياً ${active} رحلات نشطة في الميدان. الأداء مستقر بنسبة 85%.`;
        } else {
            answer += "أنا أراقب العمليات لحظياً. يمكنك سؤالي عن الأرباح، الرحلات النشطة، أو كفاءة السكوترز.";
        }
        responseDiv.innerHTML = `<strong>المساعد:</strong> ${answer}`;
        log.scrollTop = log.scrollHeight;
    }, 1000);
}

// استدعاء البيانات عند الدخول
function initData() {
    renderActiveTrips();
    // مراقبة التغييرات الحية
    db.ref('active_trips').on('child_added', renderActiveTrips);
    db.ref('active_trips').on('child_removed', renderActiveTrips);
    
    // إيرادات اليوم
    const today = new Date().toISOString().split('T')[0];
    db.ref(`history/${today}`).on('value', snap => {
        let rev = 0;
        let trips = 0;
        snap.forEach(c => { rev += (c.val().total || 0); trips++; });
        document.getElementById('stat-revenue').innerText = rev + " ج.م";
        document.getElementById('stat-trips').innerText = trips;
        updateEfficiency(trips);
    });
}
