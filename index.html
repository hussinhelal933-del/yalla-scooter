<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter Master OS</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --blue: #00f2ff; --bg: #000; --card: #0d0d0d; --red: #ff0055; --green: #0aff60; --border: rgba(0, 242, 255, 0.15); }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin:0; padding:0; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: var(--card); padding: 30px; border-radius: 30px; border: 1px solid var(--blue); text-align: center; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(0,242,255,0.2); }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { height: 60px; background: #050505; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        h1 { color: var(--blue); font-family: 'Rajdhani'; font-weight: 900; font-size: 24px; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .app-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 30px; }
        .glass-box { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (1214) */
        .speed-display { text-align: center; padding: 40px 0; }
        .speed-val { font-family: 'Rajdhani'; font-size: 110px; color: var(--blue); line-height: 1; font-weight: 900; }
        .status-pill { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-top: 10px; }
        .locked { background: rgba(255,0,85,0.1); color: var(--red); border: 1px solid var(--red); }
        .unlocked { background: rgba(10,255,96,0.1); color: var(--green); border: 1px solid var(--green); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (9924) */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: #080808; padding: 15px; border-radius: 15px; text-align: center; border-bottom: 3px solid var(--blue); }
        .trip-card { background: #0a0a0a; border-radius: 18px; padding: 15px; margin-bottom: 10px; border-right: 5px solid var(--blue); }

        input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 10px; text-align: center; font-size: 16px; }
        button { cursor: pointer; border: none; border-radius: 12px; font-weight: 800; padding: 15px; transition: 0.2s; width: 100%; }
        .btn-blue { background: var(--blue); color: #000; }
        .btn-danger { background: rgba(255,0,85,0.1); color: var(--red); border: 1px solid var(--red); }
    </style>
</head>
<body>

    <!-- Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… -->
    <div id="login-overlay">
        <div class="login-card">
            <h1>YALLA COMMAND</h1>
            <p style="color:#444; font-size:10px; letter-spacing:3px; margin-bottom:20px;">SYSTEM V120</p>
            <input type="password" id="pinInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯">
            <button onclick="App.login()" class="btn-blue">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <header id="app-header" class="hidden">
        <h1 id="user-label">YALLA SCOOTER</h1>
        <div id="clock" style="font-family:'Rajdhani'; color:#555;">00:00:00</div>
    </header>

    <main class="app-content hidden" id="main-content">
        
        <!-- 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (ÙƒÙˆØ¯ 1214) -->
        <div id="scooter-view" class="hidden">
            <div class="speed-display">
                <div class="speed-val" id="live-speed">00</div>
                <div style="color:var(--blue); font-family:'Rajdhani'; letter-spacing:5px;">KM/H</div>
                <div id="lock-status" class="status-pill locked">ğŸ”’ Ù…Ù‚ÙÙˆÙ„</div>
            </div>
            
            <div class="glass-box">
                <small style="color:#555">Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS):</small>
                <div id="gps-data" style="font-size:11px; color:var(--blue); margin-top:5px;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø©...</div>
            </div>

            <div class="glass-box" id="node-events" style="font-size:10px; color:#666; height:100px; overflow-y:auto;">
                > Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø§Ù…Ø§Ù† Ù†Ø´Ø·...
            </div>
        </div>

        <!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (ÙƒÙˆØ¯ 9924) -->
        <div id="admin-view" class="hidden">
            <div class="kpi-grid">
                <div class="kpi-card"><small>Ø§Ù„Ø¯Ø±Ø¬</small><br><span id="vault" style="font-family:'Rajdhani'; font-size:22px; color:var(--green)">0.00</span></div>
                <div class="kpi-card"><small>Ø§Ù„Ù†Ø´Ø·</small><br><span id="active-count" style="font-family:'Rajdhani'; font-size:22px;">0</span></div>
            </div>

            <div class="glass-box">
                <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
                <input type="text" id="scoot-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                <button class="btn-blue" onclick="App.startTrip()">ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
            </div>

            <h3 style="color:var(--blue); margin-bottom:10px; font-size:14px;">ğŸ›µ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©:</h3>
            <div id="active-list"></div>
        </div>

    </main>

<script>
    const App = {
        db: null, role: '', scooterID: 'A11',
        config: { databaseURL: "https://yalla-scooter-default-rtdb.firebaseio.com" }, // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·

        init: function() {
            firebase.initializeApp(this.config);
            this.db = firebase.database();
            this.sync();
            setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG'); }, 1000);
        },

        login: function() {
            const pin = document.getElementById('pinInput').value;
            if(pin === "9924") { 
                this.role = 'admin'; 
                document.getElementById('admin-view').classList.remove('hidden');
            } 
            else if(pin === "1214") { 
                this.role = 'scooter'; 
                document.getElementById('scooter-view').classList.remove('hidden');
                this.startScooterLogic();
            } 
            else return alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙ„Ø·!");

            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            this.init();
        },

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø§Ù„Ù…Ø£Ø®ÙˆØ° Ù…Ù† ÙƒÙˆØ¯Ùƒ ÙˆØ§Ù„Ù…Ø·ÙˆØ±) ---
        startScooterLogic: function() {
            if("geolocation" in navigator) {
                navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    const speed = Math.round((pos.coords.speed || 0) * 3.6);
                    document.getElementById('live-speed').innerText = speed.toString().padStart(2,'0');
                    document.getElementById('gps-data').innerText = `LAT: ${lat.toFixed(4)} | LON: ${lon.toFixed(4)}`;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨
                    this.db.ref('nodes/' + this.scooterID).update({ lat, lon, speed, last: Date.now() });

                    // ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ ÙÙŠ Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ø³ÙƒÙˆØªØ± Ù…Ù‚ÙÙˆÙ„
                    this.db.ref('active_trips/' + this.scooterID).once('value', s => {
                        if(speed > 2 && !s.exists()) this.logEvent("âš ï¸ Ø­Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† Ø±Ø­Ù„Ø©!");
                    });
                }, null, { enableHighAccuracy: true });
            }

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„ (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†)
            this.db.ref('active_trips/' + this.scooterID).on('value', s => {
                const isUnlocked = s.exists();
                const el = document.getElementById('lock-status');
                el.innerText = isUnlocked ? "ğŸ”“ Ù…ÙØªÙˆØ­ (Ø±Ø­Ù„Ø©)" : "ğŸ”’ Ù…Ù‚ÙÙˆÙ„";
                el.className = "status-pill " + (isUnlocked ? "unlocked" : "locked");
            });
        },

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©) ---
        startTrip: function() {
            const name = document.getElementById('cust-name').value;
            const scoot = document.getElementById('scoot-id').value;
            if(!name || !scoot) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            this.db.ref('active_trips/' + scoot).set({
                customer: name, start: Date.now(), scooter: scoot
            });
            document.getElementById('cust-name').value = "";
            document.getElementById('scoot-id').value = "";
        },

        finishTrip: function(scoot, startTime) {
            const mins = Math.max(1, Math.floor((Date.now() - startTime) / 60000)) || 0;
            const cost = mins * 2; // Ø§Ù„Ø­Ø³Ø§Ø¨ (2 Ø¬Ù†ÙŠÙ‡ Ù„Ù„Ø¯Ù‚ÙŠÙ‚Ø©)

            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©',
                html: `Ø§Ù„Ø³ÙƒÙˆØªØ±: ${scoot} <br> Ø§Ù„ÙˆÙ‚Øª: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© <br> Ø§Ù„Ø­Ø³Ø§Ø¨: <b>${cost} Ø¬.Ù…</b>`,
                confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ ÙˆÙ‚Ø¨Ø¶'
            }).then(r => {
                if(r.isConfirmed) {
                    const today = new Date().toISOString().split('T')[0];
                    this.db.ref('history/' + today).push({ scoot, cost, mins, time: Date.now() });
                    this.db.ref('vault').transaction(v => (v || 0) + cost);
                    this.db.ref('active_trips/' + scoot).remove();
                }
            });
        },

        logEvent: function(msg) {
            const log = document.getElementById('node-events');
            log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
            this.db.ref('events').push({ msg, scoot: this.scooterID, time: Date.now() });
        },

        sync: function() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ©
            this.db.ref('active_trips').on('value', snap => {
                const list = document.getElementById('active-list');
                list.innerHTML = ""; let count = 0;
                snap.forEach(c => {
                    count++; const t = c.val();
                    const m = Math.floor((Date.now() - t.start) / 60000) || 0;
                    list.innerHTML += `
                        <div class="trip-card">
                            <b>ğŸ›µ ${t.scooter}</b> | ${t.customer}
                            <div style="font-family:'Rajdhani'; font-size:24px; color:var(--blue); text-align:center;">${m} MIN</div>
                            <button class="btn-blue" style="padding:8px; margin-top:5px;" onclick="App.finishTrip('${t.scooter}', ${t.start})">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                        </div>`;
                });
                document.getElementById('active-count').innerText = count;
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø®Ø²Ù†Ø© (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
            if(this.role === 'admin') {
                this.db.ref('vault').on('value', s => {
                    document.getElementById('vault').innerText = (s.val() || 0).toFixed(2);
                });
            }
        }
    };
</script>
</body>
</html>
