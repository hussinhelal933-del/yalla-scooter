<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter | Official App</title>
    
    <!-- الموارد الأساسية -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Rajdhani:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --rabbit-green: #8ed254;
            --yalla-blue: #39b5e0;
            --text-dark: #1a1a1a;
            --gray-bg: #f2f2f7;
            --border: #e5e5ea;
            --shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: white; color: var(--text-dark); }

        /* --- شاشة الدخول الفخمة --- */
        #auth-screen { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .yalla-logo-hd { width: 140px; margin-bottom: 20px; }
        .auth-input { width: 100%; padding: 18px; border-radius: 15px; border: 1.5px solid var(--border); margin-bottom: 12px; font-size: 18px; text-align: center; background: var(--gray-bg); transition: 0.3s; }
        .auth-input:focus { border-color: var(--yalla-blue); background: white; }

        /* --- الخريطة (ستايل Rabbit الرمادي النظيف) --- */
        #map { position: absolute; inset: 0; z-index: 1; filter: grayscale(0.2) contrast(1.05); }

        /* --- الأزرار العائمة (HUD) --- */
        .btn-fab { position: absolute; z-index: 1000; background: white; border: none; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; }
        .btn-fab:active { transform: scale(0.9); }
        
        .btn-menu { bottom: 40px; right: 25px; }
        .btn-locate { bottom: 40px; left: 25px; }
        .btn-help { top: 70px; right: 25px; width: 45px; height: 45px; font-size: 18px; }

        .btn-scan-main {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(90deg, var(--rabbit-green), #addd7b);
            color: white; padding: 16px 45px; border-radius: 50px;
            font-weight: 900; font-size: 19px; width: 240px; z-index: 1000;
            display: flex; align-items: center; justify-content: center; gap: 12px; border: none;
            box-shadow: 0 8px 20px rgba(142, 210, 84, 0.3);
        }

        /* --- المنيو الجانبي ( rabbit UI الأصلي) --- */
        #side-menu { 
            position: fixed; top: 0; right: -100%; width: 82%; height: 100%; 
            background: white; z-index: 5000; transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1); 
            padding: 60px 25px; display: flex; flex-direction: column;
        }
        #side-menu.open { right: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 4999; display: none; backdrop-filter: blur(2px); }

        .profile-box { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .profile-data { display: flex; align-items: center; gap: 15px; }
        .profile-img-wrap { width: 55px; height: 55px; border-radius: 15px; background: var(--gray-bg); display: flex; align-items: center; justify-content: center; }
        .profile-text b { font-size: 20px; display: block; }
        .profile-text span { font-size: 14px; color: #8e8e93; }

        .prime-plus-card {
            border: 2px solid var(--yalla-blue); border-radius: 15px; padding: 15px;
            color: var(--yalla-blue); font-weight: 900; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 30px;
        }

        .menu-item { 
            display: flex; align-items: center; gap: 20px; padding: 18px 5px; 
            border-bottom: 1px solid #f2f2f7; color: var(--text-dark);
            font-weight: 600; font-size: 16px; cursor: pointer;
        }
        .menu-item i { color: var(--yalla-blue); font-size: 20px; width: 25px; text-align: center; }
        .menu-item .arrow-left { margin-right: auto; color: #ccc; font-size: 14px; }

        /* --- الصفحات الكاملة (Pages) --- */
        .full-page { position: fixed; inset: 0; background: white; z-index: 6000; display: none; flex-direction: column; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .header { padding: 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 18px; }

        /* --- أيقونة الموتوسيكل (الماركر) --- */
        .bike-marker { background: none; border: none; }
        .marker-inner { 
            width: 46px; height: 46px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2.5px solid var(--rabbit-green);
        }
    </style>
</head>
<body>

    <!-- 1. شاشة الدخول -->
    <div id="auth-screen">
        <!-- لوجو Y عالي الدقة SVG -->
        <svg class="yalla-logo-hd" viewBox="0 0 100 100">
            <path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#39b5e0" stroke-width="12" fill="none" stroke-linecap="round"/>
            <circle cx="40" cy="85" r="8" fill="#1a1a1a"/>
            <line x1="10" y1="30" x2="25" y2="30" stroke="#39b5e0" stroke-width="6" stroke-linecap="round" />
            <line x1="5" y1="45" x2="20" y2="45" stroke="#39b5e0" stroke-width="6" stroke-linecap="round" />
        </svg>
        <h1 style="font-family:'Rajdhani'; font-weight:900; letter-spacing:1px; color:#1a1a1a;">YALLA SCOOTER</h1>
        <p style="color:#8e8e93; margin-bottom:40px;">مرحباً بك، سجل دخولك للانطلاق</p>
        
        <input type="tel" id="loginPhone" class="auth-input" placeholder="رقم الهاتف">
        <input type="email" id="loginEmail" class="auth-input" placeholder="البريد الإلكتروني">
        
        <button onclick="handleLogin()" class="btn-scan-main" style="position:static; transform:none; width:100%; margin-top:10px;">دخول التطبيق</button>
    </div>

    <!-- 2. المنيو الجانبي (Rabbit Clone) -->
    <div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
    <nav id="side-menu">
        <div class="profile-box">
            <div class="profile-data">
                <div class="profile-img-wrap">
                    <svg width="28" viewBox="0 0 100 100"><path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#8ed254" stroke-width="14" fill="none" stroke-linecap="round"/></svg>
                </div>
                <div class="profile-text">
                    <b id="u-name">Hassan</b>
                    <span id="u-phone">+201153243863</span>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color:#ccc;"></i>
        </div>

        <div class="prime-plus-card" onclick="Swal.fire('Yalla Prime Plus', 'قريباً.. استمتع برحلات مجانية تماماً', 'info')">
            Yalla Prime Plus <i class="fas fa-crown"></i>
        </div>

        <div class="menu-links">
            <div class="menu-item" onclick="openPage('history')"><i class="fas fa-history"></i> سجل الرحلات <i class="fas fa-chevron-left arrow-left"></i></div>
            <div class="menu-item" onclick="openPage('wallet')"><i class="fas fa-wallet"></i> المحفظة <i class="fas fa-chevron-left arrow-left"></i></div>
            <div class="menu-item"><i class="fas fa-gift"></i> رصيد مجاني <i class="fas fa-chevron-left arrow-left"></i></div>
            <div class="menu-item" onclick="openPage('guide')"><i class="fas fa-motorcycle"></i> كيف تستخدم التطبيق <i class="fas fa-chevron-left arrow-left"></i></div>
            <div class="menu-item"><i class="fas fa-language"></i> اللغة / Language <i class="fas fa-chevron-left arrow-left"></i></div>
        </div>

        <div class="menu-item" onclick="logout()" style="color:#ff3b30; border:none; margin-top:auto;">
            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </div>
    </nav>

    <!-- 3. الواجهة الرئيسية -->
    <div id="map"></div>
    <button class="btn-fab btn-help" onclick="Swal.fire('الدعم الفني', 'جاري توصيلك بأحد ممثلي الخدمة...', 'success')"><i class="fas fa-question"></i></button>
    <button class="btn-fab btn-menu" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    <button class="btn-fab btn-locate" onclick="locateMe()"><i class="fas fa-crosshairs"></i></button>
    <button class="btn-scan-main" onclick="openScanner()">
        <i class="fas fa-expand"></i> سكان وإبدأ الرحلة
    </button>

    <!-- 4. شاشة المحفظة (Wallet) -->
    <div id="pg-wallet" class="full-page">
        <div class="header"><i class="fas fa-chevron-left" onclick="closePage('wallet')"></i> محفظة <i></i></div>
        <div style="background:var(--gray-bg); margin:20px; padding:30px; border-radius:25px; display:flex; justify-content:space-between; align-items:center;">
            <div><small style="color:#8e8e93;">الرصيد المتاح</small><h2 id="balance-txt" style="font-family:Rajdhani; font-size:35px; margin:0;">0.00 ج.م</h2></div>
            <button onclick="openPage('recharge')" style="background:var(--rabbit-green); color:white; border:none; padding:12px 25px; border-radius:12px; font-weight:bold;">إشحن</button>
        </div>
        <div style="padding:20px;">
            <p><b>طريقة الدفع</b></p>
            <div style="color:var(--rabbit-green); padding:15px; border:1px dashed var(--rabbit-green); border-radius:15px; text-align:center;">
                <i class="fas fa-plus-circle"></i> اضف كارت بنكي (قريباً)
            </div>
        </div>
    </div>

<script>
    // --- الربط مع الفايربيز ---
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, scooterMarkers = {};
    let userPhone = localStorage.getItem('yalla_verified_phone');
    let shopLoc = { lat: 30.0444, lon: 31.2357 };

    window.onload = () => { if(userPhone) { document.getElementById('auth-screen').style.display='none'; initApp(); } };

    // --- دخول وتحقق ---
    function handleLogin() {
        const ph = document.getElementById('loginPhone').value;
        if(ph.length < 11) return Swal.fire('خطأ', 'رقم الهاتف غير صحيح', 'error');
        userPhone = ph;
        localStorage.setItem('yalla_verified_phone', ph);
        location.reload();
    }

    // --- تشغيل المنظومة (بدون وهمي) ---
    function initApp() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([shopLoc.lat, shopLoc.lon], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        // ربط الخريطة بالمخزن الحقيقي
        db.ref('live_nodes').on('value', snap => {
            const data = snap.val() || {};
            
            // مسح أي سكوتر ممسوح من الداش بورد
            for (let id in scooterMarkers) { if (!data[id]) { map.removeLayer(scooterMarkers[id]); delete scooterMarkers[id]; } }

            // إضافة الحقيقي المتاح فقط
            for (let id in data) {
                const d = data[id];
                if (d.status === 'available') {
                    if (!scooterMarkers[id]) {
                        const icon = L.divIcon({
                            className: 'bike-marker',
                            html: `<div class="marker-inner"><svg width="22" viewBox="0 0 100 100"><path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#8ed254" stroke-width="15" fill="none" stroke-linecap="round"/></svg></div>`
                        });
                        scooterMarkers[id] = L.marker([d.lat, d.lon], {icon}).addTo(map);
                    } else {
                        scooterMarkers[id].setLatLng([d.lat, d.lon]);
                    }
                } else {
                    if (scooterMarkers[id]) { map.removeLayer(scooterMarkers[id]); delete scooterMarkers[id]; }
                }
            }
        });

        db.ref('users/' + userPhone + '/balance').on('value', s => {
            document.getElementById('balance-txt').innerText = (s.val()||0).toFixed(2) + " ج.م";
            document.getElementById('u-phone').innerText = userPhone;
        });
        
        locateMe();
    }

    // --- أوامر الواجهة ---
    function toggleMenu() {
        const m = document.getElementById('side-menu');
        const o = document.getElementById('overlay');
        const open = m.classList.toggle('open');
        o.style.display = open ? 'block' : 'none';
    }

    function openPage(id) { document.getElementById('pg-'+id).style.display='flex'; toggleMenu(); }
    function closePage(id) { document.getElementById('pg-'+id).style.display='none'; }

    async function openScanner() {
        const { value: scId } = await Swal.fire({ title: 'Scan to Ride', input: 'text', inputPlaceholder: 'رقم السكوتر', confirmButtonColor: '#8ed254' });
        if(scId) {
            db.ref('users/'+userPhone+'/balance').once('value', s => {
                if((s.val()||0) < 40) return Swal.fire('رصيد ضعيف', 'اشحن 40 ج كحد أدنى للبدء', 'warning');
                db.ref('active_trips').push({ phone: userPhone, scooterId: scId, start: Date.now() });
                Swal.fire('رحلة سعيدة!', 'تم تشغيل السكوتر بنجاح', 'success');
            });
        }
    }

    function locateMe() { if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => map.flyTo([p.coords.latitude, p.coords.longitude], 17)); }
    function logout() { localStorage.clear(); location.reload(); }
</script>

</body>
</html>
