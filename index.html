<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Yalla Bridge | Ø¬Ù‡Ø§Ø² Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #000; color: #00f2ff; font-family: sans-serif; text-align: center; padding: 20px; }
        .box { border: 2px solid #00f2ff; padding: 20px; border-radius: 20px; margin-top: 20px; background: #080808; }
        #status { font-weight: bold; color: #0f6; margin: 15px 0; }
        button { padding: 20px; background: #00f2ff; color: #000; border: none; border-radius: 15px; font-weight: bold; width: 100%; font-size: 18px; cursor: pointer; }
        .log { background: #111; color: #888; padding: 10px; border-radius: 10px; height: 150px; overflow-y: auto; font-size: 11px; margin-top: 20px; text-align: left; direction: ltr; }
    </style>
</head>
<body>
    <h2>Yalla Scooter Bridge ğŸ›µ</h2>
    <p>Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ø³ÙƒÙˆØªØ± Ø§Ù„Ø¢Ù†</p>
    
    <div class="box">
        <div id="status">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ø³ÙƒÙˆØªØ±</div>
        <button onclick="connectToScooter()">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø±Ø¨Ø· Ø¨Ù„ÙˆØªÙˆØ«</button>
    </div>

    <div class="log" id="log">-- Ø³Ø¬Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© --</div>

<script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
    const firebaseConfig = {
        apiKey: "AIzaSyCJOSLUFRAZV4YWYFDB9VLvju",
        authDomain: "yala-scooter.firebaseapp.com",
        databaseURL: "https://yalla-scooter-default-rtdb.firebaseio.com",
        projectId: "yala-scooter",
        storageBucket: "yala-scooter.firebasestorage.app",
        messagingSenderId: "1014076976512",
        appId: "1:1014076976512:web:c053191787884674720970"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const SCOOTER_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e"; // Ù…Ù† ØµÙˆØ±ØªÙƒ
    const SCOOTER_WRITE_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";   // Ù‚Ù†Ø§Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    let bluetoothCharacteristic;

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    // 1. Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
    async function connectToScooter() {
        try {
            addLog("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† MISCOOTER...");
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'MISCOOTER' }],
                optionalServices: [SCOOTER_SERVICE_UUID]
            });
            
            addLog("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...");
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SCOOTER_SERVICE_UUID);
            bluetoothCharacteristic = await service.getCharacteristic(SCOOTER_WRITE_UUID);
            
            document.getElementById('status').innerText = "âœ… Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø±";
            addLog("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ØªØ±Ø§Ù‚Ø¨Ùƒ Ø§Ù„Ø¢Ù†.");
            
            listenToCloud(); // Ø§Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙˆØ§Ù…Ø± Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ Ø£Ù†Øª
        } catch (e) {
            addLog("Ø®Ø·Ø£: " + e.message);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ (GPS)");
        }
    }

    // 2. Ø³Ù…Ø§Ø¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù…Ù† Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ)
    function listenToCloud() {
        const scooterKey = "A11"; // Ø±Ù‚Ù… Ø§Ù„Ø¥Ø³ÙƒÙˆØªØ± Ø§Ù„Ù„ÙŠ Ù‡ØªØ­Ø·Ù‡ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        db.ref('commands/' + scooterKey).on('value', snap => {
            const data = snap.val();
            if (data && bluetoothCharacteristic) {
                addLog("ÙˆØµÙ„ Ø£Ù…Ø± Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: " + data.action);
                sendScooterCommand(data.action);
            }
        });
    }

    // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø¥Ø³ÙƒÙˆØªØ±
    function sendScooterCommand(action) {
        let hex;
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¯ÙŠ ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŒ Ù„Ùˆ Ù…Ø§ Ø§Ø´ØªØºÙ„ØªØ´ Ù‡Ù†ØºÙŠØ±Ù‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø¯ ÙØ¹Ù„ Ø§Ù„Ø¥Ø³ÙƒÙˆØªØ±
        if (action === "UNLOCK") {
            hex = "55AA03200370000069FF"; // ÙƒÙˆØ¯ Ø§Ù„ÙØªØ­ Ù„Ù€ Mi Scooter
        } else if (action === "LOCK") {
            hex = "55AA03200370010068FF"; // ÙƒÙˆØ¯ Ø§Ù„Ù‚ÙÙ„ Ù„Ù€ Mi Scooter
        }

        if (hex) {
            const bytes = new Uint8Array(hex.match(/[\da-f]{2}/gi).map(h => parseInt(h, 16)));
            bluetoothCharacteristic.writeValue(bytes)
                .then(() => addLog("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¥Ø³ÙƒÙˆØªØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…"))
                .catch(err => addLog("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: " + err));
        }
    }
</script>
</body>
</html>
