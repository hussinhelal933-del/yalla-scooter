<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter | Master Dashboard v12</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- UI Extras -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --p: #00d2ff; --s: #3a7bd5; --d: #060912;
            --ok: #00f2fe; --err: #ff4b2b; --wait: #f9d423;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; }
        body { 
            background: var(--d); color: #fff; min-height: 100vh; padding: 20px;
            background-image: radial-gradient(circle at 50% 0%, #1a2a44 0%, #060912 85%);
            overflow-x: hidden;
        }

        .container { max-width: 1550px; margin: 0 auto; position: relative; }
        .hidden { display: none !important; }

        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 25px; border-radius: 25px; text-align: center; backdrop-filter: blur(15px); border-bottom: 5px solid var(--p); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .stat-card b { display: block; font-size: 32px; font-family: 'Orbitron'; color: var(--p); margin-top: 5px; }

        .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 30px; }
        .sidebar { background: rgba(255,255,255,0.02); padding: 25px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); height: fit-content; position: sticky; top: 20px; }

        .station-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .station-card { 
            background: linear-gradient(135deg, #111b2d, #060912); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 30px; padding: 25px; position: relative; transition: 0.4s;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        }
        .station-card.paused { border: 2.5px dashed var(--wait); opacity: 0.8; }
        .station-card:hover { transform: translateY(-8px); border-color: var(--p); }

        .scooter-id-edit { background: none; border: none; color: var(--p); font-size: 26px; font-weight: 900; font-family: 'Orbitron'; width: 100%; text-align: center; outline: none; margin-bottom: 5px; }
        .timer-val { font-family: 'Orbitron'; font-size: 45px; text-align: center; margin: 15px 0; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(0,210,255,0.5); }

        input { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; color: white; width: 100%; margin-bottom: 15px; font-size: 16px; }
        .btn { border: none; border-radius: 15px; padding: 15px; cursor: pointer; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; color: white; width: 100%; }
        .btn-p { background: linear-gradient(45deg, var(--p), var(--s)); font-size: 18px; }
        .btn-finish { background: var(--p); margin-top: 10px; }
        .btn-issue { background: none; border: 1px solid var(--err); color: var(--err); margin-top: 8px; font-size: 12px; padding: 10px; }
        .btn-pause { background: rgba(249, 212, 35, 0.1); border: 1px solid var(--wait); color: var(--wait); }
        .btn-resume { background: rgba(0, 242, 254, 0.1); border: 1px solid var(--ok); color: var(--ok); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .invoice-card { background: #0f172a; border: 2px solid var(--p); border-radius: 35px; width: 450px; padding: 40px; text-align: center; box-shadow: 0 0 50px rgba(0,210,255,0.3); }

        #logBody { max-height: 350px; overflow-y: auto; margin-top: 20px; border-top: 1px solid #222; padding-top: 15px; }
        .history-item { padding: 10px; border-bottom: 1px solid #111; font-size: 12px; background: rgba(255,255,255,0.01); border-radius: 8px; margin-bottom: 5px; }
        .fail-tag { color: var(--err); font-size: 10px; display: block; border-top: 1px dashed rgba(255,75,43,0.2); margin-top: 5px; }
    </style>
</head>
<body>

    <div id="finishModal" class="modal-overlay">
        <div class="invoice-card">
            <h1 id="invScooter" style="font-family:'Orbitron'; color:var(--p)">S-01</h1>
            
            <div id="issueSection" class="hidden" style="background: rgba(255,75,43,0.1); padding: 15px; border-radius: 15px; margin: 15px 0; border: 1px solid var(--err);">
                <p style="color:var(--err); font-weight: 900; margin-bottom: 10px;">ğŸš¨ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ ÙÙ†ÙŠ / Ø®ØµÙ…</p>
                <input type="text" id="issueReason" placeholder="Ù…Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø·Ù„ØŸ">
                <input type="number" id="issueDiscount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµÙˆÙ…ØŸ">
            </div>

            <div style="margin: 25px 0; border-top: 1px dashed #333; border-bottom: 1px dashed #333; padding: 20px 0; text-align: right;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙØ¹Ø§Ù„Ø©</span><b id="invMins">0 Ø¯Ù‚ÙŠÙ‚Ø©</b></div>
                <div style="display:flex; justify-content:space-between; color: var(--ok); font-size: 22px;"><span>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (2.50 Ø¬/Ø¯)</span><b id="invTotal">0 Ø¬.Ù…</b></div>
            </div>

            <button class="btn btn-p" onclick="App.confirmFinalFinish()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø­Ù„Ø© âœ…</button>
            <button class="btn" style="background:none; margin-top:10px; color:#555" onclick="App.closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="login-screen" class="modal-overlay" style="display:flex">
        <div class="invoice-card" style="border-color: var(--s);">
            <h1 style="font-family:'Orbitron'; font-weight: 900;">YALLA SCOOTER</h1>
            <p style="color:#555; font-size: 11px; margin-bottom: 30px;">MASTER SYSTEM v12.0</p>
            <input type="password" id="pass" placeholder="PASSWORD" style="text-align:center; font-family:'Orbitron'; letter-spacing: 5px;">
            <button class="btn btn-p" onclick="App.login()">AUTHENTICATE</button>
        </div>
    </div>

    <div id="app-screen" class="container hidden">
        <div class="stats-bar">
            <div class="stat-card"><span>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span><b id="totalCash">0.00</b></div>
            <div class="stat-card"><span>Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span><b id="activeCount">0</b></div>
            <div class="stat-card"><span>Ù…ÙƒØªÙ…Ù„ Ø§Ù„ÙŠÙˆÙ…</span><b id="totalTrips">0</b></div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <h3 style="margin-bottom: 20px; color: var(--p);">ØªØ´ØºÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
                <input type="text" id="new-staff" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                <input type="text" id="new-scooter" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                <button class="btn btn-p" onclick="App.start()">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš€</button>

                <div style="background:rgba(0,210,255,0.05); padding:15px; border-radius:15px; margin-top:20px; border:1px solid var(--p)">
                    <span style="font-size:11px; font-weight:bold; color:var(--p)">ğŸ” Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³ÙƒÙˆØªØ± (Ø´Ù‡Ø±ÙŠ)</span>
                    <input type="text" id="search-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±..." oninput="App.stats()" style="margin-top:10px; font-size:12px;">
                    <div style="display:flex; justify-content:space-around; font-size:11px; margin-top:5px;">
                        <div>Ø¥ÙŠØ±Ø§Ø¯: <b id="m-total" style="color:var(--ok)">0</b></div>
                        <div>Ø®ØµÙ…: <b id="m-disc" style="color:var(--err)">0</b></div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h4>Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h4>
                    <input type="date" id="viewDate" onchange="App.load()" style="padding:5px; margin:0; font-size:11px; margin-top:10px;">
                    <div id="logBody"></div>
                </div>
                <button class="btn" style="background:none; border:1px solid var(--err); color:var(--err); margin-top:10px; font-size:10px" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
            <div class="station-grid" id="ongoing-list"></div>
        </div>
    </div>

<script>
    const TG_TOKEN = "7899750780:AAFL31roDUbqFDoP-iUL2dhNn4GtKFAPUD0"; 
    const TG_CHAT_IDS = ["5684905593", "1089983199"]; 

    const firebaseConfig = {
        apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
        authDomain: "yalla-scooter-pro.firebaseapp.com",
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        projectId: "yalla-scooter-pro",
        storageBucket: "yalla-scooter-pro.firebasestorage.app",
        messagingSenderId: "185791475252",
        appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let curId = null; let isIssueMode = false;

    const App = {
        sendTG: (msg) => {
            TG_CHAT_IDS.forEach(id => {
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${id}&text=${encodeURIComponent(msg)}`);
            });
        },
        login: function() {
            if(document.getElementById('pass').value === "1234") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').classList.remove('hidden');
                this.init();
            } else alert("Error!");
        },
        init: function() {
            const today = new Date().toLocaleDateString('en-CA');
            document.getElementById('viewDate').value = today;
            document.getElementById('new-staff').value = localStorage.getItem('yStaff') || '';
            this.sync(); this.load();
            setInterval(() => this.timers(), 1000);
        },
        start: async function() {
            const staff = document.getElementById('new-staff').value.trim();
            const scooter = document.getElementById('new-scooter').value.trim().toUpperCase();
            if(!staff || !scooter) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            await db.ref('ongoing').push({ staff, scooter, startTime: Date.now(), status: 'running', totalPausedTime: 0, lastPauseStart: 0 });
            App.sendTG(`ğŸš€ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø£Øª!\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${scooter}\nØ§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${staff}`);
            document.getElementById('new-scooter').value = "";
            localStorage.setItem('yStaff', staff);
        },
        sync: function() {
            db.ref('ongoing').on('value', snap => {
                const list = document.getElementById('ongoing-list');
                const badge = document.getElementById('activeCount');
                list.innerHTML = ""; const data = snap.val();
                if(data) {
                    badge.innerText = Object.keys(data).length;
                    Object.entries(data).forEach(([id, t]) => {
                        const isP = t.status === 'paused';
                        list.innerHTML += `<div class="station-card ${isP ? 'paused' : ''}">
                                <input class="scooter-id-edit" value="${t.scooter}" onchange="App.rename('${id}', this.value)">
                                <p style="text-align:center; color:#555; font-size:12px;">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${t.staff}</p>
                                <div class="timer-val" id="timer-${id}">00:00</div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                    ${isP ? `<button class="btn btn-resume" onclick="App.resume('${id}')">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>` : `<button class="btn btn-pause" onclick="App.pause('${id}')">Ù…Ø¤Ù‚Øª</button>`}
                                    <button class="btn btn-finish" onclick="App.openInv('${id}', false)">Ø¥Ù†Ù‡Ø§Ø¡</button>
                                    <button class="btn" style="background:var(--err); grid-column: span 2; font-size:12px; padding:8px" onclick="App.openInv('${id}', true)">ğŸš¨ Ø¥Ù†Ù‡Ø§Ø¡ Ø¨Ø¹Ø·Ù„ Ø£Ùˆ Ø®ØµÙ…</button>
                                </div>
                            </div>`;
                    });
                } else badge.innerText = "0";
            });
        },
        timers: function() {
            db.ref('ongoing').once('value', snap => {
                const data = snap.val();
                if(data) Object.entries(data).forEach(([id, t]) => {
                    let elapsed = t.status === 'running' ? (Date.now()-t.startTime-t.totalPausedTime) : (t.lastPauseStart-t.startTime-t.totalPausedTime);
                    const m = Math.floor(elapsed/60000), s = Math.floor((elapsed%60000)/1000);
                    const el = document.getElementById(`timer-${id}`);
                    if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                });
            });
        },
        rename: (id, val) => db.ref(`ongoing/${id}`).update({ scooter: val.toUpperCase() }),
        pause: (id) => db.ref(`ongoing/${id}`).update({ status: 'paused', lastPauseStart: Date.now() }),
        resume: (id) => db.ref(`ongoing/${id}`).once('value', snap => {
            const t = snap.val();
            db.ref(`ongoing/${id}`).update({ status: 'running', totalPausedTime: t.totalPausedTime + (Date.now() - t.lastPauseStart) });
        }),
        openInv: function(id, issue) {
            curId = id; isIssueMode = issue;
            db.ref(`ongoing/${id}`).once('value', snap => {
                const t = snap.val();
                let end = t.status === 'paused' ? t.lastPauseStart : Date.now();
                const mins = Math.max(1, Math.ceil((end - t.startTime - t.totalPausedTime) / 60000));
                document.getElementById('invScooter').innerText = t.scooter;
                document.getElementById('invMins').innerText = mins;
                // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„Ø³Ø¹Ø± 2.50 ---
                document.getElementById('invTotal').innerText = (mins * 2.5).toFixed(2);
                if(issue) document.getElementById('issueSection').classList.remove('hidden');
                else document.getElementById('issueSection').classList.add('hidden');
                document.getElementById('finishModal').style.display = 'flex';
            });
        },
        confirmFinalFinish: function() {
            let disc = 0; let reason = "Ø³Ù„ÙŠÙ… âœ…";
            if(isIssueMode) {
                reason = document.getElementById('issueReason').value || "Ø¹Ø·Ù„";
                disc = parseFloat(document.getElementById('issueDiscount').value) || 0;
            }
            const mins = parseInt(document.getElementById('invMins').innerText);
            // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹: Ø§Ù„Ø³Ø¹Ø± 2.50 ---
            const finalCost = Math.max(0, (mins * 2.5) - disc);
            db.ref(`ongoing/${curId}`).once('value', async snap => {
                const t = snap.val();
                const today = new Date().toLocaleDateString('en-CA');
                await db.ref(`history/${today}`).push({ scooter: t.scooter, staff: t.staff, mins, cost: finalCost, discount: disc, reason, timestamp: Date.now() });
                await db.ref(`ongoing/${curId}`).remove();
                App.sendTG(`âœ… Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©!\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${t.scooter}\nØ§Ù„Ù…Ø¯Ø©: ${mins} Ø¯Ù‚ÙŠÙ‚Ø©\nØ§Ù„ØµØ§ÙÙŠ: ${finalCost} Ø¬.Ù…\nØ§Ù„Ø­Ø§Ù„Ø©: ${reason}`);
                this.closeModal();
            });
        },
        closeModal: () => document.getElementById('finishModal').style.display = 'none',
        load: function() {
            const date = document.getElementById('viewDate').value;
            db.ref(`history/${date}`).on('value', snap => {
                const body = document.getElementById('logBody'); body.innerHTML = "";
                let cash = 0; let trips = 0;
                if(snap.val()) Object.values(snap.val()).reverse().forEach(t => {
                    cash += t.cost; trips++;
                    const fail = t.reason !== "Ø³Ù„ÙŠÙ… âœ…";
                    body.innerHTML += `<div class="history-item"><b>${t.scooter}</b> | ${t.cost.toFixed(2)}Ø¬ ${fail ? `<span class="fail-tag">ğŸš¨ ${t.reason} (-${t.discount}Ø¬)</span>` : ''}</div>`;
                });
                document.getElementById('totalCash').innerText = cash.toFixed(2);
                document.getElementById('totalTrips').innerText = trips;
            });
        },
        stats: function() {
            const sName = document.getElementById('search-input').value.trim().toUpperCase();
            if(!sName) return;
            const month = new Date().toLocaleDateString('en-CA').substring(0, 7);
            db.ref('history').once('value', snap => {
                let total = 0, disc = 0;
                snap.forEach(day => day.forEach(t => { if(t.val().scooter === sName) { total += t.val().cost; disc += (t.val().discount || 0); } }));
                document.getElementById('m-total').innerText = total.toFixed(2); document.getElementById('m-disc').innerText = disc.toFixed(2);
            });
        }
    };
</script>
</body>
</html>
