<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter | Tactical Command V5</title>
    
    <!-- Scripts & Fonts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #020617; --card: #0f172a; --sidebar: #020617;
            --primary: #2dd4bf; --accent: #3b82f6; --danger: #f43f5e; --warn: #fbbf24;
            --text: #f8fafc; --text-muted: #64748b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 260px; background: var(--sidebar); border-left: 1px solid #1e293b; display: flex; flex-direction: column; z-index: 100; }
        .brand { padding: 30px; text-align: center; border-bottom: 1px solid #1e293b; color: var(--primary); font-family: 'Orbitron'; font-size: 20px; font-weight: 900; }
        .nav-item { padding: 16px 25px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 15px; font-weight: 700; transition: 0.3s; }
        .nav-item i { width: 20px; text-align: center; }
        .nav-item:hover, .nav-item.active { background: #0f172a; color: var(--primary); border-right: 4px solid var(--primary); }

        /* --- Main Content --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 25px; background: radial-gradient(circle at top right, #0f172a, transparent); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .section { display: none; height: 100%; overflow-y: auto; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }

        /* --- Tactical Components --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #1e293b; position: relative; }
        .kpi-card::before { content: ''; position: absolute; top:0; left:0; width: 40px; height: 2px; background: var(--primary); }
        .kpi-val { font-family: 'Orbitron'; font-size: 26px; display: block; color: var(--primary); margin-top: 5px; }

        /* Tables */
        .glass-table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 12px; overflow: hidden; font-size: 14px; }
        th { background: #020617; padding: 15px; text-align: right; color: var(--text-muted); border-bottom: 1px solid #1e293b; }
        td { padding: 15px; border-bottom: 1px solid #1e293b; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Fleet Grid */
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .scooter-card { background: var(--card); border: 1px solid #1e293b; padding: 20px; border-radius: 15px; transition: 0.3s; }
        .scooter-card:hover { border-color: var(--primary); transform: translateY(-5px); }

        /* AI Side Drawer */
        #ai-trigger { position: fixed; bottom: 30px; left: 30px; width: 65px; height: 65px; background: var(--primary); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 1000; box-shadow: 0 0 20px rgba(45, 212, 191, 0.4); }
        .ai-drawer { position: fixed; top: 0; left: -420px; width: 400px; height: 100%; background: #020617; border-right: 1px solid var(--primary); z-index: 1001; transition: 0.4s; display: flex; flex-direction: column; }
        .ai-drawer.open { left: 0; }
        .ai-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 12px; max-width: 85%; font-size: 13px; }
        .msg.bot { background: #1e293b; color: var(--primary); align-self: flex-start; }
        .msg.user { background: var(--accent); color: white; align-self: flex-end; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-warn { background: var(--warn); color: #000; }
        
        #login-overlay { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-overlay">
        <div style="background:var(--card); padding:50px; border-radius:20px; text-align:center; width:380px; border:1px solid #1e293b;">
            <h1 style="font-family:Orbitron; color:var(--primary)">YALLA ACCESS</h1>
            <input type="password" id="passInput" style="width:100%; padding:15px; margin:20px 0; background:#000; border:1px solid #1e293b; color:var(--primary); font-size:24px; text-align:center; border-radius:10px;">
            <button onclick="login()" class="btn btn-primary" style="width:100%; justify-content:center; padding:15px;">AUTHORIZE</button>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="brand">YALLA COMMAND</div>
        <div class="nav-item active" onclick="nav('rental')"><i class="fas fa-satellite"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="nav-item" onclick="nav('maintenance')"><i class="fas fa-tools"></i> ÙˆØ±Ø´Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
        <div class="nav-item" onclick="nav('attendance')"><i class="fas fa-fingerprint"></i> Ø§Ù„Ø­Ø¶ÙˆØ± (GPS)</div>
        <div class="nav-item" onclick="nav('clients')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div id="adm-nav" class="nav-item" style="display:none" onclick="nav('admin')"><i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger)" onclick="location.reload()"><i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬</div>
    </nav>

    <!-- Content Area -->
    <main class="main-content">
        <div class="top-bar">
            <h2 id="page-title" style="margin:0; font-weight:900;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h2>
            <div style="font-family:Orbitron; color:var(--primary); background:rgba(45, 212, 191, 0.1); padding:5px 15px; border-radius:20px; border:1px solid var(--primary);" id="live-clock">00:00:00</div>
        </div>

        <!-- Section: Rental -->
        <div id="sec-rental" class="section active">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div class="kpi-card" style="flex:1; margin-left:20px;"><span class="kpi-val" id="count-active">0</span><small>Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†</small></div>
                <button class="btn btn-primary" onclick="newTripPopup()">+ Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
            <div id="rental-grid" class="fleet-grid"></div>
        </div>

        <!-- Section: Maintenance -->
        <div id="sec-maintenance" class="section">
            <div class="top-bar"><h3>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª</h3><button class="btn btn-warn" onclick="maintPopup()">+ ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©</button></div>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø³ÙƒÙˆØªØ±</th><th>Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody id="maint-table"></tbody>
            </table>
        </div>

        <!-- Section: Attendance -->
        <div id="sec-attendance" class="section">
            <div class="kpi-card" style="text-align:center; margin-bottom:30px;">
                <i class="fas fa-map-marker-alt" style="font-size:40px; color:var(--primary); margin-bottom:15px;"></i>
                <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</h3>
                <p style="color:var(--text-muted)">ÙŠØ¬Ø¨ Ø§Ù„ØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù…Ø­Ù„ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.</p>
                <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
                    <button class="btn btn-primary" onclick="attendance('IN')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
                    <button class="btn" style="background:var(--danger); color:#fff" onclick="attendance('OUT')">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <!-- Section: Clients -->
        <div id="sec-clients" class="section">
            <div class="top-bar">
                <h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                <input type="text" id="clientSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." oninput="filterClients(this.value)" style="padding:10px; background:#000; border:1px solid #1e293b; color:white; border-radius:8px; width:250px;">
            </div>
            <table class="glass-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±Ø­Ù„Ø§Øª</th><th>Ø§Ù„ØµØ±Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="clients-table"></tbody>
            </table>
        </div>

        <!-- Section: Admin -->
        <div id="sec-admin" class="section">
            <div class="kpi-grid">
                <div class="kpi-card"><span class="kpi-val" id="adm-rev">0</span><small>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</small></div>
                <div class="kpi-card"><span class="kpi-val" style="color:var(--danger)" id="adm-exp">0</span><small>Ù…ØµØ±ÙˆÙØ§Øª ØµÙŠØ§Ù†Ø©</small></div>
                <div class="kpi-card"><span class="kpi-val" style="color:var(--warn)" id="adm-profit">0</span><small>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</small></div>
                <div class="kpi-card"><span class="kpi-val" style="color:var(--accent)" id="adm-trips">0</span><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</small></div>
            </div>
        </div>
    </main>

    <!-- AI Drawer -->
    <div id="ai-trigger" onclick="toggleAI()">ğŸ§ </div>
    <div id="ai-drawer" class="ai-drawer">
        <div style="padding:20px; border-bottom:1px solid #1e293b; display:flex; justify-content:space-between; align-items:center;">
            <b style="color:var(--primary)">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</b>
            <i class="fas fa-times" onclick="toggleAI()" style="cursor:pointer"></i>
        </div>
        <div id="ai-body" class="ai-body">
            <div class="msg bot">ØªØ­ÙŠØ§ØªÙŠ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù‚Ø§Ø¦Ø¯. Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©.</div>
        </div>
        <div class="ai-footer">
            <input type="text" id="ai-input" class="ai-input" style="flex:1; background:#000; border:1px solid #1e293b; color:white; padding:10px; border-radius:8px;" placeholder="Ø§Ø³Ø£Ù„ Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…...">
            <button onclick="askAI()" class="btn btn-primary" style="padding:10px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & DATA ---
        const GEMINI_KEY = "AIzaSyAPWM-Ue8plkZqxkMn86Q0xwPWB6Cbczfw";
        const TELEGRAM = { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" };
        const SHOP_LOC = { lat: 30.0444, lng: 31.2357 };

        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        setInterval(() => document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG'), 1000);

        // --- 2. AUTH & NAV ---
        function login() {
            const p = document.getElementById('passInput').value;
            if(p === "1213" || p === "9924") {
                if(p === "9924") document.getElementById('adm-nav').style.display = 'flex';
                document.getElementById('login-overlay').style.display = 'none';
                initDashboard();
            } else {
                Swal.fire('ACCESS DENIED', 'Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
            }
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'maintenance') loadMaintTable();
            if(id === 'clients') loadClients();
            if(id === 'admin') initAdmin();
        }

        // --- 3. RENTAL LOGIC ---
        function initDashboard() {
            db.ref('active_trips').on('value', snap => {
                const grid = document.getElementById('rental-grid');
                grid.innerHTML = "";
                let count = 0;
                snap.forEach(t => {
                    count++;
                    const data = t.val();
                    const mins = Math.floor((Date.now() - data.start)/60000);
                    grid.innerHTML += `
                        <div class="scooter-card">
                            <div style="display:flex; justify-content:space-between"><b>${data.scooter}</b><small>${data.client}</small></div>
                            <div style="font-family:Orbitron; font-size:30px; color:var(--primary); margin:15px 0;">${mins}m</div>
                            <button onclick="endTrip('${t.key}', ${mins}, '${data.phone}', '${data.scooter}')" class="btn" style="width:100%; background:rgba(244,63,94,0.1); color:var(--danger); border:1px solid var(--danger); justify-content:center;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                        </div>
                    `;
                });
                document.getElementById('count-active').innerText = count;
            });
        }

        async function newTripPopup() {
            const { value: form } = await Swal.fire({
                title: 'ØªØ®ØµÙŠØµ Ù…Ù‡Ù…Ø©',
                html: '<input id="sw-s" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="sw-p" class="swal2-input" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„"><input id="sw-n" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">',
                background: '#020617', color: '#fff', confirmButtonColor: '#2dd4bf',
                preConfirm: () => [document.getElementById('sw-s').value.toUpperCase(), document.getElementById('sw-p').value, document.getElementById('sw-n').value]
            });
            if(form && form[0]) {
                db.ref('active_trips').push({ scooter:form[0], phone:form[1]||'0', client:form[2]||'Ø²Ø§Ø¦Ø±', start:Date.now() });
                if(form[1]!=='0') db.ref('clients/'+form[1]).update({ name:form[2], lastVisit:Date.now() });
            }
        }

        async function endTrip(key, mins, phone, scooter) {
            const total = Math.max(mins * 1.5, 15);
            Swal.fire({
                title: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ­ØµÙŠÙ„',
                text: `Ø§Ù„Ù…Ø¨Ù„Øº: ${total} Ø¬.Ù…`,
                icon: 'success', showCancelButton: true, confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
                background: '#020617', color: '#fff', confirmButtonColor: '#2dd4bf'
            }).then(r => {
                if(r.isConfirmed) {
                    const today = new Date().toISOString().split('T')[0];
                    db.ref(`history/${today}`).push({ scooter, total, duration: mins, end: Date.now() });
                    if(phone !== '0') {
                        db.ref(`clients/${phone}`).transaction(c => {
                            return { ...c, totalSpend: (c?.totalSpend||0)+total, trips: (c?.trips||0)+1 };
                        });
                    }
                    db.ref('active_trips/'+key).remove();
                }
            });
        }

        // --- 4. ATTENDANCE (GPS) ---
        function attendance(type) {
            if(!navigator.geolocation) return Swal.fire('Error', 'GPS Not Supported', 'error');
            Swal.fire({title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹...', didOpen:()=>Swal.showLoading(), background:'#020617', color:'#fff'});
            
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, SHOP_LOC.lat, SHOP_LOC.lng);
                if(dist > 200) return Swal.fire('ÙØ´Ù„!', `Ø£Ù†Øª Ø¨Ø¹ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ (${Math.floor(dist)} Ù…ØªØ±)`, 'error');

                const time = new Date().toLocaleTimeString('ar-EG');
                const today = new Date().toISOString().split('T')[0];
                db.ref(`attendance/${today}`).push({ type, time });
                
                fetch(`https://api.telegram.org/bot${TELEGRAM.token}/sendMessage`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ chat_id: TELEGRAM.chat, text: `ğŸ“ Ø³Ø¬Ù„ <b>${type==='IN'?'Ø­Ø¶ÙˆØ±':'Ø§Ù†ØµØ±Ø§Ù'}</b>\nğŸ•’ ${time}`, parse_mode: 'HTML' })
                });
                Swal.fire('ØªÙ…!', 'Ø³ÙØ¬Ù„Øª Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }, () => Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹', 'error'));
        }

        // --- 5. MAINTENANCE & ADMIN ---
        async function maintPopup() {
            const { value: f } = await Swal.fire({
                title: 'ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø©',
                html: '<input id="m-s" class="swal2-input" placeholder="Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="m-p" class="swal2-input" placeholder="Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±"><input id="m-c" class="swal2-input" type="number" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">',
                background: '#020617', color: '#fff', preConfirm: () => [document.getElementById('m-s').value, document.getElementById('m-p').value, document.getElementById('m-c').value]
            });
            if(f) db.ref('maintenance_log').push({ scooter:f[0], part:f[1], cost:parseFloat(f[2])||0, date:Date.now() });
        }

        function loadMaintTable() {
            db.ref('maintenance_log').limitToLast(20).on('value', snap => {
                const tb = document.getElementById('maint-table'); tb.innerHTML = "";
                snap.forEach(c => {
                    const v = c.val();
                    tb.innerHTML += `<tr><td>${v.scooter}</td><td>${v.part}</td><td style="color:var(--danger)">${v.cost}</td><td>${new Date(v.date).toLocaleDateString()}</td></tr>`;
                });
            });
        }

        function initAdmin() {
            const today = new Date().toISOString().split('T')[0];
            db.ref(`history/${today}`).on('value', snap => {
                let rev = 0, count = 0;
                snap.forEach(c => { rev += (c.val().total||0); count++; });
                document.getElementById('adm-rev').innerText = rev;
                document.getElementById('adm-trips').innerText = count;
                document.getElementById('adm-profit').innerText = rev; 
            });
            db.ref('maintenance_log').on('value', snap => {
                let exp = 0;
                snap.forEach(c => exp += (c.val().cost || 0));
                document.getElementById('adm-exp').innerText = exp;
            });
        }

        // --- 6. AI & UTILS ---
        function toggleAI() { document.getElementById('ai-drawer').classList.toggle('open'); }
        async function askAI() {
            const inp = document.getElementById('ai-input'); const q = inp.value; if(!q) return;
            const body = document.getElementById('ai-body'); body.innerHTML += `<div class="msg user">${q}</div>`;
            inp.value = ""; body.scrollTop = body.scrollHeight;
            const rev = document.getElementById('adm-rev').innerText;
            const context = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø§Ù„ÙŠ Ù„Ù…Ø´Ø±ÙˆØ¹ Ø³ÙƒÙˆØªØ±. Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ… ${rev} Ø¬.Ù…. Ø¬Ø§ÙˆØ¨ Ø¨Ø§Ø®ØªØµØ§Ø± ØªÙƒØªÙŠÙƒÙŠ: ${q}`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: context }] }] })
                });
                const d = await res.json();
                body.innerHTML += `<div class="msg bot">${d.candidates[0].content.parts[0].text}</div>`;
            } catch(e) { body.innerHTML += `<div class="msg bot" style="color:red">ERROR CONNECTION</div>`; }
            body.scrollTop = body.scrollHeight;
        }

        function loadClients() {
            db.ref('clients').on('value', snap => {
                const tb = document.getElementById('clients-table'); tb.innerHTML = "";
                snap.forEach(c => {
                    const v = c.val();
                    tb.innerHTML += `<tr><td>${v.name}</td><td>${c.key}</td><td>${v.trips||0}</td><td>${v.totalSpend||0}</td><td>âœ…</td></tr>`;
                });
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
