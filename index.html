<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yalla Scooter Sovereign | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-blue: #00d2ff;
            --luxury-brown: #3E2723;
            --deep-brown: #1a1110;
            --soft-brown: #5D4037;
            --neon-red: #ff0055;
            --neon-purple: #bc13fe;
            --neon-green: #00ff9d;
            --glass: rgba(26, 17, 16, 0.95);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… ÙØ®Ù… */
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); margin: 0; padding: 0; }
        body { background: #000; color: #fff; height: 100vh; overflow: hidden; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Gate) --- */
        #auth-gate { position: fixed; inset: 0; background: linear-gradient(135deg, var(--deep-brown), #000); z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .gate-card { width: 90%; max-width: 400px; text-align: center; padding: 40px; border-radius: 40px; border: 2px solid var(--primary-blue); background: var(--glass); box-shadow: 0 0 50px rgba(0,210,255,0.2); }
        .yalla-logo-svg { width: 120px; filter: drop-shadow(0 0 10px var(--primary-blue)); margin-bottom: 20px; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Yalla App) --- */
        #user-interface { display: none; height: 100vh; position: relative; flex-direction: column; }
        #user-map { position: absolute; inset: 0; z-index: 1; filter: sepia(0.2) brightness(0.9) contrast(1.1); }
        
        .user-hud { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .user-hud button { pointer-events: auto; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø±Ø§Ø¨ÙŠØª Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .fab-btn { position: absolute; width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--luxury-brown); border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; }
        .btn-menu { bottom: 40px; right: 25px; }
        .btn-locate { bottom: 40px; left: 25px; }
        .btn-support { top: 60px; right: 25px; width: 45px; height: 45px; font-size: 18px; color: var(--soft-brown); }

        .btn-scan-ride {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(90deg, var(--soft-brown), var(--luxury-brown));
            color: var(--primary-blue); padding: 18px 50px; border-radius: 50px;
            font-weight: 900; font-size: 20px; width: 250px; border: 2px solid var(--primary-blue);
            box-shadow: 0 10px 30px rgba(0,210,255,0.3); display: flex; align-items: center; justify-content: center; gap: 12px;
        }

        /* Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø±Ø§Ø¨ÙŠØª (Ø¨Ù†ÙŠ ÙÙŠ Ø£Ø²Ø±Ù‚) */
        #side-menu { 
            position: fixed; top: 0; right: -100%; width: 82%; height: 100%; 
            background: var(--luxury-brown); z-index: 5000; padding: 60px 25px; 
            display: flex; flex-direction: column; border-left: 3px solid var(--primary-blue);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        #side-menu.open { right: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4999; display: none; backdrop-filter: blur(5px); }

        .profile-section { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .profile-img { width: 60px; height: 60px; border-radius: 20px; background: var(--deep-brown); border: 2px solid var(--primary-blue); display: flex; align-items: center; justify-content: center; }
        
        .menu-link { 
            display: flex; align-items: center; gap: 20px; padding: 20px 5px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); color: white;
            font-weight: 700; font-size: 18px; cursor: pointer;
        }
        .menu-link i { color: var(--primary-blue); font-size: 22px; width: 30px; text-align: center; }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Pilot Mode) --- */
        #pilot-interface { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        .ai-pulse { position: absolute; top: 50px; width: 80px; height: 80px; background: var(--primary-blue); border-radius: 50%; box-shadow: 0 0 30px var(--primary-blue); animation: ai-glow 2s infinite; display: flex; align-items: center; justify-content: center; }
        @keyframes ai-glow { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.15); opacity: 1; } }
        
        .speed-ring { width: 300px; height: 300px; border: 10px solid #111; border-top-color: var(--primary-blue); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 50px; }
        .speed-val { font-family: 'Orbitron'; font-size: 110px; color: #fff; text-shadow: 0 0 20px var(--primary-blue); }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Dashboard) --- */
        #admin-interface { display: none; height: 100vh; flex-direction: row; background: var(--deep-brown); }
        .admin-sidebar { width: 280px; background: #000; border-left: 2px solid #222; padding: 25px; display: flex; flex-direction: column; }
        .admin-main { flex: 1; overflow-y: auto; padding: 40px; }
        
        .admin-card { background: var(--soft-brown); border: 1.5px solid var(--primary-blue); border-radius: 25px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .trip-radar-card { border-right: 12px solid var(--primary-blue); }
        .trip-radar-card.fallen { border-right-color: var(--neon-purple); animation: shake 0.5s infinite; }
        .trip-radar-card.out-zone { border-right-color: var(--neon-red); }

        /* --- Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… --- */
        .full-page { position: fixed; inset: 0; background: var(--deep-brown); z-index: 6000; display: none; flex-direction: column; animation: slideUp 0.4s ease; overflow-y: auto; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        .pg-header { padding: 25px; display: flex; align-items: center; justify-content: space-between; background: var(--luxury-brown); border-bottom: 2px solid var(--primary-blue); font-weight: 900; font-size: 20px; }

        input, select { width: 100%; padding: 18px; background: #000; border: 1.5px solid var(--soft-brown); color: #fff; border-radius: 15px; margin-top: 10px; text-align: center; font-size: 18px; outline: none; }
        input:focus { border-color: var(--primary-blue); }
        
        .btn-luxury { background: var(--soft-brown); color: var(--primary-blue); border: 2px solid var(--primary-blue); padding: 15px; border-radius: 15px; font-weight: 900; cursor: pointer; }

        @media (max-width: 768px) { #admin-interface { flex-direction: column; } .admin-sidebar { width: 100%; flex-direction: row; height: auto; overflow-x: auto; } }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ© -->
    <div id="auth-gate">
        <div class="gate-card">
            <svg class="yalla-logo-svg" viewBox="0 0 100 100">
                <path d="M20 20 L40 50 L40 85 M40 50 L60 20" stroke="#00d2ff" stroke-width="12" fill="none" stroke-linecap="round"/>
                <circle cx="40" cy="85" r="8" fill="#5D4037"/>
            </svg>
            <h1 style="font-family:'Orbitron'; color:var(--primary-blue); font-size:35px; letter-spacing:3px;">YALLA</h1>
            <p style="color:var(--soft-brown); font-weight:900; margin-bottom:30px;">Premium Mobility System</p>
            <input type="password" id="passInput" placeholder="Passcode / Phone Number">
            <button onclick="handleAuth()" class="btn-scan-ride" style="position:static; transform:none; width:100%; margin-top:20px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Rabbit Theme) -->
    <div id="user-interface">
        <div id="user-map"></div>
        <div class="user-hud">
            <button class="fab-btn btn-support" onclick="Swal.fire('Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ', 'ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§: 01014004125', 'info')"><i class="fas fa-headset"></i></button>
            <button class="fab-btn btn-menu" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            <button class="fab-btn btn-locate" onclick="locateMe()"><i class="fas fa-crosshairs"></i></button>
            <button class="btn-scan-ride" onclick="openScanner()">
                <i class="fas fa-expand"></i> SCAN TO RIDE
            </button>
        </div>

        <div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
        <nav id="side-menu">
            <div class="profile-section">
                <div class="profile-right">
                    <div class="profile-img"><i class="fas fa-user-astronaut" style="color:var(--primary-blue); font-size:25px;"></i></div>
                    <div class="profile-name">
                        <b id="u-name-display" style="color:var(--primary-blue);">Hassan</b>
                        <span id="u-phone-display">+201153243863</span>
                    </div>
                </div>
            </div>
            <div class="menu-link" onclick="openPage('wallet')"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø­ÙØ¸Ø© <i class="fas fa-chevron-left" style="margin-right:auto; font-size:12px;"></i></div>
            <div class="menu-link" onclick="openPage('history')"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª <i class="fas fa-chevron-left" style="margin-right:auto; font-size:12px;"></i></div>
            <div class="menu-link" onclick="openPage('guide')"><i class="fas fa-motorcycle"></i> ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ <i class="fas fa-chevron-left" style="margin-right:auto; font-size:12px;"></i></div>
            <div class="menu-link" onclick="logout()" style="margin-top:auto; color:var(--primary-blue);"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
        </nav>
    </div>

    <!-- 3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙƒÙˆØªØ± (Pilot AI) -->
    <div id="pilot-interface">
        <div class="ai-pulse"><i class="fas fa-brain" style="font-size:30px;"></i></div>
        <div id="ai-text" style="margin-top:140px; font-weight:900; color:var(--primary-blue); height:30px; text-shadow:0 0 10px var(--primary-blue);">YALLA AI ACTIVE</div>
        
        <div class="speed-ring" id="node-gauge">
            <span class="speed-val" id="node-speed">0</span>
            <span style="color:var(--primary-blue); font-weight:bold; letter-spacing:5px;">KM/H</span>
        </div>
        <p id="node-id-txt" style="position:absolute; bottom:20px; color:#222; font-family:Orbitron;"></p>
    </div>

    <!-- 4. Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ops Center) -->
    <div id="admin-interface">
        <nav class="admin-sidebar">
            <h2 style="color:var(--primary-blue); text-align:center; font-family:Orbitron; margin-bottom:40px;">YALLA OPS</h2>
            <div class="menu-link active" onclick="adminNav('trips')"><i class="fas fa-bolt"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ©</div>
            <div class="menu-link" onclick="adminNav('fleet')"><i class="fas fa-satellite"></i> Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
            <div class="menu-link" onclick="adminNav('finance')"><i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„ÙˆØ±Ø¯ÙŠØ©</div>
            <div class="menu-link" onclick="adminNav('ai')"><i class="fas fa-brain"></i> ØªØ­Ù„ÙŠÙ„ AI</div>
            <div class="menu-link" onclick="adminNav('settings')"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²Ù†</div>
        </nav>
        <main class="admin-main">
            <div id="adm-trips" class="admin-section">
                <div style="display:flex; gap:20px; margin-bottom:30px;">
                    <div class="admin-card" style="flex:1">Ø§Ù„Ù†Ø´Ø·: <b id="k-active" style="color:var(--primary-blue); font-size:35px;">0</b></div>
                    <div class="admin-card" style="flex:1">Ø§Ù„Ø¯Ø±Ø¬: <b id="k-cash" style="color:var(--neon-green); font-size:35px;">0 Ø¬</b></div>
                </div>
                <div id="admin-trips-list"></div>
            </div>
            <div id="adm-settings" class="admin-section" style="display:none;">
                <div class="admin-card">
                    <h3>ØªØ¹Ø±ÙŠÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ø®ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„)</h3>
                    <p>Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ 15 Ø¯:</p><input type="number" id="set-min" onchange="saveConfig()">
                    <p>ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯:</p><input type="number" id="set-base" onchange="saveConfig()">
                </div>
                <h3>ğŸ›µ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø¹Ø§Ù…</h3>
                <div id="stock-list"></div>
                <button class="btn-scan-ride" style="position:static; width:100%; margin-top:20px;" onclick="addScooterToStock()">Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ± Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </main>
    </div>

    <!-- 5. Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„) -->
    <div id="pg-wallet" class="full-page">
        <div class="pg-header"><i class="fas fa-chevron-right" onclick="closePage('wallet')"></i> <b>Ø§Ù„Ù…Ø­ÙØ¸Ø©</b> <i></i></div>
        <div class="admin-card" style="margin:20px; text-align:center;">
            <small style="color:var(--primary-blue)">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</small>
            <h1 id="balance-txt" style="font-family:Orbitron; font-size:45px; color:white;">0.00 Ø¬.Ù…</h1>
            <button class="btn-scan-ride" style="position:static; width:180px; margin:20px auto 0 auto; padding:10px;" onclick="showTopup()">Ø¥Ø´Ø­Ù† Ø±ØµÙŠØ¯</button>
        </div>
        <div style="padding:20px;">
            <p style="color:var(--soft-brown); font-weight:900;">Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹:</p>
            <div class="admin-card" style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="showTopup()">
                <i class="fas fa-mobile-alt" style="color:var(--primary-blue); font-size:25px;"></i>
                <b>Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© (01014004125)</b>
            </div>
            <div class="admin-card" style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="Swal.fire('Visa', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ...', 'info')">
                <i class="fas fa-credit-card" style="color:var(--primary-blue); font-size:25px;"></i>
                <b>Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†ÙƒÙŠØ© (ÙÙŠØ²Ø§ / Ù…Ø§Ø³ØªØ±)</b>
            </div>
        </div>
    </div>

<script>
    // --- 1. Ø§Ù„ØªØ£Ø³ÙŠØ³ ÙˆØ§Ù„Ø±Ø¨Ø· Ø¨Ù€ Firebase ---
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let shopLoc = { lat: 30.0444, lon: 31.2357 }, isAdmin = false;
    let config = { base: 40, min: 2.66 }, activeTrips = {}, scooterMarkers = {}, userPhone = localStorage.getItem('y_ph_v90');
    const beep = new Audio('https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3');

    // --- 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ---
    function handleAuth() {
        const p = document.getElementById('passInput').value;
        const gate = document.getElementById('auth-gate');
        if(p.length >= 11) { userPhone = p; localStorage.setItem('y_ph_v90', p); gate.style.display='none'; document.getElementById('user-interface').style.display='flex'; initUserApp(); }
        else if(p === "1214") { gate.style.display='none'; document.getElementById('pilot-interface').style.display='flex'; runScooterNode(); }
        else if(p === "9924") { isAdmin=true; gate.style.display='none'; document.getElementById('admin-interface').style.display='flex'; runApp(); }
        else { Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); }
    }

    // --- 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø³ÙƒÙˆØªØ± (Pilot) + AI + Ø§Ù„Ø£Ù…Ø§Ù† ---
    function runScooterNode() {
        aiSpeak("ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©.");
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude, speed = Math.round(pos.coords.speed*3.6)||0;
                document.getElementById('node-speed').innerText = speed;
                
                // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³Ø±Ø¹Ø© 25
                if(speed >= 25) { document.getElementById('node-gauge').style.borderColor = 'var(--neon-red)'; aiSpeak("Ø®ÙÙ Ø§Ù„Ø³Ø±Ø¹Ø©ØŒ Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±Ø©"); }
                else { document.getElementById('node-gauge').style.borderColor = 'var(--primary-blue)'; }

                // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø²ÙˆÙ† 2 ÙƒÙ…
                const dist = getDist(lat,lon,shopLoc.lat,shopLoc.lon);
                if(dist > 2000) aiSpeak("ØªØ­Ø°ÙŠØ±ØŒ Ø£Ù†Øª ØªØºØ§Ø¯Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ù…Ø§Ù†ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø©");

                db.ref('live_nodes/Y-1').update({ lat, lon, speed, outZone: dist > 2000, lastUpdate: Date.now() });
            }, null, {enableHighAccuracy:true});
        }
        // Ø­Ø³Ø§Ø³ Ø§Ù„ÙˆÙ‚ÙˆØ¹
        window.addEventListener('deviceorientation', e => {
            if(Math.abs(e.beta)>75 || Math.abs(e.gamma)>75) { db.ref('live_nodes/Y-1/fallen').set(true); beep.play(); aiSpeak("ØªØ­Ø°ÙŠØ± ØªÙ… Ø±ØµØ¯ Ø³Ù‚ÙˆØ·ØŒ Ù‡Ù„ Ø£Ù†Øª Ø¨Ø®ÙŠØ±ØŸ"); }
            else { db.ref('live_nodes/Y-1/fallen').set(false); beep.pause(); }
        });
    }

    // --- 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Rabbit Style) ---
    function initUserApp() {
        const map = L.map('user-map', {zoomControl:false, attributionControl:false}).setView([shopLoc.lat, shopLoc.lon], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        db.ref('live_nodes').on('value', s => {
            const data = s.val() || {};
            for(let id in scooterMarkers) { if(!data[id]){ map.removeLayer(scooterMarkers[id]); delete scooterMarkers[id]; }}
            for(let id in data){
                const d = data[id];
                if(d.status === 'available'){
                    if(!scooterMarkers[id]){
                        scooterMarkers[id] = L.marker([d.lat, d.lon], {icon: L.divIcon({className:'m', html:`<div style="width:45px; height:45px; background:var(--luxury-brown); border-radius:50%; border:2.5px solid var(--primary-blue); display:flex; align-items:center; justify-content:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);"><i class="fas fa-motorcycle" style="color:var(--primary-blue); font-size:18px;"></i></div>`})}).addTo(map);
                    } else { scooterMarkers[id].setLatLng([d.lat, d.lon]); }
                } else { if(scooterMarkers[id]){ map.removeLayer(scooterMarkers[id]); delete scooterMarkers[id]; }}
            }
        });

        db.ref('users/'+userPhone+'/balance').on('value', s => document.getElementById('balance-txt').innerText = (s.val()||0).toFixed(2)+" Ø¬.Ù…");
        document.getElementById('u-phone-display').innerText = userPhone;
    }

    // --- 5. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Radar) ---
    function runApp() {
        db.ref('active_trips').on('value', s => { activeTrips = s.val()||{}; renderAdminTrips(); });
        db.ref('live_nodes').on('value', s => {
            const list = document.getElementById('stock-list'); list.innerHTML = "";
            s.forEach(c => { list.innerHTML += `<div class="admin-card" style="display:flex; justify-content:space-between"><b>ğŸ›µ ${c.key}</b> <span>Ø§Ù„Ø­Ø§Ù„Ø©: ${c.val().status}</span> <button onclick="deleteScooter('${c.key}')" style="background:none; border:none; color:red;">Ø­Ø°Ù</button></div>`; });
        });
        db.ref('settings').on('value', s => { if(s.exists()){ config=s.val(); document.getElementById('set-min').value=config.min; document.getElementById('set-base').value=config.base; }});
        db.ref('shifts/current/cash').on('value', s => document.getElementById('k-cash').innerText = (s.val()||0)+" Ø¬");
    }

    function renderAdminTrips() {
        const list = document.getElementById('admin-trips-list'); list.innerHTML = "";
        for(let k in activeTrips) {
            const t = activeTrips[k], diff = Date.now() - t.start, m = Math.floor(diff/60000);
            const price = Math.max(config.base, Math.round(config.base + (m-15)*config.min));
            const card = document.createElement('div'); card.className = 'admin-card trip-radar-card'; card.id=`admin-${k}`;
            list.appendChild(card);
            db.ref('live_nodes/'+t.scooterId).on('value', snap => {
                const d = snap.val()||{};
                if(d.fallen) card.classList.add('fallen'); else card.classList.remove('fallen');
                if(d.outZone) card.classList.add('out-zone'); else card.classList.remove('out-zone');
            });
            card.innerHTML = `<div><b>ğŸ›µ ${t.scooterId}</b><br><small>${t.phone}</small></div>
            <div style="text-align:center"><b>${m} Ø¯Ù‚ÙŠÙ‚Ø©</b><br><b style="color:var(--neon-green)">${price} Ø¬</b></div>
            <button class="btn-luxury" onclick="finishTripAdmin('${k}')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>`;
        }
        document.getElementById('k-active').innerText = Object.keys(activeTrips).length;
    }

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ø®Ø²Ù†) ---
    async function finishTripAdmin(key) {
        const t = activeTrips[key], diff = Date.now() - t.start, m = Math.floor(diff/60000);
        let cost = Math.max(config.base, Math.round(config.base + (m-15)*config.min));
        const { value: res } = await Swal.fire({ title:'ØªØ­ØµÙŠÙ„ Ø­Ø³Ø§Ø¨', background: '#3E2723', color: '#fff', html:`<h1>${cost} Ø¬</h1><input id="d" class="swal2-input" placeholder="Ø§Ù„Ø®ØµÙ…"><input id="r" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨">`, preConfirm:()=>({d:document.getElementById('d').value||0, r:document.getElementById('r').value||"Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨"}) });
        if(res){
            const final = cost - parseFloat(res.d);
            db.ref('shifts/history').push({...t, final, duration:m, discount:res.d, reason:res.r, end:Date.now()});
            db.ref('shifts/current/cash').transaction(v=>(v||0)+final);
            db.ref('active_trips/'+key).remove();
            db.ref('inventory/'+t.scooterId).update({status:'available'});
            db.ref('live_nodes/'+t.scooterId).update({status:'available'});
        }
    }

    async function addScooterToStock() {
        const { value: name } = await Swal.fire({ title:'Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ±', input:'text', background: '#3E2723', color: '#fff' });
        if(name) {
            db.ref('inventory/'+name).set({status:'available', added: Date.now()});
            db.ref('live_nodes/'+name).set({lat:shopLoc.lat, lon:shopLoc.lon, status:'available', speed:0, batt:100, lastUpdate: Date.now()});
        }
    }

    function showTopup() {
        Swal.fire({ title:'Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©', background:'#3E2723', color:'#fff', html:`<p>Ø­ÙˆÙ„ Ù„Ù„Ø±Ù‚Ù…:</p><h2 style="color:var(--primary-blue)">01014004125</h2><input id="amt" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„">`, preConfirm:()=>document.getElementById('amt').value }).then(r => {
            if(r.value) db.ref('topup_requests').push({phone:userPhone, amount:r.value, status:'pending', time: Date.now()});
        });
    }

    async function openScanner() {
        const { value: scId } = await Swal.fire({ title: 'Scan to Ride', input: 'text', inputPlaceholder: 'Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±', confirmButtonColor: '#3E2723', background: '#1a1110', color: '#fff' });
        if(scId) {
            db.ref('users/'+userPhone+'/balance').once('value', s => {
                if((s.val()||0) < 40) return Swal.fire('Ø±ØµÙŠØ¯ Ø¶Ø¹ÙŠÙ', 'Ø§Ø´Ø­Ù† Ù…Ø­ÙØ¸ØªÙƒ Ø¨Ù€ 40 Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                db.ref('active_trips').push({ phone: userPhone, scooterId: scId, start: Date.now() });
                db.ref('inventory/'+scId).update({ status: 'active' });
                db.ref('live_nodes/'+scId).update({ status: 'active' });
                Swal.fire('Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©!', 'ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒÙˆØªØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
            });
        }
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function aiSpeak(t) { if('speechSynthesis' in window) { const m = new SpeechSynthesisUtterance(t); m.lang='ar-SA'; window.speechSynthesis.speak(m); } }
    function getDist(lat1, lon1, lat2, lon2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180; const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
    function toggleMenu() { const m=document.getElementById('side-menu'); const o=document.getElementById('overlay'); m.classList.toggle('open'); o.style.display=m.classList.contains('open')?'block':'none'; }
    function openPage(id) { document.getElementById('pg-'+id).style.display='flex'; toggleMenu(); }
    function closePage(id) { document.getElementById('pg-'+id).style.display='none'; }
    function adminNav(id) { document.querySelectorAll('.admin-section').forEach(s=>s.style.display='none'); document.getElementById('adm-'+id).style.display='block'; }
    function saveConfig() { db.ref('settings').set({ min: parseFloat(document.getElementById('set-min').value), base: parseFloat(document.getElementById('set-base').value) }); }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
