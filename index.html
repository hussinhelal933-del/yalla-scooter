<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN OS | TRANSPARENT SYSTEM</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Orbitron:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --neon: #00f2ff; --bg: #05050a; --card: #0c0c1b; --success: #00ff88; --danger: #ff0044; }
        body { background: var(--bg); color: #fff; font-family: 'Cairo', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù„ÙˆÙŠØ© Ù…ÙƒØ´ÙˆÙØ© Ù„Ù„Ø£Ø±Ù‚Ø§Ù… */
        .dashboard-header { 
            background: #000; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            padding: 15px; 
            border-bottom: 2px solid var(--neon);
            gap: 10px;
        }
        .stat-item { background: #111; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #222; }
        .stat-label { font-size: 10px; color: #888; display: block; }
        .stat-value { font-family: 'Orbitron'; color: var(--success); font-size: 1.2rem; }

        .content { height: calc(100vh - 160px); overflow-y: auto; padding: 15px; }
        
        #map { height: 250px; border-radius: 15px; border: 1px solid var(--neon); margin-bottom: 15px; }
        
        .action-btn { 
            background: linear-gradient(45deg, #7000ff, var(--neon)); 
            color: #000; font-weight: 900; padding: 18px; border-radius: 15px; 
            border: none; width: 100%; cursor: pointer; font-size: 18px; margin-bottom: 20px;
        }

        .trip-card { 
            background: var(--card); padding: 15px; border-radius: 15px; 
            margin-bottom: 10px; display: flex; justify-content: space-between; 
            align-items: center; border-right: 4px solid var(--neon);
        }

        .admin-controls { 
            background: rgba(255, 255, 255, 0.05); 
            padding: 15px; border-radius: 15px; margin-top: 20px; 
            border: 1px dashed #444;
        }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 2px solid var(--neon); }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div class="stat-item">
            <span class="stat-label">Ø®Ø²ÙŠÙ†Ø© Ø§Ù„ÙŠÙˆÙ…</span>
            <div id="vault-total" class="stat-value">0.00 Ø¬</div>
        </div>
        <div class="stat-item">
            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span>
            <div id="trips-count" class="stat-value" style="color:var(--neon)">0</div>
        </div>
    </div>

    <div class="content">
        <div id="map"></div>

        <button class="action-btn" onclick="startNewTrip()">
            <i class="fas fa-camera"></i> ÙØªØ­ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù‡ÙˆÙŠØ©)
        </button>

        <h3 style="color:var(--neon); font-size: 14px;"><i class="fas fa-play-circle"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
        <div id="live-list"></div>

        <div class="admin-controls">
            <h4 style="margin-top:0; font-size:12px; color:#888;">Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h4>
            <div style="display: flex; gap: 10px;">
                <button onclick="clearShift()" style="flex:1; background:var(--success); color:#000; border:none; padding:10px; border-radius:8px; font-weight:bold;">ØªØµÙÙŠØ± Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
                <button onclick="addToBlacklist()" style="flex:1; background:var(--danger); color:#fff; border:none; padding:10px; border-radius:8px; font-weight:bold;">Ø­Ø¸Ø± Ø¹Ù…ÙŠÙ„</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div onclick="location.reload()" style="color:var(--neon)"><i class="fas fa-sync-alt"></i></div>
        <div onclick="sendSmsReport()"><i class="fas fa-file-invoice-dollar"></i></div>
        <div onclick="reportFix()"><i class="fas fa-tools"></i></div>
    </div>

<script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    const CONFIG = {
        TG: { token: "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs", chat: "5684905593" },
        GEO: { lat: 30.0444, lon: 31.2357, r: 1600 }
    };

    firebase.initializeApp({
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        storageBucket: "yalla-scooter-pro.appspot.com"
    });
    const db = firebase.database();
    const storage = firebase.storage();

    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ---
    let map;
    function init() {
        map = L.map('map', {zoomControl: false}).setView([CONFIG.GEO.lat, CONFIG.GEO.lon], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©
        db.ref('vault_total').on('value', s => document.getElementById('vault-total').innerText = (s.val() || 0).toFixed(2) + " Ø¬");
        db.ref('active_trips').on('value', s => {
            const data = s.val() || {};
            render(data);
            document.getElementById('trips-count').innerText = Object.keys(data).length;
        });
    }

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ---
    async function startNewTrip() {
        const { value: file } = await Swal.fire({ title: 'ØµÙˆØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©', input: 'file', inputAttributes: {'accept': 'image/*', 'capture': 'camera'} });
        if(!file) return;
        
        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', didOpen: () => Swal.showLoading() });
        const url = await upload(file);
        
        const { value: form } = await Swal.fire({
            title: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„',
            html: '<input id="sc" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±"><input id="ph" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">',
            preConfirm: () => ({ sc: document.getElementById('sc').value, ph: document.getElementById('ph').value })
        });

        if(form && form.sc) {
            const time = new Date().toLocaleTimeString('ar-EG');
            db.ref('active_trips').push({ sc: form.sc, ph: form.ph, pic: url, start: Date.now(), t: time });
            sendTG(`ğŸš€ *Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª*\nğŸ›µ Ø³ÙƒÙˆØªØ±: ${form.sc}\nğŸ“± Ù‡Ø§ØªÙ: ${form.ph}\nâ° Ø§Ù„ÙˆÙ‚Øª: ${time}\nğŸ†” [ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©](${url})`);
        }
    }

    function render(data) {
        const list = document.getElementById('live-list');
        list.innerHTML = "";
        for(let key in data) {
            const t = data[key];
            const mins = Math.floor((Date.now() - t.start)/60000);
            list.innerHTML += `
                <div class="trip-card">
                    <div><b>ğŸ›µ ${t.sc}</b><br><small>${t.ph}</small></div>
                    <div style="font-family:'Orbitron'; color:var(--neon)">${mins}m</div>
                    <button style="background:var(--neon); border:none; padding:8px; border-radius:5px; font-weight:bold;" onclick="endTrip('${key}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
                </div>`;
        }
    }

    async function endTrip(key) {
        const snap = await db.ref('active_trips/' + key).once('value');
        const t = snap.val();
        const mins = Math.max(1, Math.ceil((Date.now() - t.start)/60000));
        let cost = 40; if(mins > 15) cost += (mins-15) * 2.66; cost = Math.round(cost);

        const { isConfirmed } = await Swal.fire({ title: 'ØªØ­ØµÙŠÙ„', html: `Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬`, showCancelButton: true });
        if(isConfirmed) {
            await db.ref('vault_total').transaction(v => (v||0) + cost);
            await db.ref('active_trips/' + key).remove();
            sendTG(`ğŸ’° *ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„*\nğŸ›µ Ø³ÙƒÙˆØªØ±: ${t.sc}\nğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬\nâ± Ø§Ù„Ù…Ø¯Ø©: ${mins} Ø¯`);
        }
    }

    // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
    async function clearShift() {
        const v = document.getElementById('vault-total').innerText;
        const { isConfirmed } = await Swal.fire({ title: 'ØªØµÙÙŠØ±ØŸ', text: `Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº ${v}`, showCancelButton: true });
        if(isConfirmed) {
            sendTG(`ğŸ“¦ *ØªÙ‚Ø±ÙŠØ± ÙˆØ±Ø¯ÙŠØ©*\nğŸ’° ØªÙ… ØªØµÙÙŠØ± Ù…Ø¨Ù„Øº: ${v}`);
            db.ref('vault_total').set(0);
        }
    }

    async function addToBlacklist() {
        const { value: ph } = await Swal.fire({ title: 'Ø±Ù‚Ù… Ù„Ù„Ø­Ø¸Ø±', input: 'text' });
        if(ph) db.ref('blacklist/' + ph).set(true);
    }

    // --- Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    async function upload(f) { const ref = storage.ref(`ids/${Date.now()}.jpg`); await ref.put(f); return await ref.getDownloadURL(); }
    function sendTG(m) { fetch(`https://api.telegram.org/bot${CONFIG.TG.token}/sendMessage`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({chat_id:CONFIG.TG.chat, text:m, parse_mode:"Markdown"}) }); }

    init();
</script>
</body>
</html>
