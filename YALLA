<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter Master v17</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --p: #00d2ff; --s: #3a7bd5; --d: #060912;
            --ok: #00f2fe; --err: #ff4b2b; --wait: #f9d423;
            --glass: rgba(255, 255, 255, 0.05);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; }
        body { background: var(--d); color: #fff; min-height: 100vh; background-image: radial-gradient(circle at 50% 0%, #1a2a44 0%, #060912 85%); }
        .hidden { display: none !important; }
        .container { max-width: 1550px; margin: 0 auto; padding: 20px; }
        
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-box { background: var(--glass); padding: 20px; border-radius: 15px; text-align: center; border-bottom: 3px solid var(--p); }
        .stat-box b { display: block; font-size: 24px; font-family: 'Orbitron'; color: var(--p); }

        input, select { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; width: 100%; margin-bottom: 10px; }
        .btn { border: none; border-radius: 10px; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: linear-gradient(45deg, var(--p), var(--s)); }
        .btn-err { background: var(--err); }
        .btn-sec { background: rgba(255,255,255,0.1); }

        .scooter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .trip-card { background: linear-gradient(145deg, #111b2d, #060912); border-radius: 25px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .timer { font-family: 'Orbitron'; font-size: 38px; text-align: center; margin: 15px 0; color: var(--ok); }

        #camera-preview { width: 100%; height: 180px; background: #000; border-radius: 10px; object-fit: cover; margin-bottom: 10px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: #0f172a; border: 2px solid var(--p); padding: 30px; border-radius: 30px; width: 450px; }
    </style>
</head>
<body>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ -->
    <div id="finishModal" class="modal">
        <div class="modal-content">
            <h2 id="finScooter" style="text-align:center; color:var(--p); font-family:'Orbitron'">S-01</h2>
            <div id="issueBox" class="hidden" style="border: 1px solid var(--err); padding: 15px; border-radius: 15px; margin: 15px 0;">
                <p style="color:var(--err)">ğŸš¨ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø·Ù„ Ø£Ùˆ Ø®ØµÙ…</p>
                <input type="text" id="issueReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø·Ù„">
                <input type="number" id="issueDisc" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…">
            </div>
            <div style="padding: 15px 0; border-top: 1px dashed #333;">
                <div style="display:flex; justify-content:space-between"><span>Ø§Ù„Ù…Ø¯Ø©:</span><b id="finMins">0 Ø¯Ù‚ÙŠÙ‚Ø©</b></div>
                <div style="display:flex; justify-content:space-between; color:var(--ok); font-size:22px; margin-top:10px"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (2.50Ø¬/Ø¯):</span><b id="finTotal">0</b></div>
            </div>
            <button class="btn btn-p" onclick="App.confirmFinish()">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø­Ù„Ø© âœ…</button>
            <button class="btn" onclick="App.closeModal()" style="background:none; margin-top:10px">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen" class="modal" style="display:flex">
        <div class="modal-content" style="text-align:center">
            <h1 style="font-family:'Orbitron'">YALLA MASTER</h1>
            <input type="password" id="pass" placeholder="Password" style="text-align:center; font-size:22px; letter-spacing: 5px;">
            <button class="btn btn-p" onclick="App.login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="app-screen" class="container hidden">
        <div class="stat-grid">
            <div class="stat-box"><span>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</span><b id="dayCash">0</b></div>
            <div class="stat-box admin-only"><span>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±</span><b id="monthCash">0</b></div>
            <div class="stat-box"><span>Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span><b id="activeCount">0</b></div>
            <div class="stat-box"><span>Ø±Ø­Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span><b id="tripCount">0</b></div>
        </div>

        <div class="main-layout">
            <div class="sidebar">
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ø§Ù„ -->
                <div class="card">
                    <button class="btn btn-sec" onclick="App.attendance()" style="margin-bottom:15px">
                        <i class="fas fa-clock"></i> ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± (GPS)
                    </button>
                    <h4 style="color:var(--p); margin-bottom:10px">Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø©</h4>
                    <input type="text" id="cust-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="App.checkCustomer(this.value)">
                    <input type="text" id="cust-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    <input type="text" id="scoot-id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±">
                    
                    <video id="camera-preview" autoplay playsinline></video>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                    <button class="btn btn-sec" onclick="App.takePhoto()" style="margin-bottom:10px">ğŸ“¸ ØªØµÙˆÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                    <img id="id-final" style="width:100%; border-radius:10px; margin-bottom:10px" class="hidden">

                    <button class="btn btn-p" onclick="App.startTrip()">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš€</button>
                    <button class="btn btn-err" style="margin-top:10px" onclick="App.closeShift()">ØªÙ‚ÙÙŠÙ„ Ø§Ù„Ø´ÙØª ğŸ”’</button>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
                <div class="card admin-only">
                    <h4 style="color:var(--wait); margin-bottom:10px">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ (Master)</h4>
                    <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙƒÙˆØªØ±..." oninput="App.analyzeScooter(this.value)">
                    <div id="scoot-analysis" style="font-size:12px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
                    <hr style="opacity:0.1; margin:15px 0;">
                    <input type="date" id="historyDate" onchange="App.loadHistory()">
                    <div id="logBody" style="max-height:200px; overflow-y:auto; font-size:11px"></div>
                </div>
            </div>

            <div id="trips-list" class="scooter-grid"></div>
        </div>
    </div>

<script>
    const TG_TOKEN = "7899750780:AAFL31roDUbqFDoP-iUL2dhNn4GtKFAPUD0"; 
    const TG_CHAT_IDS = ["5684905593", "1089983199"];
    const TARGET_LAT = 30.1430; // 55RM+QM ØªÙ‚Ø±ÙŠØ¨Ø§
    const TARGET_LON = 31.4060;

    const firebaseConfig = {
        apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
        authDomain: "yalla-scooter-pro.firebaseapp.com",
        databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
        projectId: "yalla-scooter-pro",
        storageBucket: "yalla-scooter-pro.firebasestorage.app",
        messagingSenderId: "185791475252",
        appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRole = "staff";
    let capturedPhoto = "";

    const App = {
        sendTG: (msg) => {
            TG_CHAT_IDS.forEach(id => {
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${id}&text=${encodeURIComponent(msg)}`);
            });
        },

        login: function() {
            const p = document.getElementById('pass').value;
            if(p === "9924") {
                currentRole = "admin";
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            } else if(p === "1234") {
                currentRole = "staff";
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            } else return alert("Ø®Ø·Ø£!");

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').classList.remove('hidden');
            this.init();
        },

        init: function() {
            this.initCamera();
            this.syncTrips();
            this.loadStats();
            this.loadHistory();
            setInterval(() => this.updateTimers(), 1000);
        },

        initCamera: async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('camera-preview').srcObject = stream;
            } catch(e) { console.log("Camera error"); }
        },

        takePhoto: function() {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('photo-canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.5);
            document.getElementById('id-final').src = capturedPhoto;
            document.getElementById('id-final').classList.remove('hidden');
        },

        attendance: function() {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = this.getDist(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LON);
                if(dist > 0.6) return alert("Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„!");
                const today = new Date().toLocaleDateString('en-CA');
                db.ref(`attendance/${today}`).push({ role: currentRole, time: new Date().toLocaleTimeString() });
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± âœ…");
            }, () => alert("ÙØ¹Ù„ GPS Ø£ÙˆÙ„Ø§Ù‹"));
        },

        getDist: (l1, n1, l2, n2) => {
            const R = 6371;
            const dLat = (l2-l1) * Math.PI / 180;
            const dLon = (n2-n1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        },

        checkCustomer: function(ph) {
            if(ph.length >= 11) {
                db.ref(`customers/${ph}`).once('value', snap => {
                    if(snap.val()) {
                        document.getElementById('cust-name').value = snap.val().name;
                        if(snap.val().photo) {
                            document.getElementById('id-final').src = snap.val().photo;
                            document.getElementById('id-final').classList.remove('hidden');
                            capturedPhoto = snap.val().photo;
                        }
                    }
                });
            }
        },

        startTrip: async function() {
            const ph = document.getElementById('cust-phone').value;
            const name = document.getElementById('cust-name').value;
            const sid = document.getElementById('scoot-id').value.toUpperCase();
            if(!ph || !sid) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

            await db.ref(`customers/${ph}`).update({ name, photo: capturedPhoto });
            await db.ref('ongoing').push({ ph, name, scoot: sid, start: Date.now() });
            
            App.sendTG(`ğŸš€ Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${sid}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}`);
            location.reload(); // Ù„ØªØµÙÙŠØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„
        },

        syncTrips: function() {
            db.ref('ongoing').on('value', snap => {
                const list = document.getElementById('trips-list');
                list.innerHTML = "";
                if(snap.val()) {
                    document.getElementById('activeCount').innerText = Object.keys(snap.val()).length;
                    Object.entries(snap.val()).forEach(([id, t]) => {
                        list.innerHTML += `
                            <div class="trip-card">
                                <h2 style="color:var(--p)">${t.scoot}</h2>
                                <p style="font-size:12px; opacity:0.6">${t.name}</p>
                                <div class="timer" id="timer-${id}">00:00</div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                                    <button class="btn btn-p" onclick="App.openInv('${id}', false)">Ø¥Ù†Ù‡Ø§Ø¡</button>
                                    <button class="btn btn-err" onclick="App.openInv('${id}', true)">Ø¹Ø·Ù„</button>
                                </div>
                            </div>`;
                    });
                } else document.getElementById('activeCount').innerText = 0;
            });
        },

        updateTimers: function() {
            db.ref('ongoing').once('value', snap => {
                if(snap.val()) Object.entries(snap.val()).forEach(([id, t]) => {
                    let diff = Date.now() - t.start;
                    let m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
                    const el = document.getElementById(`timer-${id}`);
                    if(el) el.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                });
            });
        },

        openInv: function(id, isErr) {
            this.curId = id; this.curErr = isErr;
            db.ref(`ongoing/${id}`).once('value', snap => {
                const t = snap.val();
                const mins = Math.max(1, Math.ceil((Date.now() - t.start)/60000));
                document.getElementById('finScooter').innerText = t.scoot;
                document.getElementById('finMins').innerText = mins + " Ø¯Ù‚ÙŠÙ‚Ø©";
                document.getElementById('finTotal').innerText = (mins * 2.5).toFixed(2) + " Ø¬.Ù…";
                document.getElementById('issueBox').className = isErr ? "" : "hidden";
                document.getElementById('finishModal').style.display = 'flex';
            });
        },

        confirmFinish: function() {
            const mins = parseInt(document.getElementById('finMins').innerText);
            let disc = parseFloat(document.getElementById('issueDisc').value) || 0;
            const cost = Math.max(0, (mins * 2.5) - disc);

            db.ref(`ongoing/${this.curId}`).once('value', async snap => {
                const t = snap.val();
                const day = new Date().toLocaleDateString('en-CA');
                await db.ref(`history/${day}`).push({ ...t, mins, cost, timestamp: Date.now(), reason: this.curErr ? document.getElementById('issueReason').value : "Ø³Ù„ÙŠÙ…" });
                
                if(this.curErr) {
                    db.ref(`malfunctions/${t.scoot}`).transaction(c => {
                        if((c||0)+1 >= 3) App.sendTG(`ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø³ÙƒÙˆØªØ± ${t.scoot} Ø³Ø¬Ù„ 3 Ø£Ø¹Ø·Ø§Ù„!`);
                        return (c||0)+1;
                    });
                }

                await db.ref(`ongoing/${this.curId}`).remove();
                App.sendTG(`âœ… Ø±Ø­Ù„Ø© Ù…Ù†ØªÙ‡ÙŠØ©\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${t.scoot}\nØ§Ù„Ù…Ø¨Ù„Øº: ${cost} Ø¬.Ù…`);
                this.closeModal();
            });
        },

        closeShift: function() {
            if(!confirm("ØªÙ‚ÙÙŠÙ„ Ø§Ù„Ø´ÙØªØŸ")) return;
            const day = new Date().toLocaleDateString('en-CA');
            db.ref(`history/${day}`).once('value', snap => {
                let sum = 0; if(snap.val()) Object.values(snap.val()).forEach(t => sum += t.cost);
                App.sendTG(`ğŸ”’ ØªÙ‚ÙÙŠÙ„ Ø´ÙØª\nØ¨ÙˆØ§Ø³Ø·Ø©: ${currentRole}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${sum} Ø¬.Ù…`);
                alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©");
            });
        },

        analyzeScooter: function(val) {
            if(!val) return;
            const name = val.toUpperCase();
            db.ref('history').once('value', snap => {
                let c = 0, m = 0, t = 0;
                if(snap.val()) Object.values(snap.val()).forEach(day => Object.values(day).forEach(trip => {
                    if(trip.scoot === name) { c++; m += trip.cost; t += trip.mins; }
                }));
                document.getElementById('scoot-analysis').innerHTML = `Ø§Ù„Ø³ÙƒÙˆØªØ±: ${name}<br>Ø§Ù„Ø±Ø­Ù„Ø§Øª: ${c}<br>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯: ${m.toFixed(2)}Ø¬<br>Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚: ${t}`;
            });
        },

        loadStats: function() {
            const day = new Date().toLocaleDateString('en-CA');
            db.ref(`history/${day}`).on('value', snap => {
                let cash = 0, count = 0;
                if(snap.val()) Object.values(snap.val()).forEach(t => { cash += t.cost; count++; });
                document.getElementById('dayCash').innerText = cash.toFixed(2);
                document.getElementById('tripCount').innerText = count;
            });
            db.ref('history').on('value', snap => {
                let month = 0; const m = day.substring(0,7);
                if(snap.val()) Object.entries(snap.val()).forEach(([d,v]) => {
                    if(d.startsWith(m)) Object.values(v).forEach(t => month += t.cost);
                });
                document.getElementById('monthCash').innerText = month.toFixed(2);
            });
        },

        loadHistory: function() {
            const d = document.getElementById('historyDate').value || new Date().toLocaleDateString('en-CA');
            db.ref(`history/${d}`).on('value', snap => {
                const b = document.getElementById('logBody'); b.innerHTML = "";
                if(snap.val()) Object.values(snap.val()).reverse().forEach(t => {
                    b.innerHTML += `<div style="border-bottom:1px solid #222; padding:5px">${t.scoot} | ${t.cost}Ø¬ | ${t.reason}</div>`;
                });
            });
        },

        closeModal: () => document.getElementById('finishModal').style.display = 'none'
    };
</script>
</body>
</html>
