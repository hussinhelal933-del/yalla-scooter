<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Fleet Dashboard | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>
    
    <!-- Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --adm-dark: #0f0a09; --adm-brown: #3E2723; --adm-blue: #00d2ff;
            --success: #34c759; --danger: #ff3b30; --warn: #ff9500;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { background: var(--adm-dark); color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 280px; background: #000; border-left: 2px solid #222; display: flex; flex-direction: column; padding: 30px; }
        .logo { font-family: 'Orbitron'; font-size: 26px; color: var(--adm-blue); text-align: center; margin-bottom: 50px; letter-spacing: 3px; }
        .nav-item { padding: 18px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #555; font-weight: bold; margin-bottom: 10px; }
        .nav-item.active { background: rgba(0,210,255,0.1); color: var(--adm-blue); border-right: 5px solid var(--adm-blue); }

        /* --- Main Area --- */
        .main { flex: 1; overflow-y: auto; padding: 40px; background: radial-gradient(circle at top right, #1a1110, #000); }
        .admin-card { background: var(--adm-brown); border-radius: 25px; padding: 25px; margin-bottom: 25px; border: 1.5px solid rgba(0,210,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* --- Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Devices List) --- */
        .device-table { width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.3); border-radius: 20px; overflow: hidden; margin-top: 20px; }
        .device-table th { background: #1a1e2a; padding: 20px; text-align: right; color: #777; font-size: 13px; }
        .device-table td { padding: 20px; border-bottom: 1px solid #1a1e2a; font-size: 14px; font-weight: bold; }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© */
        .batt-bar-container { width: 100px; height: 10px; background: #111; border-radius: 10px; overflow: hidden; display: inline-block; vertical-align: middle; border: 1px solid #333; }
        .batt-fill { height: 100%; transition: 1s; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-ops { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .btn-blue { background: var(--adm-blue); color: #000; }
        .btn-danger { background: rgba(255,59,48,0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .online-glow { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .offline-glow { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

        #fleet-map { height: 400px; width: 100%; border-radius: 25px; border: 2px solid #222; margin-bottom: 30px; }
        .section { display: none; } .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">YALLA OPS</div>
        <div class="nav-item active" onclick="showSec('fleet')"><i class="fas fa-satellite"></i> Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</div>
        <div class="nav-item" onclick="showSec('trips')"><i class="fas fa-bolt"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</div>
        <div class="nav-item" onclick="showSec('users')"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav-item" onclick="location.href='index.html'"><i class="fas fa-eye"></i> ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        <div class="nav-item" onclick="logout()" style="margin-top:auto; color:red;"><i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬</div>
    </nav>

    <main class="main">
        <!-- Ù‚Ø³Ù… Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) -->
        <div id="sec-fleet" class="section active">
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„Ø£Ø³Ø·ÙˆÙ„ (ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ)</h2>
                <button class="btn-ops btn-blue" onclick="addNewScooter()">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯</button>
            </header>

            <div id="fleet-map"></div>

            <div class="admin-card">
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                            <th>Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</th>
                            <th>Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…</th>
                        </tr>
                    </thead>
                    <tbody id="device-list-body">
                        <!-- ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ (Ù…Ø®Ø¯ÙˆÙ…Ø© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª) -->
        <div id="sec-trips" class="section"><h2>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</h2><div id="trips-monitor"></div></div>
        <div id="sec-users" class="section"><h2>Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2><div id="users-db"></div></div>
    </main>

<script>
    // --- Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Firebase ---
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let fleetMap, markers = {};

    window.onload = () => {
        initFleetRadar();
        listenToDevices();
    };

    // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)
    function initFleetRadar() {
        fleetMap = L.map('fleet-map', { zoomControl: false }).setView([30.0444, 31.2357], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(fleetMap);
    }

    // 2. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù„Ø­Ø¸ÙŠØ§Ù‹ (The Heart of Fleet Management)
    function listenToDevices() {
        db.ref('live_nodes').on('value', snap => {
            const body = document.getElementById('device-list-body');
            body.innerHTML = "";
            
            snap.forEach(child => {
                const sc = child.val();
                const id = child.key;
                
                // ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø² "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" (Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø© Ù…Ù† Ø£Ù‚Ù„ Ù…Ù† 20 Ø«Ø§Ù†ÙŠØ©)
                const isOnline = (Date.now() - sc.lastUpdate < 20000);
                const battColor = sc.batt > 50 ? 'var(--success)' : (sc.batt > 20 ? 'var(--warn)' : 'var(--danger)');

                body.innerHTML += `
                    <tr>
                        <td><b style="color:var(--adm-blue)">ğŸ›µ ${id}</b></td>
                        <td>
                            <div class="batt-bar-container"><div class="batt-fill" style="width:${sc.batt}%; background:${battColor}"></div></div>
                            <span style="margin-right:10px; color:${battColor}">${sc.batt}%</span>
                        </td>
                        <td><span style="font-family:Orbitron">${sc.speed}</span> <small>ÙƒÙ…/Ø³</small></td>
                        <td>
                            <span class="status-dot ${isOnline ? 'online-glow' : 'offline-glow'}"></span>
                            <span style="color:${isOnline ? '#fff' : '#555'}">${isOnline ? 'Ù…ØªØµÙ„' : 'Ø£ÙˆÙÙ„Ø§ÙŠÙ†'}</span>
                        </td>
                        <td style="display:flex; gap:10px;">
                            <button class="btn-ops btn-blue" onclick="focusDevice('${id}', ${sc.lat}, ${sc.lon})"><i class="fas fa-map-marker-alt"></i></button>
                            <button class="btn-ops btn-danger" onclick="emergencyLock('${id}')"><i class="fas fa-lock"></i> ÙØµÙ„</button>
                        </td>
                    </tr>
                `;
                
                updateMarkerOnMap(id, sc, isOnline);
            });
        });
    }

    // 3. ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function updateMarkerOnMap(id, data, online) {
        const color = online ? (data.status === 'active' ? '#0066ff' : '#00ff9d') : '#555';
        if(markers[id]) {
            markers[id].setLatLng([data.lat, data.lon]).setStyle({color: color});
        } else {
            markers[id] = L.circleMarker([data.lat, data.lon], {radius: 8, color: color, fillOpacity: 1}).addTo(fleetMap).bindPopup("Ø³ÙƒÙˆØªØ±: " + id);
        }
    }

    function focusDevice(id, lat, lon) {
        fleetMap.flyTo([lat, lon], 18);
        markers[id].openPopup();
    }

    // 4. Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ± Ù„Ù„Ù…Ø®Ø²Ù† (ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø¹Ù…ÙŠÙ„)
    async function addNewScooter() {
        const { value: name } = await Swal.fire({ 
            title: 'Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ± Ø¬Ø¯ÙŠØ¯', 
            input: 'text', 
            inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² (Ù…Ø«Ù„Ø§Ù‹ Scooter-50)',
            background: '#0b0e14', color: '#fff'
        });
        if(name) {
            db.ref('live_nodes/' + name).set({
                lat: 30.0444, lon: 31.2357, batt: 100, speed: 0, status: 'available', lastUpdate: Date.now()
            });
            db.ref('inventory/' + name).set({ status: 'available', lastService: Date.now() });
            Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ¥ØªØ§Ø­ØªÙ‡ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡', 'success');
        }
    }

    function emergencyLock(id) {
        Swal.fire({ title: 'Ù‚ÙÙ„ Ø·ÙˆØ§Ø±Ø¦ØŸ', text: 'Ø³ÙŠØªÙ… ÙØµÙ„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø¹Ù† Ø§Ù„Ø³ÙƒÙˆØªØ± ÙÙˆØ±Ø§Ù‹', icon: 'warning', showCancelButton: true }).then(r => {
            if(r.isConfirmed) db.ref('commands/' + id).set({ cmd: 'LOCK', time: Date.now() });
        });
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function logout() { location.reload(); }
</script>
</body>
</html>
