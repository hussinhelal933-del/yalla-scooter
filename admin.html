<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Ops | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©</title>
    
    <!-- Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠØ© -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --adm-dark: #0f0a09; --adm-brown: #3E2723; --adm-blue: #00d2ff;
            --success: #34c759; --danger: #ff3b30; --text: #ffffff;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--adm-dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 300px; background: #000; border-left: 2px solid #222; display: flex; flex-direction: column; padding: 30px; }
        .logo { font-family: 'Orbitron'; font-size: 30px; color: var(--adm-blue); text-align: center; margin-bottom: 50px; letter-spacing: 5px; }
        .nav-item { padding: 18px; border-radius: 15px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #555; font-weight: bold; margin-bottom: 10px; transition: 0.3s; }
        .nav-item.active { background: rgba(0,210,255,0.1); color: var(--adm-blue); border-right: 5px solid var(--adm-blue); }

        /* --- Content Area --- */
        .main { flex: 1; overflow-y: auto; padding: 40px; }
        .admin-card { background: var(--adm-brown); border-radius: 25px; padding: 25px; margin-bottom: 25px; border: 1.5px solid rgba(0,210,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .kpi { font-family: 'Orbitron'; font-size: 40px; color: var(--adm-blue); }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª (Reply System) --- */
        .chat-list-item { background: #1a1a1a; padding: 15px; border-radius: 15px; cursor: pointer; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .chat-list-item:hover { border: 1px solid var(--adm-blue); }
        .badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 50%; font-size: 12px; }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .btn-adm { padding: 12px 25px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; }
        .btn-blue { background: var(--adm-blue); color: #000; }
        .btn-green { background: var(--success); color: #000; }
        
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        
        #admin-map { height: 450px; width: 100%; border-radius: 25px; border: 2px solid #222; }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <nav class="sidebar">
        <div class="logo">YALLA</div>
        <div class="nav-item active" onclick="showSec('overview')"><i class="fas fa-bolt"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ©</div>
        <div class="nav-item" onclick="showSec('support')"><i class="fas fa-comments"></i> Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù… <span id="msg-count" class="badge" style="display:none">0</span></div>
        <div class="nav-item" onclick="showSec('users')"><i class="fas fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø´Ø­Ù†</div>
        <div class="nav-item" onclick="showSec('fleet')"><i class="fas fa-motorcycle"></i> Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø²Ù†</div>
        <div class="nav-item" onclick="showSec('settings')"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
    </nav>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="main">
        <!-- 1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ø±Ø­Ù„Ø§Øª -->
        <div id="sec-overview" class="section active">
            <div style="display:flex; gap:25px; margin-bottom:30px;">
                <div class="admin-card" style="flex:1">Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù† <div class="kpi" id="k-active">0</div></div>
                <div class="admin-card" style="flex:1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© <div class="kpi" id="k-cash" style="color:var(--success)">0 Ø¬</div></div>
            </div>
            <div id="live-trips-monitor"></div>
        </div>

        <!-- 2. Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù… (Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) -->
        <div id="sec-support" class="section">
            <h2>Ø´Ø§Øª Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
            <p style="color:#666">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„ØªÙ‡</p>
            <div id="support-list"></div>
        </div>

        <!-- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù„Ø­Ø¸ÙŠ) -->
        <div id="sec-users" class="section">
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
            <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." id="userSearch" oninput="searchInUsers(this.value)" style="width:100%; padding:15px; background:#000; color:white; border:1px solid #333; border-radius:15px; margin-bottom:20px;">
            <div id="admin-user-list"></div>
        </div>

        <!-- 4. Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø²Ù† -->
        <div id="sec-fleet" class="section">
            <div id="admin-map"></div>
            <button class="btn-adm btn-blue" style="width:100%; margin:20px 0;" onclick="addScooter()">+ Ø¥Ø¶Ø§ÙØ© Ø³ÙƒÙˆØªØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</button>
            <div id="admin-stock-list"></div>
        </div>

        <!-- 5. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="sec-settings" class="section">
            <div class="admin-card">
                <h3>ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ø±ÙŠÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                <label>Ø³Ø¹Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©:</label>
                <input type="number" id="set-min" style="width:100%; padding:15px; background:#000; color:var(--adm-blue); border:1px solid #333; margin:10px 0;">
                <label>ÙØªØ­Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ø£ÙˆÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©):</label>
                <input type="number" id="set-base" style="width:100%; padding:15px; background:#000; color:var(--adm-blue); border:1px solid #333; margin:10px 0;">
                <button class="btn-adm btn-green" style="width:100%; margin-top:20px;" onclick="saveSettings()">Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        </div>
    </main>

<script>
    // --- Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ) ---
    const firebaseConfig = { databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let adminMap, markers = {};

    window.onload = () => {
        initAdminEngine();
    };

    function initAdminEngine() {
        // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø­ÙŠØ©
        db.ref('active_trips').on('value', s => {
            const list = document.getElementById('live-trips-monitor'); list.innerHTML = "";
            let count = 0;
            s.forEach(c => {
                count++; const t = c.val();
                const m = Math.floor((Date.now() - t.start) / 60000);
                list.innerHTML += `
                    <div class="admin-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>ğŸ›µ ${t.scooterId}</b><br><small>Ø¹Ù…ÙŠÙ„: ${t.phone}</small></div>
                        <div style="text-align:center"><b>${m} Ø¯Ù‚ÙŠÙ‚Ø©</b><br><b style="color:var(--success)">${Math.max(40, 40+(m-15)*2.66)} Ø¬</b></div>
                        <button class="btn-adm btn-blue" onclick="forceEndRide('${c.key}', '${t.scooterId}')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ­ØµÙŠÙ„</button>
                    </div>`;
            });
            document.getElementById('k-active').innerText = count;
        });

        // 2. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø´Ø§Øª Ø§Ù„Ø¯Ø¹Ù… (ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        db.ref('support_chats').on('value', snap => {
            const list = document.getElementById('support-list'); list.innerHTML = "";
            let msgCount = 0;
            snap.forEach(c => {
                msgCount++;
                list.innerHTML += `
                    <div class="chat-list-item" onclick="openChatWithUser('${c.key}')">
                        <div><i class="fas fa-user-circle"></i> <b>Ø¹Ù…ÙŠÙ„: ${c.key}</b></div>
                        <span class="badge">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </div>`;
            });
            document.getElementById('msg-count').innerText = msgCount;
            document.getElementById('msg-count').style.display = msgCount > 0 ? 'inline' : 'none';
        });

        // 3. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        db.ref('users').on('value', snap => {
            const list = document.getElementById('admin-user-list'); list.innerHTML = "";
            snap.forEach(u => {
                const data = u.val();
                list.innerHTML += `
                    <div class="admin-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>ğŸ‘¤ ${u.key}</b><br><small>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${data.balance || 0} Ø¬</small></div>
                        <button class="btn-adm btn-green" onclick="rechargeUser('${u.key}')">+ Ø´Ø­Ù† Ø±ØµÙŠØ¯</button>
                    </div>`;
            });
        });

        // 4. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø®Ø²ÙŠÙ†Ø©
        db.ref('shifts/current/cash').on('value', s => document.getElementById('k-cash').innerText = (s.val()||0) + " Ø¬");
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø´Ø§Øª Ø¨Ø´Ø±ÙŠ) ---
    async function openChatWithUser(phone) {
        const { value: reply } = await Swal.fire({
            title: `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ ${phone}`,
            input: 'textarea',
            inputPlaceholder: 'Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§ Ù„Ø¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹...',
            showCancelButton: true,
            confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯'
        });
        if(reply) {
            db.ref('support_chats/' + phone + '/messages').push({
                text: reply, sender: 'admin', time: Date.now()
            });
            Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', '', 'success');
        }
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù„Ø­Ø¸ÙŠ (Ø§Ù„Ù…Ø­ÙØ¸Ø©) ---
    async function rechargeUser(phone) {
        const { value: amt } = await Swal.fire({ title: 'Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ù„Ø­Ø¸ÙŠ', input: 'number', inputLabel: `Ø§Ù„Ø±Ù‚Ù…: ${phone}` });
        if(amt) {
            db.ref('users/' + phone + '/balance').transaction(v => (v || 0) + parseFloat(amt));
            Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†', 'success');
        }
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø²Ù† ---
    async function addScooter() {
        const { value: name } = await Swal.fire({ title: 'Ø§Ø³Ù… Ø§Ù„Ø³ÙƒÙˆØªØ±', input: 'text' });
        if(name) db.ref('live_nodes/' + name).set({ lat: 30.0444, lon: 31.2357, status: 'available', speed: 0, batt: 100 });
    }

    function forceEndRide(key, scId) {
        Swal.fire({ title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ØŸ', icon: 'warning', showCancelButton: true }).then(r => {
            if(r.isConfirmed) {
                db.ref('active_trips/' + key).remove();
                db.ref('live_nodes/' + scId).update({ status: 'available' });
            }
        });
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function saveSettings() {
        const m = document.getElementById('set-min').value;
        const b = document.getElementById('set-base').value;
        db.ref('settings').set({ min: parseFloat(m), base: parseFloat(b) });
        Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
    }
</script>
</body>
</html>
