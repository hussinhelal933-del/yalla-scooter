<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Scooter PRO | Mega V44</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1; --bg-body: #f8fafc; --surface: #ffffff;
            --text-main: #0f172a; --success: #22c55e; --border: #e2e8f0;
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }

        /* Sidebar & Navigation */
        .sidebar { width: 280px; background: var(--dark); color: #fff; height: 100vh; position: fixed; right: 0; top: 0; padding: 30px 20px; display: flex; flex-direction: column; z-index: 1000; }
        .main-content { margin-right: 280px; width: calc(100% - 280px); padding: 20px; padding-bottom: 100px; }
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--dark); height: 70px; z-index: 5000; justify-content: space-around; align-items: center; border-radius: 20px 20px 0 0; }
        .mobile-nav-item { color: #94a3b8; text-align: center; font-size: 11px; cursor: pointer; }
        .mobile-nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .mobile-nav-item.active { color: #fff; }

        @media(max-width: 1024px) { .sidebar { display: none; } .main-content { margin-right: 0; width: 100%; } .mobile-nav { display: flex; } }

        /* Stat Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); padding: 15px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); text-align: center; }
        .stat-card h4 { font-size: 12px; color: #64748b; margin-bottom: 5px; }
        .stat-card .val { font-size: 20px; font-weight: 800; color: var(--dark); }

        /* General UI */
        .form-card { background: var(--surface); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #f8fafc; margin-bottom: 10px; font-size: 14px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-warning { background: #fffbeb; color: var(--warning); }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-card { background: #fff; padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; }
        
        #adminPanel { position: fixed; inset: 0; background: #f8fafc; z-index: 10000; display: none; padding: 20px; overflow-y: auto; padding-bottom: 80px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 15px; overflow: hidden; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #f1f5f9; font-size: 12px; }
        
        .hidden { display: none; }
        .id-preview { width: 100%; height: 150px; border-radius: 12px; object-fit: cover; margin-bottom: 10px; display: none; border: 2px dashed var(--primary); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="login-screen" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"><i class="fas fa-lock"></i></div>
            <h2 style="margin-bottom: 20px;">ÙŠØ§Ù„Ø§ Ø³ÙƒÙˆØªØ± | Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ©</h2>
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (yalaa12)" style="text-align: center; font-size: 20px;">
            <button class="btn btn-primary" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Sidebar (Desktop) -->
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-bolt"></i> Yalla Scooter</div>
        <div class="nav-item active" onclick="location.reload()"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="openAttendance()" style="color:var(--success);"><i class="fas fa-clock"></i> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</div>
        <div class="nav-item" onclick="openCloseShiftModal()" style="color:var(--warning);"><i class="fas fa-cash-register"></i> ØªÙ‚ÙÙŠÙ„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</div>
        <div class="nav-item" onclick="openAdmin()" style="color:var(--warning);"><i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="nav-item" onclick="logout()" style="margin-top: auto; color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</div>
    </aside>

    <!-- Bottom Nav (Mobile) -->
    <nav class="mobile-nav">
        <div class="mobile-nav-item active" onclick="location.reload()"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="mobile-nav-item" onclick="openAttendance()"><i class="fas fa-clock"></i>Ø§Ù„Ø­Ø¶ÙˆØ±</div>
        <div class="mobile-nav-item" onclick="openCloseShiftModal()"><i class="fas fa-wallet"></i>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</div>
        <div class="mobile-nav-item" onclick="openAdmin()"><i class="fas fa-shield-alt"></i>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="mobile-nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i>Ø®Ø±ÙˆØ¬</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="appContent" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card"><h4>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</h4><div class="val" id="stat-income">0.00</div></div>
            <div class="stat-card"><h4>Ø±Ø­Ù„Ø§Øª Ù†Ø´Ø·Ø©</h4><div class="val" id="stat-active">0</div></div>
            <div class="stat-card"><h4>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h4><div class="val" id="stat-profit" style="color:var(--success);">0.00</div></div>
        </div>

        <div class="form-card">
            <h3>ØªØ£Ø¬ÙŠØ± Ø³ÙƒÙˆØªØ± Ø´Ø§ÙˆÙ…ÙŠ</h3>
            <input type="text" id="scooterID" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒÙˆØªØ± (Ù…Ø«Ù„Ø§Ù‹ S1)">
            <input type="number" id="custPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" oninput="searchCustomer(this.value)">
            <div id="debtAlert" class="hidden" style="background:#fee2e2; color:var(--danger); padding:8px; border-radius:10px; margin-bottom:10px; font-weight:800; font-size:12px;"></div>
            <img id="idPreview" class="id-preview">
            <input type="text" id="custName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <input type="file" id="custImg" accept="image/*" onchange="handleImage(this)">
            <button class="btn btn-primary" onclick="startRental()">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†</button>
        </div>

        <h3>Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</h3>
        <div id="activeTripsList" style="margin-top:15px;"></div>
    </main>

    <!-- Admin Panel -->
    <div id="adminPanel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h2>
            <button class="btn btn-danger" style="width:auto; padding:8px 15px;" onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        
        <div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:10px;">
            <button class="btn btn-primary" style="width:auto; font-size:11px;" onclick="showTab('security')">ğŸ›‘ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© (Live)</button>
            <button class="btn btn-primary" style="width:auto; font-size:11px;" onclick="showTab('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
            <button class="btn btn-primary" style="width:auto; font-size:11px;" onclick="showTab('finance')">ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
            <button class="btn btn-primary" style="width:auto; font-size:11px;" onclick="showTab('scooters')">ğŸ›µ Ø§Ù„Ø³ÙƒÙˆØªØ±Ø§Øª</button>
        </div>

        <!-- Tab: Security & Kicking -->
        <div id="tab-security" class="hidden">
            <h3>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø³ÙŠØ³ØªÙ…</h3>
            <table id="onlineStaffTable">
                <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="onlineStaffBody"></tbody>
            </table>
            <h3 style="margin-top:30px;">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
            <table id="bannedTable">
                <thead><tr><th>ID Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="bannedBody"></tbody>
            </table>
        </div>

        <!-- Tab: Expenses -->
        <div id="tab-expenses" class="hidden">
            <div class="form-card">
                <h4>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ§Ø±ÙŠÙ</h4>
                <input type="text" id="expReason" placeholder="Ø§Ù„Ø³Ø¨Ø¨ (Ø¨Ù†Ø²ÙŠÙ†ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡..)">
                <input type="number" id="expAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="btn btn-danger" onclick="addExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
            </div>
            <table id="expenseTable">
                <thead><tr><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th></tr></thead>
                <tbody id="expenseBody"></tbody>
            </table>
        </div>

        <div id="tab-finance" class="hidden">
            <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø±Ø­Ù„Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody id="financeTableBody"></tbody></table>
        </div>

        <div id="tab-scooters" class="hidden">
            <table><thead><tr><th>Ø³ÙƒÙˆØªØ±</th><th>Ø¥ÙŠØ±Ø§Ø¯</th><th>Ø£Ø¹Ø·Ø§Ù„</th></tr></thead><tbody id="scooterTableBody"></tbody></table>
        </div>
    </div>

    <!-- Modals (Shift / Attendance / Finish) -->
    <div id="attendance-modal" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <h3>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù</h3>
            <p id="loc-status" style="margin:15px 0; font-size:14px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>
            <button id="clock-in-btn" class="btn btn-primary" onclick="submitAttendance('Ø­Ø¶ÙˆØ±')" disabled>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
            <button id="clock-out-btn" class="btn btn-danger" style="margin-top:10px; background:#333; color:#fff;" onclick="submitAttendance('Ø§Ù†ØµØ±Ø§Ù')" disabled>ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù</button>
            <button class="btn btn-outline" style="margin-top:10px; border:1px solid #ddd;" onclick="document.getElementById('attendance-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="finishModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <h2>ØªØ­ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡</h2>
            <div id="finishContent"></div>
        </div>
    </div>

    <div id="closeShiftModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <h3>Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</h3>
            <div id="shiftTotals" style="margin:20px 0; background:#f1f5f9; padding:15px; border-radius:15px;"></div>
            <p style="font-size:12px; color:#666;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯Ùƒ.</p>
            <button class="btn btn-primary" onclick="confirmCloseShift()">ØªØ£ÙƒÙŠØ¯ ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„ÙƒØ§Ø´</button>
            <button class="btn btn-outline" style="margin-top:10px; border:1px solid #ddd;" onclick="document.getElementById('closeShiftModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2J3KViN4aZYRJ43rYGFtwkmy-jZXBO6c",
            authDomain: "yalla-scooter-pro.firebaseapp.com",
            databaseURL: "https://yalla-scooter-pro-default-rtdb.firebaseio.com",
            projectId: "yalla-scooter-pro",
            storageBucket: "yalla-scooter-pro.firebasestorage.app",
            messagingSenderId: "185791475252",
            appId: "1:185791475252:web:fea7d7e2e9a18cd8a86461"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const TELEGRAM_TOKEN = "8596127440:AAGNZDaao8fqddjMfEu38ZHrCTyOs9hrchs";
        const ADMIN_CHAT = "5684905593";
        const DEVICE_ID = localStorage.getItem('yalla_final_v44') || 'v44_'+Math.random().toString(36).substr(2,9);
        localStorage.setItem('yalla_final_v44', DEVICE_ID);

        const ADMIN_LIST = ["Hussin13", "shbaan12"];
        let currentImg = "";

        // --- Auth & Security Monitoring ---
        function handleLogin() {
            const p = document.getElementById('loginPass').value;
            if (p === "yalaa12") {
                db.ref('banned_devices/' + DEVICE_ID).once('value', s => {
                    if (s.exists()) return alert("Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø­Ø¸ÙˆØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!");
                    
                    let name = localStorage.getItem('staff_name');
                    if (!name) {
                        name = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:");
                        if (name) localStorage.setItem('staff_name', name); else return;
                    }
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    initApp();
                });
            } else alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£!");
        }

        function initApp() {
            listenTrips(); updateDashboard(); setInterval(updateTimers, 1000);
            // Presence
            db.ref('online_staff/' + DEVICE_ID).set({name: localStorage.getItem('staff_name'), device: DEVICE_ID, time: new Date().toLocaleTimeString()});
            db.ref('online_staff/' + DEVICE_ID).onDisconnect().remove();
            
            // Security listener (Kick/Ban)
            db.ref('online_staff/' + DEVICE_ID).on('value', s => { if(!s.exists() && localStorage.getItem('staff_name')) location.reload(); });
            db.ref('banned_devices/' + DEVICE_ID).on('value', s => { if(s.exists()) location.reload(); });
        }

        // --- Admin Functions ---
        function kickStaff(id) { db.ref('online_staff/'+id).remove(); }
        function banStaff(id) { db.ref('banned_devices/'+id).set(true); db.ref('online_staff/'+id).remove(); }
        function unbanStaff(id) { db.ref('banned_devices/'+id).remove(); }

        // --- Shift Handover ---
        function openCloseShiftModal() {
            const today = new Date().toISOString().split('T')[0];
            const name = localStorage.getItem('staff_name');
            db.ref('history/'+today).once('value', snap => {
                let total = 0;
                snap.forEach(trip => { if(trip.val().staff === name) total += parseFloat(trip.val().final || 0); });
                document.getElementById('shiftTotals').innerHTML = `<h4>ÙƒØ§Ø´ ÙˆØ±Ø¯ÙŠØ© ${name}:</h4><h1 style="color:var(--primary);">${total.toFixed(2)} Ø¬.Ù…</h1>`;
                document.getElementById('closeShiftModal').style.display = 'flex';
            });
        }

        function confirmCloseShift() {
            const name = localStorage.getItem('staff_name');
            sendTelegram(`ğŸ **ØªÙ‚ÙÙŠÙ„ ÙˆØ±Ø¯ÙŠØ©**\nØ§Ù„Ù…ÙˆØ¸Ù: ${name}\nØ§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³Ù„Ù…: ${document.querySelector('#shiftTotals h1').innerText}`);
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù†.");
            logout();
        }

        // --- Expenses ---
        function addExpense() {
            const reason = document.getElementById('expReason').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            if(!reason || !amount) return;
            const date = new Date().toISOString().split('T')[0];
            db.ref('expenses/'+date).push({reason, amount, staff: localStorage.getItem('staff_name')});
            document.getElementById('expReason').value = ""; document.getElementById('expAmount').value = "";
            sendTelegram(`ğŸ’¸ **Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯**\nØ§Ù„Ø³Ø¨Ø¨: ${reason}\nØ§Ù„Ù…Ø¨Ù„Øº: ${amount} Ø¬`);
        }

        // --- Rental Management (Original V43 logic preserved) ---
        function searchCustomer(ph) {
            const box = document.getElementById('debtAlert');
            if(ph.length < 10) { box.classList.add('hidden'); return; }
            db.ref('customers/'+ph).once('value', s => {
                if(s.exists()){
                    const c = s.val();
                    document.getElementById('custName').value = c.name;
                    if(c.img) { currentImg = c.img; document.getElementById('idPreview').src = c.img; document.getElementById('idPreview').style.display = 'block'; }
                    if(parseFloat(c.debt) > 0) { box.innerText = `âš ï¸ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©: ${c.debt} Ø¬.Ù…`; box.classList.remove('hidden'); }
                }
            });
        }

        function handleImage(i) {
            const r = new FileReader(); r.onload = e => { currentImg = e.target.result; document.getElementById('idPreview').src = e.target.result; document.getElementById('idPreview').style.display = 'block'; }; r.readAsDataURL(i.files[0]);
        }

        function startRental() {
            const sc = document.getElementById('scooterID').value.toUpperCase();
            const ph = document.getElementById('custPhone').value;
            const nm = document.getElementById('custName').value;
            if(!sc || !ph || !nm) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            db.ref('active_trips').push({ scooter: sc, phone: ph, custName: nm, staff: localStorage.getItem('staff_name'), start: Date.now(), idImg: currentImg });
            db.ref('customers/'+ph).update({name: nm, img: currentImg});
            sendTelegram(`ğŸš€ **Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø£Øª!**\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${sc}\nØ§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${localStorage.getItem('staff_name')}`);
            resetForm();
        }

        function openFinishModal(key) {
            db.ref('active_trips/'+key).once('value', s => {
                const t = s.val();
                const mins = Math.max(1, Math.ceil((Date.now() - t.start)/60000));
                const tripCost = mins * 2.5;
                db.ref('customers/'+t.phone+'/debt').once('value', dSnap => {
                    const debt = parseFloat(dSnap.val() || 0);
                    const total = tripCost + debt;
                    document.getElementById('finishContent').innerHTML = `
                        <h1 style="font-size:35px; color:var(--success);">${total.toFixed(2)}</h1>
                        <p>Ù…Ø¯Ø©: ${mins} Ø¯ | Ø±Ø­Ù„Ø©: ${tripCost} | Ø¯ÙŠÙ†: ${debt}</p>
                        <div style="text-align:right; margin-top:10px;">
                            <label><input type="checkbox" id="scBroken"> Ø¹Ø·Ù„ ğŸ› </label>
                            <input type="number" id="discount" placeholder="Ø®ØµÙ…" oninput="document.getElementById('paid').value = (${total}-this.value).toFixed(2)">
                            <input type="number" id="paid" value="${total.toFixed(2)}" style="text-align:center; font-size:20px; font-weight:800; margin-top:10px;">
                        </div>
                        <button class="btn btn-primary" onclick="confirmFinish('${key}', ${mins}, ${tripCost}, ${debt})">ØªØ­ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡</button>
                    `;
                    document.getElementById('finishModal').style.display='flex';
                });
            });
        }

        function confirmFinish(key, mins, cost, oldDebt) {
            const paid = parseFloat(document.getElementById('paid').value) || 0;
            const disc = parseFloat(document.getElementById('discount').value) || 0;
            const isBroken = document.getElementById('scBroken').checked;
            const newDebt = (cost + oldDebt - disc) - paid;
            db.ref('active_trips/'+key).once('value', s => {
                const t = s.val();
                const today = new Date().toISOString().split('T')[0];
                db.ref('history/'+today).push({...t, mins, final: paid, isBroken, end: Date.now()});
                db.ref('customers/'+t.phone+'/debt').set(newDebt);
                db.ref('scooters_stats/'+t.scooter).transaction(curr => {
                    const d = curr || { revenue: 0, issues: 0 };
                    return { revenue: (parseFloat(d.revenue)||0)+paid, issues: (parseInt(d.issues)||0)+(isBroken?1:0) };
                }).then(() => {
                    sendTelegram(`âœ… **Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©!**\nØ§Ù„Ø³ÙƒÙˆØªØ±: ${t.scooter}\nØ§Ù„ØµØ§ÙÙŠ: ${paid.toFixed(2)} Ø¬.Ù…`);
                });
                db.ref('active_trips/'+key).remove();
                document.getElementById('finishModal').style.display='none';
            });
        }

        // --- Core Stats ---
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            db.ref('history/'+today).on('value', snap => {
                let total = 0; snap.forEach(c => total += parseFloat(c.val().final || 0));
                document.getElementById('stat-income').innerText = total.toFixed(2);
                
                db.ref('expenses/'+today).on('value', eSnap => {
                    let exps = 0; eSnap.forEach(e => exps += parseFloat(e.val().amount || 0));
                    document.getElementById('stat-profit').innerText = (total - exps).toFixed(2);
                });
            });
            db.ref('active_trips').on('value', s => { document.getElementById('stat-active').innerText = s.numChildren(); });
        }

        function listenTrips() {
            db.ref('active_trips').on('value', s => {
                const list = document.getElementById('activeTripsList'); list.innerHTML = "";
                s.forEach(c => {
                    list.innerHTML += `<div class="trip-card"><b>ğŸ›µ ${c.val().scooter}</b> - ${c.val().custName}<div id="timer-${c.key}" style="font-size:22px; font-weight:800; color:var(--primary);">00:00</div><button class="btn btn-danger" onclick="openFinishModal('${c.key}')">Ø¥Ù†Ù‡Ø§Ø¡</button></div>`;
                });
            });
        }

        function updateTimers() {
            document.querySelectorAll('[id^="timer-"]').forEach(el => {
                const key = el.id.replace('timer-', '');
                db.ref('active_trips/'+key+'/start').once('value', s => {
                    if(s.exists()){
                        const d = Date.now() - s.val();
                        const m = Math.floor(d/60000); const sec = Math.floor((d%60000)/1000);
                        el.innerText = `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                    }
                });
            });
        }

        // --- Attendance ---
        function openAttendance() {
            document.getElementById('attendance-modal').style.display = 'flex';
            const name = localStorage.getItem('staff_name');
            if(ADMIN_LIST.includes(name)) { document.getElementById('loc-status').innerText = "âœ… ØªØ®Ø·ÙŠ GPS"; document.getElementById('clock-in-btn').disabled = false; }
            else {
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition(pos => {
                        const dist = getDist(pos.coords.latitude, pos.coords.longitude, 27.185688, 31.191188);
                        if(dist <= 0.2) { document.getElementById('loc-status').innerText = "âœ… ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚"; document.getElementById('clock-in-btn').disabled = false; document.getElementById('clock-out-btn').disabled = false; }
                        else document.getElementById('loc-status').innerText = "âŒ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚";
                    });
                }
            }
        }
        function submitAttendance(type) {
            const date = new Date().toISOString().split('T')[0];
            db.ref(`attendance/${date}/${localStorage.getItem('staff_name')}`).update({ name: localStorage.getItem('staff_name'), [type==='Ø­Ø¶ÙˆØ±'?'in':'out']: new Date().toLocaleTimeString('ar-EG') });
            document.getElementById('attendance-modal').style.display = 'none';
        }

        // --- Admin Tabs ---
        function openAdmin() {
            const name = localStorage.getItem('staff_name');
            if (ADMIN_LIST.includes(name)) { document.getElementById('adminPanel').style.display='block'; showTab('security'); }
            else {
                const p = prompt("ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:");
                if(p === "yalaa12") { document.getElementById('adminPanel').style.display='block'; showTab('security'); }
            }
        }

        function showTab(t) {
            document.querySelectorAll('[id^="tab-"]').forEach(x => x.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(t==='security') loadSecurity();
            if(t==='expenses') loadExpenses();
            if(t==='finance') loadFinance();
            if(t==='scooters') loadScooterStats();
        }

        function loadSecurity() {
            db.ref('online_staff').on('value', s => {
                const b = document.getElementById('onlineStaffBody'); b.innerHTML = "";
                s.forEach(c => {
                    const v = c.val();
                    const isMe = c.key === DEVICE_ID;
                    b.innerHTML += `<tr><td>${v.name} ${isMe?'(Ø£Ù†Øª)':''}</td><td>${v.time}</td><td>${!isMe? `<button onclick="kickStaff('${c.key}')" style="color:orange;">Ø·Ø±Ø¯</button> | <button onclick="banStaff('${c.key}')" style="color:red;">Ø­Ø¸Ø±</button>` : '-'}</td></tr>`;
                });
            });
            db.ref('banned_devices').on('value', s => {
                const b = document.getElementById('bannedBody'); b.innerHTML = "";
                s.forEach(c => b.innerHTML += `<tr><td>${c.key}</td><td><button onclick="unbanStaff('${c.key}')" style="color:green;">ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</button></td></tr>`);
            });
        }

        function loadExpenses() {
            const date = new Date().toISOString().split('T')[0];
            db.ref('expenses/'+date).on('value', s => {
                const b = document.getElementById('expenseBody'); b.innerHTML = "";
                s.forEach(c => b.innerHTML += `<tr><td>${c.val().reason}</td><td>${c.val().amount} Ø¬</td><td>${c.val().staff}</td></tr>`);
            });
        }

        function loadFinance() {
            db.ref('history').once('value', s => {
                const b = document.getElementById('financeTableBody'); b.innerHTML = "";
                const days = [];
                s.forEach(day => {
                    let total = 0; let count = 0;
                    day.forEach(t => { total += parseFloat(t.val().final || 0); count++; });
                    days.push({ date: day.key, count, total });
                });
                days.reverse().forEach(d => b.innerHTML += `<tr><td>${d.date}</td><td>${d.count}</td><td>${d.total.toFixed(2)}</td></tr>`);
            });
        }

        function loadScooterStats() {
            db.ref('scooters_stats').once('value', s => {
                const b = document.getElementById('scooterTableBody'); b.innerHTML = "";
                s.forEach(c => b.innerHTML += `<tr><td>${c.key}</td><td>${parseFloat(c.val().revenue).toFixed(2)} Ø¬</td><td>${c.val().issues}</td><td>${c.val().issues>=3?'ğŸ”´ ØµÙŠØ§Ù†Ø©':'ğŸŸ¢ Ø¬ÙŠØ¯'}</td></tr>`);
            });
        }

        // --- Helpers ---
        function logout() { db.ref('online_staff/'+DEVICE_ID).remove(); localStorage.removeItem('staff_name'); location.reload(); }
        function closeAdmin() { document.getElementById('adminPanel').style.display='none'; }
        function resetForm() { document.getElementById('scooterID').value=""; document.getElementById('custPhone').value=""; document.getElementById('custName').value=""; document.getElementById('idPreview').style.display='none'; currentImg=""; }
        function getDist(l1, o1, l2, o2) { const R = 6371; const dLat = (l2-l1)*Math.PI/180; const dLon = (o2-o1)*Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function sendTelegram(msg) { fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: ADMIN_CHAT, text: msg, parse_mode: 'Markdown' }) }); }
    </script>
</body>
</html>
